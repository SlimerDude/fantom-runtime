<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
  <title>wisp::WispService</title>
  <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
  <link rel='stylesheet' type='text/css' href='../doc.css'/>
  <script type='text/javascript' src='../doc.js'></script>
<!--[if lt IE 7]>
<script src='http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE7.js' type='text/javascript'></script>
<![endif]-->
</head>
<body onload='Login.check();'>
<div class='header'>
<div>
<h1><a href='/'>Fantom</a></h1>
<p id='sidewalkLogin_'>&nbsp;</p>
<form method='get' action='/sidewalk/search/'>
<p>
<input type='text' name='q' size='30' value='Search...' onfocus='if (value=="Search...") value=""' onblur='if (value=="") value="Search..."' />
</p>
</form>
<ul>
<li><a href='/'>Home</a></li>
<li class='active'><a href='../index.html'>Docs</a></li>
<li><a href='/sidewalk/blog/'>Blog</a></li>
<li><a href='/sidewalk/ticket/'>Tickets</a></li>
<li><a href='/sidewalk/topic/'>Discuss</a></li>
</ul></div>
</div>
<div class='subHeader'>
<div>
<ul>
  <li><a href='../index.html'>Doc Home</a></li>
  <li>&gt;</li>
  <li><a href='index.html'>wisp</a></li>
  <li>&gt;</li>
  <li><a href='WispService.html'>WispService</a></li>
</ul>
</div>
</div>
<div class='content'>
<div>
<div class='fandoc'>
<div class='type'>
<div class='overview'>
<h2>const class</h2>
<h1>wisp::WispService</h1>
<pre><a href='../sys/Obj.html'>sys::Obj</a>
  wisp::WispService : <a href='../sys/Service.html'>sys::Service</a></pre>
</div>
</div>
<div class='src'>
<pre>
<span class='y'>//</span>
<span class='y'>// Copyright (c) 2007, Brian Frank and Andy Frank</span>
<span class='y'>// Licensed under the Academic Free License version 3.0</span>
<span class='y'>//</span>
<span class='y'>// History:</span>
<span class='y'>//   21 Dec 07  Brian Frank  Creation</span>
<span class='y'>//</span>

<span class='k'>using</span> concurrent
<span class='k'>using</span> web
<span class='k'>using</span> inet

<span class='z'>**</span>
<span class='z'>** Simple web server services HTTP requests on a configured port</span>
<span class='z'>** to a top-level root WebMod.  A given instance of WispService can</span>
<span class='z'>** be only be used through one start/stop lifecycle.</span>
<span class='z'>**</span>
<span class='z'>** Example:</span>
<span class='z'>**   WispService { port = 8080; root = MyWebMod() }.start</span>
<span class='z'>**</span>
<span class='k'>const</span> <span class='k'>class</span> WispService : Service
<span class='b'>{</span>

  <span class='z'>**</span>
  <span class='z'>** Standard log for web service</span>
  <span class='z'>**</span>
  <span class='k'>internal</span> <span class='k'>static</span> <span class='k'>const</span> Log <span id='log'>log</span> := Log.get<span class='b'>(</span><span class='s'>"web"</span><span class='b'>)</span>

  <span class='z'>**</span>
  <span class='z'>** Well known TCP port for HTTP traffic.</span>
  <span class='z'>**</span>
  <span class='k'>const</span> Int <span id='port'>port</span> := 80

  <span class='z'>**</span>
  <span class='z'>** Root WebMod used to service requests.</span>
  <span class='z'>**</span>
  <span class='k'>const</span> WebMod <span id='root'>root</span> := WispDefaultMod<span class='b'>()</span>

  <span class='z'>**</span>
  <span class='z'>** Pluggable interface for managing web session state.</span>
  <span class='z'>** Default implementation stores sessions in main memory.</span>
  <span class='z'>**</span>
  <span class='k'>const</span> WispSessionStore <span id='sessionStore'>sessionStore</span> := MemWispSessionStore<span class='b'>()</span>

  <span class='k'>new</span> <span id='make'>make</span><span class='b'>(</span>|This|? f := <span class='k'>null</span><span class='b'>)</span> <span class='b'>{</span> <span class='k'>if</span> <span class='b'>(</span>f != <span class='k'>null</span><span class='b'>)</span> f<span class='b'>(</span><span class='k'>this</span><span class='b'>)</span> <span class='b'>}</span>

  <span class='k'>override</span> Void <span id='onStart'>onStart</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='k'>if</span> <span class='b'>(</span>listenerPool.isStopped<span class='b'>)</span> <span class='k'>throw</span> Err<span class='b'>(</span><span class='s'>"WispService is already stopped, use to new instance to restart"</span><span class='b'>)</span>
    Actor<span class='b'>(</span>listenerPool, |-&gt;| <span class='b'>{</span> listen <span class='b'>})</span>.send<span class='b'>(</span><span class='k'>null</span><span class='b'>)</span>
    sessionStore.onStart
    root.onStart
  <span class='b'>}</span>

  <span class='k'>override</span> Void <span id='onStop'>onStop</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='k'>try</span> root.onStop;            <span class='k'>catch</span> <span class='b'>(</span>Err e<span class='b'>)</span> log.err<span class='b'>(</span><span class='s'>"WispService stop root WebMod"</span>, e<span class='b'>)</span>
    <span class='k'>try</span> tcpListener.val-&gt;close; <span class='k'>catch</span> <span class='b'>(</span>Err e<span class='b'>)</span> log.err<span class='b'>(</span><span class='s'>"WispService stop listener socket"</span>, e<span class='b'>)</span>
    <span class='k'>try</span> listenerPool.stop;      <span class='k'>catch</span> <span class='b'>(</span>Err e<span class='b'>)</span> log.err<span class='b'>(</span><span class='s'>"WispService stop listener pool"</span>, e<span class='b'>)</span>
    <span class='k'>try</span> processorPool.stop;     <span class='k'>catch</span> <span class='b'>(</span>Err e<span class='b'>)</span> log.err<span class='b'>(</span><span class='s'>"WispService stop processor pool"</span>, e<span class='b'>)</span>
    <span class='k'>try</span> sessionStore.onStop;    <span class='k'>catch</span> <span class='b'>(</span>Err e<span class='b'>)</span> log.err<span class='b'>(</span><span class='s'>"WispService stop session store"</span>, e<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='k'>internal</span> Void <span id='listen'>listen</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='y'>// loop until we successfully bind to port</span>
    listener := TcpListener<span class='b'>()</span>
    <span class='k'>this</span>.tcpListener.val = listener
    <span class='k'>while</span> <span class='b'>(</span><span class='k'>true</span><span class='b'>)</span>
    <span class='b'>{</span>
      <span class='k'>try</span>
      <span class='b'>{</span>
        listener.bind<span class='b'>(</span><span class='k'>null</span>, port<span class='b'>)</span>
        <span class='k'>break</span>
      <span class='b'>}</span>
      <span class='k'>catch</span> <span class='b'>(</span>Err e<span class='b'>)</span>
      <span class='b'>{</span>
        log.err<span class='b'>(</span><span class='s'>"WispService cannot bind to port ${port}"</span>, e<span class='b'>)</span>
        Actor.sleep<span class='b'>(</span>10sec<span class='b'>)</span>
      <span class='b'>}</span>
    <span class='b'>}</span>
    log.info<span class='b'>(</span><span class='s'>"WispService started on port ${port}"</span><span class='b'>)</span>

    <span class='y'>// loop until stopped accepting incoming TCP connections</span>
    <span class='k'>while</span> <span class='b'>(</span>!listenerPool.isStopped<span class='b'>)</span>
    <span class='b'>{</span>
      <span class='k'>try</span>
      <span class='b'>{</span>
        socket := listener.accept
        WispActor<span class='b'>(</span><span class='k'>this</span>, socket<span class='b'>)</span>.send<span class='b'>(</span><span class='k'>null</span><span class='b'>)</span>
      <span class='b'>}</span>
      <span class='k'>catch</span> <span class='b'>(</span>Err e<span class='b'>)</span>
      <span class='b'>{</span>
        <span class='k'>if</span> <span class='b'>(</span>!listenerPool.isStopped<span class='b'>)</span>
          log.err<span class='b'>(</span><span class='s'>"WispService accept on ${port}"</span>, e<span class='b'>)</span>
      <span class='b'>}</span>
    <span class='b'>}</span>

    <span class='y'>// socket should be closed by onStop, but do it again to be really sure</span>
    <span class='k'>try</span> <span class='b'>{</span> listener.close <span class='b'>}</span> <span class='k'>catch</span> <span class='b'>{}</span>
    log.info<span class='b'>(</span><span class='s'>"WispService stopped on port ${port}"</span><span class='b'>)</span>
  <span class='b'>}</span>

  <span class='k'>internal</span> <span class='k'>const</span> ActorPool <span id='listenerPool'>listenerPool</span>    := ActorPool<span class='b'>()</span>
  <span class='k'>internal</span> <span class='k'>const</span> AtomicRef <span id='tcpListener'>tcpListener</span>     := AtomicRef<span class='b'>()</span>
  <span class='k'>internal</span> <span class='k'>const</span> ActorPool <span id='processorPool'>processorPool</span>   := ActorPool<span class='b'>()</span>

  @NoDoc <span class='k'>static</span> Void <span id='main'>main</span><span class='b'>()</span>
  <span class='b'>{</span>
    WispService <span class='b'>{</span> port = 8080 <span class='b'>}</span>.start
    Actor.sleep<span class='b'>(</span>Duration.maxVal<span class='b'>)</span>
  <span class='b'>}</span>
<span class='b'>}</span>


<span class='k'>internal</span> <span class='k'>const</span> <span class='k'>class</span> WispDefaultMod : WebMod
<span class='b'>{</span>
  <span class='k'>override</span> Void onGet<span class='b'>()</span>
  <span class='b'>{</span>
    res.headers<span class='b'>[</span><span class='s'>"Content-Type"</span><span class='b'>]</span> = <span class='s'>"text/html; charset=utf-8"</span>
    out := res.out
    out.html
      .head
        .title.w<span class='b'>(</span><span class='s'>"Wisp"</span><span class='b'>)</span>.titleEnd
      .headEnd
      .body
        .h1.w<span class='b'>(</span><span class='s'>"Wisp"</span><span class='b'>)</span>.h1End
        .p.w<span class='b'>(</span><span class='s'>"Wisp is running!"</span><span class='b'>)</span>.pEnd
        .p.w<span class='b'>(</span><span class='s'>"Currently there is no WebMod installed on this server."</span><span class='b'>)</span>.pEnd
        .p.w<span class='b'>(</span><span class='s'>"See &lt;a href='http://fantom.org/doc/wisp/pod-doc.html'&gt;wisp::pod-doc&lt;/a&gt;
              to configure a WebMod for the server."</span><span class='b'>)</span>.pEnd
      .bodyEnd
    .htmlEnd
  <span class='b'>}</span>
<span class='b'>}</span></pre>
</div>
</div>
<div class='sidebar'>
<h2>More Info</h2>
<ul class='clean'>
  <li><a href='WispService.html'>View Fandoc</a></li>
</ul>
<div class='slots'>
<div class='overview'>
<h2>Slots</h2>
<ul class='clean'>
  <li class='hidden' style='display: block;'><a href='#listen'>listen</a></li>
  <li class='hidden' style='display: block;'><a href='#listenerPool'>listenerPool</a></li>
  <li class='hidden' style='display: block;'><a href='#log'>log</a></li>
  <li style='display: block;'><a href='#make'>make</a></li>
  <li style='display: block;'><a href='#onStart'>onStart</a></li>
  <li style='display: block;'><a href='#onStop'>onStop</a></li>
  <li style='display: block;'><a href='#port'>port</a></li>
  <li class='hidden' style='display: block;'><a href='#processorPool'>processorPool</a></li>
  <li style='display: block;'><a href='#root'>root</a></li>
  <li style='display: block;'><a href='#sessionStore'>sessionStore</a></li>
  <li class='hidden' style='display: block;'><a href='#tcpListener'>tcpListener</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class='footer'>
<div>
<p>
wisp 1.0.56
[11-Nov-2010 Thu 10:08:21AM EST]
</p>
</div>
</div>
</body>
</html>
