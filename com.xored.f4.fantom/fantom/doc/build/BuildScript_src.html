<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
  <title>build::BuildScript</title>
  <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
  <link rel='stylesheet' type='text/css' href='../doc.css'/>
  <script type='text/javascript' src='../doc.js'></script>
<!--[if lt IE 7]>
<script src='http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE7.js' type='text/javascript'></script>
<![endif]-->
</head>
<body onload='Login.check();'>
<div class='header'>
<div>
<h1><a href='/'>Fantom</a></h1>
<p id='sidewalkLogin_'>&nbsp;</p>
<form method='get' action='/sidewalk/search/'>
<p>
<input type='text' name='q' size='30' value='Search...' onfocus='if (value=="Search...") value=""' onblur='if (value=="") value="Search..."' />
</p>
</form>
<ul>
<li><a href='/'>Home</a></li>
<li class='active'><a href='../index.html'>Docs</a></li>
<li><a href='/sidewalk/blog/'>Blog</a></li>
<li><a href='/sidewalk/ticket/'>Tickets</a></li>
<li><a href='/sidewalk/topic/'>Discuss</a></li>
</ul></div>
</div>
<div class='subHeader'>
<div>
<ul>
  <li><a href='../index.html'>Doc Home</a></li>
  <li>&gt;</li>
  <li><a href='index.html'>build</a></li>
  <li>&gt;</li>
  <li><a href='BuildScript.html'>BuildScript</a></li>
</ul>
</div>
</div>
<div class='content'>
<div>
<div class='fandoc'>
<div class='type'>
<div class='overview'>
<h2>abstract class</h2>
<h1>build::BuildScript</h1>
<pre><a href='../sys/Obj.html'>sys::Obj</a>
  build::BuildScript</pre>
</div>
</div>
<div class='src'>
<pre>
<span class='y'>//</span>
<span class='y'>// Copyright (c) 2006, Brian Frank and Andy Frank</span>
<span class='y'>// Licensed under the Academic Free License version 3.0</span>
<span class='y'>//</span>
<span class='y'>// History:</span>
<span class='y'>//   3 Nov 06  Brian Frank  Creation</span>
<span class='y'>//</span>

<span class='k'>using</span> compiler

<span class='z'>**</span>
<span class='z'>** BuildScript is the base class for build scripts - it manages</span>
<span class='z'>** the command line interface, argument parsing, environment, and</span>
<span class='z'>** target execution.</span>
<span class='z'>**</span>
<span class='z'>** See `docTools::Build` for details.</span>
<span class='z'>**</span>
<span class='k'>abstract</span> <span class='k'>class</span> BuildScript
<span class='b'>{</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Env</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Log used for error reporting and tracing</span>
  <span class='z'>**</span>
  BuildLog <span id='log'>log</span> := BuildLog<span class='b'>()</span>

  <span class='z'>**</span>
  <span class='z'>** The source file of this script</span>
  <span class='z'>**</span>
  <span class='k'>const</span> File <span id='scriptFile'>scriptFile</span> := File<span class='b'>(</span>typeof-&gt;sourceFile.toStr.toUri<span class='b'>)</span>.normalize

  <span class='z'>**</span>
  <span class='z'>** The directory containing the this script</span>
  <span class='z'>**</span>
  <span class='k'>const</span> File <span id='scriptDir'>scriptDir</span> := scriptFile.parent

  <span class='z'>**</span>
  <span class='z'>** Home directory of development installation.  By default this</span>
  <span class='z'>** value is initialized by 'devHome' config prop, otherwise</span>
  <span class='z'>** `sys::Env.homeDir` is used.</span>
  <span class='z'>**</span>
  <span class='k'>const</span> File <span id='devHomeDir'>devHomeDir</span> := configDir<span class='b'>(</span><span class='s'>"devHome"</span>, Env.cur.homeDir<span class='b'>)</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Targets</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Lookup a target by name.  If not found and checked is</span>
  <span class='z'>** false return null, otherwise throw an exception.</span>
  <span class='z'>**</span>
  TargetMethod? <span id='target'>target</span><span class='b'>(</span>Str name, Bool checked := <span class='k'>true</span><span class='b'>)</span>
  <span class='b'>{</span>
    t := targets.find |t| <span class='b'>{</span> t.name == name <span class='b'>}</span>
    <span class='k'>if</span> <span class='b'>(</span>t != <span class='k'>null</span><span class='b'>)</span> <span class='k'>return</span> t
    <span class='k'>if</span> <span class='b'>(</span>checked<span class='b'>)</span> <span class='k'>throw</span> Err<span class='b'>(</span><span class='s'>"Target not found '$name' in $scriptFile"</span><span class='b'>)</span>
    <span class='k'>return</span> <span class='k'>null</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Get the list of published targets for this script.  The</span>
  <span class='z'>** first target should be the default.  The list of targets</span>
  <span class='z'>** is defined by all the methods with the `Target` facet.</span>
  <span class='z'>**</span>
  <span class='k'>virtual</span> <span class='k'>once</span> TargetMethod<span class='b'>[]</span> <span id='targets'>targets</span><span class='b'>()</span>
  <span class='b'>{</span>
    acc := TargetMethod<span class='b'>[</span>,<span class='b'>]</span>
    typeof.methods.each |m|
    <span class='b'>{</span>
      <span class='k'>if</span> <span class='b'>(</span>!m.hasFacet<span class='b'>(</span>Target#<span class='b'>))</span> <span class='k'>return</span>
      acc.add<span class='b'>(</span>TargetMethod<span class='b'>(</span><span class='k'>this</span>, m<span class='b'>))</span>
    <span class='b'>}</span>
    <span class='k'>return</span> acc
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Utils</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Get a config property using the following rules:</span>
  <span class='z'>**   1. `sys::Env.vars` with 'FAN_BUILD_$name.upper'</span>
  <span class='z'>**   2. `sys::Env.config` for build pod</span>
  <span class='z'>**   3. fallback to 'def' parameter</span>
  <span class='z'>**</span>
  Str? <span id='config'>config</span><span class='b'>(</span>Str name, Str? def := <span class='k'>null</span><span class='b'>)</span>
  <span class='b'>{</span>
    Env.cur.vars<span class='b'>[</span><span class='s'>"FAN_BUILD_$name.upper"</span><span class='b'>]</span> ?:
    Env.cur.config<span class='b'>(</span>BuildScript#.pod, name, def<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Get a `config` prop which identifies a directory.</span>
  <span class='z'>** If the prop isn't configured or doesn't map to a</span>
  <span class='z'>** valid directory, then return def.</span>
  <span class='z'>**</span>
  File? <span id='configDir'>configDir</span><span class='b'>(</span>Str name, File? def := <span class='k'>null</span><span class='b'>)</span>
  <span class='b'>{</span>
    c := config<span class='b'>(</span>name<span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>c == <span class='k'>null</span><span class='b'>)</span> <span class='k'>return</span> def
    <span class='k'>try</span>
    <span class='b'>{</span>
      f := File<span class='b'>(</span>c.toUri<span class='b'>)</span>
      <span class='k'>if</span> <span class='b'>(</span>!f.exists || !f.isDir<span class='b'>)</span> <span class='k'>throw</span> Err<span class='b'>()</span>
      <span class='k'>return</span> f
    <span class='b'>}</span>
    <span class='k'>catch</span> <span class='b'>(</span>Err e<span class='b'>)</span> log.err<span class='b'>(</span><span class='s'>"Invalid configDir URI for '$name': $c\n  $e"</span><span class='b'>)</span>
    <span class='k'>return</span> def
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Resolve a set of URIs to files relative to scriptDir.</span>
  <span class='z'>**</span>
  <span class='k'>internal</span> File<span class='b'>[]</span> <span id='resolveFiles'>resolveFiles</span><span class='b'>(</span>Uri<span class='b'>[]</span> uris<span class='b'>)</span>
  <span class='b'>{</span>
    uris.map |uri-&gt;File|
    <span class='b'>{</span>
      f := scriptDir + uri
      <span class='k'>if</span> <span class='b'>(</span>!f.exists || f.isDir<span class='b'>)</span> <span class='k'>throw</span> fatal<span class='b'>(</span><span class='s'>"Invalid file: $uri"</span><span class='b'>)</span>
      <span class='k'>return</span> f
    <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Resolve a set of URIs to directories relative to scriptDir.</span>
  <span class='z'>**</span>
  <span class='k'>internal</span> File<span class='b'>[]</span> <span id='resolveDirs'>resolveDirs</span><span class='b'>(</span>Uri<span class='b'>[]</span> uris<span class='b'>)</span>
  <span class='b'>{</span>
    uris.map |uri-&gt;File|
    <span class='b'>{</span>
      f := scriptDir + uri
      <span class='k'>if</span> <span class='b'>(</span>!f.exists || !f.isDir<span class='b'>)</span> <span class='k'>throw</span> fatal<span class='b'>(</span><span class='s'>"Invalid dir: $uri"</span><span class='b'>)</span>
      <span class='k'>return</span> f
    <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Resolve a set of URIs to files/dirs relative to scriptDir.</span>
  <span class='z'>**</span>
  <span class='k'>internal</span> File<span class='b'>[]</span> <span id='resolveFilesOrDirs'>resolveFilesOrDirs</span><span class='b'>(</span>Uri<span class='b'>[]</span> uris<span class='b'>)</span>
  <span class='b'>{</span>
    uris.map |uri-&gt;File|
    <span class='b'>{</span>
      f := scriptDir + uri
      <span class='k'>if</span> <span class='b'>(</span>!f.exists<span class='b'>)</span> <span class='k'>throw</span> fatal<span class='b'>(</span><span class='s'>"Invalid file: $uri"</span><span class='b'>)</span>
      <span class='k'>return</span> f
    <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Dump script environment for debug.</span>
  <span class='z'>**</span>
  <span class='k'>virtual</span> Void <span id='dumpEnv'>dumpEnv</span><span class='b'>()</span>
  <span class='b'>{</span>
    log.printLine<span class='b'>(</span><span class='s'>"---------------"</span><span class='b'>)</span>
    log.printLine<span class='b'>(</span><span class='s'>"  scriptFile:    $scriptFile"</span><span class='b'>)</span>
    log.printLine<span class='b'>(</span><span class='s'>"  typeof:        $typeof.base"</span><span class='b'>)</span>
    log.printLine<span class='b'>(</span><span class='s'>"  env.homeDir:   $Env.cur.homeDir"</span><span class='b'>)</span>
    log.printLine<span class='b'>(</span><span class='s'>"  env.workDir:   $Env.cur.workDir"</span><span class='b'>)</span>
    log.printLine<span class='b'>(</span><span class='s'>"  devHomeDir:    $devHomeDir"</span><span class='b'>)</span>
    typeof.fields.each |f|
    <span class='b'>{</span>
      <span class='k'>if</span> <span class='b'>(</span>f.isPublic &amp;&amp; !f.isStatic &amp;&amp; f.parent != BuildScript#<span class='b'>)</span>
        log.printLine<span class='b'>(</span><span class='s'>"  "</span> + <span class='b'>(</span>f.name+ <span class='s'>":"</span><span class='b'>)</span>.padr<span class='b'>(</span>14<span class='b'>)</span> + <span class='s'>" "</span> + f.get<span class='b'>(</span><span class='k'>this</span><span class='b'>))</span>
    <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Log an error and return a FatalBuildErr instance</span>
  <span class='z'>**</span>
  FatalBuildErr <span id='fatal'>fatal</span><span class='b'>(</span>Str msg, Err? err := <span class='k'>null</span><span class='b'>)</span>
  <span class='b'>{</span>
    log.err<span class='b'>(</span>msg, err<span class='b'>)</span>
    <span class='k'>return</span> FatalBuildErr<span class='b'>(</span>msg, err<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Return this script's source file path.</span>
  <span class='z'>**</span>
  <span class='k'>override</span> Str <span id='toStr'>toStr</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='k'>return</span> typeof-&gt;sourceFile.toStr
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Arguments</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Parse the arguments passed from the command line.</span>
  <span class='z'>** Return true for success or false to end the script.</span>
  <span class='z'>**</span>
  <span class='k'>private</span> TargetMethod<span class='b'>[]</span>? <span id='parseArgs'>parseArgs</span><span class='b'>(</span>Str<span class='b'>[]</span> args<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='y'>// check for -? or -dumpEnv</span>
    <span class='k'>if</span> <span class='b'>(</span>args.contains<span class='b'>(</span><span class='s'>"-?"</span><span class='b'>)</span> || args.contains<span class='b'>(</span><span class='s'>"-help"</span><span class='b'>))</span> <span class='b'>{</span> usage; <span class='k'>return</span> <span class='k'>null</span> <span class='b'>}</span>
    <span class='k'>if</span> <span class='b'>(</span>args.contains<span class='b'>(</span><span class='s'>"-dumpEnv"</span><span class='b'>))</span> <span class='b'>{</span> dumpEnv; <span class='k'>return</span> <span class='k'>null</span> <span class='b'>}</span>

    success := <span class='k'>true</span>
    toRun := TargetMethod<span class='b'>[</span>,<span class='b'>]</span>

    <span class='y'>// get published targetss</span>
    published := targets
    <span class='k'>if</span> <span class='b'>(</span>published.isEmpty<span class='b'>)</span>
    <span class='b'>{</span>
      log.err<span class='b'>(</span><span class='s'>"No targets available for script"</span><span class='b'>)</span>
      <span class='k'>return</span> <span class='k'>null</span>
    <span class='b'>}</span>

    <span class='y'>// process each argument</span>
    <span class='k'>for</span> <span class='b'>(</span>i:=0; i&lt;args.size; ++i<span class='b'>)</span>
    <span class='b'>{</span>
      arg := args<span class='b'>[</span>i<span class='b'>]</span>
      <span class='k'>if</span> <span class='b'>(</span>arg == <span class='s'>"-v"</span><span class='b'>)</span> <span class='b'>{</span> log.level = LogLevel.debug; dumpEnv <span class='b'>}</span>
      <span class='k'>else</span> <span class='k'>if</span> <span class='b'>(</span>arg.startsWith<span class='b'>(</span><span class='s'>"-"</span><span class='b'>))</span> log.warn<span class='b'>(</span><span class='s'>"Unknown build option $arg"</span><span class='b'>)</span>
      <span class='k'>else</span>
      <span class='b'>{</span>
        <span class='y'>// add target to our run list</span>
        target := published.find |t| <span class='b'>{</span> t.name == arg <span class='b'>}</span>
        <span class='k'>if</span> <span class='b'>(</span>target == <span class='k'>null</span><span class='b'>)</span>
        <span class='b'>{</span>
          log.err<span class='b'>(</span><span class='s'>"Unknown build target '$arg'"</span><span class='b'>)</span>
          success = <span class='k'>false</span>
        <span class='b'>}</span>
        <span class='k'>else</span>
        <span class='b'>{</span>
          toRun.add<span class='b'>(</span>target<span class='b'>)</span>
        <span class='b'>}</span>
      <span class='b'>}</span>
    <span class='b'>}</span>
    <span class='k'>if</span> <span class='b'>(</span>!success<span class='b'>)</span> <span class='k'>return</span> <span class='k'>null</span>

    <span class='y'>// if no targets specified, then use the default</span>
    <span class='k'>if</span> <span class='b'>(</span>toRun.isEmpty<span class='b'>)</span> toRun.add<span class='b'>(</span>published.first<span class='b'>)</span>
    <span class='k'>return</span> toRun
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Dump usage including all this script's published targets.</span>
  <span class='z'>**</span>
  <span class='k'>private</span> Void <span id='usage'>usage</span><span class='b'>()</span>
  <span class='b'>{</span>
    log.printLine<span class='b'>(</span><span class='s'>"usage: "</span><span class='b'>)</span>
    log.printLine<span class='b'>(</span><span class='s'>"  build [options] &lt;target&gt;*"</span><span class='b'>)</span>
    log.printLine<span class='b'>(</span><span class='s'>"options:"</span><span class='b'>)</span>
    log.printLine<span class='b'>(</span><span class='s'>"  -? -help       Print usage summary"</span><span class='b'>)</span>
    log.printLine<span class='b'>(</span><span class='s'>"  -v             Verbose debug logging"</span><span class='b'>)</span>
    log.printLine<span class='b'>(</span><span class='s'>"  -dumpEnv       Debug dump of script env"</span><span class='b'>)</span>
    log.printLine<span class='b'>(</span><span class='s'>"targets:"</span><span class='b'>)</span>
    targets.each |t, i|
    <span class='b'>{</span>
      n := i == 0 ? <span class='s'>"${t.name}*"</span> : <span class='s'>"${t.name} "</span>
      log.print<span class='b'>(</span><span class='s'>"  ${n.justl(14)} $t.help"</span><span class='b'>)</span>
      log.printLine
    <span class='b'>}</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Main</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Run the script with the specified arguments.</span>
  <span class='z'>** Return 0 on success or -1 on failure.</span>
  <span class='z'>**</span>
  Int <span id='main'>main</span><span class='b'>(</span>Str<span class='b'>[]</span> args := Env.cur.args<span class='b'>)</span>
  <span class='b'>{</span>
    t1 := Duration.now
    success := <span class='k'>false</span>
    <span class='k'>try</span>
    <span class='b'>{</span>
      targetsToRun := parseArgs<span class='b'>(</span>args<span class='b'>)</span>
      <span class='k'>if</span> <span class='b'>(</span>targetsToRun == <span class='k'>null</span><span class='b'>)</span> <span class='k'>return</span> 1
      targetsToRun.each |t| <span class='b'>{</span> t.run <span class='b'>}</span>
      success = <span class='k'>true</span>
    <span class='b'>}</span>
    <span class='k'>catch</span> <span class='b'>(</span>FatalBuildErr err<span class='b'>)</span>
    <span class='b'>{</span>
      <span class='y'>// error should have alredy been logged</span>
    <span class='b'>}</span>
    <span class='k'>catch</span> <span class='b'>(</span>Err err<span class='b'>)</span>
    <span class='b'>{</span>
      log.err<span class='b'>(</span><span class='s'>"Internal build error [$toStr]"</span><span class='b'>)</span>
      err.trace
    <span class='b'>}</span>
    t2 := Duration.now

    <span class='k'>if</span> <span class='b'>(</span>success<span class='b'>)</span>
    <span class='b'>{</span>
      <span class='k'>if</span> <span class='b'>(</span>log.level &lt;= LogLevel.info<span class='b'>)</span>
        log.out.printLine<span class='b'>(</span><span class='s'>"BUILD SUCCESS [${(t2-t1).toMillis}ms]!"</span><span class='b'>)</span>
    <span class='b'>}</span>
    <span class='k'>else</span>
    <span class='b'>{</span>
      log.out.printLine<span class='b'>(</span><span class='s'>"BUILD FAILED [${(t2-t1).toMillis}ms]!"</span><span class='b'>)</span>
    <span class='b'>}</span>
    <span class='k'>return</span> success ? 0 : -1
  <span class='b'>}</span>

<span class='b'>}</span>

</pre>
</div>
</div>
<div class='sidebar'>
<h2>More Info</h2>
<ul class='clean'>
  <li><a href='BuildScript.html'>View Fandoc</a></li>
</ul>
<div class='slots'>
<div class='overview'>
<h2>Slots</h2>
<ul class='clean'>
  <li style='display: block;'><a href='#config'>config</a></li>
  <li style='display: block;'><a href='#configDir'>configDir</a></li>
  <li style='display: block;'><a href='#devHomeDir'>devHomeDir</a></li>
  <li style='display: block;'><a href='#dumpEnv'>dumpEnv</a></li>
  <li style='display: block;'><a href='#fatal'>fatal</a></li>
  <li style='display: block;'><a href='#log'>log</a></li>
  <li style='display: block;'><a href='#main'>main</a></li>
  <li class='hidden' style='display: block;'><a href='#parseArgs'>parseArgs</a></li>
  <li class='hidden' style='display: block;'><a href='#resolveDirs'>resolveDirs</a></li>
  <li class='hidden' style='display: block;'><a href='#resolveFiles'>resolveFiles</a></li>
  <li class='hidden' style='display: block;'><a href='#resolveFilesOrDirs'>resolveFilesOrDirs</a></li>
  <li style='display: block;'><a href='#scriptDir'>scriptDir</a></li>
  <li style='display: block;'><a href='#scriptFile'>scriptFile</a></li>
  <li style='display: block;'><a href='#target'>target</a></li>
  <li style='display: block;'><a href='#targets'>targets</a></li>
  <li style='display: block;'><a href='#toStr'>toStr</a></li>
  <li class='hidden' style='display: block;'><a href='#usage'>usage</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class='footer'>
<div>
<p>
build 1.0.56
[11-Nov-2010 Thu 10:08:18AM EST]
</p>
</div>
</div>
</body>
</html>
