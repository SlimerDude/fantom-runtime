<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
  <title>build::BuildJava</title>
  <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
  <link rel='stylesheet' type='text/css' href='../doc.css'/>
  <script type='text/javascript' src='../doc.js'></script>
<!--[if lt IE 7]>
<script src='http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE7.js' type='text/javascript'></script>
<![endif]-->
</head>
<body onload='Login.check();'>
<div class='header'>
<div>
<h1><a href='/'>Fantom</a></h1>
<p id='sidewalkLogin_'>&nbsp;</p>
<form method='get' action='/sidewalk/search/'>
<p>
<input type='text' name='q' size='30' value='Search...' onfocus='if (value=="Search...") value=""' onblur='if (value=="") value="Search..."' />
</p>
</form>
<ul>
<li><a href='/'>Home</a></li>
<li class='active'><a href='../index.html'>Docs</a></li>
<li><a href='/sidewalk/blog/'>Blog</a></li>
<li><a href='/sidewalk/ticket/'>Tickets</a></li>
<li><a href='/sidewalk/topic/'>Discuss</a></li>
</ul></div>
</div>
<div class='subHeader'>
<div>
<ul>
  <li><a href='../index.html'>Doc Home</a></li>
  <li>&gt;</li>
  <li><a href='index.html'>build</a></li>
  <li>&gt;</li>
  <li><a href='BuildJava.html'>BuildJava</a></li>
</ul>
</div>
</div>
<div class='content'>
<div>
<div class='fandoc'>
<div class='type'>
<div class='overview'>
<h2>abstract class</h2>
<h1>build::BuildJava</h1>
<pre><a href='../sys/Obj.html'>sys::Obj</a>
  <a href='BuildScript.html'>build::BuildScript</a>
    build::BuildJava</pre>
</div>
</div>
<div class='src'>
<pre>
<span class='y'>//</span>
<span class='y'>// Copyright (c) 2006, Brian Frank and Andy Frank</span>
<span class='y'>// Licensed under the Academic Free License version 3.0</span>
<span class='y'>//</span>
<span class='y'>// History:</span>
<span class='y'>//   3 Nov 06  Brian Frank  Creation</span>
<span class='y'>//</span>

<span class='z'>**</span>
<span class='z'>** BuildJava is the base class for build scripts used to manage</span>
<span class='z'>** building Java source code into a Java jar file.</span>
<span class='z'>**</span>
<span class='k'>abstract</span> <span class='k'>class</span> BuildJava : BuildScript
<span class='b'>{</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Pod Meta-Data</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Required target jar file to build</span>
  <span class='z'>**</span>
  Uri? <span id='jar'>jar</span>

  <span class='z'>**</span>
  <span class='z'>** Required list of dotted package names to compile.  Each of these</span>
  <span class='z'>** packages must have a corresponding source directory relative to the</span>
  <span class='z'>** script directory.</span>
  <span class='z'>**</span>
  Str<span class='b'>[]</span>? <span id='packages'>packages</span>

  <span class='z'>**</span>
  <span class='z'>** List of files to include in compiler classpath.  The core</span>
  <span class='z'>** Java rt.jar is always implied and should not be specified.</span>
  <span class='z'>** These URIs are relative to the script dir.</span>
  <span class='z'>**</span>
  Uri<span class='b'>[]</span>? <span id='cp'>cp</span>

  <span class='z'>**</span>
  <span class='z'>** Main class name to add to manifest if not null.</span>
  <span class='z'>**</span>
  Str? <span id='mainClass'>mainClass</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Validate</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>private</span> Void <span id='validate'>validate</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='k'>if</span> <span class='b'>(</span>jar == <span class='k'>null</span><span class='b'>)</span> <span class='k'>throw</span> fatal<span class='b'>(</span><span class='s'>"Must set BuildJava.jar"</span><span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>packages == <span class='k'>null</span><span class='b'>)</span> <span class='k'>throw</span> fatal<span class='b'>(</span><span class='s'>"Must set BuildJava.packages"</span><span class='b'>)</span>

    <span class='y'>// boot strap checking - ensure that we aren't overwriting sys.jar</span>
    <span class='k'>if</span> <span class='b'>(</span>jar.name == <span class='s'>"sys.jar"</span><span class='b'>)</span>
    <span class='b'>{</span>
      <span class='k'>if</span> <span class='b'>(</span>Env.cur.homeDir == devHomeDir<span class='b'>)</span>
        <span class='k'>throw</span> fatal<span class='b'>(</span><span class='s'>"Must update 'devHome' for bootstrap build"</span><span class='b'>)</span>
    <span class='b'>}</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Dump Env</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>override</span> Void <span id='dumpEnv'>dumpEnv</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='k'>super</span>.dumpEnv

    oldLevel := log.level
    log.level = LogLevel.silent
    <span class='k'>try</span>
      log.out.printLine<span class='b'>(</span><span class='s'>"  javaHome:      ${JdkTask(this).jdkHomeDir}"</span><span class='b'>)</span>
    <span class='k'>catch</span> <span class='b'>(</span>Err e<span class='b'>)</span>
      log.out.printLine<span class='b'>(</span><span class='s'>"  javaHome:      $e"</span><span class='b'>)</span>
    <span class='k'>finally</span>
      log.level = oldLevel
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Compile</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Compile Java source into jar</span>
  <span class='z'>**</span>
  @Target <span class='b'>{</span> help = <span class='s'>"Compile Java source into jar"</span> <span class='b'>}</span>
  Void compile<span class='b'>()</span>
  <span class='b'>{</span>
    validate

    log.info<span class='b'>(</span><span class='s'>"compile [${scriptDir.name}]"</span><span class='b'>)</span>
    log.indent

    temp     := scriptDir + <span class='u'>`temp/`</span>
    jdk      := JdkTask<span class='b'>(</span><span class='k'>this</span><span class='b'>)</span>
    jarExe   := jdk.jarExe
    manifest := temp + <span class='u'>`Manifest.mf`</span>
    jar      := <span class='k'>this</span>.jar.toFile

    <span class='y'>// make temp dir</span>
    CreateDir<span class='b'>(</span><span class='k'>this</span>, temp<span class='b'>)</span>.run

    <span class='y'>// find all the packages which have out of date files</span>
    outOfDate := findOutOfDateDirs<span class='b'>(</span>temp<span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>outOfDate.isEmpty<span class='b'>)</span>
    <span class='b'>{</span>
      log.unindent
      log.info<span class='b'>(</span><span class='s'>"Up to date!"</span><span class='b'>)</span>
      <span class='k'>return</span>
    <span class='b'>}</span>

    <span class='y'>// compile out of date packages</span>
    javac := CompileJava<span class='b'>(</span><span class='k'>this</span><span class='b'>)</span>
    javac.src = outOfDate
    javac.cp.add<span class='b'>(</span>temp<span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>cp != <span class='k'>null</span><span class='b'>)</span> javac.cp.addAll<span class='b'>(</span>resolveFilesOrDirs<span class='b'>(</span>cp<span class='b'>))</span>
    javac.outDir = temp
    javac.run

    <span class='y'>// write manifest</span>
    log.info<span class='b'>(</span><span class='s'>"Write Manifest [${manifest.osPath}]"</span><span class='b'>)</span>
    out := manifest.out
    out.printLine<span class='b'>(</span><span class='s'>"Manifest-Version: 1.0"</span><span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>mainClass != <span class='k'>null</span><span class='b'>)</span> out.printLine<span class='b'>(</span><span class='s'>"Main-Class: $mainClass"</span><span class='b'>)</span>
    out.close

    <span class='y'>// ensure jar target directory exists</span>
    CreateDir<span class='b'>(</span><span class='k'>this</span>, jar.parent<span class='b'>)</span>.run

    <span class='y'>// jar up temp directory</span>
    log.info<span class='b'>(</span><span class='s'>"Jar [${jar.osPath}]"</span><span class='b'>)</span>
    Exec<span class='b'>(</span><span class='k'>this</span>, <span class='b'>[</span>jarExe, <span class='s'>"cfm"</span>, jar.osPath, manifest.osPath, <span class='s'>"-C"</span>, temp.osPath, <span class='s'>"."</span><span class='b'>]</span>, temp<span class='b'>)</span>.run

    log.unindent
  <span class='b'>}</span>

  <span class='k'>private</span> File<span class='b'>[]</span> <span id='findOutOfDateDirs'>findOutOfDateDirs</span><span class='b'>(</span>File temp<span class='b'>)</span>
  <span class='b'>{</span>
    acc := File<span class='b'>[</span>,<span class='b'>]</span>
    packages.each |Str p|
    <span class='b'>{</span>
      path := Uri.fromStr<span class='b'>(</span>p.replace<span class='b'>(</span><span class='s'>"."</span>, <span class='s'>"/"</span><span class='b'>)</span> + <span class='s'>"/"</span><span class='b'>)</span>
      srcDir := scriptDir + path
      outDir := temp + path
      <span class='k'>if</span> <span class='b'>(</span>anyOutOfDate<span class='b'>(</span>srcDir, outDir<span class='b'>))</span>
        acc.add<span class='b'>(</span>srcDir<span class='b'>)</span>
    <span class='b'>}</span>
    <span class='k'>return</span> acc
  <span class='b'>}</span>

  <span class='k'>private</span> Bool <span id='anyOutOfDate'>anyOutOfDate</span><span class='b'>(</span>File srcDir, File outDir<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>return</span> srcDir.list.any |File src-&gt;Bool|
    <span class='b'>{</span>
      <span class='k'>if</span> <span class='b'>(</span>src.ext != <span class='s'>"java"</span><span class='b'>)</span> <span class='k'>return</span> <span class='k'>false</span>
      out := outDir + <span class='b'>(</span>src.basename + <span class='s'>".class"</span><span class='b'>)</span>.toUri
      <span class='k'>return</span> !out.exists || out.modified &lt; src.modified
    <span class='b'>}</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Clean</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Delete all intermediate and target files</span>
  <span class='z'>**</span>
  @Target <span class='b'>{</span> help = <span class='s'>"Delete all intermediate and target files"</span> <span class='b'>}</span>
  Void clean<span class='b'>()</span>
  <span class='b'>{</span>
    log.info<span class='b'>(</span><span class='s'>"clean [${scriptDir.name}]"</span><span class='b'>)</span>
    log.indent
    Delete<span class='b'>(</span><span class='k'>this</span>, scriptDir + <span class='u'>`temp/`</span><span class='b'>)</span>.run
    Delete<span class='b'>(</span><span class='k'>this</span>, jar.toFile<span class='b'>)</span>.run
    log.unindent
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Full</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Run clean, compile</span>
  <span class='z'>**</span>
  @Target <span class='b'>{</span> help = <span class='s'>"Run clean, compile"</span> <span class='b'>}</span>
  Void full<span class='b'>()</span>
  <span class='b'>{</span>
    clean
    compile<span class='b'>()</span>
  <span class='b'>}</span>

<span class='b'>}</span></pre>
</div>
</div>
<div class='sidebar'>
<h2>More Info</h2>
<ul class='clean'>
  <li><a href='BuildJava.html'>View Fandoc</a></li>
</ul>
<div class='slots'>
<div class='overview'>
<h2>Slots</h2>
<ul class='clean'>
  <li class='hidden' style='display: block;'><a href='#anyOutOfDate'>anyOutOfDate</a></li>
  <li style='display: block;'><a href='#clean'>clean</a></li>
  <li style='display: block;'><a href='#compile'>compile</a></li>
  <li style='display: block;'><a href='#cp'>cp</a></li>
  <li style='display: block;'><a href='#dumpEnv'>dumpEnv</a></li>
  <li class='hidden' style='display: block;'><a href='#findOutOfDateDirs'>findOutOfDateDirs</a></li>
  <li style='display: block;'><a href='#full'>full</a></li>
  <li style='display: block;'><a href='#jar'>jar</a></li>
  <li style='display: block;'><a href='#mainClass'>mainClass</a></li>
  <li style='display: block;'><a href='#packages'>packages</a></li>
  <li class='hidden' style='display: block;'><a href='#validate'>validate</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class='footer'>
<div>
<p>
build 1.0.56
[11-Nov-2010 Thu 10:08:18AM EST]
</p>
</div>
</div>
</body>
</html>
