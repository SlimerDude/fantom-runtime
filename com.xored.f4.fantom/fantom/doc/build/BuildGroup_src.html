<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
  <title>build::BuildGroup</title>
  <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
  <link rel='stylesheet' type='text/css' href='../doc.css'/>
  <script type='text/javascript' src='../doc.js'></script>
<!--[if lt IE 7]>
<script src='http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE7.js' type='text/javascript'></script>
<![endif]-->
</head>
<body onload='Login.check();'>
<div class='header'>
<div>
<h1><a href='/'>Fantom</a></h1>
<p id='sidewalkLogin_'>&nbsp;</p>
<form method='get' action='/sidewalk/search/'>
<p>
<input type='text' name='q' size='30' value='Search...' onfocus='if (value=="Search...") value=""' onblur='if (value=="") value="Search..."' />
</p>
</form>
<ul>
<li><a href='/'>Home</a></li>
<li class='active'><a href='../index.html'>Docs</a></li>
<li><a href='/sidewalk/blog/'>Blog</a></li>
<li><a href='/sidewalk/ticket/'>Tickets</a></li>
<li><a href='/sidewalk/topic/'>Discuss</a></li>
</ul></div>
</div>
<div class='subHeader'>
<div>
<ul>
  <li><a href='../index.html'>Doc Home</a></li>
  <li>&gt;</li>
  <li><a href='index.html'>build</a></li>
  <li>&gt;</li>
  <li><a href='BuildGroup.html'>BuildGroup</a></li>
</ul>
</div>
</div>
<div class='content'>
<div>
<div class='fandoc'>
<div class='type'>
<div class='overview'>
<h2>abstract class</h2>
<h1>build::BuildGroup</h1>
<pre><a href='../sys/Obj.html'>sys::Obj</a>
  <a href='BuildScript.html'>build::BuildScript</a>
    build::BuildGroup</pre>
</div>
</div>
<div class='src'>
<pre>
<span class='y'>//</span>
<span class='y'>// Copyright (c) 2006, Brian Frank and Andy Frank</span>
<span class='y'>// Licensed under the Academic Free License version 3.0</span>
<span class='y'>//</span>
<span class='y'>// History:</span>
<span class='y'>//   3 Nov 06  Brian Frank  Creation</span>
<span class='y'>//</span>

<span class='z'>**</span>
<span class='z'>** BuildGroup is the base class for build scripts which compose</span>
<span class='z'>** a set of children build scripts into a single group.  The</span>
<span class='z'>** target's of a BuildGroup are the union of the target</span>
<span class='z'>** names available in the children scripts.</span>
<span class='z'>**</span>
<span class='k'>abstract</span> <span class='k'>class</span> BuildGroup : BuildScript
<span class='b'>{</span>

  <span class='z'>**</span>
  <span class='z'>** Required list of Uris relative to this scriptDir of</span>
  <span class='z'>** Fantom build script files to group together.</span>
  <span class='z'>**</span>
  Uri<span class='b'>[]</span> <span id='childrenScripts'>childrenScripts</span> := Uri<span class='b'>[</span>,<span class='b'>]</span>

  <span class='z'>**</span>
  <span class='z'>** Compiled children scripts</span>
  <span class='z'>**</span>
  <span class='k'>once</span> BuildScript<span class='b'>[]</span> <span id='children'>children</span><span class='b'>()</span>
  <span class='b'>{</span>
    acc := BuildScript<span class='b'>[</span>,<span class='b'>]</span>
    childrenScripts.each |uri|
    <span class='b'>{</span>
      f := scriptDir + uri
      log.debug<span class='b'>(</span><span class='s'>"CompileScript [$f]"</span><span class='b'>)</span>
      s := <span class='b'>(</span>BuildScript<span class='b'>)</span>FanScript<span class='b'>(</span><span class='k'>this</span>, f<span class='b'>)</span>.compile.types.first.make
      s.log = log
      acc.add<span class='b'>(</span>s<span class='b'>)</span>
    <span class='b'>}</span>
    <span class='k'>return</span> acc
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** BuildGroup publishes the union by name of it's</span>
  <span class='z'>** children script targets plus any of its own targets.</span>
  <span class='z'>**</span>
  <span class='k'>override</span> <span class='k'>once</span> TargetMethod<span class='b'>[]</span> <span id='targets'>targets</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='y'>// get union of names in my children scripts</span>
    Str<span class='b'>[]</span>? names := <span class='k'>null</span>
    children.each |child|
    <span class='b'>{</span>
      <span class='y'>// get all the target names in this subscript</span>
      Str<span class='b'>[]</span> n := child.targets.map |t| <span class='b'>{</span> t.name <span class='b'>}</span>

      <span class='y'>// get union of names</span>
      <span class='k'>if</span> <span class='b'>(</span>names == <span class='k'>null</span><span class='b'>)</span>
        names = n
      <span class='k'>else</span>
        names = names.union<span class='b'>(</span>n<span class='b'>)</span>
    <span class='b'>}</span>

    <span class='y'>// map names to group targets</span>
    map := Str:TargetMethod<span class='b'>[</span>:<span class='b'>]</span> <span class='b'>{</span> ordered = <span class='k'>true</span> <span class='b'>}</span>
    names.each |n| <span class='b'>{</span> map<span class='b'>[</span>n<span class='b'>]</span> = GroupTarget<span class='b'>(</span><span class='k'>this</span>, n<span class='b'>)</span> <span class='b'>}</span>

    <span class='y'>// add my own targets, which trump children targets</span>
    typeof.methods.each |m|
    <span class='b'>{</span>
      <span class='k'>if</span> <span class='b'>(</span>!m.hasFacet<span class='b'>(</span>Target#<span class='b'>))</span> <span class='k'>return</span>
      map<span class='b'>[</span>m.name<span class='b'>]</span> = TargetMethod<span class='b'>(</span><span class='k'>this</span>, m<span class='b'>)</span>
    <span class='b'>}</span>

    <span class='y'>// now create a Target for each name</span>
    list := map.vals
    list.moveTo<span class='b'>(</span>map<span class='b'>[</span><span class='s'>"compile"</span><span class='b'>]</span>, 0<span class='b'>)</span>
    <span class='k'>return</span> list
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Run the specified target name on each of the</span>
  <span class='z'>** children scripts that support the specified name.</span>
  <span class='z'>**</span>
  <span class='k'>virtual</span> Void <span id='runOnChildren'>runOnChildren</span><span class='b'>(</span>Str targetName<span class='b'>)</span>
  <span class='b'>{</span>
    children.each |child|
    <span class='b'>{</span>
      target := child.target<span class='b'>(</span>targetName, <span class='k'>false</span><span class='b'>)</span>
      <span class='k'>if</span> <span class='b'>(</span>target != <span class='k'>null</span><span class='b'>)</span> target.run
    <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Run the specified target name on each of the children</span>
  <span class='z'>** scripts that support the specified name.  Unlike runOnChildren</span>
  <span class='z'>** this method actually spawns a new process to run the child</span>
  <span class='z'>** script.</span>
  <span class='z'>**</span>
  <span class='k'>virtual</span> Void <span id='spawnOnChildren'>spawnOnChildren</span><span class='b'>(</span>Str targetName<span class='b'>)</span>
  <span class='b'>{</span>
    fanExe := Exec.exePath<span class='b'>(</span>devHomeDir + <span class='u'>`bin/fan`</span><span class='b'>)</span>
    children.each |child|
    <span class='b'>{</span>
      target := child.target<span class='b'>(</span>targetName<span class='b'>)</span>
      <span class='k'>if</span> <span class='b'>(</span>target != <span class='k'>null</span><span class='b'>)</span>
        Exec<span class='b'>(</span><span class='k'>this</span>, <span class='b'>[</span>fanExe, child.scriptFile.osPath, targetName<span class='b'>])</span>.run
    <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='k'>override</span> Void <span id='dumpEnv'>dumpEnv</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='k'>super</span>.dumpEnv
    children.each |child| <span class='b'>{</span> child.dumpEnv <span class='b'>}</span>
  <span class='b'>}</span>
<span class='b'>}</span>

<span class='k'>internal</span> <span class='k'>class</span> GroupTarget : TargetMethod
<span class='b'>{</span>
  <span class='k'>new</span> make<span class='b'>(</span>BuildGroup s, Str n<span class='b'>)</span> : <span class='k'>super</span><span class='b'>(</span>s, BuildGroup#runOnChildren<span class='b'>)</span> <span class='b'>{</span> name = n <span class='b'>}</span>
  <span class='k'>override</span> <span class='k'>const</span> Str name
  <span class='k'>override</span> Str help<span class='b'>()</span> <span class='b'>{</span> <span class='s'>"Run '$name' on group"</span> <span class='b'>}</span>
  <span class='k'>override</span> Void run<span class='b'>()</span> <span class='b'>{</span> <span class='b'>((</span>BuildGroup<span class='b'>)</span>script<span class='b'>)</span>.runOnChildren<span class='b'>(</span>name<span class='b'>)</span> <span class='b'>}</span>
<span class='b'>}</span></pre>
</div>
</div>
<div class='sidebar'>
<h2>More Info</h2>
<ul class='clean'>
  <li><a href='BuildGroup.html'>View Fandoc</a></li>
</ul>
<div class='slots'>
<div class='overview'>
<h2>Slots</h2>
<ul class='clean'>
  <li style='display: block;'><a href='#children'>children</a></li>
  <li style='display: block;'><a href='#childrenScripts'>childrenScripts</a></li>
  <li style='display: block;'><a href='#dumpEnv'>dumpEnv</a></li>
  <li style='display: block;'><a href='#runOnChildren'>runOnChildren</a></li>
  <li style='display: block;'><a href='#spawnOnChildren'>spawnOnChildren</a></li>
  <li style='display: block;'><a href='#targets'>targets</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class='footer'>
<div>
<p>
build 1.0.56
[11-Nov-2010 Thu 10:08:18AM EST]
</p>
</div>
</div>
</body>
</html>
