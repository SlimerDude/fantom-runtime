<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
  <title>build::JarDist</title>
  <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
  <link rel='stylesheet' type='text/css' href='../doc.css'/>
  <script type='text/javascript' src='../doc.js'></script>
<!--[if lt IE 7]>
<script src='http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE7.js' type='text/javascript'></script>
<![endif]-->
</head>
<body onload='Login.check();'>
<div class='header'>
<div>
<h1><a href='/'>Fantom</a></h1>
<p id='sidewalkLogin_'>&nbsp;</p>
<form method='get' action='/sidewalk/search/'>
<p>
<input type='text' name='q' size='30' value='Search...' onfocus='if (value=="Search...") value=""' onblur='if (value=="") value="Search..."' />
</p>
</form>
<ul>
<li><a href='/'>Home</a></li>
<li class='active'><a href='../index.html'>Docs</a></li>
<li><a href='/sidewalk/blog/'>Blog</a></li>
<li><a href='/sidewalk/ticket/'>Tickets</a></li>
<li><a href='/sidewalk/topic/'>Discuss</a></li>
</ul></div>
</div>
<div class='subHeader'>
<div>
<ul>
  <li><a href='../index.html'>Doc Home</a></li>
  <li>&gt;</li>
  <li><a href='index.html'>build</a></li>
  <li>&gt;</li>
  <li><a href='JarDist.html'>JarDist</a></li>
</ul>
</div>
</div>
<div class='content'>
<div>
<div class='fandoc'>
<div class='type'>
<div class='overview'>
<h2>class</h2>
<h1>build::JarDist</h1>
<pre><a href='../sys/Obj.html'>sys::Obj</a>
  <a href='Task.html'>build::Task</a>
    <a href='JdkTask.html'>build::JdkTask</a>
      build::JarDist</pre>
</div>
</div>
<div class='src'>
<pre>
<span class='y'>//</span>
<span class='y'>// Copyright (c) 2010, Brian Frank and Andy Frank</span>
<span class='y'>// Licensed under the Academic Free License version 3.0</span>
<span class='y'>//</span>
<span class='y'>// History:</span>
<span class='y'>//   1 Feb 10  Brian Frank  Creation</span>
<span class='y'>//</span>

<span class='z'>**</span>
<span class='z'>** JarDist compiles a set of Fantom pods into a single Java JAR file.</span>
<span class='z'>**</span>
<span class='k'>class</span> JarDist : JdkTask
<span class='b'>{</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Construction</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Construct uninitialized task</span>
  <span class='z'>**</span>
  <span class='k'>new</span> <span id='make'>make</span><span class='b'>(</span>BuildScript script<span class='b'>)</span>
    : <span class='k'>super</span><span class='b'>(</span>script<span class='b'>)</span>
  <span class='b'>{</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Run</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Run the javac task</span>
  <span class='z'>**</span>
  <span class='k'>override</span> Void <span id='run'>run</span><span class='b'>()</span>
  <span class='b'>{</span>
    log.info<span class='b'>(</span><span class='s'>"JarDist"</span><span class='b'>)</span>
    verifyConfig
    log.indent
    initTempDir
    sysClasses
    podNames.each |name| <span class='b'>{</span> podClasses<span class='b'>(</span>name<span class='b'>)</span> <span class='b'>}</span>
    etcFiles
    main
    manifest
    jar
    cleanupTempDir
    log.info<span class='b'>(</span><span class='s'>"Success [$outFile]"</span><span class='b'>)</span>
    log.unindent
  <span class='b'>}</span>

  <span class='k'>private</span> Void <span id='verifyConfig'>verifyConfig</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='k'>if</span> <span class='b'>(</span>podNames.isEmpty<span class='b'>)</span> <span class='k'>throw</span> fatal<span class='b'>(</span><span class='s'>"Not configured: JarDist.podNames"</span><span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>podNames.contains<span class='b'>(</span><span class='s'>"sys"</span><span class='b'>))</span> <span class='k'>throw</span> fatal<span class='b'>(</span><span class='s'>"sys is implied in JarDist.podNames"</span><span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>outFile == <span class='k'>null</span><span class='b'>)</span> <span class='k'>throw</span> fatal<span class='b'>(</span><span class='s'>"Not configured: JarDist.outFile"</span><span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>mainMethod == <span class='k'>null</span><span class='b'>)</span> <span class='k'>throw</span> fatal<span class='b'>(</span><span class='s'>"Not configured: JarDist.mainMethod"</span><span class='b'>)</span>

    m := Slot.findMethod<span class='b'>(</span>mainMethod, <span class='k'>false</span><span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>m == <span class='k'>null</span><span class='b'>)</span> <span class='k'>throw</span> fatal<span class='b'>(</span><span class='s'>"mainMethod not found: $mainMethod"</span><span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>!m.isStatic<span class='b'>)</span> <span class='k'>throw</span> fatal<span class='b'>(</span><span class='s'>"mainMethod not static: $mainMethod"</span><span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>!m.params.isEmpty<span class='b'>)</span> <span class='k'>throw</span> fatal<span class='b'>(</span><span class='s'>"mainMethod must have no params: $mainMethod"</span><span class='b'>)</span>
  <span class='b'>}</span>

  <span class='k'>private</span> Void <span id='initTempDir'>initTempDir</span><span class='b'>()</span>
  <span class='b'>{</span>
    tempDir = <span class='b'>(</span>Env.cur.tempDir + <span class='u'>`jardist-$Int.random.toHex/`</span><span class='b'>)</span>.create
    log.debug<span class='b'>(</span><span class='s'>"TempDir [$tempDir]"</span><span class='b'>)</span>
  <span class='b'>}</span>

  <span class='k'>private</span> Void <span id='cleanupTempDir'>cleanupTempDir</span><span class='b'>()</span>
  <span class='b'>{</span>
    tempDir.delete
    manifestFile.delete
  <span class='b'>}</span>

  <span class='k'>private</span> Void <span id='sysClasses'>sysClasses</span><span class='b'>()</span>
  <span class='b'>{</span>
    log.info<span class='b'>(</span><span class='s'>"Pod [sys]"</span><span class='b'>)</span>
    extractClassfilesToTemp<span class='b'>(</span>script.devHomeDir + <span class='u'>`lib/java/sys.jar`</span><span class='b'>)</span>
    reflect<span class='b'>(</span><span class='s'>"sys"</span><span class='b'>)</span>
  <span class='b'>}</span>

  <span class='k'>private</span> Void <span id='podClasses'>podClasses</span><span class='b'>(</span>Str podName<span class='b'>)</span>
  <span class='b'>{</span>
    log.info<span class='b'>(</span><span class='s'>"Pod [$podName]"</span><span class='b'>)</span>

    <span class='y'>// open as zip and</span>
    podFile := script.devHomeDir + <span class='u'>`lib/fan/${podName}.pod`</span>
    <span class='k'>if</span> <span class='b'>(</span>!podFile.exists<span class='b'>)</span> <span class='k'>throw</span> Err<span class='b'>(</span><span class='s'>"Pod not found: $podFile"</span><span class='b'>)</span>
    podZip  := Zip.open<span class='b'>(</span>podFile<span class='b'>)</span>
    meta := podZip.contents<span class='b'>[</span><span class='u'>`/meta.props`</span><span class='b'>]</span>.readProps
    podZip.close

    <span class='y'>// double check dependencies; for basic sanity check</span>
    <span class='y'>// we just check names not version numbers</span>
    meta.get<span class='b'>(</span><span class='s'>"pod.depends"</span>, <span class='s'>""</span><span class='b'>)</span>.split<span class='b'>(</span><span class='s'>';'</span><span class='b'>)</span>.each |dependStr|
    <span class='b'>{</span>
      <span class='k'>if</span> <span class='b'>(</span>dependStr.isEmpty<span class='b'>)</span> <span class='k'>return</span>
      depend := Depend<span class='b'>(</span>dependStr<span class='b'>)</span>
      <span class='k'>if</span> <span class='b'>(</span>!podNames.contains<span class='b'>(</span>depend.name<span class='b'>)</span> &amp;&amp; depend.name != <span class='s'>"sys"</span><span class='b'>)</span>
        <span class='k'>throw</span> fatal<span class='b'>(</span><span class='s'>"Missing dependency for '$podName': $depend"</span><span class='b'>)</span>
    <span class='b'>}</span>

    <span class='y'>// if pod already has its java native code, then the pod</span>
    <span class='y'>// zip should already contain all the classfiles, otherwise</span>
    <span class='y'>// we need to kick off a JStub</span>
    <span class='k'>if</span> <span class='b'>(</span>meta<span class='b'>[</span><span class='s'>"pod.native.java"</span><span class='b'>]</span> == <span class='s'>"true"</span><span class='b'>)</span>
    <span class='b'>{</span>
      log.info<span class='b'>(</span><span class='s'>"  Extract pre-stubbed classfiles"</span><span class='b'>)</span>
      extractClassfilesToTemp<span class='b'>(</span>podFile<span class='b'>)</span>
    <span class='b'>}</span>
    <span class='k'>else</span>
    <span class='b'>{</span>
      log.info<span class='b'>(</span><span class='s'>"  JStub to classfiles"</span><span class='b'>)</span>
      <span class='y'>// stub into Java classfiles using JStub</span>
      Exec<span class='b'>(</span>script,
        <span class='b'>[</span>javaExe,
         <span class='s'>"-cp"</span>, <span class='b'>(</span>script.devHomeDir + <span class='u'>`lib/java/sys.jar`</span><span class='b'>)</span>.osPath,
         <span class='s'>"-Dfan.home=$Env.cur.workDir.osPath"</span>,
         <span class='s'>"fanx.tools.Jstub"</span>,
         <span class='s'>"-d"</span>, tempDir.osPath,
         podName<span class='b'>])</span>.run

      <span class='y'>// stub is "tempDir/{pod}.jar" - extract to tempDir and then delete it</span>
      jar := tempDir + <span class='u'>`${podName}.jar`</span>
      extractClassfilesToTemp<span class='b'>(</span>jar<span class='b'>)</span>
      jar.delete
    <span class='b'>}</span>

    reflect<span class='b'>(</span>podName<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='k'>private</span> Void <span id='extractClassfilesToTemp'>extractClassfilesToTemp</span><span class='b'>(</span>File zipFile<span class='b'>)</span>
  <span class='b'>{</span>
    zip := Zip.open<span class='b'>(</span>zipFile<span class='b'>)</span>
    copyOpts := <span class='b'>[</span><span class='s'>"overwrite"</span>:<span class='k'>true</span><span class='b'>]</span>
    zip.contents.each |f|
    <span class='b'>{</span>
      <span class='k'>if</span> <span class='b'>(</span>f.isDir<span class='b'>)</span> <span class='k'>return</span>
      <span class='k'>if</span> <span class='b'>(</span>f.ext != <span class='s'>"class"</span><span class='b'>)</span> <span class='k'>return</span>
      path := f.uri.toStr<span class='b'>[</span>1..-1<span class='b'>]</span>
      dest := tempDir + path.toUri
      f.copyTo<span class='b'>(</span>dest, copyOpts<span class='b'>)</span>
    <span class='b'>}</span>
    zip.close
  <span class='b'>}</span>

  <span class='k'>private</span> Void <span id='reflect'>reflect</span><span class='b'>(</span>Str podName<span class='b'>)</span>
  <span class='b'>{</span>
    copyOpts := <span class='b'>[</span><span class='s'>"overwrite"</span>:<span class='k'>true</span><span class='b'>]</span>
    resources := Str<span class='b'>[</span>,<span class='b'>]</span>
    zip := Zip.open<span class='b'>(</span>script.devHomeDir + <span class='u'>`lib/fan/${podName}.pod`</span><span class='b'>)</span>
    zip.contents.each |f|
    <span class='b'>{</span>
      <span class='k'>if</span> <span class='b'>(</span>f.isDir<span class='b'>)</span> <span class='k'>return</span>
      <span class='k'>if</span> <span class='b'>(</span>f.name == <span class='s'>"meta.props"</span> || f.ext == <span class='s'>"def"</span> || f.ext == <span class='s'>"fcode"</span><span class='b'>)</span>
      <span class='b'>{</span>
        dest := tempDir + <span class='s'>"reflect/${podName}${f.pathStr}"</span>.toUri
        f.copyTo<span class='b'>(</span>dest, copyOpts<span class='b'>)</span>
      <span class='b'>}</span>
      <span class='k'>else</span>
      <span class='b'>{</span>
        <span class='y'>// decide if this is a resource file we should bundle</span>
        <span class='k'>if</span> <span class='b'>(</span>f.ext == <span class='s'>"class"</span><span class='b'>)</span> <span class='k'>return</span>
        <span class='k'>if</span> <span class='b'>(</span>f.ext == <span class='s'>"apidoc"</span><span class='b'>)</span> <span class='k'>return</span>

        resources.add<span class='b'>(</span>f.pathStr<span class='b'>)</span>
        dest := tempDir + <span class='s'>"res/${podName}${f.pathStr}"</span>.toUri
        f.copyTo<span class='b'>(</span>dest, copyOpts<span class='b'>)</span>
      <span class='b'>}</span>
    <span class='b'>}</span>
    <span class='b'>(</span>tempDir + <span class='u'>`res/${podName}/res-manifest.txt`</span><span class='b'>)</span>.out.print<span class='b'>(</span>resources.join<span class='b'>(</span><span class='s'>"\n"</span><span class='b'>))</span>.close
  <span class='b'>}</span>

  <span class='k'>private</span> Void <span id='etcFiles'>etcFiles</span><span class='b'>()</span>
  <span class='b'>{</span>
    copyEtcFile<span class='b'>(</span><span class='u'>`etc/sys/timezones.ftz`</span><span class='b'>)</span>
    copyEtcFile<span class='b'>(</span><span class='u'>`etc/sys/ext2mime.props`</span>, <span class='u'>`res/sys/ext2mime.props`</span><span class='b'>)</span>
    copyEtcFile<span class='b'>(</span><span class='u'>`etc/sys/units.txt`</span><span class='b'>)</span>
  <span class='b'>}</span>

  <span class='k'>private</span> Void <span id='copyEtcFile'>copyEtcFile</span><span class='b'>(</span>Uri uri, Uri destUri := uri<span class='b'>)</span>
  <span class='b'>{</span>
    src  := script.devHomeDir + uri
    dest := tempDir + destUri
    src.copyTo<span class='b'>(</span>dest<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='k'>private</span> Void <span id='manifest'>manifest</span><span class='b'>()</span>
  <span class='b'>{</span>
    log.info<span class='b'>(</span><span class='s'>"Manifest"</span><span class='b'>)</span>
    <span class='k'>this</span>.manifestFile = Env.cur.workDir + <span class='u'>`Manifest.mf`</span>
    out := <span class='k'>this</span>.manifestFile.out
    out.printLine<span class='b'>(</span><span class='s'>"Manifest-Version: 1.0"</span><span class='b'>)</span>
    out.printLine<span class='b'>(</span><span class='s'>"Main-Class: fanjardist.Main"</span><span class='b'>)</span>
    out.printLine<span class='b'>(</span><span class='s'>"Created-By: Fantom JarDist $typeof.pod.version"</span><span class='b'>)</span>
    out.close
  <span class='b'>}</span>

  <span class='k'>private</span> Void <span id='main'>main</span><span class='b'>()</span>
  <span class='b'>{</span>
    log.info<span class='b'>(</span><span class='s'>"Main"</span><span class='b'>)</span>

    <span class='y'>// explicitly initialize all the pod constants</span>
    podInits := StrBuf<span class='b'>()</span>;
    podNames.each |podName|
    <span class='b'>{</span>
      podInits.add<span class='b'>(</span><span class='s'>""</span><span class='s'>"      Env.cur().loadPodClass(Pod.find("</span>$podName<span class='s'>"));\n"</span><span class='s'>""</span><span class='b'>)</span>
    <span class='b'>}</span>

    <span class='y'>// write out Main Java class</span>
    file := tempDir + <span class='u'>`fanjardist/Main.java`</span>
    file.out.print<span class='b'>(</span>
      <span class='s'>""</span><span class='s'>"package fanjardist;
         import fan.sys.*;
         public class Main
         {
           public static void main(String[] args)
           {
             try
             {
               System.getProperties().put("</span>fan.jardist<span class='s'>", "</span><span class='k'>true</span><span class='s'>");
               System.getProperties().put("</span>fan.home<span class='s'>",    "</span>.<span class='s'>");
               Sys.boot();
               Sys.bootEnv.setArgs(args);
         $podInits
               Method m = Slot.findMethod("</span>$mainMethod<span class='s'>");
               m.call();
             }
             catch (Err.Val e) { e.err().trace(); }
             catch (Throwable e) { e.printStackTrace(); }
           }
         }
         "</span><span class='s'>""</span><span class='b'>)</span>.close

    <span class='y'>// compile main</span>
    Exec<span class='b'>(</span>script,
      <span class='b'>[</span>javacExe,
       <span class='s'>"-cp"</span>, tempDir.osPath,
       <span class='s'>"-d"</span>, tempDir.osPath,
       file.osPath<span class='b'>]</span>, tempDir<span class='b'>)</span>.run

    <span class='y'>// delete source file once we have compiled into .class file</span>
    Delete<span class='b'>(</span>script, file<span class='b'>)</span>.run
  <span class='b'>}</span>

  <span class='k'>private</span> Void <span id='jar'>jar</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='y'>// jar everything back up outFile</span>
    log.info<span class='b'>(</span><span class='s'>"Jar [$outFile]"</span><span class='b'>)</span>
    Exec<span class='b'>(</span>script,
      <span class='b'>[</span>jarExe,
       <span class='s'>"cfm"</span>, outFile.osPath, manifestFile.osPath,
       <span class='s'>"-C"</span>, tempDir.osPath,
       <span class='s'>"."</span><span class='b'>]</span>, tempDir<span class='b'>)</span>.run
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Fields</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>** Required output jar file to create</span>
  File? <span id='outFile'>outFile</span>

  <span class='z'>** Qualified name of main method to run for JAR.</span>
  <span class='z'>** This must be a static void method with no arguments.</span>
  Str? <span id='mainMethod'>mainMethod</span>

  <span class='z'>** List of pods to compile into JAR; sys is always implied</span>
  Str<span class='b'>[]</span> <span id='podNames'>podNames</span> := Str<span class='b'>[</span>,<span class='b'>]</span>

  <span class='k'>private</span> File? <span id='tempDir'>tempDir</span>       <span class='y'>// initTempDir</span>
  <span class='k'>private</span> File? <span id='manifestFile'>manifestFile</span>  <span class='y'>// manifest</span>
<span class='b'>}</span></pre>
</div>
</div>
<div class='sidebar'>
<h2>More Info</h2>
<ul class='clean'>
  <li><a href='JarDist.html'>View Fandoc</a></li>
</ul>
<div class='slots'>
<div class='overview'>
<h2>Slots</h2>
<ul class='clean'>
  <li class='hidden' style='display: block;'><a href='#cleanupTempDir'>cleanupTempDir</a></li>
  <li class='hidden' style='display: block;'><a href='#copyEtcFile'>copyEtcFile</a></li>
  <li class='hidden' style='display: block;'><a href='#etcFiles'>etcFiles</a></li>
  <li class='hidden' style='display: block;'><a href='#extractClassfilesToTemp'>extractClassfilesToTemp</a></li>
  <li class='hidden' style='display: block;'><a href='#initTempDir'>initTempDir</a></li>
  <li class='hidden' style='display: block;'><a href='#jar'>jar</a></li>
  <li class='hidden' style='display: block;'><a href='#main'>main</a></li>
  <li style='display: block;'><a href='#mainMethod'>mainMethod</a></li>
  <li style='display: block;'><a href='#make'>make</a></li>
  <li class='hidden' style='display: block;'><a href='#manifest'>manifest</a></li>
  <li class='hidden' style='display: block;'><a href='#manifestFile'>manifestFile</a></li>
  <li style='display: block;'><a href='#outFile'>outFile</a></li>
  <li class='hidden' style='display: block;'><a href='#podClasses'>podClasses</a></li>
  <li style='display: block;'><a href='#podNames'>podNames</a></li>
  <li class='hidden' style='display: block;'><a href='#reflect'>reflect</a></li>
  <li style='display: block;'><a href='#run'>run</a></li>
  <li class='hidden' style='display: block;'><a href='#sysClasses'>sysClasses</a></li>
  <li class='hidden' style='display: block;'><a href='#tempDir'>tempDir</a></li>
  <li class='hidden' style='display: block;'><a href='#verifyConfig'>verifyConfig</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class='footer'>
<div>
<p>
build 1.0.56
[11-Nov-2010 Thu 10:08:18AM EST]
</p>
</div>
</div>
</body>
</html>
