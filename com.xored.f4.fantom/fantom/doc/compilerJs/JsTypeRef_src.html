<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
  <title>compilerJs::JsTypeRef</title>
  <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
  <link rel='stylesheet' type='text/css' href='../doc.css'/>
  <script type='text/javascript' src='../doc.js'></script>
<!--[if lt IE 7]>
<script src='http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE7.js' type='text/javascript'></script>
<![endif]-->
</head>
<body onload='Login.check();'>
<div class='header'>
<div>
<h1><a href='/'>Fantom</a></h1>
<p id='sidewalkLogin_'>&nbsp;</p>
<form method='get' action='/sidewalk/search/'>
<p>
<input type='text' name='q' size='30' value='Search...' onfocus='if (value=="Search...") value=""' onblur='if (value=="") value="Search..."' />
</p>
</form>
<ul>
<li><a href='/'>Home</a></li>
<li class='active'><a href='../index.html'>Docs</a></li>
<li><a href='/sidewalk/blog/'>Blog</a></li>
<li><a href='/sidewalk/ticket/'>Tickets</a></li>
<li><a href='/sidewalk/topic/'>Discuss</a></li>
</ul></div>
</div>
<div class='subHeader'>
<div>
<ul>
  <li><a href='../index.html'>Doc Home</a></li>
  <li>&gt;</li>
  <li><a href='index.html'>compilerJs</a></li>
  <li>&gt;</li>
  <li><a href='JsTypeRef.html'>JsTypeRef</a></li>
</ul>
</div>
</div>
<div class='content'>
<div>
<div class='fandoc'>
<div class='type'>
<div class='overview'>
<h2>class</h2>
<h1>compilerJs::JsTypeRef</h1>
<pre><a href='../sys/Obj.html'>sys::Obj</a>
  <a href='JsNode.html'>compilerJs::JsNode</a>
    compilerJs::JsTypeRef</pre>
</div>
</div>
<div class='src'>
<pre>
<span class='y'>//</span>
<span class='y'>// Copyright (c) 2009, Brian Frank and Andy Frank</span>
<span class='y'>// Licensed under the Academic Free License version 3.0</span>
<span class='y'>//</span>
<span class='y'>// History:</span>
<span class='y'>//   9 Jul 09  Andy Frank  Creation</span>
<span class='y'>//</span>

<span class='k'>using</span> compiler

<span class='z'>**</span>
<span class='z'>** JsType</span>
<span class='z'>**</span>
<span class='k'>class</span> JsType : JsNode
<span class='b'>{</span>
  <span class='k'>new</span> make<span class='b'>(</span>JsCompilerSupport s, TypeDef def<span class='b'>)</span> : <span class='k'>super</span><span class='b'>(</span>s<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>this</span>.base        = JsTypeRef<span class='b'>(</span>s, def.base<span class='b'>)</span>
    <span class='k'>this</span>.qname       = qnameToJs<span class='b'>(</span>def<span class='b'>)</span>
    <span class='k'>this</span>.pod         = def.pod.name
    <span class='k'>this</span>.name        = def.name
    <span class='k'>this</span>.sig         = def.signature
    <span class='k'>this</span>.flags       = def.flags
    <span class='k'>this</span>.peer        = findPeer<span class='b'>(</span>s, def<span class='b'>)</span>
    <span class='k'>this</span>.isNative    = def.isNative
    <span class='k'>this</span>.hasNatives  = <span class='k'>null</span> != def.slots.find |n| <span class='b'>{</span> n.isNative &amp;&amp; n.parent.qname == def.qname <span class='b'>}</span>
    <span class='k'>this</span>.isMixin     = def.isMixin
    <span class='k'>this</span>.isSynthetic = def.isSynthetic
    <span class='k'>this</span>.mixins      = def.mixins.map |TypeRef r-&gt;JsTypeRef| <span class='b'>{</span> JsTypeRef<span class='b'>(</span>s, r<span class='b'>)</span> <span class='b'>}</span>
    <span class='k'>this</span>.fields      = def.fieldDefs.map |FieldDef f-&gt;JsField| <span class='b'>{</span> JsField<span class='b'>(</span>s, f<span class='b'>)</span> <span class='b'>}</span>
    <span class='k'>if</span> <span class='b'>(</span>def.staticInit != <span class='k'>null</span><span class='b'>)</span> <span class='k'>this</span>.staticInit = def.staticInit.name

    <span class='k'>this</span>.methods = JsMethod<span class='b'>[</span>,<span class='b'>]</span>
    def.methodDefs.each |m|
    <span class='b'>{</span>
      <span class='k'>if</span> <span class='b'>(</span>m.isInstanceInit<span class='b'>)</span> instanceInit = JsBlock<span class='b'>(</span>s, m.code<span class='b'>)</span>
      <span class='k'>else</span> <span class='k'>this</span>.methods.add<span class='b'>(</span>JsMethod<span class='b'>(</span>s, m<span class='b'>))</span>
    <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='k'>static</span> JsTypeRef? findPeer<span class='b'>(</span>JsCompilerSupport cs, CType def<span class='b'>)</span>
  <span class='b'>{</span>
    CType? t := def
    <span class='k'>while</span> <span class='b'>(</span>t != <span class='k'>null</span><span class='b'>)</span>
    <span class='b'>{</span>
      slot := t.slots.find |s| <span class='b'>{</span> s.isNative &amp;&amp; s.parent.qname == t.qname <span class='b'>}</span>
      <span class='k'>if</span> <span class='b'>(</span>slot != <span class='k'>null</span><span class='b'>)</span> <span class='k'>return</span> JsTypeRef<span class='b'>(</span>cs, slot.parent<span class='b'>)</span>
      t = t.base
    <span class='b'>}</span>
    <span class='k'>return</span> <span class='k'>null</span>
  <span class='b'>}</span>

  <span class='k'>override</span> Void write<span class='b'>(</span>JsWriter out<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='y'>// class/mixin</span>
    <span class='k'>if</span> <span class='b'>(</span>isMixin<span class='b'>)</span> out.w<span class='b'>(</span><span class='s'>"$qname = function() {}"</span><span class='b'>)</span>.nl
    <span class='k'>else</span> out.w<span class='b'>(</span><span class='s'>"$qname = fan.sys.Obj.\$extend($base.qname);"</span><span class='b'>)</span>.nl
    mixins.each |m| <span class='b'>{</span> copyMixin<span class='b'>(</span>m, out<span class='b'>)</span> <span class='b'>}</span>

    <span class='y'>// ctor</span>
    out.w<span class='b'>(</span><span class='s'>"${qname}.prototype.\$ctor = function()"</span><span class='b'>)</span>.nl
    out.w<span class='b'>(</span><span class='s'>"{"</span><span class='b'>)</span>.nl
    out.indent
    out.w<span class='b'>(</span><span class='s'>"${base.qname}.prototype.\$ctor.call(this);"</span><span class='b'>)</span>.nl
    <span class='k'>if</span> <span class='b'>(</span>peer != <span class='k'>null</span><span class='b'>)</span> out.w<span class='b'>(</span><span class='s'>"this.peer = new ${peer.qname}Peer(this);"</span><span class='b'>)</span>.nl
    out.w<span class='b'>(</span><span class='s'>"var \$this = this;"</span><span class='b'>)</span>.nl
    instanceInit?.write<span class='b'>(</span>out<span class='b'>)</span>
    out.unindent
    out.w<span class='b'>(</span><span class='s'>"}"</span><span class='b'>)</span>.nl

    <span class='y'>// type</span>
    <span class='k'>if</span> <span class='b'>(</span>!isSynthetic<span class='b'>)</span>
      out.w<span class='b'>(</span><span class='s'>"${qname}.prototype.\$typeof = function() { return ${qname}.\$type; }"</span><span class='b'>)</span>.nl

    <span class='y'>// slots</span>
    methods.each |m| <span class='b'>{</span> m.write<span class='b'>(</span>out<span class='b'>)</span> <span class='b'>}</span>
    fields.each |f| <span class='b'>{</span> f.write<span class='b'>(</span>out<span class='b'>)</span> <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='y'>// see JsPod.write</span>
  Void writeStatic<span class='b'>(</span>JsWriter out<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='y'>// static inits</span>
    <span class='k'>if</span> <span class='b'>(</span>staticInit != <span class='k'>null</span><span class='b'>)</span>
      out.w<span class='b'>(</span><span class='s'>"${qname}.static\$init();"</span><span class='b'>)</span>.nl
  <span class='b'>}</span>

  Void copyMixin<span class='b'>(</span>JsTypeRef ref, JsWriter out<span class='b'>)</span>
  <span class='b'>{</span>
    ref.slots.each |s|
    <span class='b'>{</span>
      <span class='k'>if</span> <span class='b'>(</span>s.parent == <span class='s'>"fan.sys.Obj"</span><span class='b'>)</span> <span class='k'>return</span>
      <span class='k'>if</span> <span class='b'>(</span>s.isAbstract<span class='b'>)</span> <span class='k'>return</span>
      <span class='k'>if</span> <span class='b'>(</span>s.isStatic<span class='b'>)</span> <span class='k'>return</span>
      <span class='k'>if</span> <span class='b'>(</span>overrides<span class='b'>(</span>s<span class='b'>))</span> <span class='k'>return</span>
      out.w<span class='b'>(</span><span class='s'>"${qname}.prototype.${s.name} = ${s.parent}.prototype.${s.name};"</span><span class='b'>)</span>.nl
    <span class='b'>}</span>
  <span class='b'>}</span>

  Bool overrides<span class='b'>(</span>JsSlotRef ref<span class='b'>)</span>
  <span class='b'>{</span>
    v := methods.find |m| <span class='b'>{</span> m.name == ref.name <span class='b'>}</span>
    <span class='k'>return</span> v != <span class='k'>null</span>
  <span class='b'>}</span>

  <span class='k'>override</span> Str toStr<span class='b'>()</span> <span class='b'>{</span> sig <span class='b'>}</span>

  JsTypeRef base         <span class='y'>// base type qname</span>
  Str qname              <span class='y'>// type qname</span>
  Str pod                <span class='y'>// pod name for type</span>
  Str name               <span class='y'>// simple type name</span>
  Str sig                <span class='y'>// full type signature</span>
  Int flags              <span class='y'>// flags</span>
  Bool isMixin           <span class='y'>// is this type a mixin</span>
  Bool isSynthetic       <span class='y'>// is type synthetic</span>
  JsTypeRef? peer        <span class='y'>// peer type if has one</span>
  Bool isNative          <span class='y'>// is this a full native class</span>
  Bool hasNatives        <span class='y'>// does type have any native slots directly</span>
  JsTypeRef<span class='b'>[]</span> mixins     <span class='y'>// mixins for this type</span>
  JsMethod<span class='b'>[]</span> methods     <span class='y'>// methods</span>
  JsField<span class='b'>[]</span> fields       <span class='y'>// fields</span>
  JsBlock? instanceInit  <span class='y'>// instanceInit block</span>
  Str? staticInit        <span class='y'>// name of static initializer if has one - see JsPod</span>
<span class='b'>}</span>

<span class='z'>**************************************************************************</span>
<span class='z'>** JsTypeRef</span>
<span class='z'>**************************************************************************</span>

<span class='z'>**</span>
<span class='z'>** JsTypeRef</span>
<span class='z'>**</span>
<span class='k'>class</span> JsTypeRef : JsNode
<span class='b'>{</span>
  <span class='k'>static</span> JsTypeRef <span id='make'>make</span><span class='b'>(</span>JsCompilerSupport cs, CType ref<span class='b'>)</span>
  <span class='b'>{</span>
    key := ref.signature
    js  := cs.typeRef<span class='b'>[</span>key<span class='b'>]</span>
    <span class='k'>if</span> <span class='b'>(</span>js == <span class='k'>null</span><span class='b'>)</span> cs.typeRef<span class='b'>[</span>key<span class='b'>]</span> = js = JsTypeRef.makePriv<span class='b'>(</span>cs, ref<span class='b'>)</span>
    <span class='k'>return</span> js
  <span class='b'>}</span>

  <span class='k'>private</span> <span class='k'>new</span> <span id='makePriv'>makePriv</span><span class='b'>(</span>JsCompilerSupport cs, CType ref<span class='b'>)</span> : <span class='k'>super</span>.make<span class='b'>(</span>cs<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>this</span>.qname = qnameToJs<span class='b'>(</span>ref<span class='b'>)</span>
    <span class='k'>this</span>.pod   = ref.pod.name
    <span class='k'>this</span>.name  = ref.name
    <span class='k'>this</span>.sig   = ref.signature
    <span class='k'>this</span>.slots = ref.slots.vals.map |CSlot s-&gt;JsSlotRef| <span class='b'>{</span> JsSlotRef<span class='b'>(</span>cs, s<span class='b'>)</span> <span class='b'>}</span>
    <span class='k'>this</span>.isSynthetic = ref.isSynthetic
    <span class='k'>this</span>.isNullable  = ref.isNullable
    <span class='k'>this</span>.isList = ref.isList
    <span class='k'>this</span>.isMap  = ref.isMap
    <span class='k'>this</span>.isFunc = ref.isFunc

    deref := ref.deref
    <span class='k'>if</span> <span class='b'>(</span>deref <span class='k'>is</span> ListType<span class='b'>)</span> v = JsTypeRef<span class='b'>(</span>cs, deref-&gt;v<span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>deref <span class='k'>is</span> MapType<span class='b'>)</span>
    <span class='b'>{</span>
      k = JsTypeRef<span class='b'>(</span>cs, deref-&gt;k<span class='b'>)</span>
      v = JsTypeRef<span class='b'>(</span>cs, deref-&gt;v<span class='b'>)</span>
    <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='k'>override</span> Void <span id='write'>write</span><span class='b'>(</span>JsWriter out<span class='b'>)</span>
  <span class='b'>{</span>
    out.w<span class='b'>(</span>qname<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='k'>override</span> Str <span id='toStr'>toStr</span><span class='b'>()</span> <span class='b'>{</span> sig <span class='b'>}</span>

  Str <span id='qname'>qname</span>          <span class='y'>// qname of type ref</span>
  Str <span id='pod'>pod</span>            <span class='y'>// pod name for type</span>
  Str <span id='name'>name</span>           <span class='y'>// simple type name</span>
  Str <span id='sig'>sig</span>            <span class='y'>// full type signature</span>
  JsSlotRef<span class='b'>[]</span> <span id='slots'>slots</span>  <span class='y'>// slots</span>
  Bool <span id='isSynthetic'>isSynthetic</span>   <span class='y'>// is type synthetic</span>
  Bool <span id='isNullable'>isNullable</span>    <span class='y'>// is type nullable</span>
  Bool <span id='isList'>isList</span>        <span class='y'>// is type a sys::List</span>
  Bool <span id='isMap'>isMap</span>         <span class='y'>// is type a sys::Map</span>
  Bool <span id='isFunc'>isFunc</span>        <span class='y'>// is type a sys::Func</span>

  JsTypeRef? <span id='k'>k</span>       <span class='y'>// only valid for MapType</span>
  JsTypeRef? <span id='v'>v</span>       <span class='y'>// only valid for ListType, MapType</span>
<span class='b'>}</span>

</pre>
</div>
</div>
<div class='sidebar'>
<h2>More Info</h2>
<ul class='clean'>
  <li><a href='JsTypeRef.html'>View Fandoc</a></li>
</ul>
<div class='slots'>
<div class='overview'>
<h2>Slots</h2>
<ul class='clean'>
  <li style='display: block;'><a href='#isFunc'>isFunc</a></li>
  <li style='display: block;'><a href='#isList'>isList</a></li>
  <li style='display: block;'><a href='#isMap'>isMap</a></li>
  <li style='display: block;'><a href='#isNullable'>isNullable</a></li>
  <li style='display: block;'><a href='#isSynthetic'>isSynthetic</a></li>
  <li style='display: block;'><a href='#k'>k</a></li>
  <li style='display: block;'><a href='#make'>make</a></li>
  <li class='hidden' style='display: block;'><a href='#makePriv'>makePriv</a></li>
  <li style='display: block;'><a href='#name'>name</a></li>
  <li style='display: block;'><a href='#pod'>pod</a></li>
  <li style='display: block;'><a href='#qname'>qname</a></li>
  <li style='display: block;'><a href='#sig'>sig</a></li>
  <li style='display: block;'><a href='#slots'>slots</a></li>
  <li style='display: block;'><a href='#toStr'>toStr</a></li>
  <li style='display: block;'><a href='#v'>v</a></li>
  <li style='display: block;'><a href='#write'>write</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class='footer'>
<div>
<p>
compilerJs 1.0.56
[11-Nov-2010 Thu 10:08:19AM EST]
</p>
</div>
</div>
</body>
</html>
