<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
  <title>flux::Flux</title>
  <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
  <link rel='stylesheet' type='text/css' href='../doc.css'/>
  <script type='text/javascript' src='../doc.js'></script>
<!--[if lt IE 7]>
<script src='http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE7.js' type='text/javascript'></script>
<![endif]-->
</head>
<body onload='Login.check();'>
<div class='header'>
<div>
<h1><a href='/'>Fantom</a></h1>
<p id='sidewalkLogin_'>&nbsp;</p>
<form method='get' action='/sidewalk/search/'>
<p>
<input type='text' name='q' size='30' value='Search...' onfocus='if (value=="Search...") value=""' onblur='if (value=="") value="Search..."' />
</p>
</form>
<ul>
<li><a href='/'>Home</a></li>
<li class='active'><a href='../index.html'>Docs</a></li>
<li><a href='/sidewalk/blog/'>Blog</a></li>
<li><a href='/sidewalk/ticket/'>Tickets</a></li>
<li><a href='/sidewalk/topic/'>Discuss</a></li>
</ul></div>
</div>
<div class='subHeader'>
<div>
<ul>
  <li><a href='../index.html'>Doc Home</a></li>
  <li>&gt;</li>
  <li><a href='index.html'>flux</a></li>
  <li>&gt;</li>
  <li><a href='Flux.html'>Flux</a></li>
</ul>
</div>
</div>
<div class='content'>
<div>
<div class='fandoc'>
<div class='type'>
<div class='overview'>
<h2>class</h2>
<h1>flux::Flux</h1>
<pre><a href='../sys/Obj.html'>sys::Obj</a>
  flux::Flux</pre>
</div>
</div>
<div class='src'>
<pre>
<span class='y'>//</span>
<span class='y'>// Copyright (c) 2008, Brian Frank and Andy Frank</span>
<span class='y'>// Licensed under the Academic Free License version 3.0</span>
<span class='y'>//</span>
<span class='y'>// History:</span>
<span class='y'>//   21 Jul 08  Brian Frank  Creation</span>
<span class='y'>//</span>

<span class='k'>using</span> concurrent
<span class='k'>using</span> gfx
<span class='k'>using</span> fwt

<span class='z'>**</span>
<span class='z'>** Flux provides system level utilities for flux applications</span>
<span class='z'>**</span>
<span class='k'>class</span> Flux
<span class='b'>{</span>

  <span class='z'>**</span>
  <span class='z'>** Standard log for flux pod.</span>
  <span class='z'>**</span>
  <span class='k'>static</span> <span class='k'>const</span> Log <span id='log'>log</span> := Flux#.pod.log

  <span class='z'>**</span>
  <span class='z'>** Read an session options file into memory.  An option file</span>
  <span class='z'>** is a serialized object stored at "etc/{pod}/{name}.fog".</span>
  <span class='z'>**</span>
  <span class='k'>static</span> Obj? <span id='loadOptions'>loadOptions</span><span class='b'>(</span>Pod pod, Str name, Type? t<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='b'>[</span>Str:CachedOptions<span class='b'>]</span>? options := Actor.locals<span class='b'>[</span><span class='s'>"flux.options"</span><span class='b'>]</span>
    <span class='k'>if</span> <span class='b'>(</span>options == <span class='k'>null</span><span class='b'>)</span> Actor.locals<span class='b'>[</span><span class='s'>"flux.options"</span><span class='b'>]</span> = options = Str:CachedOptions<span class='b'>[</span>:<span class='b'>]</span>

    <span class='y'>// check cache</span>
    path := <span class='s'>"etc/${pod.name}/${name}.fog"</span>
    cached := options<span class='b'>[</span>path<span class='b'>]</span>
    <span class='k'>if</span> <span class='b'>(</span>cached != <span class='k'>null</span> &amp;&amp; cached.file.modified == cached.modified<span class='b'>)</span>
      <span class='k'>return</span> cached.val

    <span class='y'>// not cached or modified since we loaded cache</span>
    pathUri := path.toUri
    file := Env.cur.findFile<span class='b'>(</span>pathUri, <span class='k'>false</span><span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>file == <span class='k'>null</span><span class='b'>)</span> file = Env.cur.workDir + pathUri
    Obj? value := <span class='k'>null</span>
    <span class='k'>try</span>
    <span class='b'>{</span>
      <span class='k'>if</span> <span class='b'>(</span>file.exists<span class='b'>)</span>
      <span class='b'>{</span>
        log.debug<span class='b'>(</span><span class='s'>"Load options: $file"</span><span class='b'>)</span>
        value = file.readObj
      <span class='b'>}</span>
    <span class='b'>}</span>
    <span class='k'>catch</span> <span class='b'>(</span>Err e<span class='b'>)</span>
    <span class='b'>{</span>
      log.err<span class='b'>(</span><span class='s'>"Cannot load options: $file"</span>, e<span class='b'>)</span>
    <span class='b'>}</span>
    <span class='k'>if</span> <span class='b'>(</span>value == <span class='k'>null</span><span class='b'>)</span> value = t?.make

    <span class='y'>// update cache</span>
    options<span class='b'>[</span>path<span class='b'>]</span> = CachedOptions<span class='b'>(</span>file, value<span class='b'>)</span>

    <span class='k'>return</span> value
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Save sessions options back to file. An option file is a</span>
  <span class='z'>** serialized object stored at "etc/{pod}/{name}.fog".</span>
  <span class='z'>** Return true on success, false on failure.</span>
  <span class='z'>**</span>
  <span class='k'>static</span> Bool <span id='saveOptions'>saveOptions</span><span class='b'>(</span>Pod pod, Str name, Obj options<span class='b'>)</span>
  <span class='b'>{</span>
    uri := <span class='u'>`etc/${pod.name}/${name}.fog`</span>
    file := Env.cur.workDir + uri
    <span class='k'>try</span>
    <span class='b'>{</span>
      log.debug<span class='b'>(</span><span class='s'>"Save options: $file"</span><span class='b'>)</span>
      file.writeObj<span class='b'>(</span>options, <span class='b'>[</span><span class='s'>"indent"</span>:2, <span class='s'>"skipDefaults"</span>:<span class='k'>true</span><span class='b'>])</span>
      <span class='k'>return</span> <span class='k'>true</span>
    <span class='b'>}</span>
    <span class='k'>catch</span> <span class='b'>(</span>Err e<span class='b'>)</span>
    <span class='b'>{</span>
      log.err<span class='b'>(</span><span class='s'>"Cannot save options: $file"</span>, e<span class='b'>)</span>
      <span class='k'>return</span> <span class='k'>false</span>
    <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='z'>** convenience 'flux' pod</span>
  <span class='k'>internal</span> <span class='k'>static</span> <span class='k'>const</span> Pod <span id='pod'>pod</span> := Flux#.pod

  <span class='z'>** convenience for images loaded out of icons</span>
  <span class='k'>internal</span> <span class='k'>static</span> Image <span id='icon'>icon</span><span class='b'>(</span>Uri uri<span class='b'>)</span>
  <span class='b'>{</span>
    Image<span class='b'>((</span><span class='s'>"fan://icons"</span>+uri<span class='b'>)</span>.toUri<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='z'>** Convenience for looking up a locale prop in the 'flux' pod.</span>
  <span class='k'>static</span> Str <span id='locale'>locale</span><span class='b'>(</span>Str key<span class='b'>)</span>
  <span class='b'>{</span>
    Flux#.pod.locale<span class='b'>(</span>key<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='z'>** Map list of qualified type names to types</span>
  <span class='k'>internal</span> <span class='k'>static</span> Type<span class='b'>[]</span> <span id='qnamesToTypes'>qnamesToTypes</span><span class='b'>(</span>Str<span class='b'>[]</span> qnames<span class='b'>)</span>
  <span class='b'>{</span>
    qnames.map |qn-&gt;Type| <span class='b'>{</span> Type.find<span class='b'>(</span>qn<span class='b'>)</span> <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='z'>** Given key like "flux.resource." find all indexed prop matches</span>
  <span class='z'>** for t, t.super, etc where the values are qualified type names</span>
  <span class='k'>internal</span> <span class='k'>static</span> Type<span class='b'>[]</span> <span id='indexForInheritance'>indexForInheritance</span><span class='b'>(</span>Str base, Type? t<span class='b'>)</span>
  <span class='b'>{</span>
    acc := Type<span class='b'>[</span>,<span class='b'>]</span>
    <span class='k'>while</span> <span class='b'>(</span>t != <span class='k'>null</span><span class='b'>)</span>
    <span class='b'>{</span>
      acc.addAll<span class='b'>(</span>qnamesToTypes<span class='b'>(</span>Env.cur.index<span class='b'>(</span>base + t.qname<span class='b'>)))</span>
      t = t.base
    <span class='b'>}</span>
    <span class='k'>return</span> acc
  <span class='b'>}</span>

<span class='b'>}</span>

<span class='z'>**************************************************************************</span>
<span class='z'>** CachedOptions</span>
<span class='z'>**************************************************************************</span>

<span class='k'>internal</span> <span class='k'>class</span> CachedOptions
<span class='b'>{</span>
  <span class='k'>new</span> make<span class='b'>(</span>File f, Obj? v<span class='b'>)</span> <span class='b'>{</span> file = f; modified = f.modified; val = v <span class='b'>}</span>
  File file
  DateTime? modified
  Obj? val
<span class='b'>}</span>

<span class='z'>**************************************************************************</span>
<span class='z'>** FluxUtilThread</span>
<span class='z'>**************************************************************************</span>

<span class='x'>/*
internal const class FluxUtilThread : Thread
{
  new make() : super("FluxUtilThread") {}

  override Obj run()
  {
    options := Str:Obj[:]
    loop |Obj msg-&gt;Obj|
    {
      echo("---&gt; $msg")
      fm := (FluxMsg)msg
      return trap(fm.name, fm.args)
    }
    return null
  }

  Obj readOptions(Type t, Str name)
  {
    file := Flux.homeDir + "${name}.fog".toUri
    try
    {
      if (file.exists) return file.readObj
    }
    catch (Err e)
    {
      type.log.err("Cannot load options: $file", e)
    }
    return t.make
  }
}

internal const class FluxMsg
{
  new make(Str n, Obj[] a) { name = n; args = a }
  override Str toStr() { return "${name}(${args})" }
  const Str name
  const Obj[] args
}
*/</span></pre>
</div>
</div>
<div class='sidebar'>
<h2>More Info</h2>
<ul class='clean'>
  <li><a href='Flux.html'>View Fandoc</a></li>
</ul>
<div class='slots'>
<div class='overview'>
<h2>Slots</h2>
<ul class='clean'>
  <li class='hidden' style='display: block;'><a href='#icon'>icon</a></li>
  <li class='hidden' style='display: block;'><a href='#indexForInheritance'>indexForInheritance</a></li>
  <li style='display: block;'><a href='#loadOptions'>loadOptions</a></li>
  <li style='display: block;'><a href='#locale'>locale</a></li>
  <li style='display: block;'><a href='#log'>log</a></li>
  <li class='hidden' style='display: block;'><a href='#pod'>pod</a></li>
  <li class='hidden' style='display: block;'><a href='#qnamesToTypes'>qnamesToTypes</a></li>
  <li style='display: block;'><a href='#saveOptions'>saveOptions</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class='footer'>
<div>
<p>
flux 1.0.56
[11-Nov-2010 Thu 10:08:27AM EST]
</p>
</div>
</div>
</body>
</html>
