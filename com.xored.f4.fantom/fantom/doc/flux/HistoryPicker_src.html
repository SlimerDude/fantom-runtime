<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
  <title>flux::HistoryPicker</title>
  <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
  <link rel='stylesheet' type='text/css' href='../doc.css'/>
  <script type='text/javascript' src='../doc.js'></script>
<!--[if lt IE 7]>
<script src='http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE7.js' type='text/javascript'></script>
<![endif]-->
</head>
<body onload='Login.check();'>
<div class='header'>
<div>
<h1><a href='/'>Fantom</a></h1>
<p id='sidewalkLogin_'>&nbsp;</p>
<form method='get' action='/sidewalk/search/'>
<p>
<input type='text' name='q' size='30' value='Search...' onfocus='if (value=="Search...") value=""' onblur='if (value=="") value="Search..."' />
</p>
</form>
<ul>
<li><a href='/'>Home</a></li>
<li class='active'><a href='../index.html'>Docs</a></li>
<li><a href='/sidewalk/blog/'>Blog</a></li>
<li><a href='/sidewalk/ticket/'>Tickets</a></li>
<li><a href='/sidewalk/topic/'>Discuss</a></li>
</ul></div>
</div>
<div class='subHeader'>
<div>
<ul>
  <li><a href='../index.html'>Doc Home</a></li>
  <li>&gt;</li>
  <li><a href='index.html'>flux</a></li>
  <li>&gt;</li>
  <li><a href='HistoryPicker.html'>HistoryPicker</a></li>
</ul>
</div>
</div>
<div class='content'>
<div>
<div class='fandoc'>
<div class='type'>
<div class='overview'>
<h2>class</h2>
<h1>flux::HistoryPicker</h1>
<pre><a href='../sys/Obj.html'>sys::Obj</a>
  <a href='../fwt/Widget.html'>fwt::Widget</a>
    <a href='../fwt/Pane.html'>fwt::Pane</a>
      <a href='../fwt/EdgePane.html'>fwt::EdgePane</a>
        flux::HistoryPicker</pre>
</div>
</div>
<div class='src'>
<pre>
<span class='y'>//</span>
<span class='y'>// Copyright (c) 2008, Brian Frank and Andy Frank</span>
<span class='y'>// Licensed under the Academic Free License version 3.0</span>
<span class='y'>//</span>
<span class='y'>// History:</span>
<span class='y'>//   12 Sep 08  Brian Frank  Creation</span>
<span class='y'>//</span>

<span class='k'>using</span> gfx
<span class='k'>using</span> fwt

<span class='z'>**</span>
<span class='z'>** History maintains the most recent navigation history</span>
<span class='z'>** of the entire application.</span>
<span class='z'>**</span>
@Serializable <span class='b'>{</span> collection = <span class='k'>true</span> <span class='b'>}</span>
<span class='k'>class</span> History
<span class='b'>{</span>

  <span class='z'>**</span>
  <span class='z'>** Convenience for loading from "session/history"</span>
  <span class='z'>**</span>
  <span class='k'>static</span> History load<span class='b'>()</span>
  <span class='b'>{</span>
    <span class='k'>return</span> Flux.loadOptions<span class='b'>(</span>Flux.pod, <span class='s'>"session/history"</span>, History#<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Convenience for save to "session/history".</span>
  <span class='z'>** Return this.</span>
  <span class='z'>**</span>
  This save<span class='b'>()</span>
  <span class='b'>{</span>
    Flux.saveOptions<span class='b'>(</span>Flux.pod, <span class='s'>"session/history"</span>, <span class='k'>this</span><span class='b'>)</span>
    <span class='k'>return</span> <span class='k'>this</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Log navigation to the specified resource</span>
  <span class='z'>** into the history.  Return this.</span>
  <span class='z'>**</span>
  This push<span class='b'>(</span>Resource r<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='y'>// don't log flux: uris</span>
    <span class='k'>if</span> <span class='b'>(</span>r.uri.scheme == <span class='s'>"flux"</span><span class='b'>)</span> <span class='k'>return</span> <span class='k'>this</span>

    <span class='y'>// map resource to item</span>
    item := HistoryItem
    <span class='b'>{</span>
      uri = r.uri
      iconUri = r.icon.uri
      time = DateTime.now
    <span class='b'>}</span>

    <span class='y'>// push as most recent (remove old record for uri if found)</span>
    dup := items.findIndex |HistoryItem i-&gt;Bool| <span class='b'>{</span> <span class='k'>return</span> i.uri == r.uri <span class='b'>}</span>
    <span class='k'>if</span> <span class='b'>(</span>dup != <span class='k'>null</span><span class='b'>)</span> list.removeAt<span class='b'>(</span>dup<span class='b'>)</span>
    <span class='k'>while</span> <span class='b'>(</span>items.size &gt;= max<span class='b'>)</span> list.removeAt<span class='b'>(</span>-1<span class='b'>)</span>
    list.insert<span class='b'>(</span>0, item<span class='b'>)</span>

    <span class='k'>return</span> <span class='k'>this</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Get a readonly copy of all the items in the history.</span>
  <span class='z'>** The first item is the most recent navigation and the last</span>
  <span class='z'>** item is the oldest navigation.</span>
  <span class='z'>**</span>
  HistoryItem<span class='b'>[]</span> items<span class='b'>()</span>
  <span class='b'>{</span>
    <span class='k'>return</span> list.ro
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Add a new history item to the end of the history.</span>
  <span class='z'>** This method is typically only used for serialization.</span>
  <span class='z'>** See `push` to log navigation of a Uri.  Return this.</span>
  <span class='z'>**</span>
  This add<span class='b'>(</span>HistoryItem item<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>if</span> <span class='b'>((</span>Obj?<span class='b'>)</span>item.uri == <span class='k'>null</span> || <span class='b'>(</span>Obj?<span class='b'>)</span>item.time == <span class='k'>null</span><span class='b'>)</span>
      <span class='k'>throw</span> ArgErr<span class='b'>(</span><span class='s'>"Invalid item: "</span> + item<span class='b'>)</span>
    list.add<span class='b'>(</span>item<span class='b'>)</span>
    <span class='k'>return</span> <span class='k'>this</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Iterate the history items from most recent to oldest.</span>
  <span class='z'>**</span>
  Void each<span class='b'>(</span>|HistoryItem item| f<span class='b'>)</span>
  <span class='b'>{</span>
    list.each<span class='b'>(</span>f<span class='b'>)</span>
  <span class='b'>}</span>

  @Transient <span class='k'>private</span> Int max := 40
  @Transient <span class='k'>private</span> HistoryItem<span class='b'>[]</span> list := HistoryItem<span class='b'>[</span>,<span class='b'>]</span>
<span class='b'>}</span>

<span class='z'>**************************************************************************</span>
<span class='z'>** HistoryItem</span>
<span class='z'>**************************************************************************</span>

<span class='z'>**</span>
<span class='z'>** HistoryItem stores information about navigation to a specific uri.</span>
<span class='z'>**</span>
@Serializable
<span class='k'>const</span> <span class='k'>class</span> HistoryItem
<span class='b'>{</span>
  <span class='z'>**</span>
  <span class='z'>** Default constructor with it-block</span>
  <span class='z'>**</span>
  <span class='k'>new</span> make<span class='b'>(</span>|This|? f := <span class='k'>null</span><span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>if</span> <span class='b'>(</span>f != <span class='k'>null</span><span class='b'>)</span> f<span class='b'>(</span><span class='k'>this</span><span class='b'>)</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Uri of resource.</span>
  <span class='z'>**</span>
  <span class='k'>const</span> Uri uri := <span class='u'>``</span>

  <span class='z'>**</span>
  <span class='z'>** Last time of access.</span>
  <span class='z'>**</span>
  <span class='k'>const</span> DateTime time := DateTime.now

  <span class='z'>**</span>
  <span class='z'>** Uri for icon of resource or null.</span>
  <span class='z'>**</span>
  <span class='k'>const</span> Uri? iconUri

  <span class='z'>**</span>
  <span class='z'>** Return uri string.</span>
  <span class='z'>**</span>
  <span class='k'>override</span> Str toStr<span class='b'>()</span> <span class='b'>{</span> <span class='k'>return</span> uri.toStr <span class='b'>}</span>
<span class='b'>}</span>

<span class='z'>**************************************************************************</span>
<span class='z'>** HistoryPicker</span>
<span class='z'>**************************************************************************</span>

<span class='k'>class</span> HistoryPicker : EdgePane
<span class='b'>{</span>
  <span class='k'>new</span> <span id='make'>make</span><span class='b'>(</span>HistoryItem<span class='b'>[]</span> items, Bool fullPath, |HistoryItem, Event| onAction<span class='b'>)</span>
  <span class='b'>{</span>
    model := HistoryPickerModel<span class='b'>(</span>items, fullPath<span class='b'>)</span>
    center = Table
    <span class='b'>{</span>
      it.headerVisible = <span class='k'>false</span>
      it.model = model
      it.onAction.add |Event e|
      <span class='b'>{</span>
        onAction<span class='b'>(</span>model.items<span class='b'>[</span>e.index<span class='b'>]</span>, e<span class='b'>)</span>
      <span class='b'>}</span>
      it.onKeyDown.add |Event e|
      <span class='b'>{</span>
        code := e.keyChar
        <span class='k'>if</span> <span class='b'>(</span>code &gt;= 97 &amp;&amp; code &lt;= 122<span class='b'>)</span> code -= 32
        code -= 65
        <span class='k'>if</span> <span class='b'>(</span>code &gt;= 0 &amp;&amp; code &lt; 26 &amp;&amp; code &lt; model.numRows<span class='b'>)</span>
          onAction<span class='b'>(</span>model.items<span class='b'>[</span>code<span class='b'>]</span>, e<span class='b'>)</span>
      <span class='b'>}</span>
    <span class='b'>}</span>
  <span class='b'>}</span>
<span class='b'>}</span>

<span class='k'>internal</span> <span class='k'>class</span> HistoryPickerModel : TableModel
<span class='b'>{</span>
  <span class='k'>new</span> make<span class='b'>(</span>HistoryItem<span class='b'>[]</span> items, Bool fullPath<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>this</span>.items = items
    <span class='k'>this</span>.fullPath = fullPath
    icons = items.map |HistoryItem item-&gt;Image|
    <span class='b'>{</span>
      Image<span class='b'>(</span>item.iconUri, <span class='k'>false</span><span class='b'>)</span> ?: def
    <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='k'>override</span> Int numCols<span class='b'>()</span> <span class='b'>{</span> <span class='k'>return</span> 2 <span class='b'>}</span>
  <span class='k'>override</span> Int numRows<span class='b'>()</span> <span class='b'>{</span> <span class='k'>return</span> items.size <span class='b'>}</span>
  <span class='k'>override</span> Int? prefWidth<span class='b'>(</span>Int col<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>switch</span> <span class='b'>(</span>col<span class='b'>)</span>
    <span class='b'>{</span>
      <span class='k'>case</span> 0: <span class='k'>return</span> fullPath ? 450 : 250
      <span class='k'>case</span> 1: <span class='k'>return</span> 20
      <span class='k'>default</span>: <span class='k'>return</span> <span class='k'>null</span>
    <span class='b'>}</span>
  <span class='b'>}</span>
  <span class='k'>override</span> Image? image<span class='b'>(</span>Int col, Int row<span class='b'>)</span> <span class='b'>{</span> <span class='k'>return</span> col==0 ? icons<span class='b'>[</span>row<span class='b'>]</span> : <span class='k'>null</span> <span class='b'>}</span>
  <span class='k'>override</span> Font? font<span class='b'>(</span>Int col, Int row<span class='b'>)</span> <span class='b'>{</span> <span class='k'>return</span> col==1 ? accFont : <span class='k'>null</span> <span class='b'>}</span>
  <span class='k'>override</span> Color? fg<span class='b'>(</span>Int col, Int row<span class='b'>)</span>  <span class='b'>{</span> <span class='k'>return</span> col==1 ? accColor : <span class='k'>null</span> <span class='b'>}</span>
  <span class='k'>override</span> Str text<span class='b'>(</span>Int col, Int row<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>switch</span> <span class='b'>(</span>col<span class='b'>)</span>
    <span class='b'>{</span>
      <span class='k'>case</span> 0:  uri := items<span class='b'>[</span>row<span class='b'>]</span>.uri; <span class='k'>return</span> fullPath ? uri.toStr : uri.name
      <span class='k'>case</span> 1:  <span class='k'>return</span> <span class='b'>(</span>row &lt; 26<span class='b'>)</span> ? <span class='b'>(</span>row+65<span class='b'>)</span>.toChar : <span class='s'>""</span>
      <span class='k'>default</span>: <span class='k'>return</span> <span class='s'>""</span>
    <span class='b'>}</span>
  <span class='b'>}</span>
  HistoryItem<span class='b'>[]</span> items
  Image<span class='b'>[]</span> icons
  Image def := Flux.icon<span class='b'>(</span><span class='u'>`/x16/file.png`</span><span class='b'>)</span>
  Font accFont := Desktop.sysFont.toSize<span class='b'>(</span>Desktop.sysFont.size-1<span class='b'>)</span>
  Color accColor := Color<span class='b'>(</span><span class='s'>"#666"</span><span class='b'>)</span>
  Bool fullPath
<span class='b'>}</span>

</pre>
</div>
</div>
<div class='sidebar'>
<h2>More Info</h2>
<ul class='clean'>
  <li><a href='HistoryPicker.html'>View Fandoc</a></li>
</ul>
<div class='slots'>
<div class='overview'>
<h2>Slots</h2>
<ul class='clean'>
  <li style='display: block;'><a href='#make'>make</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class='footer'>
<div>
<p>
flux 1.0.56
[11-Nov-2010 Thu 10:08:27AM EST]
</p>
</div>
</div>
</body>
</html>
