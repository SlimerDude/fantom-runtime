<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
  <title>flux::Console</title>
  <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
  <link rel='stylesheet' type='text/css' href='../doc.css'/>
  <script type='text/javascript' src='../doc.js'></script>
<!--[if lt IE 7]>
<script src='http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE7.js' type='text/javascript'></script>
<![endif]-->
</head>
<body onload='Login.check();'>
<div class='header'>
<div>
<h1><a href='/'>Fantom</a></h1>
<p id='sidewalkLogin_'>&nbsp;</p>
<form method='get' action='/sidewalk/search/'>
<p>
<input type='text' name='q' size='30' value='Search...' onfocus='if (value=="Search...") value=""' onblur='if (value=="") value="Search..."' />
</p>
</form>
<ul>
<li><a href='/'>Home</a></li>
<li class='active'><a href='../index.html'>Docs</a></li>
<li><a href='/sidewalk/blog/'>Blog</a></li>
<li><a href='/sidewalk/ticket/'>Tickets</a></li>
<li><a href='/sidewalk/topic/'>Discuss</a></li>
</ul></div>
</div>
<div class='subHeader'>
<div>
<ul>
  <li><a href='../index.html'>Doc Home</a></li>
  <li>&gt;</li>
  <li><a href='index.html'>flux</a></li>
  <li>&gt;</li>
  <li><a href='Console.html'>Console</a></li>
</ul>
</div>
</div>
<div class='content'>
<div>
<div class='fandoc'>
<div class='type'>
<div class='overview'>
<h2>class</h2>
<h1>flux::Console</h1>
<pre><a href='../sys/Obj.html'>sys::Obj</a>
  <a href='../fwt/Widget.html'>fwt::Widget</a>
    <a href='../fwt/Pane.html'>fwt::Pane</a>
      <a href='../fwt/ContentPane.html'>fwt::ContentPane</a>
        <a href='SideBar.html'>flux::SideBar</a>
          flux::Console</pre>
</div>
</div>
<div class='src'>
<pre>
<span class='y'>//</span>
<span class='y'>// Copyright (c) 2008, Brian Frank and Andy Frank</span>
<span class='y'>// Licensed under the Academic Free License version 3.0</span>
<span class='y'>//</span>
<span class='y'>// History:</span>
<span class='y'>//   14 Sep 08  Brian Frank  Creation</span>
<span class='y'>//</span>

<span class='k'>using</span> concurrent
<span class='k'>using</span> gfx
<span class='k'>using</span> fwt

<span class='z'>**</span>
<span class='z'>** Console is used to run external programs and capture output.</span>
<span class='z'>**</span>
<span class='k'>class</span> Console : SideBar
<span class='b'>{</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Construction</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Use `Frame.console` to get the console.</span>
  <span class='z'>**</span>
  <span class='k'>override</span> Void <span id='onLoad'>onLoad</span><span class='b'>()</span>
  <span class='b'>{</span>
    model = ConsoleModel<span class='b'>()</span>
    model.clear
    richText = RichText
    <span class='b'>{</span>
      it.model = <span class='k'>this</span>.model
      it.editable = <span class='k'>false</span>
      it.border = <span class='k'>false</span>
      it.font = Desktop.sysFontMonospace
      it.onMouseUp.add |e| <span class='b'>{</span> onRichTextMouseDown<span class='b'>(</span>e<span class='b'>)</span> <span class='b'>}</span>
    <span class='b'>}</span>
    content = EdgePane
    <span class='b'>{</span>
      top = EdgePane
      <span class='b'>{</span>
        top = BorderPane
        <span class='b'>{</span>
          border = Border<span class='b'>(</span><span class='s'>"1,0,1,0 $Desktop.sysNormShadow,#000,$Desktop.sysHighlightShadow"</span><span class='b'>)</span>
        <span class='b'>}</span>
        bottom = InsetPane<span class='b'>(</span>4,4,4,4<span class='b'>)</span>
        <span class='b'>{</span>
          EdgePane
          <span class='b'>{</span>
            left = ToolBar
            <span class='b'>{</span>
              addCommand<span class='b'>(</span>copyCmd<span class='b'>)</span>
              addCommand<span class='b'>(</span>frame.command<span class='b'>(</span>CommandId.jumpPrev<span class='b'>))</span>
              addCommand<span class='b'>(</span>frame.command<span class='b'>(</span>CommandId.jumpNext<span class='b'>))</span>
            <span class='b'>}</span>
            right = ToolBar
            <span class='b'>{</span>
              addCommand<span class='b'>(</span>hideCmd<span class='b'>)</span>
            <span class='b'>}</span>
          <span class='b'>}</span>,
        <span class='b'>}</span>
      <span class='b'>}</span>
      center = BorderPane
      <span class='b'>{</span>
        it.content = richText
        it.border = Border<span class='b'>(</span><span class='s'>"1,0,0,1 $Desktop.sysNormShadow"</span><span class='b'>)</span>
      <span class='b'>}</span>
    <span class='b'>}</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// SideBar</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Console is aligned at the bottom of the frame.</span>
  <span class='z'>**</span>
  <span class='k'>override</span> Obj <span id='prefAlign'>prefAlign</span><span class='b'>()</span> <span class='b'>{</span> <span class='k'>return</span> Valign.bottom <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Write</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Write the string to the end of the console</span>
  <span class='z'>**</span>
  This <span id='clear'>clear</span><span class='b'>()</span>
  <span class='b'>{</span>
    model.clear
    richText.repaint
    <span class='k'>return</span> <span class='k'>this</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Write the string to the end of the console</span>
  <span class='z'>**</span>
  This <span id='append'>append</span><span class='b'>(</span>Str s<span class='b'>)</span>
  <span class='b'>{</span>
    model.append<span class='b'>(</span>s<span class='b'>)</span>
    richText.repaint
    richText.select<span class='b'>(</span>model.size, 0<span class='b'>)</span>
    <span class='k'>return</span> <span class='k'>this</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Exec</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Return true if the console is busy executing a job.</span>
  <span class='z'>**</span>
  <span class='k'>readonly</span> Bool <span id='busy'>busy</span> := <span class='k'>false</span>

  <span class='z'>**</span>
  <span class='z'>** Execute an external process and capture its output</span>
  <span class='z'>** in the console.  See `sys::Process` for a description</span>
  <span class='z'>** of the command and dir parameters.</span>
  <span class='z'>**</span>
  This <span id='exec'>exec</span><span class='b'>(</span>Str<span class='b'>[]</span> command, File? dir := <span class='k'>null</span><span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>if</span> <span class='b'>(</span>busy<span class='b'>)</span> <span class='k'>throw</span> Err<span class='b'>(</span><span class='s'>"Console is busy"</span><span class='b'>)</span>
    frame.marks = Mark<span class='b'>[</span>,<span class='b'>]</span>
    model.clear.append<span class='b'>(</span>command.join<span class='b'>(</span><span class='s'>" "</span><span class='b'>)</span> + <span class='s'>"\n"</span><span class='b'>)</span>
    richText.repaint
    busy = <span class='k'>true</span>
    params := ExecParams
    <span class='b'>{</span>
      it.frameId = frame.id
      it.command = command
      it.dir = dir
    <span class='b'>}</span>
    Actor<span class='b'>(</span>ActorPool<span class='b'>()</span>, |-&gt;| <span class='b'>{</span> execRun<span class='b'>(</span>params<span class='b'>)</span> <span class='b'>})</span>.send<span class='b'>(</span><span class='k'>null</span><span class='b'>)</span>
    <span class='k'>return</span> <span class='k'>this</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** This is the method which executes the process</span>
  <span class='z'>** on a background thread.</span>
  <span class='z'>**</span>
  <span class='k'>internal</span> <span class='k'>static</span> Void <span id='execRun'>execRun</span><span class='b'>(</span>ExecParams params<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>try</span>
    <span class='b'>{</span>
      proc := Process<span class='b'>(</span>params.command, params.dir<span class='b'>)</span>
      proc.out = ConsoleOutStream<span class='b'>(</span>params.frameId<span class='b'>)</span>
      proc.run.join
    <span class='b'>}</span>
    <span class='k'>catch</span> <span class='b'>(</span>Err e<span class='b'>)</span>
    <span class='b'>{</span>
      e.trace
    <span class='b'>}</span>
    <span class='k'>finally</span>
    <span class='b'>{</span>
      Desktop.callAsync |-&gt;| <span class='b'>{</span> execDone<span class='b'>(</span>params.frameId<span class='b'>)</span> <span class='b'>}</span>
    <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Called on UI thread by ConsoleOutStream when the</span>
  <span class='z'>** process writes to stdout.</span>
  <span class='z'>**</span>
  <span class='k'>internal</span> <span class='k'>static</span> Void <span id='execWrite'>execWrite</span><span class='b'>(</span>Str frameId, Str str<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>try</span>
    <span class='b'>{</span>
      Frame.findById<span class='b'>(</span>frameId<span class='b'>)</span>.console.append<span class='b'>(</span>str<span class='b'>)</span>
    <span class='b'>}</span>
    <span class='k'>catch</span> <span class='b'>(</span>Err e<span class='b'>)</span>
    <span class='b'>{</span>
      e.trace
    <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Called on UI thread by execRun when process completes.</span>
  <span class='z'>**</span>
  <span class='k'>internal</span> <span class='k'>static</span> Void <span id='execDone'>execDone</span><span class='b'>(</span>Str frameId<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>try</span>
    <span class='b'>{</span>
      frame := Frame.findById<span class='b'>(</span>frameId<span class='b'>)</span>
      console := frame.console
      console.busy = <span class='k'>false</span>
      frame.marks = console.model.toMarks
    <span class='b'>}</span>
    <span class='k'>catch</span> <span class='b'>(</span>Err e<span class='b'>)</span>
    <span class='b'>{</span>
      e.trace
    <span class='b'>}</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Run</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Run the given function in another thread.</span>
  <span class='z'>** TODO - this function is experimental and will change!</span>
  <span class='z'>**</span>
  <span class='k'>internal</span> This <span id='run'>run</span><span class='b'>(</span>Method method, Str<span class='b'>[]</span> params<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>if</span> <span class='b'>(</span>busy<span class='b'>)</span> <span class='k'>throw</span> Err<span class='b'>(</span><span class='s'>"Console is busy"</span><span class='b'>)</span>
    frame.marks = Mark<span class='b'>[</span>,<span class='b'>]</span>
    model.clear
    richText.repaint
    busy = <span class='k'>true</span>
    execParams := ExecParams
    <span class='b'>{</span>
      frameId = frame.id
      command = params
    <span class='b'>}</span>
    Actor<span class='b'>(</span>ActorPool<span class='b'>()</span>, |-&gt;| <span class='b'>{</span> doRun<span class='b'>(</span>method, execParams<span class='b'>)</span> <span class='b'>})</span>.send<span class='b'>(</span><span class='k'>null</span><span class='b'>)</span>
    <span class='k'>return</span> <span class='k'>this</span>
  <span class='b'>}</span>

  <span class='k'>internal</span> <span class='k'>static</span> Void <span id='doRun'>doRun</span><span class='b'>(</span>Method method, ExecParams params<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>try</span>
    <span class='b'>{</span>
      results := <span class='b'>(</span>Str<span class='b'>[])</span>method.call<span class='b'>(</span>params<span class='b'>)</span>
      results.each |Str s| <span class='b'>{</span> Desktop.callAsync |-&gt;| <span class='b'>{</span> execWrite<span class='b'>(</span>params.frameId, s<span class='b'>)</span> <span class='b'>}</span> <span class='b'>}</span>
    <span class='b'>}</span>
    <span class='k'>catch</span> <span class='b'>(</span>Err e<span class='b'>)</span>
    <span class='b'>{</span>
      e.trace
    <span class='b'>}</span>
    <span class='k'>finally</span>
    <span class='b'>{</span>
      Desktop.callAsync |-&gt;| <span class='b'>{</span> execDone<span class='b'>(</span>params.frameId<span class='b'>)</span> <span class='b'>}</span>
    <span class='b'>}</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Eventing</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>override</span> Void <span id='onGotoMark'>onGotoMark</span><span class='b'>(</span>Mark mark<span class='b'>)</span>
  <span class='b'>{</span>
    model.curMark = mark
    line := model.lineForMark<span class='b'>(</span>mark<span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>line != <span class='k'>null</span><span class='b'>)</span> richText.showLine<span class='b'>(</span>line.index<span class='b'>)</span>
    richText.repaint
  <span class='b'>}</span>

  <span class='k'>internal</span> Void <span id='onRichTextMouseDown'>onRichTextMouseDown</span><span class='b'>(</span>Event event<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='y'>// clear current mark</span>
    model.curMark = <span class='k'>null</span>

    <span class='y'>// map event to line and check if line has mark</span>
    offset := richText.offsetAtPos<span class='b'>(</span>event.pos.x, event.pos.y<span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>offset != <span class='k'>null</span><span class='b'>)</span>
    <span class='b'>{</span>
      line := model.lines<span class='b'>[</span>model.lineAtOffset<span class='b'>(</span>offset<span class='b'>)]</span>
      <span class='k'>if</span> <span class='b'>(</span>line.mark != <span class='k'>null</span><span class='b'>)</span>
        model.curMark = line.mark
    <span class='b'>}</span>

    <span class='y'>// update highlight</span>
    richText.repaint

    <span class='y'>// hyperlink to view</span>
    <span class='k'>if</span> <span class='b'>(</span>model.curMark != <span class='k'>null</span><span class='b'>)</span>
      frame.loadMark<span class='b'>(</span>model.curMark, LoadMode<span class='b'>(</span>event<span class='b'>))</span>
  <span class='b'>}</span>

  <span class='k'>internal</span> Void <span id='onCopy'>onCopy</span><span class='b'>()</span>
  <span class='b'>{</span>
    richText.selectAll
    richText.copy
  <span class='b'>}</span>

  <span class='k'>internal</span> Void <span id='onClose'>onClose</span><span class='b'>()</span>
  <span class='b'>{</span>
    hide
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Fields</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>internal</span> ConsoleModel? <span id='model'>model</span>
  <span class='k'>internal</span> RichText? <span id='richText'>richText</span>

  <span class='k'>private</span> Command <span id='copyCmd'>copyCmd</span> := Command.makeLocale<span class='b'>(</span>Flux#.pod, <span class='s'>"copy"</span><span class='b'>)</span> <span class='b'>{</span> onCopy <span class='b'>}</span>
  <span class='k'>private</span> Command <span id='hideCmd'>hideCmd</span> := Command.makeLocale<span class='b'>(</span>Flux#.pod, <span class='s'>"navBar.close"</span><span class='b'>)</span> <span class='b'>{</span> onClose <span class='b'>}</span>

<span class='b'>}</span>

<span class='z'>**************************************************************************</span>
<span class='z'>** ConsoleModel</span>
<span class='z'>**************************************************************************</span>

<span class='k'>internal</span> <span class='k'>class</span> ConsoleModel : RichTextModel
<span class='b'>{</span>
  <span class='k'>override</span> Str text
  <span class='b'>{</span>
    get <span class='b'>{</span> <span class='k'>return</span> lines.join<span class='b'>(</span>delimiter<span class='b'>)</span> |ConsoleLine line-&gt;Str| <span class='b'>{</span> <span class='k'>return</span> line.text <span class='b'>}</span> <span class='b'>}</span>
    set <span class='b'>{</span> modify<span class='b'>(</span>0, size, it<span class='b'>)</span> <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='k'>override</span> Int charCount<span class='b'>()</span> <span class='b'>{</span> <span class='k'>return</span> size <span class='b'>}</span>

  <span class='k'>override</span> Int lineCount<span class='b'>()</span> <span class='b'>{</span> <span class='k'>return</span> lines.size <span class='b'>}</span>

  <span class='k'>override</span> Str line<span class='b'>(</span>Int lineIndex<span class='b'>)</span> <span class='b'>{</span> <span class='k'>return</span> lines<span class='b'>[</span>lineIndex<span class='b'>]</span>.text <span class='b'>}</span>

  <span class='k'>override</span> Int offsetAtLine<span class='b'>(</span>Int lineIndex<span class='b'>)</span> <span class='b'>{</span> <span class='k'>return</span> lines<span class='b'>[</span>lineIndex<span class='b'>]</span>.offset <span class='b'>}</span>

  <span class='k'>override</span> Int lineAtOffset<span class='b'>(</span>Int offset<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='y'>// binary search by offset, returns '-insertationPoint-1'</span>
    key := ConsoleLine <span class='b'>{</span> it.offset = offset <span class='b'>}</span>
    line := lines.binarySearch<span class='b'>(</span>key<span class='b'>)</span> |ConsoleLine a, ConsoleLine b-&gt;Int| <span class='b'>{</span> <span class='k'>return</span> a.offset &lt;=&gt; b.offset <span class='b'>}</span>
    <span class='k'>if</span> <span class='b'>(</span>line &lt; 0<span class='b'>)</span> line = -<span class='b'>(</span>line + 2<span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>line &gt;= lines.size<span class='b'>)</span> line = lines.size-1
    <span class='k'>return</span> line
  <span class='b'>}</span>

  <span class='k'>override</span> Void modify<span class='b'>(</span>Int startOffset, Int len, Str newText<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='y'>// we only allow appending to end of console text since we</span>
    <span class='y'>// are actually modifying the text displayed to show short</span>
    <span class='y'>// filenames versus full file paths</span>
    <span class='k'>throw</span> UnsupportedErr<span class='b'>(</span><span class='s'>"Cannot only call ConsoleModel.append"</span><span class='b'>)</span>
  <span class='b'>}</span>

  This clear<span class='b'>()</span>
  <span class='b'>{</span>
    size = 0
    lines = <span class='b'>[</span>ConsoleLine <span class='b'>{</span> it.offset=0; it.text=<span class='s'>""</span>; it.fullText=<span class='s'>""</span> <span class='b'>}]</span>
    curMark = <span class='k'>null</span>
    <span class='k'>return</span> <span class='k'>this</span>
  <span class='b'>}</span>

  This append<span class='b'>(</span>Str s<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='y'>// save initial state for modification event</span>
    startOffset := size
    startLineIndex := lines.last.index

    <span class='y'>// normalize newlines</span>
    newLines := s.splitLines
    numNewLines := newLines.size - 1

    <span class='y'>// figure out if this we are starting a new line or need to append</span>
    <span class='y'>// to the last line; if appending to the last line we have to use</span>
    <span class='y'>// the original fullText to ensure we parse filenames correctly</span>
    <span class='k'>if</span> <span class='b'>(</span>newLines.first == <span class='s'>""</span><span class='b'>)</span>
    <span class='b'>{</span>
      newLines.removeAt<span class='b'>(</span>0<span class='b'>)</span>
      startLineIndex++
    <span class='b'>}</span>
    <span class='k'>else</span>
    <span class='b'>{</span>
      newLines<span class='b'>[</span>0<span class='b'>]</span> = lines.last.fullText + newLines.first
      lines.removeAt<span class='b'>(</span>-1<span class='b'>)</span>
    <span class='b'>}</span>

    <span class='y'>// parse and append new lines</span>
    newLines.each |Str line|
    <span class='b'>{</span>
      lines.add<span class='b'>(</span>parseLine<span class='b'>(</span>line<span class='b'>))</span>
    <span class='b'>}</span>

    <span class='y'>// update total size, line offsets</span>
    updateLines<span class='b'>(</span>lines<span class='b'>)</span>

    <span class='y'>// fire modification event</span>
    tc := TextChange
    <span class='b'>{</span>
      it.startOffset    = startOffset
      it.startLine      = startLineIndex
      it.oldText        = <span class='s'>""</span>
      it.newText        = s
      it.oldNumNewlines = 0
      it.newNumNewlines = numNewLines
    <span class='b'>}</span>
    onModify.fire<span class='b'>(</span>Event <span class='b'>{</span> id =EventId.modified; data = tc <span class='b'>})</span>

    <span class='k'>return</span> <span class='k'>this</span>
  <span class='b'>}</span>

  <span class='k'>private</span> Void updateLines<span class='b'>(</span>ConsoleLine<span class='b'>[]</span> lines<span class='b'>)</span>
  <span class='b'>{</span>
    n := 0
    lastIndex := lines.size-1
    delimiterSize := delimiter.size

    <span class='y'>// walk the lines</span>
    lines.each |ConsoleLine line, Int i|
    <span class='b'>{</span>
      <span class='y'>// update offset and total running size</span>
      line.index  = i;
      line.offset = n
      n += line.text.size
      <span class='k'>if</span> <span class='b'>(</span>i != lastIndex<span class='b'>)</span> n += delimiterSize
    <span class='b'>}</span>

    <span class='y'>// update total size</span>
    size = n
  <span class='b'>}</span>

  ConsoleLine parseLine<span class='b'>(</span>Str t<span class='b'>)</span>
  <span class='b'>{</span>
    Obj<span class='b'>[]</span>? s := <span class='k'>null</span>
    full := t

    <span class='y'>// attempt to parse mark (filename) in the line</span>
    mp := MarkParser<span class='b'>(</span>t<span class='b'>)</span>
    m := mp.parse

    <span class='y'>// don't show paths that are likely executables (bin)</span>
    <span class='k'>if</span> <span class='b'>(</span>m != <span class='k'>null</span> &amp;&amp; m.uri.path.contains<span class='b'>(</span><span class='s'>"bin"</span><span class='b'>))</span> m = <span class='k'>null</span>

    <span class='y'>// update the text to only show the filename (not the full path);</span>
    <span class='y'>// compute the styling to make filename appear as a hyperlink</span>
    <span class='k'>if</span> <span class='b'>(</span>m != <span class='k'>null</span><span class='b'>)</span>
    <span class='b'>{</span>
      start := mp.fileStart
      name  := m.uri.name
      t = t<span class='b'>[</span>0..&lt;start<span class='b'>]</span> + name + t<span class='b'>[</span>mp.fileEnd+1..-1<span class='b'>]</span>
      <span class='k'>if</span> <span class='b'>(</span>start == 0<span class='b'>)</span>
        s = <span class='b'>[</span>0, link, name.size, norm<span class='b'>]</span>
      <span class='k'>else</span>
        s = <span class='b'>[</span>0, norm, start, link, start+name.size, norm<span class='b'>]</span>
    <span class='b'>}</span>

    <span class='k'>return</span> ConsoleLine <span class='b'>{</span> it.text = t; it.fullText = full; it.mark = m; it.styling = s <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='k'>override</span> Obj<span class='b'>[]</span>? lineStyling<span class='b'>(</span>Int lineIndex<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>return</span> lines<span class='b'>[</span>lineIndex<span class='b'>]</span>.styling
  <span class='b'>}</span>

  <span class='k'>override</span> Color? lineBackground<span class='b'>(</span>Int lineIndex<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>if</span> <span class='b'>(</span>curMark != <span class='k'>null</span> &amp;&amp; lines<span class='b'>[</span>lineIndex<span class='b'>]</span>.mark === curMark<span class='b'>)</span>
      <span class='k'>return</span> Color.yellow
    <span class='k'>else</span>
      <span class='k'>return</span> <span class='k'>null</span>
  <span class='b'>}</span>

  ConsoleLine? lineForMark<span class='b'>(</span>Mark m<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>return</span> lines.find |ConsoleLine line-&gt;Bool| <span class='b'>{</span> <span class='k'>return</span> line.mark === m <span class='b'>}</span>
  <span class='b'>}</span>

  Mark<span class='b'>[]</span> toMarks<span class='b'>()</span>
  <span class='b'>{</span>
    marks := Mark<span class='b'>[</span>,<span class='b'>]</span>
    lines.each |ConsoleLine line, Int i|
    <span class='b'>{</span>
      <span class='k'>if</span> <span class='b'>(</span>line.mark != <span class='k'>null</span> &amp;&amp; i != 0<span class='b'>)</span> marks.add<span class='b'>(</span>line.mark<span class='b'>)</span>
    <span class='b'>}</span>
    <span class='k'>return</span> marks
  <span class='b'>}</span>

  Int size
  ConsoleLine<span class='b'>[]</span> lines := ConsoleLine<span class='b'>[</span>,<span class='b'>]</span>
  Str delimiter := <span class='s'>"\n"</span>
  RichTextStyle norm := RichTextStyle <span class='b'>{}</span>
  RichTextStyle link := RichTextStyle <span class='b'>{</span> fg=Color.blue; underline = RichTextUnderline.single; <span class='b'>}</span>
  Mark? curMark
<span class='b'>}</span>

<span class='z'>**************************************************************************</span>
<span class='z'>** ConsoleLine</span>
<span class='z'>**************************************************************************</span>

<span class='k'>internal</span> <span class='k'>class</span> ConsoleLine
<span class='b'>{</span>
  <span class='k'>new</span> make<span class='b'>(</span>|This| f<span class='b'>)</span> <span class='b'>{</span> f<span class='b'>(</span><span class='k'>this</span><span class='b'>)</span> <span class='b'>}</span>

  <span class='z'>** Return 'text'.</span>
  <span class='k'>override</span> Str toStr<span class='b'>()</span> <span class='b'>{</span> <span class='k'>return</span> text <span class='b'>}</span>

  <span class='z'>** Zero based line index</span>
  Int index

  <span class='z'>** Zero based offset from start of document (this</span>
  <span class='z'>** field is managed by the Doc).</span>
  Int offset <span class='b'>{</span> <span class='k'>internal</span> set; <span class='b'>}</span>

  <span class='z'>** Text we show (short uri filename)</span>
  <span class='k'>const</span> Str text := <span class='s'>""</span>

  <span class='z'>** Full text we show (long uri)</span>
  <span class='k'>const</span> Str fullText := <span class='s'>""</span>

  <span class='z'>** If we matched a file location from text</span>
  Mark? mark

  <span class='z'>** Styling</span>
  Obj<span class='b'>[]</span>? styling
<span class='b'>}</span>

<span class='z'>**************************************************************************</span>
<span class='z'>** ConsoleOutStream</span>
<span class='z'>**************************************************************************</span>

<span class='k'>internal</span> <span class='k'>class</span> ConsoleOutStream : OutStream
<span class='b'>{</span>
  <span class='k'>new</span> make<span class='b'>(</span>Str frameId<span class='b'>)</span> : <span class='k'>super</span><span class='b'>(</span><span class='k'>null</span><span class='b'>)</span> <span class='b'>{</span> <span class='k'>this</span>.frameId = frameId <span class='b'>}</span>

  <span class='k'>override</span> This write<span class='b'>(</span>Int b<span class='b'>)</span>
  <span class='b'>{</span>
    frameId := <span class='k'>this</span>.frameId
    str := Buf<span class='b'>()</span>.write<span class='b'>(</span>b<span class='b'>)</span>.flip.readAllStr
    Desktop.callAsync |-&gt;| <span class='b'>{</span> Console.execWrite<span class='b'>(</span>frameId, str<span class='b'>)</span> <span class='b'>}</span>
    <span class='k'>return</span> <span class='k'>this</span>
  <span class='b'>}</span>

  <span class='k'>override</span> This writeBuf<span class='b'>(</span>Buf b, Int n := b.remaining<span class='b'>)</span>
  <span class='b'>{</span>
    frameId := <span class='k'>this</span>.frameId
    str := Buf<span class='b'>()</span>.writeBuf<span class='b'>(</span>b, n<span class='b'>)</span>.flip.readAllStr
    Desktop.callAsync |-&gt;| <span class='b'>{</span> Console.execWrite<span class='b'>(</span>frameId, str<span class='b'>)</span> <span class='b'>}</span>
    <span class='k'>return</span> <span class='k'>this</span>
  <span class='b'>}</span>

  Str frameId
<span class='b'>}</span>

<span class='z'>**************************************************************************</span>
<span class='z'>** ExecParams</span>
<span class='z'>**************************************************************************</span>

<span class='k'>internal</span> <span class='k'>const</span> <span class='k'>class</span> ExecParams
<span class='b'>{</span>
  <span class='k'>new</span> make<span class='b'>(</span>|This| f<span class='b'>)</span> <span class='b'>{</span> f<span class='b'>(</span><span class='k'>this</span><span class='b'>)</span> <span class='b'>}</span>
  <span class='k'>const</span> Str frameId := <span class='s'>""</span>
  <span class='k'>const</span> Str<span class='b'>[]</span> command := Str#.emptyList
  <span class='k'>const</span> File? dir
<span class='b'>}</span></pre>
</div>
</div>
<div class='sidebar'>
<h2>More Info</h2>
<ul class='clean'>
  <li><a href='Console.html'>View Fandoc</a></li>
</ul>
<div class='slots'>
<div class='overview'>
<h2>Slots</h2>
<ul class='clean'>
  <li style='display: block;'><a href='#append'>append</a></li>
  <li style='display: block;'><a href='#busy'>busy</a></li>
  <li style='display: block;'><a href='#clear'>clear</a></li>
  <li class='hidden' style='display: block;'><a href='#copyCmd'>copyCmd</a></li>
  <li class='hidden' style='display: block;'><a href='#doRun'>doRun</a></li>
  <li style='display: block;'><a href='#exec'>exec</a></li>
  <li class='hidden' style='display: block;'><a href='#execDone'>execDone</a></li>
  <li class='hidden' style='display: block;'><a href='#execRun'>execRun</a></li>
  <li class='hidden' style='display: block;'><a href='#execWrite'>execWrite</a></li>
  <li class='hidden' style='display: block;'><a href='#hideCmd'>hideCmd</a></li>
  <li class='hidden' style='display: block;'><a href='#model'>model</a></li>
  <li class='hidden' style='display: block;'><a href='#onClose'>onClose</a></li>
  <li class='hidden' style='display: block;'><a href='#onCopy'>onCopy</a></li>
  <li style='display: block;'><a href='#onGotoMark'>onGotoMark</a></li>
  <li style='display: block;'><a href='#onLoad'>onLoad</a></li>
  <li class='hidden' style='display: block;'><a href='#onRichTextMouseDown'>onRichTextMouseDown</a></li>
  <li style='display: block;'><a href='#prefAlign'>prefAlign</a></li>
  <li class='hidden' style='display: block;'><a href='#richText'>richText</a></li>
  <li class='hidden' style='display: block;'><a href='#run'>run</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class='footer'>
<div>
<p>
flux 1.0.56
[11-Nov-2010 Thu 10:08:27AM EST]
</p>
</div>
</div>
</body>
</html>
