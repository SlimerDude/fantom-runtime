<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
  <title>fansh::Evaluator</title>
  <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
  <link rel='stylesheet' type='text/css' href='../doc.css'/>
  <script type='text/javascript' src='../doc.js'></script>
<!--[if lt IE 7]>
<script src='http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE7.js' type='text/javascript'></script>
<![endif]-->
</head>
<body onload='Login.check();'>
<div class='header'>
<div>
<h1><a href='/'>Fantom</a></h1>
<p id='sidewalkLogin_'>&nbsp;</p>
<form method='get' action='/sidewalk/search/'>
<p>
<input type='text' name='q' size='30' value='Search...' onfocus='if (value=="Search...") value=""' onblur='if (value=="") value="Search..."' />
</p>
</form>
<ul>
<li><a href='/'>Home</a></li>
<li class='active'><a href='../index.html'>Docs</a></li>
<li><a href='/sidewalk/blog/'>Blog</a></li>
<li><a href='/sidewalk/ticket/'>Tickets</a></li>
<li><a href='/sidewalk/topic/'>Discuss</a></li>
</ul></div>
</div>
<div class='subHeader'>
<div>
<ul>
  <li><a href='../index.html'>Doc Home</a></li>
  <li>&gt;</li>
  <li><a href='index.html'>fansh</a></li>
  <li>&gt;</li>
  <li><a href='Evaluator.html'>Evaluator</a></li>
</ul>
</div>
</div>
<div class='content'>
<div>
<div class='fandoc'>
<div class='type'>
<div class='overview'>
<h2>class</h2>
<h1>fansh::Evaluator</h1>
<pre><a href='../sys/Obj.html'>sys::Obj</a>
  fansh::Evaluator</pre>
</div>
</div>
<div class='src'>
<pre>
<span class='y'>//</span>
<span class='y'>// Copyright (c) 2008, Brian Frank and Andy Frank</span>
<span class='y'>// Licensed under the Academic Free License version 3.0</span>
<span class='y'>//</span>
<span class='y'>// History:</span>
<span class='y'>//   1 Jan 08  Brian Frank  Creation</span>
<span class='y'>//</span>

<span class='k'>using</span> compiler

<span class='z'>**</span>
<span class='z'>** Evaluator is responsible for compiling and</span>
<span class='z'>** evaluating a statement or expression.</span>
<span class='z'>**</span>
<span class='k'>class</span> Evaluator
<span class='b'>{</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Constructor</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>new</span> <span id='make'>make</span><span class='b'>(</span>Shell? shell<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>if</span> <span class='b'>(</span>shell != <span class='k'>null</span><span class='b'>)</span>
    <span class='b'>{</span>
      <span class='k'>this</span>.shell = shell
      <span class='k'>this</span>.out = shell.out
    <span class='b'>}</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Eval</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  Void <span id='eval'>eval</span><span class='b'>(</span>Str line<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='y'>// generate source for class which maps</span>
    <span class='y'>// local variables to scope map</span>
    s := StrBuf<span class='b'>()</span>
    shell.usings.each |u| <span class='b'>{</span> s.add<span class='b'>(</span>u<span class='b'>)</span>.add<span class='b'>(</span><span class='s'>"\n"</span><span class='b'>)</span> <span class='b'>}</span>

    s.add<span class='b'>(</span><span class='s'>"class FanshEval {\n"</span><span class='b'>)</span>
    s.add<span class='b'>(</span><span class='s'>"new make(Str:Obj s) { _scope = s }\n"</span><span class='b'>)</span>
    s.add<span class='b'>(</span><span class='s'>"Str:Obj? _scope\n"</span><span class='b'>)</span>
    s.add<span class='b'>(</span><span class='s'>"Obj? _eval() {\n"</span><span class='b'>)</span>
    scopeMap := Str:Obj?<span class='b'>[</span>:<span class='b'>]</span>
    <span class='k'>if</span> <span class='b'>(</span>shell != <span class='k'>null</span><span class='b'>)</span>
    <span class='b'>{</span>
      shell.scope.each |Var v|
      <span class='b'>{</span>
        sig := v.of.toNullable.signature
        s.add<span class='b'>(</span><span class='s'>"  $v.name := ($sig)_scope[\"$v.name\"];\n"</span><span class='b'>)</span>
        scopeMap<span class='b'>[</span>v.name<span class='b'>]</span> = v.val
      <span class='b'>}</span>
    <span class='b'>}</span>
    srcPrefix := s.toStr

    <span class='y'>// if line has a local variable definition, then we</span>
    <span class='y'>// want to capture it as part of the continuing scope</span>
    ctrl := isCtrl<span class='b'>(</span>line<span class='b'>)</span>
    Var? local := <span class='k'>null</span>
    <span class='k'>if</span> <span class='b'>(</span>line.contains<span class='b'>(</span><span class='s'>":="</span><span class='b'>)</span> &amp;&amp; !ctrl<span class='b'>)</span>
    <span class='b'>{</span>
      local = Var.make
      local.name = line<span class='b'>[</span>0..line.index<span class='b'>(</span><span class='s'>":="</span><span class='b'>)</span>-1<span class='b'>]</span>.trim.split.last
      compile<span class='b'>(</span>srcPrefix + <span class='s'>"$line; return $local.name } }"</span><span class='b'>)</span>
      <span class='k'>if</span> <span class='b'>(</span>pod != <span class='k'>null</span><span class='b'>)</span>
        local.of = localDefType<span class='b'>()</span>
    <span class='b'>}</span>

    <span class='y'>// if line has a local variable assignment, then we</span>
    <span class='y'>// want to capture it as part of the continuing scope</span>
    <span class='k'>else</span> <span class='k'>if</span> <span class='b'>(</span>line.contains<span class='b'>(</span><span class='s'>"="</span><span class='b'>)</span> &amp;&amp; !ctrl<span class='b'>)</span>
    <span class='b'>{</span>
      eq := line.index<span class='b'>(</span><span class='s'>"="</span><span class='b'>)</span>
      name := line<span class='b'>[</span>0..eq-1<span class='b'>]</span>.trim
      expr := line<span class='b'>[</span>eq+1..-1<span class='b'>]</span>.trim
      <span class='k'>if</span> <span class='b'>(</span>!expr.startsWith<span class='b'>(</span><span class='s'>"="</span><span class='b'>))</span>
      <span class='b'>{</span>
        local = shell.findInScope<span class='b'>(</span>name<span class='b'>)</span>
        <span class='k'>if</span> <span class='b'>(</span>local != <span class='k'>null</span><span class='b'>)</span>
          compile<span class='b'>(</span>srcPrefix + <span class='s'>"$expr; } }"</span><span class='b'>)</span>
      <span class='b'>}</span>
    <span class='b'>}</span>

    <span class='y'>// assuming we didn't have anything fishy regarding local variables,</span>
    <span class='y'>// then first try - this will fail if line is a Void expression</span>
    <span class='k'>if</span> <span class='b'>(</span>pod == <span class='k'>null</span><span class='b'>)</span>
      compile<span class='b'>(</span>srcPrefix + <span class='s'>"return $line } }"</span><span class='b'>)</span>

    <span class='y'>// if that failed, try again assuming line is a void expression</span>
    <span class='k'>if</span> <span class='b'>(</span>pod == <span class='k'>null</span><span class='b'>)</span>
      compile<span class='b'>(</span>srcPrefix + <span class='s'>"$line; return \"__void__\"; } }"</span><span class='b'>)</span>

    <span class='y'>// if no shell, this is a warmup</span>
    <span class='k'>if</span> <span class='b'>(</span>shell == <span class='k'>null</span><span class='b'>)</span> <span class='k'>return</span>

    <span class='y'>// if we still don't have a compile, report errors and bail</span>
    <span class='k'>if</span> <span class='b'>(</span>pod == <span class='k'>null</span><span class='b'>)</span>
    <span class='b'>{</span>
      reportCompilerErrs
      <span class='k'>return</span>
    <span class='b'>}</span>

    <span class='y'>// evaluate by calling eval</span>
    t := pod.types.first
    method := t.method<span class='b'>(</span><span class='s'>"_eval"</span><span class='b'>)</span>
    Obj? result := <span class='k'>null</span>
    <span class='k'>try</span>
    <span class='b'>{</span>
      instance := t.make<span class='b'>([</span>scopeMap<span class='b'>])</span>
      result = method.callOn<span class='b'>(</span>instance, <span class='b'>[</span>,<span class='b'>])</span>
    <span class='b'>}</span>
    <span class='k'>catch</span> <span class='b'>(</span>Err e<span class='b'>)</span>
    <span class='b'>{</span>
      reportEvalErr<span class='b'>(</span>e<span class='b'>)</span>
      <span class='k'>return</span>
    <span class='b'>}</span>

    <span class='y'>// print result</span>
    <span class='k'>if</span> <span class='b'>(</span>result != <span class='s'>"__void__"</span><span class='b'>)</span>
      out.printLine<span class='b'>(</span>result<span class='b'>)</span>

    <span class='y'>// if we had a local def add (or replace) it to our scope</span>
    <span class='k'>if</span> <span class='b'>(</span>local != <span class='k'>null</span><span class='b'>)</span>
    <span class='b'>{</span>
      local.val = result
      shell.scope<span class='b'>[</span>local.name<span class='b'>]</span> = local
    <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='k'>private</span> Void <span id='compile'>compile</span><span class='b'>(</span>Str source<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='y'>// setup compiler input</span>
    ci := CompilerInput
    <span class='b'>{</span>
      podName     = shell == <span class='k'>null</span> ? <span class='s'>"shWarmup"</span> : <span class='s'>"sh${shell.evalCount++}"</span>
      summary     = <span class='s'>"eval"</span>
      isScript    = <span class='k'>true</span>
      version     = Version.defVal
      log.level   = LogLevel.silent
      output      = CompilerOutputMode.transientPod
      mode        = CompilerInputMode.str
      srcStr      = source
      srcStrLoc   = Loc<span class='b'>(</span><span class='s'>"fansh"</span><span class='b'>)</span>
    <span class='b'>}</span>

    <span class='y'>// create fresh compiler</span>
    <span class='k'>this</span>.compiler = Compiler<span class='b'>(</span>ci<span class='b'>)</span>

    <span class='y'>// try to compile</span>
    <span class='k'>try</span>
    <span class='b'>{</span>
      <span class='k'>this</span>.pod = compiler.compile.transientPod
    <span class='b'>}</span>
    <span class='k'>catch</span> <span class='b'>(</span>CompilerErr e<span class='b'>)</span>
    <span class='b'>{</span>
      <span class='k'>this</span>.pod = <span class='k'>null</span>
    <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='k'>private</span> Bool <span id='isCtrl'>isCtrl</span><span class='b'>(</span>Str line<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>try</span>
    <span class='b'>{</span>
      <span class='k'>return</span> <span class='b'>(</span>line.startsWith<span class='b'>(</span><span class='s'>"for"</span><span class='b'>)</span>    &amp;&amp; !line<span class='b'>[</span>4<span class='b'>]</span>.isAlpha<span class='b'>)</span> ||
             <span class='b'>(</span>line.startsWith<span class='b'>(</span><span class='s'>"if"</span><span class='b'>)</span>     &amp;&amp; !line<span class='b'>[</span>3<span class='b'>]</span>.isAlpha<span class='b'>)</span> ||
             <span class='b'>(</span>line.startsWith<span class='b'>(</span><span class='s'>"while"</span><span class='b'>)</span>  &amp;&amp; !line<span class='b'>[</span>5<span class='b'>]</span>.isAlpha<span class='b'>)</span> ||
             <span class='b'>(</span>line.startsWith<span class='b'>(</span><span class='s'>"switch"</span><span class='b'>)</span> &amp;&amp; !line<span class='b'>[</span>6<span class='b'>]</span>.isAlpha<span class='b'>)</span> ||
             <span class='b'>(</span>line.startsWith<span class='b'>(</span><span class='s'>"try"</span><span class='b'>)</span>    &amp;&amp; !line<span class='b'>[</span>4<span class='b'>]</span>.isAlpha<span class='b'>)</span>
    <span class='b'>}</span>
    <span class='k'>catch</span> <span class='k'>return</span> <span class='k'>false</span>
  <span class='b'>}</span>

  <span class='k'>private</span> Type? <span id='localDefType'>localDefType</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='k'>if</span> <span class='b'>(</span>pod == <span class='k'>null</span><span class='b'>)</span> <span class='k'>return</span> <span class='k'>null</span>
    stmt := <span class='b'>(</span>LocalDefStmt<span class='b'>)</span>compiler.pod.typeDefs<span class='b'>[</span><span class='s'>"FanshEval"</span><span class='b'>]</span>.methodDef<span class='b'>(</span><span class='s'>"_eval"</span><span class='b'>)</span>.code.stmts<span class='b'>[</span>-2<span class='b'>]</span>
    <span class='k'>return</span> Type.find<span class='b'>(</span>stmt.ctype.signature<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='k'>private</span> Void <span id='reportCompilerErrs'>reportCompilerErrs</span><span class='b'>()</span>
  <span class='b'>{</span>
    compiler.errs.each |CompilerErr e|
    <span class='b'>{</span>
      out.printLine<span class='b'>(</span><span class='s'>"ERROR($e.col): $e.msg"</span><span class='b'>)</span>
    <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='k'>private</span> Void <span id='reportEvalErr'>reportEvalErr</span><span class='b'>(</span>Err e<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='y'>// trace to buffer</span>
    buf := Buf.make
    e.trace<span class='b'>(</span>buf.out<span class='b'>)</span>
    lines := buf.flip.readAllLines

    <span class='y'>// only output until we reach the FanshEval</span>
    br := lines.find |Str line-&gt;Bool| <span class='b'>{</span> <span class='k'>return</span> line.contains<span class='b'>(</span><span class='s'>"FanshEval"</span><span class='b'>)</span> <span class='b'>}</span>
    <span class='k'>if</span> <span class='b'>(</span>br != <span class='k'>null</span><span class='b'>)</span> lines = lines<span class='b'>[</span>0..lines.index<span class='b'>(</span>br<span class='b'>)</span>-1<span class='b'>]</span>
    lines.each |Str line| <span class='b'>{</span> out.printLine<span class='b'>(</span>line<span class='b'>)</span> <span class='b'>}</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Fields</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>private</span> Shell? <span id='shell'>shell</span>
  <span class='k'>private</span> OutStream? <span id='out'>out</span>
  <span class='k'>private</span> Compiler? <span id='compiler'>compiler</span>
  <span class='k'>private</span> Pod? <span id='pod'>pod</span>

<span class='b'>}</span></pre>
</div>
</div>
<div class='sidebar'>
<h2>More Info</h2>
<ul class='clean'>
  <li><a href='Evaluator.html'>View Fandoc</a></li>
</ul>
<div class='slots'>
<div class='overview'>
<h2>Slots</h2>
<ul class='clean'>
  <li class='hidden' style='display: block;'><a href='#compile'>compile</a></li>
  <li class='hidden' style='display: block;'><a href='#compiler'>compiler</a></li>
  <li style='display: block;'><a href='#eval'>eval</a></li>
  <li class='hidden' style='display: block;'><a href='#isCtrl'>isCtrl</a></li>
  <li class='hidden' style='display: block;'><a href='#localDefType'>localDefType</a></li>
  <li style='display: block;'><a href='#make'>make</a></li>
  <li class='hidden' style='display: block;'><a href='#out'>out</a></li>
  <li class='hidden' style='display: block;'><a href='#pod'>pod</a></li>
  <li class='hidden' style='display: block;'><a href='#reportCompilerErrs'>reportCompilerErrs</a></li>
  <li class='hidden' style='display: block;'><a href='#reportEvalErr'>reportEvalErr</a></li>
  <li class='hidden' style='display: block;'><a href='#shell'>shell</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class='footer'>
<div>
<p>
fansh 1.0.56
[11-Nov-2010 Thu 10:08:20AM EST]
</p>
</div>
</div>
</body>
</html>
