<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
  <title>web::Cookie</title>
  <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
  <link rel='stylesheet' type='text/css' href='../doc.css'/>
  <script type='text/javascript' src='../doc.js'></script>
<!--[if lt IE 7]>
<script src='http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE7.js' type='text/javascript'></script>
<![endif]-->
</head>
<body onload='Login.check();'>
<div class='header'>
<div>
<h1><a href='/'>Fantom</a></h1>
<p id='sidewalkLogin_'>&nbsp;</p>
<form method='get' action='/sidewalk/search/'>
<p>
<input type='text' name='q' size='30' value='Search...' onfocus='if (value=="Search...") value=""' onblur='if (value=="") value="Search..."' />
</p>
</form>
<ul>
<li><a href='/'>Home</a></li>
<li class='active'><a href='../index.html'>Docs</a></li>
<li><a href='/sidewalk/blog/'>Blog</a></li>
<li><a href='/sidewalk/ticket/'>Tickets</a></li>
<li><a href='/sidewalk/topic/'>Discuss</a></li>
</ul></div>
</div>
<div class='subHeader'>
<div>
<ul>
  <li><a href='../index.html'>Doc Home</a></li>
  <li>&gt;</li>
  <li><a href='index.html'>web</a></li>
  <li>&gt;</li>
  <li><a href='Cookie.html'>Cookie</a></li>
</ul>
</div>
</div>
<div class='content'>
<div>
<div class='fandoc'>
<div class='type'>
<div class='overview'>
<h2>const class</h2>
<h1>web::Cookie</h1>
<pre><a href='../sys/Obj.html'>sys::Obj</a>
  web::Cookie</pre>
</div>
</div>
<div class='src'>
<pre>
<span class='y'>//</span>
<span class='y'>// Copyright (c) 2008, Brian Frank and Andy Frank</span>
<span class='y'>// Licensed under the Academic Free License version 3.0</span>
<span class='y'>//</span>
<span class='y'>// History:</span>
<span class='y'>//   17 Mar 08  Brian Frank  Creation</span>
<span class='y'>//</span>

<span class='z'>**</span>
<span class='z'>** Cookie models an HTTP cookie used to pass data between the server</span>
<span class='z'>** and brower as defined by the original Netscape cookie specification</span>
<span class='z'>** and RFC 2109.  Note the newer RFC 2965 is unsupported by most browsers,</span>
<span class='z'>** and even 2109 isn't really supported by some of the major browsers.</span>
<span class='z'>** See `WebReq.cookies` and `WebRes.cookies`.</span>
<span class='z'>**</span>
@Js
<span class='k'>const</span> <span class='k'>class</span> Cookie
<span class='b'>{</span>

  <span class='z'>**</span>
  <span class='z'>** Parse a HTTP cookie header name/value pair.</span>
  <span class='z'>** Throw ParseErr if not formatted correctly.</span>
  <span class='z'>**</span>
  <span class='k'>static</span> Cookie <span id='fromStr'>fromStr</span><span class='b'>(</span>Str s<span class='b'>)</span>
  <span class='b'>{</span>
    eq := s.index<span class='b'>(</span><span class='s'>"="</span><span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>eq == <span class='k'>null</span><span class='b'>)</span> <span class='k'>throw</span> ParseErr<span class='b'>(</span>s<span class='b'>)</span>
    name := s<span class='b'>[</span>0..&lt;eq<span class='b'>]</span>.trim
    val := s<span class='b'>[</span>eq+1..-1<span class='b'>]</span>.trim
    <span class='k'>if</span> <span class='b'>(</span>val.size &gt;= 2 &amp;&amp; val<span class='b'>[</span>0<span class='b'>]</span> == <span class='s'>'"'</span> &amp;&amp; val<span class='b'>[</span>-1<span class='b'>]</span> == <span class='s'>'"'</span><span class='b'>)</span>
      val = WebUtil.fromQuotedStr<span class='b'>(</span>val<span class='b'>)</span>
    <span class='k'>return</span> make<span class='b'>(</span>name, val<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Construct with name and value.  The name must be a valid</span>
  <span class='z'>** HTTP token and must not start with "$" (see `WebUtil.isToken`).</span>
  <span class='z'>** The value string must be an ASCII string within the inclusive</span>
  <span class='z'>** range of 0x20 and 0x7e (see `WebUtil.toQuotedStr`) with the</span>
  <span class='z'>** exception of the semicolon.</span>
  <span class='z'>**</span>
  <span class='z'>** Fantom cookies will use quoted string values, however some browsers</span>
  <span class='z'>** such as IE won't parse a quoted string with semicolons correctly,</span>
  <span class='z'>** so we make semicolons illegal.  If you have a value which might</span>
  <span class='z'>** include non-ASCII characters or semicolons, then consider encoding</span>
  <span class='z'>** using something like Base64:</span>
  <span class='z'>**</span>
  <span class='z'>**   // write response</span>
  <span class='z'>**   res.cookies.add(Cookie("baz", val.toBuf.toBase64))</span>
  <span class='z'>**</span>
  <span class='z'>**   // read from request</span>
  <span class='z'>**   val := Buf.fromBase64(req.cookies.get("baz", "")).readAllStr</span>
  <span class='z'>**</span>
  <span class='k'>new</span> <span id='make'>make</span><span class='b'>(</span>Str name, Str val, |This|? f := <span class='k'>null</span><span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>if</span> <span class='b'>(</span>f != <span class='k'>null</span><span class='b'>)</span> f<span class='b'>(</span><span class='k'>this</span><span class='b'>)</span>
    <span class='k'>this</span>.name = name
    <span class='k'>this</span>.val = val

    <span class='y'>// validate name</span>
    <span class='k'>if</span> <span class='b'>(</span>!WebUtil.isToken<span class='b'>(</span><span class='k'>this</span>.name<span class='b'>)</span> || <span class='k'>this</span>.name<span class='b'>[</span>0<span class='b'>]</span> == <span class='s'>'$'</span><span class='b'>)</span>
      <span class='k'>throw</span> ArgErr<span class='b'>(</span><span class='s'>"Cookie name has illegal chars: $val"</span><span class='b'>)</span>

    <span class='y'>// validate value</span>
    <span class='k'>if</span> <span class='b'>(</span>!<span class='k'>this</span>.val.all |Int c-&gt;Bool| <span class='b'>{</span> <span class='k'>return</span> 0x20 &lt;= c &amp;&amp; c &lt;= 0x7e &amp;&amp; c != <span class='s'>';'</span><span class='b'>})</span>
      <span class='k'>throw</span> ArgErr<span class='b'>(</span><span class='s'>"Cookie value has illegal chars: $val"</span><span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span><span class='k'>this</span>.val.size + 32 &gt;= WebUtil.maxTokenSize<span class='b'>)</span> <span class='y'>// fudge room for quotes &amp; escapes</span>
      <span class='k'>throw</span> ArgErr<span class='b'>(</span><span class='s'>"Cookie value too big"</span><span class='b'>)</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Name of the cookie.</span>
  <span class='z'>**</span>
  <span class='k'>const</span> Str <span id='name'>name</span>

  <span class='z'>**</span>
  <span class='z'>** Value string of the cookie.</span>
  <span class='z'>**</span>
  <span class='k'>const</span> Str <span id='val'>val</span>

  <span class='z'>**</span>
  <span class='z'>** Defines the lifetime of the cookie, after the the max-age</span>
  <span class='z'>** elapses the client should discard the cookie.  The duration</span>
  <span class='z'>** is floored to seconds (fractional seconds are truncated).</span>
  <span class='z'>** If maxAge is null (the default) then the  cookie persists</span>
  <span class='z'>** until the client is shutdown.  If zero is specified, the</span>
  <span class='z'>** cookie is discarded immediately.  Note that many browsers</span>
  <span class='z'>** still don't recognize max-age, so setting max-age also</span>
  <span class='z'>** always includes an expires attribute.</span>
  <span class='z'>**</span>
  <span class='k'>const</span> Duration? <span id='maxAge'>maxAge</span>

  <span class='z'>**</span>
  <span class='z'>** Specifies the domain for which the cookie is valid.</span>
  <span class='z'>** An explicit domain must always start with a dot.  If</span>
  <span class='z'>** null (the default) then the cookie only applies to</span>
  <span class='z'>** the server which set it.</span>
  <span class='z'>**</span>
  <span class='k'>const</span> Str? <span id='domain'>domain</span>

  <span class='z'>**</span>
  <span class='z'>** Specifies the subset of URLs to which the cookie applies.</span>
  <span class='z'>** If set to "/" (the default), then the cookie applies to all</span>
  <span class='z'>** paths.  If the path is null, it as assumed to be the same</span>
  <span class='z'>** path as the document being described by the header which</span>
  <span class='z'>** contains the cookie.</span>
  <span class='z'>**</span>
  <span class='k'>const</span> Str? <span id='path'>path</span> := <span class='s'>"/"</span>

  <span class='z'>**</span>
  <span class='z'>** If true, then the client only sends this cookie using a</span>
  <span class='z'>** secure protocol such as HTTPS.  Defaults to false.</span>
  <span class='z'>**</span>
  <span class='k'>const</span> Bool <span id='secure'>secure</span> := <span class='k'>false</span>

  <span class='z'>**</span>
  <span class='z'>** Return the cookie formatted as an HTTP header.</span>
  <span class='z'>**</span>
  <span class='k'>override</span> Str <span id='toStr'>toStr</span><span class='b'>()</span>
  <span class='b'>{</span>
    s := StrBuf<span class='b'>(</span>64<span class='b'>)</span>
    s.add<span class='b'>(</span>name<span class='b'>)</span>.add<span class='b'>(</span><span class='s'>"="</span><span class='b'>)</span>.add<span class='b'>(</span>WebUtil.toQuotedStr<span class='b'>(</span>val<span class='b'>))</span>
    <span class='k'>if</span> <span class='b'>(</span>maxAge != <span class='k'>null</span><span class='b'>)</span>
    <span class='b'>{</span>
      <span class='y'>// we need to use Max-Age *and* Expires since many browsers</span>
      <span class='y'>// such as Safari and IE still don't recognize max-age</span>
      s.add<span class='b'>(</span><span class='s'>";Max-Age="</span><span class='b'>)</span>.add<span class='b'>(</span>maxAge.toSec<span class='b'>)</span>
      <span class='k'>if</span> <span class='b'>(</span>maxAge.ticks &lt;= 0<span class='b'>)</span>
        s.add<span class='b'>(</span><span class='s'>";Expires="</span><span class='b'>)</span>.add<span class='b'>(</span><span class='s'>"Sat, 01 Jan 2000 00:00:00 GMT"</span><span class='b'>)</span>
      <span class='k'>else</span>
        s.add<span class='b'>(</span><span class='s'>";Expires="</span><span class='b'>)</span>.add<span class='b'>((</span>DateTime.nowUtc+maxAge<span class='b'>)</span>.toHttpStr<span class='b'>)</span>
    <span class='b'>}</span>
    <span class='k'>if</span> <span class='b'>(</span>domain != <span class='k'>null</span><span class='b'>)</span> s.add<span class='b'>(</span><span class='s'>";Domain="</span><span class='b'>)</span>.add<span class='b'>(</span>domain<span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>path != <span class='k'>null</span><span class='b'>)</span> s.add<span class='b'>(</span><span class='s'>";Path="</span><span class='b'>)</span>.add<span class='b'>(</span>path<span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>secure<span class='b'>)</span> s.add<span class='b'>(</span><span class='s'>";Secure"</span><span class='b'>)</span>
    <span class='k'>return</span> s.toStr
  <span class='b'>}</span>

<span class='b'>}</span></pre>
</div>
</div>
<div class='sidebar'>
<h2>More Info</h2>
<ul class='clean'>
  <li><a href='Cookie.html'>View Fandoc</a></li>
</ul>
<div class='slots'>
<div class='overview'>
<h2>Slots</h2>
<ul class='clean'>
  <li style='display: block;'><a href='#domain'>domain</a></li>
  <li style='display: block;'><a href='#fromStr'>fromStr</a></li>
  <li style='display: block;'><a href='#make'>make</a></li>
  <li style='display: block;'><a href='#maxAge'>maxAge</a></li>
  <li style='display: block;'><a href='#name'>name</a></li>
  <li style='display: block;'><a href='#path'>path</a></li>
  <li style='display: block;'><a href='#secure'>secure</a></li>
  <li style='display: block;'><a href='#toStr'>toStr</a></li>
  <li style='display: block;'><a href='#val'>val</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class='footer'>
<div>
<p>
web 1.0.56
[11-Nov-2010 Thu 10:08:21AM EST]
</p>
</div>
</div>
</body>
</html>
