<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
  <title>compilerJava::ClassPath</title>
  <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
  <link rel='stylesheet' type='text/css' href='../doc.css'/>
  <script type='text/javascript' src='../doc.js'></script>
<!--[if lt IE 7]>
<script src='http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE7.js' type='text/javascript'></script>
<![endif]-->
</head>
<body onload='Login.check();'>
<div class='header'>
<div>
<h1><a href='/'>Fantom</a></h1>
<p id='sidewalkLogin_'>&nbsp;</p>
<form method='get' action='/sidewalk/search/'>
<p>
<input type='text' name='q' size='30' value='Search...' onfocus='if (value=="Search...") value=""' onblur='if (value=="") value="Search..."' />
</p>
</form>
<ul>
<li><a href='/'>Home</a></li>
<li class='active'><a href='../index.html'>Docs</a></li>
<li><a href='/sidewalk/blog/'>Blog</a></li>
<li><a href='/sidewalk/ticket/'>Tickets</a></li>
<li><a href='/sidewalk/topic/'>Discuss</a></li>
</ul></div>
</div>
<div class='subHeader'>
<div>
<ul>
  <li><a href='../index.html'>Doc Home</a></li>
  <li>&gt;</li>
  <li><a href='index.html'>compilerJava</a></li>
  <li>&gt;</li>
  <li><a href='ClassPath.html'>ClassPath</a></li>
</ul>
</div>
</div>
<div class='content'>
<div>
<div class='fandoc'>
<div class='type'>
<div class='overview'>
<h2>class</h2>
<h1>compilerJava::ClassPath</h1>
<pre><a href='../sys/Obj.html'>sys::Obj</a>
  compilerJava::ClassPath</pre>
</div>
</div>
<div class='src'>
<pre>
<span class='y'>//</span>
<span class='y'>// Copyright (c) 2008, Brian Frank and Andy Frank</span>
<span class='y'>// Licensed under the Academic Free License version 3.0</span>
<span class='y'>//</span>
<span class='y'>// History:</span>
<span class='y'>//    15 Nov 08  Brian Frank  Creation</span>
<span class='y'>//</span>

<span class='z'>**</span>
<span class='z'>** ClassPath models a Java classpath to resolve package</span>
<span class='z'>** names to types.  Since the standard Java APIs don't expose</span>
<span class='z'>** this, we have go thru a lot of pain.</span>
<span class='z'>**</span>
<span class='k'>class</span> ClassPath
<span class='b'>{</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Construction</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Attempt to derive the current classpath by looking at</span>
  <span class='z'>** system properties.</span>
  <span class='z'>**</span>
  <span class='k'>static</span> ClassPath <span id='makeForCurrent'>makeForCurrent</span><span class='b'>()</span>
  <span class='b'>{</span>
    entries := File<span class='b'>[</span>,<span class='b'>]</span>

    <span class='y'>// System.property "sun.boot.class.path"; this is preferable</span>
    <span class='y'>// to trying to figure out rt.jar - on platforms like Mac OS X</span>
    <span class='y'>// the classes are in very non-standard locations</span>
    Env.cur.vars.get<span class='b'>(</span><span class='s'>"sun.boot.class.path"</span>, <span class='s'>""</span><span class='b'>)</span>.split<span class='b'>(</span>File.pathSep<span class='b'>[</span>0<span class='b'>])</span>.each |Str path|
    <span class='b'>{</span>
      f := File.os<span class='b'>(</span>path<span class='b'>)</span>
      <span class='y'>// skip big jar files we can probably safely ignore</span>
      <span class='k'>if</span> <span class='b'>(</span>!f.isDir &amp;&amp; f.ext != <span class='s'>"jar"</span><span class='b'>)</span> <span class='k'>return</span>
      <span class='k'>if</span> <span class='b'>(</span>f.name == <span class='s'>"deploy.jar"</span><span class='b'>)</span> <span class='k'>return</span>
      <span class='k'>if</span> <span class='b'>(</span>f.name == <span class='s'>"charsets.jar"</span><span class='b'>)</span> <span class='k'>return</span>
      <span class='k'>if</span> <span class='b'>(</span>f.name == <span class='s'>"javaws.jar"</span><span class='b'>)</span> <span class='k'>return</span>
      entries.add<span class='b'>(</span>f<span class='b'>)</span>
    <span class='b'>}</span>

    <span class='y'>// {java}lib/rt.jar (only if sun.boot.class.path failed)</span>
    lib := File.os<span class='b'>(</span>Env.cur.vars.get<span class='b'>(</span><span class='s'>"java.home"</span>, <span class='s'>""</span><span class='b'>)</span> + File.sep + <span class='s'>"lib"</span><span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>entries.isEmpty<span class='b'>)</span>
    <span class='b'>{</span>
      rt := lib + <span class='u'>`rt.jar`</span>
      <span class='k'>if</span> <span class='b'>(</span>rt.exists<span class='b'>)</span> entries.add<span class='b'>(</span>rt<span class='b'>)</span>
    <span class='b'>}</span>

    <span class='y'>// {java}lib/ext</span>
    <span class='y'>// {fan}lib/java/ext</span>
    <span class='y'>// {fan}lib/java/ext/{plat}</span>
    addJars<span class='b'>(</span>entries, lib + <span class='u'>`ext/`</span><span class='b'>)</span>
    addJars<span class='b'>(</span>entries, Env.cur.homeDir + <span class='u'>`lib/java/ext/`</span><span class='b'>)</span>
    addJars<span class='b'>(</span>entries, Env.cur.homeDir + <span class='u'>`lib/java/ext/${Env.cur.platform}/`</span><span class='b'>)</span>

    <span class='y'>// -classpath</span>
    Env.cur.vars.get<span class='b'>(</span><span class='s'>"java.class.path"</span>, <span class='s'>""</span><span class='b'>)</span>.split<span class='b'>(</span>File.pathSep<span class='b'>[</span>0<span class='b'>])</span>.each |Str path|
    <span class='b'>{</span>
      f := File.os<span class='b'>(</span>path<span class='b'>)</span>
      <span class='k'>if</span> <span class='b'>(</span>f.exists<span class='b'>)</span> entries.add<span class='b'>(</span>f<span class='b'>)</span>
    <span class='b'>}</span>

    <span class='k'>return</span> make<span class='b'>(</span>entries<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='k'>private</span> <span class='k'>static</span> Void <span id='addJars'>addJars</span><span class='b'>(</span>File<span class='b'>[]</span> entries, File dir<span class='b'>)</span>
  <span class='b'>{</span>
    dir.list.each |f| <span class='b'>{</span> <span class='k'>if</span> <span class='b'>(</span>f.ext == <span class='s'>"jar"</span><span class='b'>)</span> entries.add<span class='b'>(</span>f<span class='b'>)</span> <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Make for current set of jars.</span>
  <span class='z'>**</span>
  <span class='k'>new</span> <span id='make'>make</span><span class='b'>(</span>File<span class='b'>[]</span> entries<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>this</span>.entries = entries
    <span class='k'>this</span>.classes = loadClasses
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// State</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Class path entries to search</span>
  <span class='z'>**</span>
  <span class='k'>const</span> File<span class='b'>[]</span> <span id='entries'>entries</span>

  <span class='z'>**</span>
  <span class='z'>** List of classes keyed by package name in class path</span>
  <span class='z'>**</span>
  <span class='k'>const</span> Str:Str<span class='b'>[]</span> <span id='classes'>classes</span>

  <span class='z'>**</span>
  <span class='z'>** Return list of jar files.</span>
  <span class='z'>**</span>
  <span class='k'>override</span> Str <span id='toStr'>toStr</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='k'>return</span> entries.toStr
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Loading</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Load the map of package:class[] by walking every entry</span>
  <span class='z'>**</span>
  <span class='k'>protected</span> <span class='k'>virtual</span> Str:Str<span class='b'>[]</span> <span id='loadClasses'>loadClasses</span><span class='b'>()</span>
  <span class='b'>{</span>
    acc := Str:Str<span class='b'>[][</span>:<span class='b'>]</span>
    entries.each |File f|  <span class='b'>{</span> loadEntry<span class='b'>(</span>acc, f<span class='b'>)</span> <span class='b'>}</span>
    <span class='k'>return</span> acc
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Load the map of package:class[] by walking class path entry</span>
  <span class='z'>**</span>
  <span class='k'>private</span> Void <span id='loadEntry'>loadEntry</span><span class='b'>(</span>Str:Str<span class='b'>[]</span> acc, File f<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>if</span><span class='b'>(</span>f.isDir<span class='b'>)</span>
    <span class='b'>{</span>
      f.walk |File x| <span class='b'>{</span> accept<span class='b'>(</span>acc, x.uri.relTo<span class='b'>(</span>f.uri<span class='b'>))</span> <span class='b'>}</span>
    <span class='b'>}</span>
    <span class='k'>else</span>
    <span class='b'>{</span>
      Zip? zip := <span class='k'>null</span>
      <span class='k'>try</span>
      <span class='b'>{</span>
        zip = Zip.open<span class='b'>(</span>f<span class='b'>)</span>
        zip.contents.each |File x, Uri uri| <span class='b'>{</span> accept<span class='b'>(</span>acc, uri<span class='b'>)</span> <span class='b'>}</span>
      <span class='b'>}</span>
      <span class='k'>catch</span> <span class='b'>{}</span>
      <span class='k'>finally</span> <span class='b'>{</span> <span class='k'>if</span> <span class='b'>(</span>zip != <span class='k'>null</span><span class='b'>)</span> zip.close <span class='b'>}</span>
    <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='k'>private</span> Void <span id='accept'>accept</span><span class='b'>(</span>Str:Str<span class='b'>[]</span> acc, Uri uri<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>if</span> <span class='b'>(</span>uri.ext != <span class='s'>"class"</span><span class='b'>)</span> <span class='k'>return</span>
    package := uri.path<span class='b'>[</span>0..-2<span class='b'>]</span>.join<span class='b'>(</span><span class='s'>"."</span><span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>package.startsWith<span class='b'>(</span><span class='s'>"com.sun"</span><span class='b'>)</span> || package.startsWith<span class='b'>(</span><span class='s'>"sun"</span><span class='b'>))</span> <span class='k'>return</span>
    name := uri.basename
    <span class='k'>if</span> <span class='b'>(</span>name == <span class='s'>"Void"</span><span class='b'>)</span> <span class='k'>return</span>
    classes := acc<span class='b'>[</span>package<span class='b'>]</span>
    <span class='k'>if</span> <span class='b'>(</span>classes == <span class='k'>null</span><span class='b'>)</span> acc<span class='b'>[</span>package<span class='b'>]</span> = classes = Str<span class='b'>[</span>,<span class='b'>]</span>
    <span class='k'>if</span> <span class='b'>(</span>!classes.contains<span class='b'>(</span>name<span class='b'>))</span> classes.add<span class='b'>(</span>name<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='k'>static</span> Void <span id='main'>main</span><span class='b'>()</span>
  <span class='b'>{</span>
    t1 := Duration.now
    cp := makeForCurrent
    t2:= Duration.now
    echo<span class='b'>(</span><span class='s'>"ClassPath.makeForCurrent: ${(t2-t1).toMillis}ms"</span><span class='b'>)</span>

    echo<span class='b'>(</span><span class='s'>"Entries Found:"</span><span class='b'>)</span>
    cp.entries.each |File f| <span class='b'>{</span> echo<span class='b'>(</span><span class='s'>"  $f"</span><span class='b'>)</span> <span class='b'>}</span>

    echo<span class='b'>(</span><span class='s'>"Packages Found:"</span><span class='b'>)</span>
    cp.classes.keys.sort.each |Str p| <span class='b'>{</span> echo<span class='b'>(</span><span class='s'>"  $p ["</span> + cp.classes<span class='b'>[</span>p<span class='b'>]</span>.size + <span class='s'>"]"</span><span class='b'>)</span> <span class='b'>}</span>
  <span class='b'>}</span>

<span class='b'>}</span></pre>
</div>
</div>
<div class='sidebar'>
<h2>More Info</h2>
<ul class='clean'>
  <li><a href='ClassPath.html'>View Fandoc</a></li>
</ul>
<div class='slots'>
<div class='overview'>
<h2>Slots</h2>
<ul class='clean'>
  <li class='hidden' style='display: block;'><a href='#accept'>accept</a></li>
  <li class='hidden' style='display: block;'><a href='#addJars'>addJars</a></li>
  <li style='display: block;'><a href='#classes'>classes</a></li>
  <li style='display: block;'><a href='#entries'>entries</a></li>
  <li style='display: block;'><a href='#loadClasses'>loadClasses</a></li>
  <li class='hidden' style='display: block;'><a href='#loadEntry'>loadEntry</a></li>
  <li style='display: block;'><a href='#main'>main</a></li>
  <li style='display: block;'><a href='#make'>make</a></li>
  <li style='display: block;'><a href='#makeForCurrent'>makeForCurrent</a></li>
  <li style='display: block;'><a href='#toStr'>toStr</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class='footer'>
<div>
<p>
compilerJava 1.0.56
[11-Nov-2010 Thu 10:08:17AM EST]
</p>
</div>
</div>
</body>
</html>
