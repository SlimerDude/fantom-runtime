<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
  <title>obix::ObixMod</title>
  <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
  <link rel='stylesheet' type='text/css' href='../doc.css'/>
  <script type='text/javascript' src='../doc.js'></script>
<!--[if lt IE 7]>
<script src='http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE7.js' type='text/javascript'></script>
<![endif]-->
</head>
<body onload='Login.check();'>
<div class='header'>
<div>
<h1><a href='/'>Fantom</a></h1>
<p id='sidewalkLogin_'>&nbsp;</p>
<form method='get' action='/sidewalk/search/'>
<p>
<input type='text' name='q' size='30' value='Search...' onfocus='if (value=="Search...") value=""' onblur='if (value=="") value="Search..."' />
</p>
</form>
<ul>
<li><a href='/'>Home</a></li>
<li class='active'><a href='../index.html'>Docs</a></li>
<li><a href='/sidewalk/blog/'>Blog</a></li>
<li><a href='/sidewalk/ticket/'>Tickets</a></li>
<li><a href='/sidewalk/topic/'>Discuss</a></li>
</ul></div>
</div>
<div class='subHeader'>
<div>
<ul>
  <li><a href='../index.html'>Doc Home</a></li>
  <li>&gt;</li>
  <li><a href='index.html'>obix</a></li>
  <li>&gt;</li>
  <li><a href='ObixMod.html'>ObixMod</a></li>
</ul>
</div>
</div>
<div class='content'>
<div>
<div class='fandoc'>
<div class='type'>
<div class='overview'>
<h2>abstract const class</h2>
<h1>obix::ObixMod</h1>
<pre><a href='../sys/Obj.html'>sys::Obj</a>
  <a href='../web/WebMod.html'>web::WebMod</a>
    obix::ObixMod</pre>
</div>
</div>
<div class='src'>
<pre>
<span class='y'>//</span>
<span class='y'>// Copyright (c) 2010, SkyFoundry LLC</span>
<span class='y'>// All Rights Reserved</span>
<span class='y'>//</span>
<span class='y'>// History:</span>
<span class='y'>//   17 May 10  Brian Frank  Creation</span>
<span class='y'>//</span>

<span class='k'>using</span> web

<span class='z'>**</span>
<span class='z'>** ObixMod is an abstract base class that implements the</span>
<span class='z'>** standard plumbing for adding oBIX server side support.</span>
<span class='z'>** Standardized URIs handled by the base class:</span>
<span class='z'>**</span>
<span class='z'>**   {modBase}/xsl     debug style sheet</span>
<span class='z'>**   {modBase}/about   about object</span>
<span class='z'>**   {modBase}/batch   batch operation</span>
<span class='z'>**</span>
<span class='z'>** All other URIs to the mod are automatically handled</span>
<span class='z'>** by the following callbacks:</span>
<span class='z'>**  - GET: `onRead`</span>
<span class='z'>**  - PUT: `onWrite`</span>
<span class='z'>**  - POST: `onInvoke`</span>
<span class='z'>**</span>
<span class='k'>const</span> <span class='k'>abstract</span> <span class='k'>class</span> ObixMod : WebMod
<span class='b'>{</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Construction</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Construct with the given map for 'obix:About' parameters:</span>
  <span class='z'>**   - serverName: defaults to 'Env.cur.host'</span>
  <span class='z'>**   - vendorName: defaults to "Fantom"</span>
  <span class='z'>**   - vendorUrl: defaults to "http://fantom.org/"</span>
  <span class='z'>**   - productName: defaults to "Fantom"</span>
  <span class='z'>**   - productVersion: defaults to version of obix pod</span>
  <span class='z'>**   - productUrl: defaults to "http://fantom.org/"</span>
  <span class='z'>**</span>
  <span class='k'>new</span> <span id='make'>make</span><span class='b'>(</span>Str:Obj about := Str:Obj<span class='b'>[</span>:<span class='b'>])</span>
  <span class='b'>{</span>
    <span class='k'>this</span>.aboutServerName  = about<span class='b'>[</span><span class='s'>"serverName"</span><span class='b'>]</span>     ?: Env.cur.host
    <span class='k'>this</span>.aboutVendorName  = about<span class='b'>[</span><span class='s'>"vendorName"</span><span class='b'>]</span>     ?: <span class='s'>"Fantom"</span>
    <span class='k'>this</span>.aboutVendorUrl   = about<span class='b'>[</span><span class='s'>"vendorUrl"</span><span class='b'>]</span>      ?: <span class='u'>`http://fantom.org`</span>
    <span class='k'>this</span>.aboutProductName = about<span class='b'>[</span><span class='s'>"productName"</span><span class='b'>]</span>    ?: <span class='s'>"Fantom"</span>
    <span class='k'>this</span>.aboutProductVer  = about<span class='b'>[</span><span class='s'>"productVersion"</span><span class='b'>]</span> ?: ObixMod#.pod.version.toStr
    <span class='k'>this</span>.aboutProductUrl  = about<span class='b'>[</span><span class='s'>"productUrl"</span><span class='b'>]</span>     ?: <span class='u'>`http://fantom.org`</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Service</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>override</span> Void <span id='onService'>onService</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='y'>// handle special built-in URIs</span>
    uri := req.modRel
    cmd := uri.path.getSafe<span class='b'>(</span>0<span class='b'>)</span>
    <span class='k'>switch</span> <span class='b'>(</span>cmd<span class='b'>)</span>
    <span class='b'>{</span>
      <span class='k'>case</span> <span class='k'>null</span>:    onLobby; <span class='k'>return</span>
      <span class='k'>case</span> <span class='s'>"about"</span>: onAbout; <span class='k'>return</span>
      <span class='k'>case</span> <span class='s'>"xsl"</span>:   onXsl;   <span class='k'>return</span>
    <span class='b'>}</span>

    ObixObj? result
    <span class='k'>try</span>
    <span class='b'>{</span>
      <span class='y'>// route to callback</span>
      <span class='k'>switch</span> <span class='b'>(</span>req.method<span class='b'>)</span>
      <span class='b'>{</span>
        <span class='k'>case</span> <span class='s'>"GET"</span>:  result = onRead<span class='b'>(</span>uri<span class='b'>)</span>
        <span class='k'>case</span> <span class='s'>"PUT"</span>:  result = onWrite<span class='b'>(</span>uri, readReqObj<span class='b'>)</span>
        <span class='k'>case</span> <span class='s'>"POST"</span>: result = onInvoke<span class='b'>(</span>uri, readReqObj<span class='b'>)</span>
        <span class='k'>default</span>:     res.sendErr<span class='b'>(</span>501<span class='b'>)</span>; <span class='k'>return</span>
      <span class='b'>}</span>
    <span class='b'>}</span>
    <span class='k'>catch</span> <span class='b'>(</span>UnresolvedErr e<span class='b'>)</span>
    <span class='b'>{</span>
      res.sendErr<span class='b'>(</span>404<span class='b'>)</span>
      <span class='k'>return</span>
    <span class='b'>}</span>
    <span class='k'>catch</span> <span class='b'>(</span>Err e<span class='b'>)</span>
    <span class='b'>{</span>
      e.trace
      res.sendErr<span class='b'>(</span>500, e.traceToStr<span class='b'>)</span>
      <span class='k'>return</span>
    <span class='b'>}</span>

    <span class='y'>// return response</span>
    writeResObj<span class='b'>(</span>result<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='k'>private</span> Void <span id='onLobby'>onLobby</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='k'>if</span> <span class='b'>(</span>req.method != <span class='s'>"GET"</span><span class='b'>)</span> <span class='b'>{</span> res.sendErr<span class='b'>(</span>501<span class='b'>)</span>; <span class='k'>return</span> <span class='b'>}</span>
    writeResObj<span class='b'>(</span>lobby<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='k'>private</span> Void <span id='onAbout'>onAbout</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='k'>if</span> <span class='b'>(</span>req.method != <span class='s'>"GET"</span><span class='b'>)</span> <span class='b'>{</span> res.sendErr<span class='b'>(</span>501<span class='b'>)</span>; <span class='k'>return</span> <span class='b'>}</span>
    writeResObj<span class='b'>(</span>about<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='k'>private</span> Void <span id='onXsl'>onXsl</span><span class='b'>()</span>
  <span class='b'>{</span>
    file := ObixMod#.pod.file<span class='b'>(</span><span class='u'>`/res/xsl.xml`</span><span class='b'>)</span>
    FileWeblet<span class='b'>(</span>file<span class='b'>)</span>.onService
  <span class='b'>}</span>

  <span class='k'>private</span> ObixObj <span id='readReqObj'>readReqObj</span><span class='b'>()</span>
  <span class='b'>{</span>
    str := req.in.readAllStr
    <span class='k'>return</span> ObixObj.readXml<span class='b'>(</span>str.in<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='k'>private</span> Void <span id='writeResObj'>writeResObj</span><span class='b'>(</span>ObixObj obj<span class='b'>)</span>
  <span class='b'>{</span>
    buf := Buf<span class='b'>()</span>
    out := buf.out
    out.print<span class='b'>(</span><span class='s'>"&lt;?xml version='1.0' encoding='UTF-8'?&gt;\n"</span><span class='b'>)</span>
    out.print<span class='b'>(</span><span class='s'>"&lt;?xml-stylesheet type='text/xsl' href='"</span><span class='b'>)</span>.print<span class='b'>(</span>req.modBase<span class='b'>)</span>.print<span class='b'>(</span><span class='s'>"xsl'?&gt;\n"</span><span class='b'>)</span>
    obj.writeXml<span class='b'>(</span>out<span class='b'>)</span>
    buf.flip

    res.headers<span class='b'>[</span><span class='s'>"Content-Type"</span><span class='b'>]</span> = <span class='s'>"text/xml"</span>
    res.headers<span class='b'>[</span><span class='s'>"Content-Length"</span><span class='b'>]</span> = buf.size.toStr
    res.out.writeBuf<span class='b'>(</span>buf<span class='b'>)</span>
    res.out.close
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Requests</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Return the ObixObj representation of the given URI for</span>
  <span class='z'>** the application.  The URI is relative to the ObixMod</span>
  <span class='z'>** base - see `web::WebReq.modRel`.  Throw UnresolvedErr</span>
  <span class='z'>** if URI doesn't map to a valid object.  The resulting</span>
  <span class='z'>** object must have its href set to the proper absolute</span>
  <span class='z'>** URI according to 5.2 of the oBIX specification.</span>
  <span class='z'>**</span>
  <span class='k'>abstract</span> ObixObj <span id='onRead'>onRead</span><span class='b'>(</span>Uri uri<span class='b'>)</span>

  <span class='z'>**</span>
  <span class='z'>** Write the value for the given URI and return the new</span>
  <span class='z'>** representation.  The URI is relative to the ObixMod</span>
  <span class='z'>** base - see `web::WebReq.modRel`.  Throw UnresolvedErr if URI</span>
  <span class='z'>** doesn't map to a valid object.  Throw ReadonlyErr if</span>
  <span class='z'>** URI doesn't map to a writable object.</span>
  <span class='z'>**</span>
  <span class='k'>abstract</span> ObixObj <span id='onWrite'>onWrite</span><span class='b'>(</span>Uri uri, ObixObj val<span class='b'>)</span>

  <span class='z'>**</span>
  <span class='z'>** Invoke the operation for the given URI and return the result.</span>
  <span class='z'>** The URI is relative to the ObixMod base - see `web::WebReq.modRel`</span>
  <span class='z'>** Throw UnresolvedErr if URI doesn't map to a valid operation.</span>
  <span class='z'>**</span>
  <span class='k'>abstract</span> ObixObj <span id='onInvoke'>onInvoke</span><span class='b'>(</span>Uri uri, ObixObj arg<span class='b'>)</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Overrides</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Get represenation of the Lobby object.  Subclasses</span>
  <span class='z'>** can override this to customize their lobby.</span>
  <span class='z'>**</span>
  <span class='k'>virtual</span> ObixObj <span id='lobby'>lobby</span><span class='b'>()</span>
  <span class='b'>{</span>
    ObixObj
    <span class='b'>{</span>
      href = req.absUri.plusSlash
      contract = Contract<span class='b'>(</span><span class='s'>"obix:Lobby"</span><span class='b'>)</span>
      ObixObj <span class='b'>{</span> elemName = <span class='s'>"ref"</span>; name = <span class='s'>"about"</span>; href=<span class='u'>`about/`</span> <span class='b'>}</span>,
    <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Get represenation of the About object.  Subclasses should</span>
  <span class='z'>** override this to customize their about.  See `make` to</span>
  <span class='z'>** customize vendor and product fields.</span>
  <span class='z'>**</span>
  <span class='k'>virtual</span> ObixObj <span id='about'>about</span><span class='b'>()</span>
  <span class='b'>{</span>
    ObixObj
    <span class='b'>{</span>
      href = req.absUri.plusSlash
      contract = Contract<span class='b'>(</span><span class='s'>"obix:About"</span><span class='b'>)</span>
      ObixObj <span class='b'>{</span> name = <span class='s'>"obixVersion"</span>;    val = <span class='s'>"1.1"</span> <span class='b'>}</span>,
      ObixObj <span class='b'>{</span> name = <span class='s'>"serverName"</span>;     val = aboutServerName <span class='b'>}</span>,
      ObixObj <span class='b'>{</span> name = <span class='s'>"serverTime"</span>;     val = DateTime.now <span class='b'>}</span>,
      ObixObj <span class='b'>{</span> name = <span class='s'>"serverBootTime"</span>; val = DateTime.boot <span class='b'>}</span>,
      ObixObj <span class='b'>{</span> name = <span class='s'>"vendorName"</span>;     val = aboutVendorName <span class='b'>}</span>,
      ObixObj <span class='b'>{</span> name = <span class='s'>"vendorUrl"</span>;      val = aboutVendorUrl <span class='b'>}</span>,
      ObixObj <span class='b'>{</span> name = <span class='s'>"productName"</span>;    val = aboutProductName <span class='b'>}</span>,
      ObixObj <span class='b'>{</span> name = <span class='s'>"productVersion"</span>; val = aboutProductVer<span class='b'>}</span>,
      ObixObj <span class='b'>{</span> name = <span class='s'>"productUrl"</span>;     val = aboutProductUrl <span class='b'>}</span>,
      ObixObj <span class='b'>{</span> name = <span class='s'>"tz"</span>;             val = TimeZone.cur.fullName <span class='b'>}</span>,
    <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='k'>private</span> <span class='k'>const</span> Str <span id='aboutServerName'>aboutServerName</span>
  <span class='k'>private</span> <span class='k'>const</span> Str <span id='aboutVendorName'>aboutVendorName</span>
  <span class='k'>private</span> <span class='k'>const</span> Uri <span id='aboutVendorUrl'>aboutVendorUrl</span>
  <span class='k'>private</span> <span class='k'>const</span> Str <span id='aboutProductName'>aboutProductName</span>
  <span class='k'>private</span> <span class='k'>const</span> Str <span id='aboutProductVer'>aboutProductVer</span>
  <span class='k'>private</span> <span class='k'>const</span> Uri <span id='aboutProductUrl'>aboutProductUrl</span>

<span class='b'>}</span>

</pre>
</div>
</div>
<div class='sidebar'>
<h2>More Info</h2>
<ul class='clean'>
  <li><a href='ObixMod.html'>View Fandoc</a></li>
</ul>
<div class='slots'>
<div class='overview'>
<h2>Slots</h2>
<ul class='clean'>
  <li style='display: block;'><a href='#about'>about</a></li>
  <li class='hidden' style='display: block;'><a href='#aboutProductName'>aboutProductName</a></li>
  <li class='hidden' style='display: block;'><a href='#aboutProductUrl'>aboutProductUrl</a></li>
  <li class='hidden' style='display: block;'><a href='#aboutProductVer'>aboutProductVer</a></li>
  <li class='hidden' style='display: block;'><a href='#aboutServerName'>aboutServerName</a></li>
  <li class='hidden' style='display: block;'><a href='#aboutVendorName'>aboutVendorName</a></li>
  <li class='hidden' style='display: block;'><a href='#aboutVendorUrl'>aboutVendorUrl</a></li>
  <li style='display: block;'><a href='#lobby'>lobby</a></li>
  <li style='display: block;'><a href='#make'>make</a></li>
  <li class='hidden' style='display: block;'><a href='#onAbout'>onAbout</a></li>
  <li style='display: block;'><a href='#onInvoke'>onInvoke</a></li>
  <li class='hidden' style='display: block;'><a href='#onLobby'>onLobby</a></li>
  <li style='display: block;'><a href='#onRead'>onRead</a></li>
  <li style='display: block;'><a href='#onService'>onService</a></li>
  <li style='display: block;'><a href='#onWrite'>onWrite</a></li>
  <li class='hidden' style='display: block;'><a href='#onXsl'>onXsl</a></li>
  <li class='hidden' style='display: block;'><a href='#readReqObj'>readReqObj</a></li>
  <li class='hidden' style='display: block;'><a href='#writeResObj'>writeResObj</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class='footer'>
<div>
<p>
obix 1.0.56
[11-Nov-2010 Thu 10:08:27AM EST]
</p>
</div>
</div>
</body>
</html>
