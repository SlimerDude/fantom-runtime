<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
  <title>sql PodDoc</title>
  <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
  <link rel='stylesheet' type='text/css' href='../doc.css'/>
  <script type='text/javascript' src='../doc.js'></script>
<!--[if lt IE 7]>
<script src='http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE7.js' type='text/javascript'></script>
<![endif]-->
</head>
<body onload='Login.check();'>
<div class='header'>
<div>
<h1><a href='/'>Fantom</a></h1>
<p id='sidewalkLogin_'>&nbsp;</p>
<form method='get' action='/sidewalk/search/'>
<p>
<input type='text' name='q' size='30' value='Search...' onfocus='if (value=="Search...") value=""' onblur='if (value=="") value="Search..."' />
</p>
</form>
<ul>
<li><a href='/'>Home</a></li>
<li class='active'><a href='../index.html'>Docs</a></li>
<li><a href='/sidewalk/blog/'>Blog</a></li>
<li><a href='/sidewalk/ticket/'>Tickets</a></li>
<li><a href='/sidewalk/topic/'>Discuss</a></li>
</ul></div>
</div>
<div class='subHeader'>
<div>
<ul>
  <li><a href='../index.html'>Doc Home</a></li>
  <li>&gt;</li>
  <li><a href='index.html'>sql</a></li>
  <li>&gt;</li>
  <li><a href='pod-doc.html'>sql PodDoc</a></li>
</ul>
</div>
</div>
<div class='content'>
<div>
<div class='fandoc'>
<div class='type'>
 <div class='overview'>
  <h2>pod</h2>
  <h1>sql</h1>
 </div>
</div>

<h1 id='overview'>Overview </h1>

<p>The <a href='index.html'>sql</a> pod provides a standardized, low level API to work with relational databases.  Its basic goals in life:</p>

<ul>
<li>Connections: manage interaction with the database</li>

<li>Statements: execute SQL statements</li>

<li>Map Queries: map query results into Fantom objects</li>
</ul>

<p class='NOTE'>NOTE: the <code>sql</code> API is pretty basic right now - it is just enough to get us started.  Please let us know which enhancements would be the most beneficial.</p>

<h1 id='testSetup'>Test Setup </h1>

<p>The Sql tests use the following config props to determine the database configuration:</p>

<ul>
<li><code>test.connection</code>: connection/jdbc url string, defaults to "jdbc:mysql://localhost:3306/fantest"</li>

<li><code>test.username</code>: defaults to "fantest"</li>

<li><code>test.password</code>: defaults to "fantest"</li>

<li><code>test.dialect</code>: qname for dialect type, defaults to "sql::MySqlDialect"</li>
</ul>

<p>You can change these defaults via "etc/sql/config.props".</p>

<p>We've been testing with MySql 5.0.41 running InnoDB using "fantest" for the database name, user name, and password.  You can configure InnoDB as the default storage engine with this line in your "my.cfg":</p>

<pre>default-storage-engine=INNODB</pre>

<p>To setup the fantest database and user account via the mysql command line:</p>

<pre>mysql -u root -p
mysql> create user fantest identified by 'fantest';
mysql> create database fantest;
mysql> grant all privileges on fantest.* to fantest identified by 'fantest';</pre>

<h1 id='connections'>Connections </h1>

<p>Connections are managed by the SqlService.  A SqlService instance represents a database instance.  To open and close connections to the database, simply call the SqlService <code><a href='SqlService.html#open'>open</a></code> and <code><a href='SqlService.html#close'>close</a></code> methods.  A thread may only open an instance of SqlService once.  Subsequent calls to <code><a href='SqlService.html#open'>open</a></code> in the same thread simply increment the open count for the database.  A call to <code><a href='SqlService.html#close'>close</a></code> decrements the open count.  When the open count for a thread is zero, the connection to the database is closed.</p>

<h2 id='java'>Connections in Java </h2>

<p>When running in a Java VM, Fantom uses JDBC under the covers.  Using MySQL as an example, follow these steps to open a connection in the JVM:</p>

<ol style='list-style-type:decimal'>
<li>Ensure your JDBC driver is installed and available via the system class path.  The best place to stick it is in the "jre/lib/ext" directory.  You can use <code>fan -version</code> to locate your JRE directory.  For MySQL the driver is packaged up as something like "mysql-connector-java-5.0.6-bin.jar".</li>

<li>Ensure the JDBC class is loaded into memory.  The simplest way to preload the class is to define a config prop in "etc/sql/config.props" for your dialect:
<pre>sql::MySqlDialect.driver=com.mysql.jdbc.Driver</pre>
</li>

<li>Create and start a SqlService instance using the JDBC URL for the <code>connection</code> parameter to the make method. For example to create a SqlService for MySQL:
<pre>db := SqlService("jdbc:mysql://localhost:3306/fantest", "fantest", "fantest")</pre>
</li>

<li>Open the database for the current thread.
<pre>db.open</pre>
</li>
</ol>

<h2 id='dotnet'>Connections in .NET </h2>

<p>TODO</p>

<h1 id='statements'>Statements </h1>

<p>SQL statements are created using the <code><a href='SqlService.html#sql'>SqlService.sql</a></code> method.  After a statement has been created, it can be executed immediately by calling <code><a href='Statement.html#execute'>execute</a></code> or it can be prepared for later execution by calling <code><a href='Statement.html#prepare'>prepare</a></code>.</p>

<p>For example, to create a table in MySQL:</p>

<pre>db.sql("create table Books (
        id integer auto_increment not null,
        title varchar(128) not null,
        author varchar(128) not null,
        year integer,
        primary key (id))").execute</pre>

<p>Prepared statements can be parameterized by including named parameters in the SQL text.  For example:</p>

<pre>addBook := db.sql("insert into Books (title, author, year)
                   values (@title, @author, @year)").prepare</pre>

<p>This statement can then be executed multiple times with different parameters.</p>

<pre>addBook.execute(["title":"David Copperfield", "author":"Charles Dickens", "year":1850])
addBook.execute(["title":"Hard Times", "author":"Charles Dickens", "year":1854])
addBook.execute(["title":"The Jungle Book", "author":"Rudyard Kipling", "year":1894])
addBook.execute(["title":"Captains Courageous", "author":"Rudyard Kipling", "year":1897])</pre>

<h1 id='queries'>Queries </h1>

<p>The result of an SQL query is always a relational table described by fixed columns with zero or more rows.  Fantom supports two different mechanisms  for retrieving query results: as a list of <code><a href='Row.html'>Rows</a></code> or by iterating the rows with a closure.</p>

<p>To fetch as a list of rows:</p>

<pre>stmt := db.sql("select title, year from Books
                where author = @author and year > @year").prepare
dickensNovels := stmt.query(["author":"Charles Dickens", "year":1850])
kiplingNovels := stmt.query(["author":"Rudyard Kipling", "year":1890])</pre>

<p>Or to iterate through the rows:</p>

<pre>lastPublished := 0
stmt.queryEach(["author":"Charles Dickens", "year":0]) |Row row|
{
  lastPublished = lastPublished.max(row->year)
}</pre>

<h2 id='row'>sql::Row </h2>

<p>The rows for a given query result all share a list of <code><a href='Col.html'>sql::Cols</a></code> which describes the meta-data.  You can use access the column of each row using the <code>get(Col)</code> or with <a href='../docLang/Methods.html#dynamicInvoke'>dynamic invoke</a>:</p>

<pre>// using dynamic invoke
dickensNovels.each |Row book| { echo("${book->title}, ${book->year}") }

// using col
title := row.col("title")
year  := row.col("year")
dickensNovels.each |Row book| { echo("${book[title]}, ${book[year]}") }</pre>

<p>If you have a large query result, using <code>get(Col)</code> provides a little better performance.</p>
</div>
<div class='sidebar'>
<h2>Contents</h2>
<ul>
<li><a href='#overview'>Overview </a></li><li><a href='#testSetup'>Test Setup </a></li><li><a href='#connections'>Connections </a><ul>
<li><a href='#java'>Connections in Java </a></li><li><a href='#dotnet'>Connections in .NET </a></li></ul>
</li><li><a href='#statements'>Statements </a></li><li><a href='#queries'>Queries </a><ul>
<li><a href='#row'>sql::Row </a></li></ul>
</li></ul>
</div>
</div>
</div>
<div class='footer'>
<div>
<p>
sql 1.0.56
[11-Nov-2010 Thu 10:08:23AM EST]
</p>
</div>
</div>
</body>
</html>
