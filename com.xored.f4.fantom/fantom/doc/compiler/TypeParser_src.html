<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
  <title>compiler::TypeParser</title>
  <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
  <link rel='stylesheet' type='text/css' href='../doc.css'/>
  <script type='text/javascript' src='../doc.js'></script>
<!--[if lt IE 7]>
<script src='http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE7.js' type='text/javascript'></script>
<![endif]-->
</head>
<body onload='Login.check();'>
<div class='header'>
<div>
<h1><a href='/'>Fantom</a></h1>
<p id='sidewalkLogin_'>&nbsp;</p>
<form method='get' action='/sidewalk/search/'>
<p>
<input type='text' name='q' size='30' value='Search...' onfocus='if (value=="Search...") value=""' onblur='if (value=="") value="Search..."' />
</p>
</form>
<ul>
<li><a href='/'>Home</a></li>
<li class='active'><a href='../index.html'>Docs</a></li>
<li><a href='/sidewalk/blog/'>Blog</a></li>
<li><a href='/sidewalk/ticket/'>Tickets</a></li>
<li><a href='/sidewalk/topic/'>Discuss</a></li>
</ul></div>
</div>
<div class='subHeader'>
<div>
<ul>
  <li><a href='../index.html'>Doc Home</a></li>
  <li>&gt;</li>
  <li><a href='index.html'>compiler</a></li>
  <li>&gt;</li>
  <li><a href='TypeParser.html'>TypeParser</a></li>
</ul>
</div>
</div>
<div class='content'>
<div>
<div class='fandoc'>
<div class='type'>
<div class='overview'>
<h2>class</h2>
<h1>compiler::TypeParser</h1>
<pre><a href='../sys/Obj.html'>sys::Obj</a>
  compiler::TypeParser</pre>
</div>
</div>
<div class='src'>
<pre>
<span class='y'>//</span>
<span class='y'>// Copyright (c) 2006, Brian Frank and Andy Frank</span>
<span class='y'>// Licensed under the Academic Free License version 3.0</span>
<span class='y'>//</span>
<span class='y'>// History:</span>
<span class='y'>//   30 Jan 06  Brian Frank  Creation</span>
<span class='y'>//   06 Jul 07  Brian Frank  Port from Java</span>
<span class='y'>//</span>

<span class='z'>**</span>
<span class='z'>** TypeParser is used to parser formal type signatures into CTypes.</span>
<span class='z'>**</span>
<span class='z'>**   x::N</span>
<span class='z'>**   x::V[]</span>
<span class='z'>**   x::V[x::K]</span>
<span class='z'>**   |x::A, ... -&gt; x::R|</span>
<span class='z'>**</span>
<span class='k'>class</span> TypeParser
<span class='b'>{</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Factory</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Parse the signature into a resolved CType.  We *don't*</span>
  <span class='z'>** use the CNamespace's cache - it is using me when a signature</span>
  <span class='z'>** isn't found in the cache.  But we do use the CPod's type cache</span>
  <span class='z'>** via CPod.resolveType.</span>
  <span class='z'>**</span>
  <span class='k'>public</span> <span class='k'>static</span> CType <span id='resolve'>resolve</span><span class='b'>(</span>CNamespace ns, Str sig<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='y'>// if last char is ? then parse as nullable</span>
    last := sig<span class='b'>[</span>-1<span class='b'>]</span>
    <span class='k'>if</span> <span class='b'>(</span>last == <span class='s'>'?'</span><span class='b'>)</span> <span class='k'>return</span> resolve<span class='b'>(</span>ns, sig<span class='b'>[</span>0..-2<span class='b'>])</span>.toNullable

    <span class='y'>// if the last character isn't ] or |, then this a non-generic</span>
    <span class='y'>// type and we don't even need to allocate a parser</span>
    <span class='k'>if</span> <span class='b'>(</span>last != <span class='s'>']'</span> &amp;&amp; last != <span class='s'>'|'</span><span class='b'>)</span>
    <span class='b'>{</span>
      colon    := sig.index<span class='b'>(</span><span class='s'>"::"</span><span class='b'>)</span>
      podName  := sig<span class='b'>[</span>0..&lt;colon<span class='b'>]</span>
      typeName := sig<span class='b'>[</span>colon+2..-1<span class='b'>]</span>
      <span class='k'>return</span> ns.resolvePod<span class='b'>(</span>podName, <span class='k'>null</span><span class='b'>)</span>.resolveType<span class='b'>(</span>typeName, <span class='k'>true</span><span class='b'>)</span>
    <span class='b'>}</span>

    <span class='y'>// we got our work cut out for us - create parser</span>
    <span class='k'>return</span> TypeParser<span class='b'>(</span>ns, sig<span class='b'>)</span>.loadTop
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Constructor</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>private</span> <span class='k'>new</span> <span id='make'>make</span><span class='b'>(</span>CNamespace ns, Str sig<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>this</span>.ns    = ns
    <span class='k'>this</span>.sig   = sig
    <span class='k'>this</span>.len   = sig.size
    <span class='k'>this</span>.pos   = 0
    <span class='k'>this</span>.cur   = sig<span class='b'>[</span>pos<span class='b'>]</span>
    <span class='k'>this</span>.peek  = sig<span class='b'>[</span>pos+1<span class='b'>]</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Parse</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>private</span> CType <span id='loadTop'>loadTop</span><span class='b'>()</span>
  <span class='b'>{</span>
    t := loadAny
    <span class='k'>if</span> <span class='b'>(</span>cur != 0<span class='b'>)</span> <span class='k'>throw</span> err
    <span class='k'>return</span> t
  <span class='b'>}</span>

  <span class='k'>private</span> CType <span id='loadAny'>loadAny</span><span class='b'>()</span>
  <span class='b'>{</span>
    CType? t

    <span class='y'>// |...| is function</span>
    <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'|'</span><span class='b'>)</span>
      t = loadFunc

    <span class='y'>// [ is either [ffi]xxx or [K:V] map</span>
    <span class='k'>else</span> <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'['</span><span class='b'>)</span>
    <span class='b'>{</span>
      ffi := <span class='k'>true</span>
      <span class='k'>for</span> <span class='b'>(</span>i:=pos+1; i&lt;len; ++i<span class='b'>)</span>
      <span class='b'>{</span>
        ch := sig<span class='b'>[</span>i<span class='b'>]</span>
        <span class='k'>if</span> <span class='b'>(</span>isIdChar<span class='b'>(</span>ch<span class='b'>))</span> <span class='k'>continue</span>
        ffi = <span class='b'>(</span>ch == <span class='s'>']'</span><span class='b'>)</span>
        <span class='k'>break</span>
      <span class='b'>}</span>

      <span class='k'>if</span> <span class='b'>(</span>ffi<span class='b'>)</span>
        t = loadFFI
      <span class='k'>else</span>
        t = loadMap
    <span class='b'>}</span>

    <span class='y'>// otherwise must be basic[]</span>
    <span class='k'>else</span>
      t = loadBasic

    <span class='y'>// nullable</span>
    <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'?'</span><span class='b'>)</span>
    <span class='b'>{</span>
      consume<span class='b'>(</span><span class='s'>'?'</span><span class='b'>)</span>
      t = t.toNullable
    <span class='b'>}</span>

    <span class='y'>// anything left must be []</span>
    <span class='k'>while</span> <span class='b'>(</span>cur == <span class='s'>'['</span><span class='b'>)</span>
    <span class='b'>{</span>
      consume<span class='b'>(</span><span class='s'>'['</span><span class='b'>)</span>
      consume<span class='b'>(</span><span class='s'>']'</span><span class='b'>)</span>
      t = t.toListOf
    <span class='b'>}</span>

    <span class='y'>// nullable</span>
    <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'?'</span><span class='b'>)</span>
    <span class='b'>{</span>
      consume<span class='b'>(</span><span class='s'>'?'</span><span class='b'>)</span>
      t = t.toNullable
    <span class='b'>}</span>

    <span class='k'>return</span> t
  <span class='b'>}</span>

  <span class='k'>private</span> CType <span id='loadMap'>loadMap</span><span class='b'>()</span>
  <span class='b'>{</span>
    consume<span class='b'>(</span><span class='s'>'['</span><span class='b'>)</span>
    key := loadAny
    consume<span class='b'>(</span><span class='s'>':'</span><span class='b'>)</span>
    val := loadAny
    consume<span class='b'>(</span><span class='s'>']'</span><span class='b'>)</span>
    <span class='k'>return</span> MapType<span class='b'>(</span>key, val<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='k'>private</span> CType <span id='loadFunc'>loadFunc</span><span class='b'>()</span>
  <span class='b'>{</span>
    consume<span class='b'>(</span><span class='s'>'|'</span><span class='b'>)</span>
    params := CType<span class='b'>[</span>,<span class='b'>]</span>
    names  := Str<span class='b'>[</span>,<span class='b'>]</span>
    <span class='k'>if</span> <span class='b'>(</span>cur != <span class='s'>'-'</span><span class='b'>)</span>
    <span class='b'>{</span>
      <span class='k'>while</span> <span class='b'>(</span><span class='k'>true</span><span class='b'>)</span>
      <span class='b'>{</span>
        params.add<span class='b'>(</span>loadAny<span class='b'>)</span>
        names.add<span class='b'>((</span><span class='s'>'a'</span>+names.size<span class='b'>)</span>.toChar<span class='b'>)</span>
        <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'-'</span><span class='b'>)</span> <span class='k'>break</span>
        consume<span class='b'>(</span><span class='s'>','</span><span class='b'>)</span>
      <span class='b'>}</span>
    <span class='b'>}</span>
    consume<span class='b'>(</span><span class='s'>'-'</span><span class='b'>)</span>
    consume<span class='b'>(</span><span class='s'>'&gt;'</span><span class='b'>)</span>
    ret := loadAny
    consume<span class='b'>(</span><span class='s'>'|'</span><span class='b'>)</span>

    <span class='k'>return</span> FuncType<span class='b'>(</span>params, names, ret<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='k'>private</span> CType <span id='loadFFI'>loadFFI</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='y'>// [java]foo.bar.foo</span>
    start := pos
    <span class='k'>while</span> <span class='b'>(</span>cur != <span class='s'>':'</span> || peek != <span class='s'>':'</span><span class='b'>)</span> consume
    <span class='y'>//podName := sig[start..&lt;pos]</span>

    consume<span class='b'>(</span><span class='s'>':'</span><span class='b'>)</span>
    consume<span class='b'>(</span><span class='s'>':'</span><span class='b'>)</span>

    <span class='y'>// Baz or [Baz</span>
    <span class='y'>//start = pos</span>
    <span class='k'>while</span> <span class='b'>(</span>cur == <span class='s'>'['</span><span class='b'>)</span> consume
    <span class='k'>while</span> <span class='b'>(</span>isIdChar<span class='b'>(</span>cur<span class='b'>))</span> consume
    <span class='y'>//typeName := sig[start..&lt;pos]</span>
    qname := sig<span class='b'>[</span>start..&lt;pos<span class='b'>]</span>

    <span class='k'>return</span> ns.resolveType<span class='b'>(</span>qname<span class='b'>)</span>;
  <span class='b'>}</span>

  <span class='k'>private</span> CType <span id='loadBasic'>loadBasic</span><span class='b'>()</span>
  <span class='b'>{</span>
    start := pos
    <span class='k'>while</span> <span class='b'>(</span>cur != <span class='s'>':'</span> || peek != <span class='s'>':'</span><span class='b'>)</span> consume
    consume<span class='b'>(</span><span class='s'>':'</span><span class='b'>)</span>
    consume<span class='b'>(</span><span class='s'>':'</span><span class='b'>)</span>
    <span class='k'>while</span> <span class='b'>(</span>isIdChar<span class='b'>(</span>cur<span class='b'>))</span> consume
    qname := sig<span class='b'>[</span>start..&lt;pos<span class='b'>]</span>
    <span class='k'>return</span> ns.resolveType<span class='b'>(</span>qname<span class='b'>)</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Utils</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>private</span> Void <span id='consume'>consume</span><span class='b'>(</span>Int? expected := <span class='k'>null</span><span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>if</span> <span class='b'>(</span>expected != <span class='k'>null</span> &amp;&amp; cur != expected<span class='b'>)</span> <span class='k'>throw</span> err
    cur = peek
    pos++
    peek = pos+1 &lt; len ? sig<span class='b'>[</span>pos+1<span class='b'>]</span> : 0
  <span class='b'>}</span>

  <span class='k'>private</span> <span class='k'>static</span> Bool <span id='isIdChar'>isIdChar</span><span class='b'>(</span>Int ch<span class='b'>)</span>
  <span class='b'>{</span>
    ch.isAlphaNum || ch == <span class='s'>'_'</span>
  <span class='b'>}</span>

  <span class='k'>private</span> ArgErr <span id='err'>err</span><span class='b'>()</span>
  <span class='b'>{</span>
    ArgErr<span class='b'>(</span><span class='s'>"Invalid type signature '"</span> + sig + <span class='s'>"'"</span><span class='b'>)</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Fields</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>private</span> CNamespace <span id='ns'>ns</span>  <span class='y'>// namespace we are loading from</span>
  <span class='k'>private</span> Str <span id='sig'>sig</span>        <span class='y'>// signature being parsed</span>
  <span class='k'>private</span> Int <span id='len'>len</span>        <span class='y'>// length of sig</span>
  <span class='k'>private</span> Int <span id='pos'>pos</span>        <span class='y'>// index of cur in sig</span>
  <span class='k'>private</span> Int <span id='cur'>cur</span>        <span class='y'>// cur character; sig[pos]</span>
  <span class='k'>private</span> Int <span id='peek'>peek</span>       <span class='y'>// next character; sig[pos+1]</span>

<span class='b'>}</span></pre>
</div>
</div>
<div class='sidebar'>
<h2>More Info</h2>
<ul class='clean'>
  <li><a href='TypeParser.html'>View Fandoc</a></li>
</ul>
<div class='slots'>
<div class='overview'>
<h2>Slots</h2>
<ul class='clean'>
  <li class='hidden' style='display: block;'><a href='#consume'>consume</a></li>
  <li class='hidden' style='display: block;'><a href='#cur'>cur</a></li>
  <li class='hidden' style='display: block;'><a href='#err'>err</a></li>
  <li class='hidden' style='display: block;'><a href='#isIdChar'>isIdChar</a></li>
  <li class='hidden' style='display: block;'><a href='#len'>len</a></li>
  <li class='hidden' style='display: block;'><a href='#loadAny'>loadAny</a></li>
  <li class='hidden' style='display: block;'><a href='#loadBasic'>loadBasic</a></li>
  <li class='hidden' style='display: block;'><a href='#loadFFI'>loadFFI</a></li>
  <li class='hidden' style='display: block;'><a href='#loadFunc'>loadFunc</a></li>
  <li class='hidden' style='display: block;'><a href='#loadMap'>loadMap</a></li>
  <li class='hidden' style='display: block;'><a href='#loadTop'>loadTop</a></li>
  <li class='hidden' style='display: block;'><a href='#make'>make</a></li>
  <li class='hidden' style='display: block;'><a href='#ns'>ns</a></li>
  <li class='hidden' style='display: block;'><a href='#peek'>peek</a></li>
  <li class='hidden' style='display: block;'><a href='#pos'>pos</a></li>
  <li style='display: block;'><a href='#resolve'>resolve</a></li>
  <li class='hidden' style='display: block;'><a href='#sig'>sig</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class='footer'>
<div>
<p>
compiler 1.0.56
[11-Nov-2010 Thu 10:08:17AM EST]
</p>
</div>
</div>
</body>
</html>
