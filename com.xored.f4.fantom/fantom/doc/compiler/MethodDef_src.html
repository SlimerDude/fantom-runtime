<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
  <title>compiler::MethodDef</title>
  <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
  <link rel='stylesheet' type='text/css' href='../doc.css'/>
  <script type='text/javascript' src='../doc.js'></script>
<!--[if lt IE 7]>
<script src='http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE7.js' type='text/javascript'></script>
<![endif]-->
</head>
<body onload='Login.check();'>
<div class='header'>
<div>
<h1><a href='/'>Fantom</a></h1>
<p id='sidewalkLogin_'>&nbsp;</p>
<form method='get' action='/sidewalk/search/'>
<p>
<input type='text' name='q' size='30' value='Search...' onfocus='if (value=="Search...") value=""' onblur='if (value=="") value="Search..."' />
</p>
</form>
<ul>
<li><a href='/'>Home</a></li>
<li class='active'><a href='../index.html'>Docs</a></li>
<li><a href='/sidewalk/blog/'>Blog</a></li>
<li><a href='/sidewalk/ticket/'>Tickets</a></li>
<li><a href='/sidewalk/topic/'>Discuss</a></li>
</ul></div>
</div>
<div class='subHeader'>
<div>
<ul>
  <li><a href='../index.html'>Doc Home</a></li>
  <li>&gt;</li>
  <li><a href='index.html'>compiler</a></li>
  <li>&gt;</li>
  <li><a href='MethodDef.html'>MethodDef</a></li>
</ul>
</div>
</div>
<div class='content'>
<div>
<div class='fandoc'>
<div class='type'>
<div class='overview'>
<h2>class</h2>
<h1>compiler::MethodDef</h1>
<pre><a href='../sys/Obj.html'>sys::Obj</a>
  <a href='Node.html'>compiler::Node</a>
    <a href='DefNode.html'>compiler::DefNode</a>
      <a href='SlotDef.html'>compiler::SlotDef</a>
        compiler::MethodDef : <a href='CMethod.html'>compiler::CMethod</a></pre>
</div>
</div>
<div class='src'>
<pre>
<span class='y'>//</span>
<span class='y'>// Copyright (c) 2006, Brian Frank and Andy Frank</span>
<span class='y'>// Licensed under the Academic Free License version 3.0</span>
<span class='y'>//</span>
<span class='y'>// History:</span>
<span class='y'>//   15 Sep 05  Brian Frank  Creation</span>
<span class='y'>//   19 Jul 06  Brian Frank  Ported from Java to Fan</span>
<span class='y'>//</span>

<span class='z'>**</span>
<span class='z'>** MethodDef models a method definition - it's signature and body.</span>
<span class='z'>**</span>
<span class='k'>class</span> MethodDef : SlotDef, CMethod
<span class='b'>{</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Construction</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>public</span> <span class='k'>static</span> MethodDef <span id='makeStaticInit'>makeStaticInit</span><span class='b'>(</span>Loc loc, TypeDef parent, Block? block<span class='b'>)</span>
  <span class='b'>{</span>
    def := make<span class='b'>(</span>loc, parent<span class='b'>)</span>
    def.name   = <span class='s'>"static\$init"</span>
    def.flags  = FConst.Private + FConst.Static + FConst.Synthetic
    def.ret    = parent.ns.voidType
    def.code   = block
    <span class='k'>return</span> def;
  <span class='b'>}</span>

  <span class='k'>public</span> <span class='k'>static</span> MethodDef <span id='makeInstanceInit'>makeInstanceInit</span><span class='b'>(</span>Loc loc, TypeDef parent, Block? block<span class='b'>)</span>
  <span class='b'>{</span>
    def := make<span class='b'>(</span>loc, parent<span class='b'>)</span>
    def.name   = <span class='s'>"instance\$init\$$parent.pod.name\$$parent.name"</span>;
    def.flags  = FConst.Private + FConst.Synthetic
    def.ret    = parent.ns.voidType
    def.code   = block
    <span class='k'>return</span> def;
  <span class='b'>}</span>

  <span class='k'>new</span> <span id='make'>make</span><span class='b'>(</span>Loc loc, TypeDef parent, Str name := <span class='s'>"?"</span>, Int flags := 0<span class='b'>)</span>
     : <span class='k'>super</span><span class='b'>(</span>loc, parent<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>this</span>.name = name
    <span class='k'>this</span>.flags = flags
    <span class='k'>this</span>.ret = parent.ns.error
    paramDefs = ParamDef<span class='b'>[</span>,<span class='b'>]</span>
    vars = MethodVar<span class='b'>[</span>,<span class='b'>]</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Methods</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Return if this a static initializer block.</span>
  <span class='z'>**</span>
  Bool <span id='isStaticInit'>isStaticInit</span><span class='b'>()</span> <span class='b'>{</span> name == <span class='s'>"static\$init"</span> <span class='b'>}</span>
  <span class='k'>static</span> Bool <span id='isNameStaticInit'>isNameStaticInit</span><span class='b'>(</span>Str name<span class='b'>)</span> <span class='b'>{</span> name == <span class='s'>"static\$init"</span> <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Return if this a instance initializer block.</span>
  <span class='z'>**</span>
  Bool <span id='isInstanceInit'>isInstanceInit</span><span class='b'>()</span> <span class='b'>{</span> name.startsWith<span class='b'>(</span><span class='s'>"instance\$init\$"</span><span class='b'>)</span> <span class='b'>}</span>
  <span class='k'>static</span> Bool <span id='isNameInstanceInit'>isNameInstanceInit</span><span class='b'>(</span>Str name<span class='b'>)</span> <span class='b'>{</span> name.startsWith<span class='b'>(</span><span class='s'>"instance\$init\$"</span><span class='b'>)</span> <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Return if getter/setter for FieldDef</span>
  <span class='z'>**</span>
  Bool <span id='isFieldAccessor'>isFieldAccessor</span><span class='b'>()</span> <span class='b'>{</span> accessorFor != <span class='k'>null</span> <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Return if setter for FieldDef</span>
  <span class='z'>**</span>
  Bool <span id='isFieldSetter'>isFieldSetter</span><span class='b'>()</span> <span class='b'>{</span> accessorFor != <span class='k'>null</span> &amp;&amp; paramDefs.size == 1  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Return if this is a once method</span>
  <span class='z'>**</span>
  Bool <span id='isOnce'>isOnce</span><span class='b'>()</span> <span class='b'>{</span> flags.and<span class='b'>(</span>Parser.Once<span class='b'>)</span> != 0 <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Return if this is a constructor with an it-block as last parameter</span>
  <span class='z'>**</span>
  Bool <span id='isItBlockCtor'>isItBlockCtor</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='k'>if</span> <span class='b'>(</span>!isCtor || params.isEmpty<span class='b'>)</span> <span class='k'>return</span> <span class='k'>false</span>
    lastArg := params.last.paramType.deref.toNonNullable <span class='k'>as</span> FuncType
    <span class='k'>if</span> <span class='b'>(</span>lastArg == <span class='k'>null</span> || lastArg.params.size != 1<span class='b'>)</span> <span class='k'>return</span> <span class='k'>false</span>
    <span class='k'>return</span> <span class='k'>true</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Make and add a MethodVar for a local variable.</span>
  <span class='z'>**</span>
  MethodVar <span id='addLocalVarForDef'>addLocalVarForDef</span><span class='b'>(</span>LocalDefStmt def, Block? scope<span class='b'>)</span>
  <span class='b'>{</span>
    var := addLocalVar<span class='b'>(</span>def.ctype, def.name, scope<span class='b'>)</span>
    var.isCatchVar = def.isCatchVar
    <span class='k'>return</span> var
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Make and add a MethodVar for a local variable.  If name is</span>
  <span class='z'>** null then we auto-generate a temporary variable name</span>
  <span class='z'>**</span>
  MethodVar <span id='addLocalVar'>addLocalVar</span><span class='b'>(</span>CType ctype, Str? name, Block? scope<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='y'>// allocate next register index, implicit this always register 0</span>
    reg := vars.size
    <span class='k'>if</span> <span class='b'>(</span>!isStatic<span class='b'>)</span> reg++

    <span class='y'>// auto-generate name</span>
    <span class='k'>if</span> <span class='b'>(</span>name == <span class='k'>null</span><span class='b'>)</span> name = <span class='s'>"\$temp"</span> + reg

    <span class='y'>// create variable and add it variable list</span>
    var := MethodVar<span class='b'>(</span><span class='k'>this</span>, reg, ctype, name, 0, scope<span class='b'>)</span>
    vars.add<span class='b'>(</span>var<span class='b'>)</span>
    <span class='k'>return</span> var
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Add a parameter to the end of the method signature and</span>
  <span class='z'>** initialize the param MethodVar.</span>
  <span class='z'>** Note: currently this only works if no locals are defined.</span>
  <span class='z'>**</span>
  MethodVar <span id='addParamVar'>addParamVar</span><span class='b'>(</span>CType ctype, Str name<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>if</span> <span class='b'>(</span>vars.size &gt; 0 &amp;&amp; !vars<span class='b'>[</span>-1<span class='b'>]</span>.isParam<span class='b'>)</span> <span class='k'>throw</span> Err<span class='b'>(</span><span class='s'>"Add param with locals $qname"</span><span class='b'>)</span>
    param := ParamDef<span class='b'>(</span>loc, ctype, name<span class='b'>)</span>
    params.add<span class='b'>(</span>param<span class='b'>)</span>
    var := MethodVar.makeForParam<span class='b'>(</span><span class='k'>this</span>, params.size, param, ctype<span class='b'>)</span>
    vars.add<span class='b'>(</span>var<span class='b'>)</span>
    <span class='k'>return</span> var
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// CMethod</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>override</span> Str <span id='signature'>signature</span><span class='b'>()</span> <span class='b'>{</span> qname + <span class='s'>"("</span> + params.join<span class='b'>(</span><span class='s'>","</span><span class='b'>)</span> + <span class='s'>")"</span> <span class='b'>}</span>

  <span class='k'>override</span> CType <span id='returnType'>returnType</span><span class='b'>()</span> <span class='b'>{</span> ret <span class='b'>}</span>

  <span class='k'>override</span> CType <span id='inheritedReturnType'>inheritedReturnType</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='k'>if</span> <span class='b'>(</span>inheritedRet != <span class='k'>null</span><span class='b'>)</span>
      <span class='k'>return</span> inheritedRet
    <span class='k'>else</span>
      <span class='k'>return</span> ret
  <span class='b'>}</span>

  <span class='k'>override</span> CParam<span class='b'>[]</span> <span id='params'>params</span><span class='b'>()</span> <span class='b'>{</span> paramDefs <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Tree</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>override</span> Void <span id='walk'>walk</span><span class='b'>(</span>Visitor v, VisitDepth depth<span class='b'>)</span>
  <span class='b'>{</span>
    v.enterMethodDef<span class='b'>(</span><span class='k'>this</span><span class='b'>)</span>
    walkFacets<span class='b'>(</span>v, depth<span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>depth &gt;= VisitDepth.stmt<span class='b'>)</span>
    <span class='b'>{</span>
      <span class='k'>if</span> <span class='b'>(</span>depth &gt;= VisitDepth.expr<span class='b'>)</span>
      <span class='b'>{</span>
        <span class='k'>if</span> <span class='b'>(</span>ctorChain != <span class='k'>null</span><span class='b'>)</span> ctorChain = <span class='b'>(</span>CallExpr<span class='b'>)</span>ctorChain.walk<span class='b'>(</span>v<span class='b'>)</span>
        paramDefs.each |ParamDef p| <span class='b'>{</span> <span class='k'>if</span> <span class='b'>(</span>p.def != <span class='k'>null</span><span class='b'>)</span> p.def = p.def.walk<span class='b'>(</span>v<span class='b'>)</span> <span class='b'>}</span>
      <span class='b'>}</span>
      <span class='k'>if</span> <span class='b'>(</span>code != <span class='k'>null</span><span class='b'>)</span> code.walk<span class='b'>(</span>v, depth<span class='b'>)</span>
    <span class='b'>}</span>
    v.visitMethodDef<span class='b'>(</span><span class='k'>this</span><span class='b'>)</span>
    v.exitMethodDef<span class='b'>(</span><span class='k'>this</span><span class='b'>)</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Documentation</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>override</span> <span class='b'>[</span>Str:Str<span class='b'>]</span>? <span id='docMeta'>docMeta</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='k'>if</span> <span class='b'>(</span>paramDefs.isEmpty || !paramDefs<span class='b'>[</span>-1<span class='b'>]</span>.hasDefault<span class='b'>)</span>
      <span class='k'>return</span> <span class='k'>null</span>

    meta := Str:Str<span class='b'>[</span>:<span class='b'>]</span>
    paramDefs.each |ParamDef p|
    <span class='b'>{</span>
      <span class='k'>if</span> <span class='b'>(</span>p.hasDefault<span class='b'>)</span>
      <span class='b'>{</span>
        defStr := p.def.toDocStr
        <span class='k'>if</span> <span class='b'>(</span>defStr != <span class='k'>null</span><span class='b'>)</span> meta<span class='b'>[</span>p.name+<span class='s'>".def"</span><span class='b'>]</span> = defStr
      <span class='b'>}</span>
    <span class='b'>}</span>
    <span class='k'>return</span> meta
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Debug</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>override</span> Void <span id='print'>print</span><span class='b'>(</span>AstWriter out<span class='b'>)</span>
  <span class='b'>{</span>
    printFacets<span class='b'>(</span>out<span class='b'>)</span>
    out.flags<span class='b'>(</span>flags<span class='b'>)</span>.w<span class='b'>(</span>ret<span class='b'>)</span>.w<span class='b'>(</span><span class='s'>" "</span><span class='b'>)</span>.w<span class='b'>(</span>name<span class='b'>)</span>.w<span class='b'>(</span><span class='s'>"("</span><span class='b'>)</span>
    paramDefs.each |ParamDef p, Int i|
    <span class='b'>{</span>
      <span class='k'>if</span> <span class='b'>(</span>i &gt; 0<span class='b'>)</span> out.w<span class='b'>(</span><span class='s'>", "</span><span class='b'>)</span>
      p.print<span class='b'>(</span>out<span class='b'>)</span>
    <span class='b'>}</span>
    out.w<span class='b'>(</span><span class='s'>")"</span><span class='b'>)</span>.nl

    <span class='k'>if</span> <span class='b'>(</span>ctorChain != <span class='k'>null</span><span class='b'>)</span> <span class='b'>{</span> out.w<span class='b'>(</span><span class='s'>" : "</span><span class='b'>)</span>; ctorChain.print<span class='b'>(</span>out<span class='b'>)</span>; out.nl <span class='b'>}</span>

    <span class='k'>if</span> <span class='b'>(</span>code != <span class='k'>null</span><span class='b'>)</span> code.print<span class='b'>(</span>out<span class='b'>)</span>
    out.nl
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Fields</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  CType <span id='ret'>ret</span>              <span class='y'>// return type</span>
  CType? <span id='inheritedRet'>inheritedRet</span>    <span class='y'>// used for original return if covariant</span>
  ParamDef<span class='b'>[]</span> <span id='paramDefs'>paramDefs</span>   <span class='y'>// parameter definitions</span>
  Block? <span id='code'>code</span>            <span class='y'>// code block</span>
  CallExpr? <span id='ctorChain'>ctorChain</span>    <span class='y'>// constructor chain for this/super ctor</span>
  MethodVar<span class='b'>[]</span> <span id='vars'>vars</span>       <span class='y'>// all param/local variables in method</span>
  FieldDef? <span id='accessorFor'>accessorFor</span>  <span class='y'>// if accessor method for field</span>
  Bool <span id='usesCvars'>usesCvars</span>         <span class='y'>// does this method have locals enclosed by closure</span>
<span class='b'>}</span></pre>
</div>
</div>
<div class='sidebar'>
<h2>More Info</h2>
<ul class='clean'>
  <li><a href='MethodDef.html'>View Fandoc</a></li>
</ul>
<div class='slots'>
<div class='overview'>
<h2>Slots</h2>
<ul class='clean'>
  <li style='display: block;'><a href='#accessorFor'>accessorFor</a></li>
  <li style='display: block;'><a href='#addLocalVar'>addLocalVar</a></li>
  <li style='display: block;'><a href='#addLocalVarForDef'>addLocalVarForDef</a></li>
  <li style='display: block;'><a href='#addParamVar'>addParamVar</a></li>
  <li style='display: block;'><a href='#code'>code</a></li>
  <li style='display: block;'><a href='#ctorChain'>ctorChain</a></li>
  <li style='display: block;'><a href='#docMeta'>docMeta</a></li>
  <li style='display: block;'><a href='#inheritedRet'>inheritedRet</a></li>
  <li style='display: block;'><a href='#inheritedReturnType'>inheritedReturnType</a></li>
  <li style='display: block;'><a href='#isFieldAccessor'>isFieldAccessor</a></li>
  <li style='display: block;'><a href='#isFieldSetter'>isFieldSetter</a></li>
  <li style='display: block;'><a href='#isInstanceInit'>isInstanceInit</a></li>
  <li style='display: block;'><a href='#isItBlockCtor'>isItBlockCtor</a></li>
  <li style='display: block;'><a href='#isNameInstanceInit'>isNameInstanceInit</a></li>
  <li style='display: block;'><a href='#isNameStaticInit'>isNameStaticInit</a></li>
  <li style='display: block;'><a href='#isOnce'>isOnce</a></li>
  <li style='display: block;'><a href='#isStaticInit'>isStaticInit</a></li>
  <li style='display: block;'><a href='#make'>make</a></li>
  <li style='display: block;'><a href='#makeInstanceInit'>makeInstanceInit</a></li>
  <li style='display: block;'><a href='#makeStaticInit'>makeStaticInit</a></li>
  <li style='display: block;'><a href='#paramDefs'>paramDefs</a></li>
  <li style='display: block;'><a href='#params'>params</a></li>
  <li style='display: block;'><a href='#print'>print</a></li>
  <li style='display: block;'><a href='#ret'>ret</a></li>
  <li style='display: block;'><a href='#returnType'>returnType</a></li>
  <li style='display: block;'><a href='#signature'>signature</a></li>
  <li style='display: block;'><a href='#usesCvars'>usesCvars</a></li>
  <li style='display: block;'><a href='#vars'>vars</a></li>
  <li style='display: block;'><a href='#walk'>walk</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class='footer'>
<div>
<p>
compiler 1.0.56
[11-Nov-2010 Thu 10:08:17AM EST]
</p>
</div>
</div>
</body>
</html>
