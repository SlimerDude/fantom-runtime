<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
  <title>compiler::Tokenizer</title>
  <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
  <link rel='stylesheet' type='text/css' href='../doc.css'/>
  <script type='text/javascript' src='../doc.js'></script>
<!--[if lt IE 7]>
<script src='http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE7.js' type='text/javascript'></script>
<![endif]-->
</head>
<body onload='Login.check();'>
<div class='header'>
<div>
<h1><a href='/'>Fantom</a></h1>
<p id='sidewalkLogin_'>&nbsp;</p>
<form method='get' action='/sidewalk/search/'>
<p>
<input type='text' name='q' size='30' value='Search...' onfocus='if (value=="Search...") value=""' onblur='if (value=="") value="Search..."' />
</p>
</form>
<ul>
<li><a href='/'>Home</a></li>
<li class='active'><a href='../index.html'>Docs</a></li>
<li><a href='/sidewalk/blog/'>Blog</a></li>
<li><a href='/sidewalk/ticket/'>Tickets</a></li>
<li><a href='/sidewalk/topic/'>Discuss</a></li>
</ul></div>
</div>
<div class='subHeader'>
<div>
<ul>
  <li><a href='../index.html'>Doc Home</a></li>
  <li>&gt;</li>
  <li><a href='index.html'>compiler</a></li>
  <li>&gt;</li>
  <li><a href='Tokenizer.html'>Tokenizer</a></li>
</ul>
</div>
</div>
<div class='content'>
<div>
<div class='fandoc'>
<div class='type'>
<div class='overview'>
<h2>class</h2>
<h1>compiler::Tokenizer</h1>
<pre><a href='../sys/Obj.html'>sys::Obj</a>
  <a href='CompilerSupport.html'>compiler::CompilerSupport</a>
    compiler::Tokenizer</pre>
</div>
</div>
<div class='src'>
<pre>
<span class='y'>//</span>
<span class='y'>// Copyright (c) 2006, Brian Frank and Andy Frank</span>
<span class='y'>// Licensed under the Academic Free License version 3.0</span>
<span class='y'>//</span>
<span class='y'>// History:</span>
<span class='y'>//    3 Sep 05  Brian Frank  Creation</span>
<span class='y'>//   18 May 06  Brian Frank  Ported from Java to Fan</span>
<span class='y'>//</span>

<span class='z'>**</span>
<span class='z'>** Tokenizer inputs a Str and output a list of Tokens</span>
<span class='z'>**</span>
<span class='k'>class</span> Tokenizer : CompilerSupport
<span class='b'>{</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Constructor</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Construct with characters of source file.  The buffer</span>
  <span class='z'>** passed must be normalized in that all newlines must be</span>
  <span class='z'>** represented strictly as \n and not \r or \r\n (see</span>
  <span class='z'>** File.readAllStr).  If isDoc is false, we skip all star-star</span>
  <span class='z'>** Fandoc comments.</span>
  <span class='z'>**</span>
  <span class='k'>new</span> <span id='make'>make</span><span class='b'>(</span>Compiler compiler, Loc loc, Str buf, Bool isDoc<span class='b'>)</span>
    : <span class='k'>super</span><span class='b'>(</span>compiler<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>this</span>.buf      = buf
    <span class='k'>this</span>.filename = loc.file
    <span class='k'>this</span>.isDoc    = isDoc
    <span class='k'>this</span>.tokens   = TokenVal<span class='b'>[</span>,<span class='b'>]</span>
    <span class='k'>this</span>.inStrLiteral = <span class='k'>false</span>
    <span class='k'>this</span>.posOfLine = 0
    <span class='k'>this</span>.whitespace = <span class='k'>false</span>

    <span class='y'>// initialize cur and peek</span>
    cur = peek = <span class='s'>' '</span>
    <span class='k'>if</span> <span class='b'>(</span>buf.size &gt; 0<span class='b'>)</span> cur  = buf<span class='b'>[</span>0<span class='b'>]</span>
    <span class='k'>if</span> <span class='b'>(</span>buf.size &gt; 1<span class='b'>)</span> peek = buf<span class='b'>[</span>1<span class='b'>]</span>
    pos = 0

    <span class='y'>// if first line starts with #, then treat it like an end of</span>
    <span class='y'>// line, so that Unix guys can specify the executable to run</span>
    <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'#'</span><span class='b'>)</span>
    <span class='b'>{</span>
      <span class='k'>while</span> <span class='b'>(</span><span class='k'>true</span><span class='b'>)</span>
      <span class='b'>{</span>
        <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'\n'</span><span class='b'>)</span> <span class='b'>{</span> consume; <span class='k'>break</span> <span class='b'>}</span>
        <span class='k'>if</span> <span class='b'>(</span>cur == 0<span class='b'>)</span> <span class='k'>break</span>
        consume
      <span class='b'>}</span>
    <span class='b'>}</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Access</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Tokenize the entire input into a list of tokens.</span>
  <span class='z'>**</span>
  TokenVal<span class='b'>[]</span> <span id='tokenize'>tokenize</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='k'>while</span> <span class='b'>(</span><span class='k'>true</span><span class='b'>)</span>
    <span class='b'>{</span>
      tok := next
      tokens.add<span class='b'>(</span>tok<span class='b'>)</span>
      <span class='k'>if</span> <span class='b'>(</span>tok.kind === Token.eof<span class='b'>)</span> <span class='k'>break</span>
    <span class='b'>}</span>
    <span class='k'>return</span> tokens
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Return the next token in the buffer.</span>
  <span class='z'>**</span>
  TokenVal? <span id='next'>next</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='k'>while</span> <span class='b'>(</span><span class='k'>true</span><span class='b'>)</span>
    <span class='b'>{</span>
      <span class='y'>// save current line</span>
      line := <span class='k'>this</span>.line
      col  := <span class='k'>this</span>.col

      <span class='y'>// find next token</span>
      TokenVal? tok := find
      <span class='k'>if</span> <span class='b'>(</span>tok == <span class='k'>null</span><span class='b'>)</span> <span class='k'>continue</span>

      <span class='y'>// fill in token's location</span>
      tok.file = filename
      tok.line = line
      tok.col  = col
      tok.newline = lastLine &lt; line
      tok.whitespace = whitespace

      <span class='y'>// save last line, clear whitespace flag</span>
      lastLine = line
      whitespace = <span class='k'>false</span>

      <span class='k'>return</span> tok
    <span class='b'>}</span>
    <span class='k'>return</span> <span class='k'>null</span> <span class='y'>// TODO - shouldn't need this</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Find the next token or return null.</span>
  <span class='z'>**</span>
  <span class='k'>private</span> TokenVal? <span id='find'>find</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='y'>// skip whitespace</span>
    <span class='k'>if</span> <span class='b'>(</span>cur.isSpace<span class='b'>)</span> <span class='b'>{</span> consume; whitespace = <span class='k'>true</span>; <span class='k'>return</span> <span class='k'>null</span> <span class='b'>}</span>

    <span class='y'>// alpha means keyword or identifier</span>
    <span class='k'>if</span> <span class='b'>(</span>cur.isAlpha || cur == <span class='s'>'_'</span><span class='b'>)</span> <span class='k'>return</span> word

    <span class='y'>// number or .number (note that + and - are handled as unary operator)</span>
    <span class='k'>if</span> <span class='b'>(</span>cur.isDigit<span class='b'>)</span> <span class='k'>return</span> number
    <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'.'</span> &amp;&amp; peek.isDigit<span class='b'>)</span> <span class='k'>return</span> number

    <span class='y'>// str literal</span>
    <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'"'</span> &amp;&amp; peek == <span class='s'>'"'</span> &amp;&amp; peekPeek == <span class='s'>'"'</span><span class='b'>)</span> <span class='k'>return</span> quoted<span class='b'>(</span>Quoted.triple<span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'"'</span><span class='b'>)</span> <span class='k'>return</span> quoted<span class='b'>(</span>Quoted.normal<span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'`'</span><span class='b'>)</span> <span class='k'>return</span> quoted<span class='b'>(</span>Quoted.uri<span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'\''</span><span class='b'>)</span> <span class='k'>return</span> ch

    <span class='y'>// comments</span>
    <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'*'</span> &amp;&amp; peek == <span class='s'>'*'</span><span class='b'>)</span> <span class='k'>return</span> docComment
    <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'/'</span> &amp;&amp; peek == <span class='s'>'/'</span><span class='b'>)</span> <span class='k'>return</span> skipCommentSL
    <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'/'</span> &amp;&amp; peek == <span class='s'>'*'</span><span class='b'>)</span> <span class='k'>return</span> skipCommentML

    <span class='y'>// DSL</span>
    <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'&lt;'</span> &amp;&amp; peek == <span class='s'>'|'</span><span class='b'>)</span> <span class='k'>return</span> dsl

    <span class='y'>// symbols</span>
    <span class='k'>return</span> symbol
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Word</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Parse a word token: alpha (alpha|number)*</span>
  <span class='z'>** Words are either keywords or identifiers</span>
  <span class='z'>**</span>
  <span class='k'>private</span> TokenVal <span id='word'>word</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='y'>// store starting position of word</span>
    start := pos

    <span class='y'>// find end of word to compute length</span>
    <span class='k'>while</span> <span class='b'>(</span>cur.isAlphaNum || cur == <span class='s'>'_'</span><span class='b'>)</span> consume

    <span class='y'>// create Str (gc note this string might now reference buf)</span>
    word := buf<span class='b'>[</span>start..&lt;pos<span class='b'>]</span>

    <span class='y'>// check keywords</span>
    keyword := Token.keywords<span class='b'>[</span>word<span class='b'>]</span>
    <span class='k'>if</span> <span class='b'>(</span>keyword != <span class='k'>null</span><span class='b'>)</span>
      <span class='k'>return</span> TokenVal<span class='b'>(</span>keyword<span class='b'>)</span>

    <span class='y'>// otherwise this is a normal identifier</span>
    <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.identifier, word<span class='b'>)</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Number</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Parse a number literal token: int, float, decimal, or duration.</span>
  <span class='z'>**</span>
  <span class='k'>private</span> TokenVal <span id='number'>number</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='y'>// check for hex value</span>
    <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'0'</span> &amp;&amp; peek == <span class='s'>'x'</span><span class='b'>)</span>
      <span class='k'>return</span> hex

    <span class='y'>// find end of literal</span>
    start := pos
    dot   := <span class='k'>false</span>
    exp   := <span class='k'>false</span>

    <span class='y'>// whole part</span>
    <span class='k'>while</span> <span class='b'>(</span>cur.isDigit || cur == <span class='s'>'_'</span><span class='b'>)</span> consume

    <span class='y'>// fraction part</span>
    <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'.'</span> &amp;&amp; peek.isDigit<span class='b'>)</span>
    <span class='b'>{</span>
      dot = <span class='k'>true</span>
      consume
      <span class='k'>while</span> <span class='b'>(</span>cur.isDigit || cur == <span class='s'>'_'</span><span class='b'>)</span> consume
    <span class='b'>}</span>

    <span class='y'>// exponent</span>
    <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'e'</span> || cur == <span class='s'>'E'</span><span class='b'>)</span>
    <span class='b'>{</span>
      consume
      exp = <span class='k'>true</span>
      <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'-'</span> || cur == <span class='s'>'+'</span><span class='b'>)</span> consume
      <span class='k'>if</span> <span class='b'>(</span>!cur.isDigit<span class='b'>)</span> <span class='k'>throw</span> err<span class='b'>(</span><span class='s'>"Expected exponent digits"</span><span class='b'>)</span>
      <span class='k'>while</span> <span class='b'>(</span>cur.isDigit || cur == <span class='s'>'_'</span><span class='b'>)</span> consume
    <span class='b'>}</span>

    <span class='y'>// string value of literal</span>
    str := buf<span class='b'>[</span>start..&lt;pos<span class='b'>]</span>.replace<span class='b'>(</span><span class='s'>"_"</span>, <span class='s'>""</span><span class='b'>)</span>

    <span class='y'>// check for suffixes</span>
    floatSuffix   := <span class='k'>false</span>
    decimalSuffix := <span class='k'>false</span>
    Int? dur      := <span class='k'>null</span>
    <span class='k'>if</span> <span class='b'>(</span>cur.isLower &amp;&amp; peek.isLower<span class='b'>)</span>
    <span class='b'>{</span>
      <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'n'</span> &amp;&amp; peek == <span class='s'>'s'</span><span class='b'>)</span> <span class='b'>{</span> consume; consume; dur = 1 <span class='b'>}</span>
      <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'m'</span> &amp;&amp; peek == <span class='s'>'s'</span><span class='b'>)</span> <span class='b'>{</span> consume; consume; dur = 1000000 <span class='b'>}</span>
      <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'s'</span> &amp;&amp; peek == <span class='s'>'e'</span><span class='b'>)</span> <span class='b'>{</span> consume; consume; <span class='k'>if</span> <span class='b'>(</span>cur != <span class='s'>'c'</span><span class='b'>)</span> <span class='k'>throw</span> err<span class='b'>(</span><span class='s'>"Expected 'sec' in Duration literal"</span><span class='b'>)</span>; consume; dur = 1_000_000_000 <span class='b'>}</span>
      <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'m'</span> &amp;&amp; peek == <span class='s'>'i'</span><span class='b'>)</span> <span class='b'>{</span> consume; consume; <span class='k'>if</span> <span class='b'>(</span>cur != <span class='s'>'n'</span><span class='b'>)</span> <span class='k'>throw</span> err<span class='b'>(</span><span class='s'>"Expected 'min' in Duration literal"</span><span class='b'>)</span>; consume; dur = 60_000_000_000 <span class='b'>}</span>
      <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'h'</span> &amp;&amp; peek == <span class='s'>'r'</span><span class='b'>)</span> <span class='b'>{</span> consume; consume; dur = 3_600_000_000_000 <span class='b'>}</span>
      <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'d'</span> &amp;&amp; peek == <span class='s'>'a'</span><span class='b'>)</span> <span class='b'>{</span> consume; consume; <span class='k'>if</span> <span class='b'>(</span>cur != <span class='s'>'y'</span><span class='b'>)</span> <span class='k'>throw</span> err<span class='b'>(</span><span class='s'>"Expected 'day' in Duration literal"</span><span class='b'>)</span>; consume; dur = 86_400_000_000_000 <span class='b'>}</span>
    <span class='b'>}</span>
    <span class='k'>else</span> <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'f'</span> || cur == <span class='s'>'F'</span><span class='b'>)</span>
    <span class='b'>{</span>
      consume
      floatSuffix = <span class='k'>true</span>
    <span class='b'>}</span>
    <span class='k'>else</span> <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'d'</span> || cur == <span class='s'>'D'</span><span class='b'>)</span>
    <span class='b'>{</span>
      consume
      decimalSuffix = <span class='k'>true</span>
    <span class='b'>}</span>

    <span class='k'>try</span>
    <span class='b'>{</span>
      <span class='y'>// float literal</span>
      <span class='k'>if</span> <span class='b'>(</span>floatSuffix<span class='b'>)</span>
      <span class='b'>{</span>
        num := Float.fromStr<span class='b'>(</span>str<span class='b'>)</span>
        <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.floatLiteral, num<span class='b'>)</span>
      <span class='b'>}</span>

      <span class='y'>// decimal literal</span>
      <span class='k'>if</span> <span class='b'>(</span>decimalSuffix || dot || exp<span class='b'>)</span>
      <span class='b'>{</span>
        num := Decimal.fromStr<span class='b'>(</span>str<span class='b'>)</span>
        <span class='k'>if</span> <span class='b'>(</span>dur != <span class='k'>null</span><span class='b'>)</span>
          <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.durationLiteral, Duration<span class='b'>((</span>num*dur.toDecimal<span class='b'>)</span>.toInt<span class='b'>))</span>
        <span class='k'>else</span>
          <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.decimalLiteral, num<span class='b'>)</span>
      <span class='b'>}</span>

      <span class='y'>// int literal</span>
      num := Int.fromStr<span class='b'>(</span>str<span class='b'>)</span>
      <span class='k'>if</span> <span class='b'>(</span>dur != <span class='k'>null</span><span class='b'>)</span>
        <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.durationLiteral, Duration<span class='b'>(</span>num*dur<span class='b'>))</span>
      <span class='k'>else</span>
        <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.intLiteral, num<span class='b'>)</span>
    <span class='b'>}</span>
    <span class='k'>catch</span> <span class='b'>(</span>ParseErr e<span class='b'>)</span>
    <span class='b'>{</span>
      <span class='k'>throw</span> err<span class='b'>(</span><span class='s'>"Invalid numeric literal '$str'"</span><span class='b'>)</span>
    <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Process hex int/long literal starting with 0x</span>
  <span class='z'>**</span>
  TokenVal <span id='hex'>hex</span><span class='b'>()</span>
  <span class='b'>{</span>
    consume <span class='y'>// 0</span>
    consume <span class='y'>// x</span>

    <span class='y'>// read first hex</span>
    val := cur.fromDigit<span class='b'>(</span>16<span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>val == <span class='k'>null</span><span class='b'>)</span> <span class='k'>throw</span> err<span class='b'>(</span><span class='s'>"Expecting hex number"</span><span class='b'>)</span>
    consume
    Int nibCount := 1
    <span class='k'>while</span> <span class='b'>(</span><span class='k'>true</span><span class='b'>)</span>
    <span class='b'>{</span>
      nib := cur.fromDigit<span class='b'>(</span>16<span class='b'>)</span>
      <span class='k'>if</span> <span class='b'>(</span>nib == <span class='k'>null</span><span class='b'>)</span>
      <span class='b'>{</span>
        <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'_'</span><span class='b'>)</span> <span class='b'>{</span> consume; <span class='k'>continue</span> <span class='b'>}</span>
        <span class='k'>break</span>
      <span class='b'>}</span>
      nibCount++
      <span class='k'>if</span> <span class='b'>(</span>nibCount &gt; 16<span class='b'>)</span> <span class='k'>throw</span> err<span class='b'>(</span><span class='s'>"Hex literal too big"</span><span class='b'>)</span>
      val = val.shiftl<span class='b'>(</span>4<span class='b'>)</span> + nib;
      consume
    <span class='b'>}</span>

    <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.intLiteral, val<span class='b'>)</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Quoted Literals</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Parse a quoted literal token: normal, triple, or uri</span>
  <span class='z'>** Opening quote must already be consumed.</span>
  <span class='z'>**</span>
  <span class='k'>private</span> TokenVal? <span id='quoted'>quoted</span><span class='b'>(</span>Quoted q<span class='b'>)</span>
  <span class='b'>{</span>
    inStrLiteral = <span class='k'>true</span>
    <span class='k'>try</span>
    <span class='b'>{</span>
      <span class='y'>// opening quote</span>
      line := <span class='k'>this</span>.line
      col := <span class='k'>this</span>.col
      consume
      <span class='k'>if</span> <span class='b'>(</span>q.isTriple<span class='b'>)</span> <span class='b'>{</span> consume; consume <span class='b'>}</span>

      <span class='y'>// init starting position</span>
      openLine := posOfLine
      openPos  := pos
      multiLineOk := <span class='k'>true</span>
      s := StrBuf<span class='b'>()</span>
      interpolated := <span class='k'>false</span>

      <span class='y'>// loop until we find end of string</span>
      <span class='k'>while</span> <span class='b'>(</span><span class='k'>true</span><span class='b'>)</span>
      <span class='b'>{</span>
        <span class='k'>if</span> <span class='b'>(</span>cur == 0<span class='b'>)</span> <span class='k'>throw</span> err<span class='b'>(</span><span class='s'>"Unexpected end of $q"</span><span class='b'>)</span>

        <span class='k'>if</span> <span class='b'>(</span>endOfQuoted<span class='b'>(</span>q<span class='b'>))</span> <span class='k'>break</span>

        <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'\n'</span><span class='b'>)</span>
        <span class='b'>{</span>
          <span class='k'>if</span> <span class='b'>(</span>!q.multiLine<span class='b'>)</span> <span class='k'>throw</span> err<span class='b'>(</span><span class='s'>"Unexpected end of $q"</span><span class='b'>)</span>
          s.addChar<span class='b'>(</span>cur<span class='b'>)</span>
          consume
          <span class='k'>if</span> <span class='b'>(</span>multiLineOk<span class='b'>)</span> multiLineOk = skipStrWs<span class='b'>(</span>openLine, openPos<span class='b'>)</span>
          <span class='k'>continue</span>
        <span class='b'>}</span>

        <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'$'</span><span class='b'>)</span>
        <span class='b'>{</span>
          <span class='y'>// if we have detected an interpolated string, then</span>
          <span class='y'>// insert opening paren to treat whole string atomically</span>
          <span class='k'>if</span> <span class='b'>(</span>!interpolated<span class='b'>)</span>
          <span class='b'>{</span>
            interpolated = <span class='k'>true</span>
            tokens.add<span class='b'>(</span>makeVirtualToken<span class='b'>(</span>line, col, Token.lparenSynthetic, <span class='k'>null</span><span class='b'>))</span>
          <span class='b'>}</span>

          <span class='y'>// process interpolated string, it returns null</span>
          <span class='y'>// if at end of string literal</span>
          <span class='k'>if</span> <span class='b'>(</span>!interpolation<span class='b'>(</span>line, col, s.toStr, q<span class='b'>))</span>
          <span class='b'>{</span>
            line = <span class='k'>this</span>.line; col = <span class='k'>this</span>.col - 1;  <span class='y'>// before quote</span>
            tokens.add<span class='b'>(</span>makeVirtualToken<span class='b'>(</span>line, col, Token.rparen, <span class='k'>null</span><span class='b'>))</span>
            <span class='k'>if</span> <span class='b'>(</span>q.isUri<span class='b'>)</span>
            <span class='b'>{</span>
              tokens.add<span class='b'>(</span>makeVirtualToken<span class='b'>(</span>line, col, Token.dot<span class='b'>))</span>
              tokens.add<span class='b'>(</span>makeVirtualToken<span class='b'>(</span>line, col, Token.identifier, <span class='s'>"toUri"</span><span class='b'>))</span>
            <span class='b'>}</span>
            <span class='k'>return</span> <span class='k'>null</span>
          <span class='b'>}</span>
          line = <span class='k'>this</span>.line; col = <span class='k'>this</span>.col

          s.clear
        <span class='b'>}</span>
        <span class='k'>else</span> <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'\\'</span><span class='b'>)</span>
        <span class='b'>{</span>
          <span class='k'>if</span> <span class='b'>(</span>q.isUri<span class='b'>)</span>
          <span class='b'>{</span>
            <span class='k'>switch</span> <span class='b'>(</span>peek<span class='b'>)</span>
            <span class='b'>{</span>
              <span class='k'>case</span> <span class='s'>':'</span>: <span class='k'>case</span> <span class='s'>'/'</span>: <span class='k'>case</span> <span class='s'>'?'</span>: <span class='k'>case</span> <span class='s'>'#'</span>:
              <span class='k'>case</span> <span class='s'>'['</span>: <span class='k'>case</span> <span class='s'>']'</span>: <span class='k'>case</span> <span class='s'>'@'</span>: <span class='k'>case</span> <span class='s'>'\\'</span>:
              <span class='k'>case</span> <span class='s'>'&amp;'</span>: <span class='k'>case</span> <span class='s'>'='</span>: <span class='k'>case</span> <span class='s'>';'</span>:
                s.addChar<span class='b'>(</span>cur<span class='b'>)</span>.addChar<span class='b'>(</span>peek<span class='b'>)</span>
                consume
                consume
              <span class='k'>default</span>:
                s.addChar<span class='b'>(</span>escape<span class='b'>)</span>
            <span class='b'>}</span>
          <span class='b'>}</span>
          <span class='k'>else</span>
          <span class='b'>{</span>
            s.addChar<span class='b'>(</span>escape<span class='b'>)</span>
          <span class='b'>}</span>
        <span class='b'>}</span>
        <span class='k'>else</span>
        <span class='b'>{</span>
          s.addChar<span class='b'>(</span>cur<span class='b'>)</span>
          consume
        <span class='b'>}</span>
      <span class='b'>}</span>

      <span class='y'>// if interpolated then we add rparen to treat whole atomically,</span>
      <span class='y'>// and if URI, then add call to Uri</span>
      <span class='k'>if</span> <span class='b'>(</span>interpolated<span class='b'>)</span>
      <span class='b'>{</span>
        tokens.add<span class='b'>(</span>makeVirtualToken<span class='b'>(</span>line, col, Token.strLiteral, s.toStr<span class='b'>))</span>
        line = <span class='k'>this</span>.line; col = <span class='k'>this</span>.col - 1;  <span class='y'>// before quote</span>
        tokens.add<span class='b'>(</span>makeVirtualToken<span class='b'>(</span>line, col, Token.rparen, <span class='k'>null</span><span class='b'>))</span>
        <span class='k'>if</span> <span class='b'>(</span>q.isUri<span class='b'>)</span>
        <span class='b'>{</span>
          tokens.add<span class='b'>(</span>makeVirtualToken<span class='b'>(</span>line, col, Token.dot, <span class='k'>null</span><span class='b'>))</span>
          tokens.add<span class='b'>(</span>makeVirtualToken<span class='b'>(</span>line, col, Token.identifier, <span class='s'>"toUri"</span><span class='b'>))</span>
        <span class='b'>}</span>
        <span class='k'>return</span> <span class='k'>null</span>
      <span class='b'>}</span>
      <span class='k'>else</span>
      <span class='b'>{</span>
        <span class='k'>if</span> <span class='b'>(</span>q.isUri<span class='b'>)</span>
          <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.uriLiteral, s.toStr<span class='b'>)</span>
        <span class='k'>else</span>
          <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.strLiteral, s.toStr<span class='b'>)</span>
      <span class='b'>}</span>
    <span class='b'>}</span>
    <span class='k'>finally</span>
    <span class='b'>{</span>
      inStrLiteral = <span class='k'>false</span>
    <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Leading white space in a multi-line string is assumed</span>
  <span class='z'>** to be outside of the string literal.  If there is an</span>
  <span class='z'>** non-whitespace char, then it is an compile time error.</span>
  <span class='z'>** Return true if ok, false on error.</span>
  <span class='z'>**</span>
  <span class='k'>private</span> Bool <span id='skipStrWs'>skipStrWs</span><span class='b'>(</span>Int openLine, Int openPos<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>for</span> <span class='b'>(</span>i:=openLine; i&lt;openPos; ++i<span class='b'>)</span>
    <span class='b'>{</span>
      a := buf<span class='b'>[</span>i<span class='b'>]</span>
      <span class='k'>if</span> <span class='b'>((</span>a == <span class='s'>'\t'</span> &amp;&amp; cur != <span class='s'>'\t'</span><span class='b'>)</span> || <span class='b'>(</span>a != <span class='s'>'\t'</span> &amp;&amp; cur != <span class='s'>' '</span><span class='b'>))</span>
      <span class='b'>{</span>
        <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'\n'</span><span class='b'>)</span> <span class='k'>return</span> <span class='k'>true</span>
        numTabs := 0; numSpaces := 0
        <span class='k'>for</span> <span class='b'>(</span>j:=openLine; j&lt;openPos; ++j<span class='b'>)</span>
          <span class='b'>{</span> <span class='k'>if</span> <span class='b'>(</span>buf<span class='b'>[</span>j<span class='b'>]</span> == <span class='s'>'\t'</span><span class='b'>)</span> ++numTabs; <span class='k'>else</span> ++numSpaces <span class='b'>}</span>
        <span class='k'>if</span> <span class='b'>(</span>numTabs == 0<span class='b'>)</span>
          err<span class='b'>(</span><span class='s'>"Leading space in multi-line Str must be $numSpaces spaces"</span><span class='b'>)</span>
        <span class='k'>else</span>
          err<span class='b'>(</span><span class='s'>"Leading space in multi-line Str must be $numTabs tabs and $numSpaces spaces"</span><span class='b'>)</span>
        <span class='k'>return</span> <span class='k'>false</span>
      <span class='b'>}</span>
      consume
    <span class='b'>}</span>
    <span class='k'>return</span> <span class='k'>true</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** When we hit a $ inside a string it indicates an embedded</span>
  <span class='z'>** expression.  We make this look like a stream of tokens</span>
  <span class='z'>** such that:</span>
  <span class='z'>**   "a ${b} c" -&gt; "a " + b + " c"</span>
  <span class='z'>**   "a $&lt;b&gt; c" -&gt; "a " + LocaleExpr("b") + " c"</span>
  <span class='z'>** Return true if more in the string literal.</span>
  <span class='z'>**</span>
  <span class='k'>private</span> Bool <span id='interpolation'>interpolation</span><span class='b'>(</span>Int line, Int col, Str s, Quoted q<span class='b'>)</span>
  <span class='b'>{</span>
    consume <span class='y'>// $</span>
    tokens.add<span class='b'>(</span>makeVirtualToken<span class='b'>(</span>line, col, Token.strLiteral, s<span class='b'>))</span>
    line = <span class='k'>this</span>.line; col = <span class='k'>this</span>.col
    tokens.add<span class='b'>(</span>makeVirtualToken<span class='b'>(</span>line, col, Token.plus<span class='b'>))</span>

    <span class='y'>// if { we allow an expression b/w {...}</span>
    <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'{'</span><span class='b'>)</span>
    <span class='b'>{</span>
      line = <span class='k'>this</span>.line; col = <span class='k'>this</span>.col
      tokens.add<span class='b'>(</span>makeVirtualToken<span class='b'>(</span>line, col, Token.lparenSynthetic<span class='b'>))</span>
      consume
      <span class='k'>while</span> <span class='b'>(</span><span class='k'>true</span><span class='b'>)</span>
      <span class='b'>{</span>
        <span class='k'>if</span> <span class='b'>(</span>endOfQuoted<span class='b'>(</span>q<span class='b'>)</span> || cur == 0<span class='b'>)</span> <span class='k'>throw</span> err<span class='b'>(</span><span class='s'>"Unexpected end of $q, missing }"</span><span class='b'>)</span>
        tok := next
        <span class='k'>if</span> <span class='b'>(</span>tok.kind == Token.rbrace<span class='b'>)</span> <span class='k'>break</span>
        tokens.add<span class='b'>(</span>tok<span class='b'>)</span>
      <span class='b'>}</span>
      line = <span class='k'>this</span>.line; col = <span class='k'>this</span>.col
      tokens.add<span class='b'>(</span>makeVirtualToken<span class='b'>(</span>line, col, Token.rparen<span class='b'>))</span>
    <span class='b'>}</span>

    <span class='y'>// if &lt; this is a localized literal &lt;xxxx&gt;</span>
    <span class='k'>else</span> <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'&lt;'</span><span class='b'>)</span>
    <span class='b'>{</span>
      line = <span class='k'>this</span>.line; col = <span class='k'>this</span>.col
      tokens.add<span class='b'>(</span>makeVirtualToken<span class='b'>(</span>line, col, Token.lparenSynthetic<span class='b'>))</span>
      consume
      buf := StrBuf<span class='b'>()</span>
      <span class='k'>while</span> <span class='b'>(</span><span class='k'>true</span><span class='b'>)</span>
      <span class='b'>{</span>
        <span class='k'>if</span> <span class='b'>(</span>endOfQuoted<span class='b'>(</span>q<span class='b'>)</span> || cur == 0<span class='b'>)</span> <span class='k'>throw</span> err<span class='b'>(</span><span class='s'>"Unexpected end of $q, missing &gt;"</span><span class='b'>)</span>
        <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'\n'</span><span class='b'>)</span> <span class='k'>throw</span> err<span class='b'>(</span><span class='s'>"Unexpected newline, missing &gt;"</span><span class='b'>)</span>
        <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'&gt;'</span><span class='b'>)</span> <span class='k'>break</span>
        buf.addChar<span class='b'>(</span>cur<span class='b'>)</span>
        consume
      <span class='b'>}</span>
      consume

      tok := TokenVal<span class='b'>(</span>Token.localeLiteral, buf.toStr<span class='b'>)</span>
      tok.file = filename
      tok.line = line
      tok.col  = col
      tokens.add<span class='b'>(</span>tok<span class='b'>)</span>

      line = <span class='k'>this</span>.line; col = <span class='k'>this</span>.col
      tokens.add<span class='b'>(</span>makeVirtualToken<span class='b'>(</span>line, col, Token.rparen<span class='b'>))</span>
    <span class='b'>}</span>

    <span class='y'>// else also allow a single identifier with</span>
    <span class='y'>// dotted accessors x, x.y, x.y.z</span>
    <span class='k'>else</span>
    <span class='b'>{</span>
      tok := next
      <span class='k'>if</span> <span class='b'>(</span>tok.kind !== Token.identifier &amp;&amp;
          tok.kind !== Token.thisKeyword &amp;&amp;
          tok.kind !== Token.superKeyword &amp;&amp;
          tok.kind !== Token.itKeyword<span class='b'>)</span>
        <span class='k'>throw</span> err<span class='b'>(</span><span class='s'>"Expected identifier after \$"</span><span class='b'>)</span>
      tokens.add<span class='b'>(</span>tok<span class='b'>)</span>
      <span class='k'>while</span> <span class='b'>(</span><span class='k'>true</span><span class='b'>)</span>
      <span class='b'>{</span>
        <span class='k'>if</span> <span class='b'>(</span>cur != <span class='s'>'.'</span><span class='b'>)</span> <span class='k'>break</span>
        tokens.add<span class='b'>(</span>next<span class='b'>)</span> <span class='y'>// dot</span>
        tok = next
        <span class='k'>if</span> <span class='b'>(</span>tok.kind !== Token.identifier<span class='b'>)</span> <span class='k'>throw</span> err<span class='b'>(</span><span class='s'>"Expected identifier"</span><span class='b'>)</span>
        tokens.add<span class='b'>(</span>tok<span class='b'>)</span>
      <span class='b'>}</span>
    <span class='b'>}</span>

    <span class='y'>// if at end of string, all done</span>
    <span class='k'>if</span> <span class='b'>(</span>endOfQuoted<span class='b'>(</span>q<span class='b'>))</span> <span class='k'>return</span> <span class='k'>false</span>

    <span class='y'>// add plus and return true to keep chugging</span>
    line = <span class='k'>this</span>.line; col = <span class='k'>this</span>.col
    tokens.add<span class='b'>(</span>makeVirtualToken<span class='b'>(</span>line, col, Token.plus<span class='b'>))</span>
    <span class='k'>return</span> <span class='k'>true</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** If at end of quoted literal consume the</span>
  <span class='z'>** ending token(s) and return true.</span>
  <span class='z'>**</span>
  <span class='k'>private</span> Bool <span id='endOfQuoted'>endOfQuoted</span><span class='b'>(</span>Quoted q<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>switch</span> <span class='b'>(</span>q<span class='b'>)</span>
    <span class='b'>{</span>
      <span class='k'>case</span> Quoted.normal:
        <span class='k'>if</span> <span class='b'>(</span>cur != <span class='s'>'"'</span><span class='b'>)</span> <span class='k'>return</span> <span class='k'>false</span>
        consume; <span class='k'>return</span> <span class='k'>true</span>

      <span class='k'>case</span> Quoted.triple:
        <span class='k'>if</span> <span class='b'>(</span>cur != <span class='s'>'"'</span> || peek != <span class='s'>'"'</span> || peekPeek != <span class='s'>'"'</span><span class='b'>)</span> <span class='k'>return</span> <span class='k'>false</span>
        consume; consume; consume; <span class='k'>return</span> <span class='k'>true</span>

      <span class='k'>case</span> Quoted.uri:
        <span class='k'>if</span> <span class='b'>(</span>cur != <span class='s'>'`'</span><span class='b'>)</span> <span class='k'>return</span> <span class='k'>false</span>
        consume; <span class='k'>return</span> <span class='k'>true</span>

      <span class='k'>default</span>:
        <span class='k'>throw</span> Err<span class='b'>(</span>q.toStr<span class='b'>)</span>
    <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Create a virtual token for string interpolation.</span>
  <span class='z'>**</span>
  <span class='k'>private</span> TokenVal <span id='makeVirtualToken'>makeVirtualToken</span><span class='b'>(</span>Int line, Int col, Token kind, Obj? value := <span class='k'>null</span><span class='b'>)</span>
  <span class='b'>{</span>
    tok := TokenVal<span class='b'>(</span>kind, value<span class='b'>)</span>
    tok.file  = filename
    tok.line  = line
    tok.col   = col
    <span class='k'>return</span> tok
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Char</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Parse a char literal token.</span>
  <span class='z'>**</span>
  <span class='k'>private</span> TokenVal <span id='ch'>ch</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='y'>// consume opening quote</span>
    consume

    <span class='y'>// if \ then process as escape</span>
    c := -1
    <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'\\'</span><span class='b'>)</span>
    <span class='b'>{</span>
      c = escape
    <span class='b'>}</span>
    <span class='k'>else</span>
    <span class='b'>{</span>
      c = cur
      consume
    <span class='b'>}</span>

    <span class='y'>// expecting ' quote</span>
    <span class='k'>if</span> <span class='b'>(</span>cur != <span class='s'>'\''</span><span class='b'>)</span> <span class='k'>throw</span> err<span class='b'>(</span><span class='s'>"Expecting ' close of char literal"</span><span class='b'>)</span>
    consume

    <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.intLiteral, c<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Parse an escapse sequence which starts with a \</span>
  <span class='z'>**</span>
  Int <span id='escape'>escape</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='y'>// consume slash</span>
    <span class='k'>if</span> <span class='b'>(</span>cur != <span class='s'>'\\'</span><span class='b'>)</span> <span class='k'>throw</span> err<span class='b'>(</span><span class='s'>"Internal error"</span><span class='b'>)</span>
    consume

    <span class='y'>// check basics</span>
    <span class='k'>switch</span> <span class='b'>(</span>cur<span class='b'>)</span>
    <span class='b'>{</span>
      <span class='k'>case</span> <span class='s'>'b'</span>:   consume; <span class='k'>return</span> <span class='s'>'\b'</span>
      <span class='k'>case</span> <span class='s'>'f'</span>:   consume; <span class='k'>return</span> <span class='s'>'\f'</span>
      <span class='k'>case</span> <span class='s'>'n'</span>:   consume; <span class='k'>return</span> <span class='s'>'\n'</span>
      <span class='k'>case</span> <span class='s'>'r'</span>:   consume; <span class='k'>return</span> <span class='s'>'\r'</span>
      <span class='k'>case</span> <span class='s'>'t'</span>:   consume; <span class='k'>return</span> <span class='s'>'\t'</span>
      <span class='k'>case</span> <span class='s'>'"'</span>:   consume; <span class='k'>return</span> <span class='s'>'"'</span>
      <span class='k'>case</span> <span class='s'>'$'</span>:   consume; <span class='k'>return</span> <span class='s'>'$'</span>
      <span class='k'>case</span> <span class='s'>'\''</span>:  consume; <span class='k'>return</span> <span class='s'>'\''</span>
      <span class='k'>case</span> <span class='s'>'`'</span>:   consume; <span class='k'>return</span> <span class='s'>'`'</span>
      <span class='k'>case</span> <span class='s'>'\\'</span>:  consume; <span class='k'>return</span> <span class='s'>'\\'</span>
    <span class='b'>}</span>

    <span class='y'>// check for uxxxx</span>
    <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'u'</span><span class='b'>)</span>
    <span class='b'>{</span>
      consume
      n3 := cur.fromDigit<span class='b'>(</span>16<span class='b'>)</span>; consume
      n2 := cur.fromDigit<span class='b'>(</span>16<span class='b'>)</span>; consume
      n1 := cur.fromDigit<span class='b'>(</span>16<span class='b'>)</span>; consume
      n0 := cur.fromDigit<span class='b'>(</span>16<span class='b'>)</span>; consume
      <span class='k'>if</span> <span class='b'>(</span>n3 == <span class='k'>null</span> || n2 == <span class='k'>null</span> || n1 == <span class='k'>null</span> || n0 == <span class='k'>null</span><span class='b'>)</span> <span class='k'>throw</span> err<span class='b'>(</span><span class='s'>"Invalid hex value for \\uxxxx"</span><span class='b'>)</span>
      <span class='k'>return</span> n3.shiftl<span class='b'>(</span>12<span class='b'>)</span>.or<span class='b'>(</span>n2.shiftl<span class='b'>(</span>8<span class='b'>))</span>.or<span class='b'>(</span>n1.shiftl<span class='b'>(</span>4<span class='b'>))</span>.or<span class='b'>(</span>n0<span class='b'>)</span>
    <span class='b'>}</span>

    <span class='k'>throw</span> err<span class='b'>(</span><span class='s'>"Invalid escape sequence"</span><span class='b'>)</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// DSL</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Parse a domain specific language &lt;| ... |&gt;</span>
  <span class='z'>**</span>
  <span class='k'>private</span> TokenVal <span id='dsl'>dsl</span><span class='b'>()</span>
  <span class='b'>{</span>
    consume <span class='y'>// &lt;</span>
    consume <span class='y'>// |</span>

    <span class='y'>// compute leading tabs/spaces</span>
    leadingTabs := 0
    leadingSpaces := 0
    <span class='k'>for</span> <span class='b'>(</span>i:=posOfLine; i&lt;pos; ++i<span class='b'>)</span>
      <span class='k'>if</span> <span class='b'>(</span>buf<span class='b'>[</span>i<span class='b'>]</span> == <span class='s'>'\t'</span><span class='b'>)</span> leadingTabs++; <span class='k'>else</span> leadingSpaces++

    <span class='y'>// loop until we find end of DSL</span>
    s := StrBuf<span class='b'>()</span>
    <span class='k'>while</span> <span class='b'>(</span><span class='k'>true</span><span class='b'>)</span>
    <span class='b'>{</span>
      <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'|'</span> &amp;&amp; peek == <span class='s'>'&gt;'</span><span class='b'>)</span> <span class='k'>break</span>
      <span class='k'>if</span> <span class='b'>(</span>cur == 0<span class='b'>)</span> <span class='k'>throw</span> err<span class='b'>(</span><span class='s'>"Unexpected end of DSL"</span><span class='b'>)</span>
      s.addChar<span class='b'>(</span>cur<span class='b'>)</span>
      consume
    <span class='b'>}</span>

    consume <span class='y'>// |</span>
    consume <span class='y'>// &gt;</span>

    <span class='k'>return</span> TokenValDsl<span class='b'>(</span>Token.dsl, s.toStr, leadingTabs, leadingSpaces<span class='b'>)</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Comments</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Skip a single line // comment</span>
  <span class='z'>**</span>
  <span class='k'>private</span> TokenVal? <span id='skipCommentSL'>skipCommentSL</span><span class='b'>()</span>
  <span class='b'>{</span>
    consume  <span class='y'>// first slash</span>
    consume  <span class='y'>// next slash</span>
    <span class='k'>while</span> <span class='b'>(</span><span class='k'>true</span><span class='b'>)</span>
    <span class='b'>{</span>
      <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'\n'</span><span class='b'>)</span> <span class='b'>{</span> consume; <span class='k'>break</span> <span class='b'>}</span>
      <span class='k'>if</span> <span class='b'>(</span>cur == 0<span class='b'>)</span> <span class='k'>break</span>
      consume
    <span class='b'>}</span>
    <span class='k'>return</span> <span class='k'>null</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Skip a multi line /* comment.  Note unlike C/Java,</span>
  <span class='z'>** slash/star comments can be nested.</span>
  <span class='z'>**</span>
  <span class='k'>private</span> TokenVal? <span id='skipCommentML'>skipCommentML</span><span class='b'>()</span>
  <span class='b'>{</span>
    consume   <span class='y'>// first slash</span>
    consume   <span class='y'>// next slash</span>
    depth := 1
    <span class='k'>while</span> <span class='b'>(</span><span class='k'>true</span><span class='b'>)</span>
    <span class='b'>{</span>
      <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'*'</span> &amp;&amp; peek == <span class='s'>'/'</span><span class='b'>)</span> <span class='b'>{</span> consume; consume; depth--; <span class='k'>if</span> <span class='b'>(</span>depth &lt;= 0<span class='b'>)</span> <span class='k'>break</span> <span class='b'>}</span>
      <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'/'</span> &amp;&amp; peek == <span class='s'>'*'</span><span class='b'>)</span> <span class='b'>{</span> consume; consume; depth++; <span class='k'>continue</span> <span class='b'>}</span>
      <span class='k'>if</span> <span class='b'>(</span>cur == 0<span class='b'>)</span> <span class='k'>break</span>
      consume
    <span class='b'>}</span>
    <span class='k'>return</span> <span class='k'>null</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Parse a Javadoc style comment into a documentation comment token.</span>
  <span class='z'>**</span>
  <span class='k'>private</span> TokenVal? <span id='docComment'>docComment</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='y'>// if doc is off, then just skip the line and be done</span>
    <span class='k'>if</span> <span class='b'>(</span>!isDoc<span class='b'>)</span> <span class='b'>{</span> skipCommentSL; <span class='k'>return</span> <span class='k'>null</span> <span class='b'>}</span>

    <span class='k'>while</span> <span class='b'>(</span>cur == <span class='s'>'*'</span><span class='b'>)</span> consume
    <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>' '</span><span class='b'>)</span> consume

    <span class='y'>// parse comment</span>
    lines := Str<span class='b'>[</span>,<span class='b'>]</span>
    s := StrBuf<span class='b'>()</span>
    <span class='k'>while</span> <span class='b'>(</span>cur &gt; 0<span class='b'>)</span>
    <span class='b'>{</span>
      <span class='y'>// add to buffer and advance</span>
      c := cur
      consume

      <span class='y'>// if not at newline, then loop</span>
      <span class='k'>if</span> <span class='b'>(</span>c != <span class='s'>'\n'</span><span class='b'>)</span>
      <span class='b'>{</span>
        s.addChar<span class='b'>(</span>c<span class='b'>)</span>
        <span class='k'>continue</span>
      <span class='b'>}</span>

      <span class='y'>// add line and reset buffer (but don't add leading empty lines)</span>
      line := s.toStr
      <span class='k'>if</span> <span class='b'>(</span>!lines.isEmpty || !line.trim.isEmpty<span class='b'>)</span> lines.add<span class='b'>(</span>line<span class='b'>)</span>
      s.clear

      <span class='y'>// we at a newline, check for leading whitespace(0+)/star(2+)/whitespace(1)</span>
      <span class='k'>while</span> <span class='b'>(</span>cur == <span class='s'>' '</span> || cur == <span class='s'>'\t'</span><span class='b'>)</span> consume
      <span class='k'>if</span> <span class='b'>(</span>cur != <span class='s'>'*'</span> || peek != <span class='s'>'*'</span><span class='b'>)</span> <span class='k'>break</span>
      <span class='k'>while</span> <span class='b'>(</span>cur == <span class='s'>'*'</span><span class='b'>)</span> consume
      <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>' '</span> || cur == <span class='s'>'\t'</span><span class='b'>)</span> consume
    <span class='b'>}</span>
    lines.add<span class='b'>(</span>s.toStr<span class='b'>)</span>

    <span class='y'>// strip trailing empty lines</span>
    <span class='k'>while</span> <span class='b'>(</span>!lines.isEmpty<span class='b'>)</span>
      <span class='k'>if</span> <span class='b'>(</span>lines.last.trim.isEmpty<span class='b'>)</span> lines.removeAt<span class='b'>(</span>-1<span class='b'>)</span>
      <span class='k'>else</span> <span class='k'>break</span>

    <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.docComment, lines<span class='b'>)</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Symbol</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Parse a symbol token (typically into an operator).</span>
  <span class='z'>**</span>
  <span class='k'>private</span> TokenVal <span id='symbol'>symbol</span><span class='b'>()</span>
  <span class='b'>{</span>
    c := cur
    consume
    <span class='k'>switch</span> <span class='b'>(</span>c<span class='b'>)</span>
    <span class='b'>{</span>
      <span class='k'>case</span> <span class='s'>'\r'</span>:
        <span class='k'>throw</span> err<span class='b'>(</span><span class='s'>"Carriage return \\r not allowed in source"</span><span class='b'>)</span>
      <span class='k'>case</span> <span class='s'>'!'</span>:
        <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'='</span><span class='b'>)</span>
        <span class='b'>{</span>
          consume
          <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'='</span><span class='b'>)</span> <span class='b'>{</span> consume; <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.notSame<span class='b'>)</span> <span class='b'>}</span>
          <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.notEq<span class='b'>)</span>
        <span class='b'>}</span>
        <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.bang<span class='b'>)</span>
      <span class='k'>case</span> <span class='s'>'#'</span>:
        <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.pound<span class='b'>)</span>
      <span class='k'>case</span> <span class='s'>'%'</span>:
        <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'='</span><span class='b'>)</span> <span class='b'>{</span> consume; <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.assignPercent<span class='b'>)</span> <span class='b'>}</span>
        <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.percent<span class='b'>)</span>
      <span class='k'>case</span> <span class='s'>'&amp;'</span>:
        <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'&amp;'</span><span class='b'>)</span> <span class='b'>{</span> consume; <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.doubleAmp<span class='b'>)</span> <span class='b'>}</span>
        <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.amp<span class='b'>)</span>
      <span class='k'>case</span> <span class='s'>'('</span>:
        <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.lparen<span class='b'>)</span>
      <span class='k'>case</span> <span class='s'>')'</span>:
        <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.rparen<span class='b'>)</span>
      <span class='k'>case</span> <span class='s'>'*'</span>:
        <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'='</span><span class='b'>)</span> <span class='b'>{</span> consume; <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.assignStar<span class='b'>)</span> <span class='b'>}</span>
        <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.star<span class='b'>)</span>
      <span class='k'>case</span> <span class='s'>'+'</span>:
        <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'='</span><span class='b'>)</span> <span class='b'>{</span> consume; <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.assignPlus<span class='b'>)</span> <span class='b'>}</span>
        <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'+'</span><span class='b'>)</span> <span class='b'>{</span> consume; <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.increment<span class='b'>)</span> <span class='b'>}</span>
        <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.plus<span class='b'>)</span>
      <span class='k'>case</span> <span class='s'>','</span>:
        <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.comma<span class='b'>)</span>
      <span class='k'>case</span> <span class='s'>'-'</span>:
        <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'&gt;'</span><span class='b'>)</span> <span class='b'>{</span> consume; <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.arrow<span class='b'>)</span> <span class='b'>}</span>
        <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'-'</span><span class='b'>)</span> <span class='b'>{</span> consume; <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.decrement<span class='b'>)</span> <span class='b'>}</span>
        <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'='</span><span class='b'>)</span> <span class='b'>{</span> consume; <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.assignMinus<span class='b'>)</span> <span class='b'>}</span>
        <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.minus<span class='b'>)</span>
      <span class='k'>case</span> <span class='s'>'.'</span>:
        <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'.'</span><span class='b'>)</span>
        <span class='b'>{</span>
          consume
          <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'&lt;'</span><span class='b'>)</span> <span class='b'>{</span> consume; <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.dotDotLt<span class='b'>)</span> <span class='b'>}</span>
          <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.dotDot<span class='b'>)</span>
        <span class='b'>}</span>
        <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.dot<span class='b'>)</span>
      <span class='k'>case</span> <span class='s'>'/'</span>:
        <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'='</span><span class='b'>)</span> <span class='b'>{</span> consume; <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.assignSlash<span class='b'>)</span> <span class='b'>}</span>
        <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.slash<span class='b'>)</span>
      <span class='k'>case</span> <span class='s'>':'</span>:
        <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>':'</span><span class='b'>)</span> <span class='b'>{</span> consume; <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.doubleColon<span class='b'>)</span> <span class='b'>}</span>
        <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'='</span><span class='b'>)</span> <span class='b'>{</span> consume; <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.defAssign<span class='b'>)</span> <span class='b'>}</span>
        <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.colon<span class='b'>)</span>
      <span class='k'>case</span> <span class='s'>';'</span>:
        <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.semicolon<span class='b'>)</span>
      <span class='k'>case</span> <span class='s'>'&lt;'</span>:
        <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'='</span><span class='b'>)</span>
        <span class='b'>{</span>
          consume
          <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'&gt;'</span><span class='b'>)</span> <span class='b'>{</span> consume; <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.cmp<span class='b'>)</span> <span class='b'>}</span>
          <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.ltEq<span class='b'>)</span>
        <span class='b'>}</span>
        <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.lt<span class='b'>)</span>
      <span class='k'>case</span> <span class='s'>'='</span>:
        <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'='</span><span class='b'>)</span>
        <span class='b'>{</span>
          consume
          <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'='</span><span class='b'>)</span> <span class='b'>{</span> consume; <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.same<span class='b'>)</span> <span class='b'>}</span>
          <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.eq<span class='b'>)</span>
        <span class='b'>}</span>
        <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.assign<span class='b'>)</span>
      <span class='k'>case</span> <span class='s'>'&gt;'</span>:
        <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'='</span><span class='b'>)</span> <span class='b'>{</span> consume; <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.gtEq<span class='b'>)</span> <span class='b'>}</span>
        <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.gt<span class='b'>)</span>
      <span class='k'>case</span> <span class='s'>'?'</span>:
        <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>':'</span><span class='b'>)</span> <span class='b'>{</span> consume; <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.elvis<span class='b'>)</span> <span class='b'>}</span>
        <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'.'</span><span class='b'>)</span> <span class='b'>{</span> consume; <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.safeDot<span class='b'>)</span> <span class='b'>}</span>
        <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'-'</span><span class='b'>)</span>
        <span class='b'>{</span>
          consume
          <span class='k'>if</span> <span class='b'>(</span>cur != <span class='s'>'&gt;'</span><span class='b'>)</span> <span class='k'>throw</span> err<span class='b'>(</span><span class='s'>"Expected '?-&gt;' symbol"</span><span class='b'>)</span>
          consume
          <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.safeArrow<span class='b'>)</span>
        <span class='b'>}</span>
        <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.question<span class='b'>)</span>
      <span class='k'>case</span> <span class='s'>'@'</span>:
        <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.at<span class='b'>)</span>
      <span class='k'>case</span> <span class='s'>'['</span>:
        <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.lbracket<span class='b'>)</span>
      <span class='k'>case</span> <span class='s'>']'</span>:
        <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.rbracket<span class='b'>)</span>
      <span class='k'>case</span> <span class='s'>'^'</span>:
        <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.caret<span class='b'>)</span>
      <span class='k'>case</span> <span class='s'>'{'</span>:
        <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.lbrace<span class='b'>)</span>
      <span class='k'>case</span> <span class='s'>'|'</span>:
        <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'|'</span><span class='b'>)</span> <span class='b'>{</span> consume; <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.doublePipe<span class='b'>)</span> <span class='b'>}</span>
        <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.pipe<span class='b'>)</span>
      <span class='k'>case</span> <span class='s'>'}'</span>:
        <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.rbrace<span class='b'>)</span>
      <span class='k'>case</span> <span class='s'>'~'</span>:
        <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.tilde<span class='b'>)</span>
      <span class='k'>case</span> <span class='s'>'$'</span>:
        <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.dollar<span class='b'>)</span>
    <span class='b'>}</span>

    <span class='k'>if</span> <span class='b'>(</span>c == 0<span class='b'>)</span>
      <span class='k'>return</span> TokenVal<span class='b'>(</span>Token.eof<span class='b'>)</span>

    <span class='k'>throw</span> err<span class='b'>(</span><span class='s'>"Unexpected symbol: "</span> + c.toChar + <span class='s'>" (0x"</span> + c.toHex + <span class='s'>")"</span><span class='b'>)</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Utils</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Return a CompilerException for current location in source.</span>
  <span class='z'>**</span>
  <span class='k'>override</span> CompilerErr <span id='err'>err</span><span class='b'>(</span>Str msg, Loc? loc := <span class='k'>null</span><span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>if</span> <span class='b'>(</span>loc == <span class='k'>null</span><span class='b'>)</span> loc = Loc<span class='b'>(</span>filename, line, col<span class='b'>)</span>
    <span class='k'>return</span> <span class='k'>super</span>.err<span class='b'>(</span>msg, loc<span class='b'>)</span>;
  <span class='b'>}</span>

<span class='y'>////////////////////////////////////////////////////////////////</span>
<span class='y'>// Consume</span>
<span class='y'>////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Peek at the character after peek</span>
  <span class='z'>**</span>
  <span class='k'>private</span> Int <span id='peekPeek'>peekPeek</span><span class='b'>()</span>
  <span class='b'>{</span>
    pos+2 &lt; buf.size ? buf<span class='b'>[</span>pos+2<span class='b'>]</span> : 0
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Consume the cur char and advance to next char in buffer:</span>
  <span class='z'>**  - updates cur and peek fields</span>
  <span class='z'>**  - updates the line and col count</span>
  <span class='z'>**  - end of file, sets fields to 0</span>
  <span class='z'>**</span>
  <span class='k'>private</span> Void <span id='consume'>consume</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='y'>// if cur is a line break, then advance line number,</span>
    <span class='y'>// because the char we are getting ready to make cur</span>
    <span class='y'>// is the first char on the next line</span>
    <span class='k'>if</span> <span class='b'>(</span>cur == <span class='s'>'\n'</span><span class='b'>)</span>
    <span class='b'>{</span>
      line++
      col = 1
      posOfLine = pos+1
    <span class='b'>}</span>
    <span class='k'>else</span>
    <span class='b'>{</span>
      col++
    <span class='b'>}</span>

    <span class='y'>// get the next character from the buffer, any</span>
    <span class='y'>// problems mean that we have read past the end</span>
    cur = peek
    pos++
    <span class='k'>if</span> <span class='b'>(</span>pos+1 &lt; buf.size<span class='b'>)</span>
      peek = buf<span class='b'>[</span>pos+1<span class='b'>]</span> <span class='y'>// next peek is cur+1</span>
    <span class='k'>else</span>
      peek = 0
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Test</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='x'>/*
  static Void main()
  {
    t1 := Duration.now
    files := File(`/dev/fan/src/testSys/fan/`).list
    files.each |File f|
    {
      tok := Tokenizer(null, Loc(f.name), f.readAllStr, false).tokenize
      echo("-- " + f + " [" + tok.size + "]")
    }
    t2 := Duration.now
    echo("Time: " + (t2-t1).toMillis)
    echo("Time: " + (t2-t1))
  }
  */</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Fields</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>private</span> Str <span id='buf'>buf</span>           <span class='y'>// buffer</span>
  <span class='k'>private</span> Int <span id='pos'>pos</span>           <span class='y'>// index into buf for cur</span>
  <span class='k'>private</span> Bool <span id='isDoc'>isDoc</span>        <span class='y'>// return documentation comments or if false ignore them</span>
  <span class='k'>private</span> Str <span id='filename'>filename</span>      <span class='y'>// source file name</span>
  <span class='k'>private</span> Int <span id='line'>line</span> := 1     <span class='y'>// pos line number</span>
  <span class='k'>private</span> Int <span id='col'>col</span> := 1      <span class='y'>// pos column number</span>
  <span class='k'>private</span> Int <span id='cur'>cur</span>           <span class='y'>// current char</span>
  <span class='k'>private</span> Int <span id='peek'>peek</span>          <span class='y'>// next char</span>
  <span class='k'>private</span> Int <span id='lastLine'>lastLine</span>      <span class='y'>// line number of last token returned from next()</span>
  <span class='k'>private</span> Int <span id='posOfLine'>posOfLine</span>     <span class='y'>// index into buf for start of current line</span>
  <span class='k'>private</span> TokenVal<span class='b'>[]</span> <span id='tokens'>tokens</span> <span class='y'>// token accumulator</span>
  <span class='k'>private</span> Bool <span id='inStrLiteral'>inStrLiteral</span> <span class='y'>// return if inside a string literal token</span>
  <span class='k'>private</span> Bool <span id='whitespace'>whitespace</span>   <span class='y'>// was there whitespace before current token</span>
<span class='b'>}</span>

<span class='z'>**************************************************************************</span>
<span class='z'>** Quoted</span>
<span class='z'>**************************************************************************</span>

<span class='k'>internal</span> <span class='k'>enum</span> <span class='k'>class</span> Quoted
<span class='b'>{</span>
  normal<span class='b'>(</span><span class='s'>"Str literal"</span>, <span class='k'>true</span><span class='b'>)</span>,
  triple<span class='b'>(</span><span class='s'>"Str literal"</span>, <span class='k'>true</span><span class='b'>)</span>,
  uri<span class='b'>(</span><span class='s'>"Uri literal"</span>, <span class='k'>false</span><span class='b'>)</span>

  Bool isUri<span class='b'>()</span> <span class='b'>{</span> <span class='k'>return</span> <span class='k'>this</span> === uri <span class='b'>}</span>
  Bool isTriple<span class='b'>()</span> <span class='b'>{</span> <span class='k'>return</span> <span class='k'>this</span> === triple <span class='b'>}</span>

  <span class='k'>private</span> <span class='k'>new</span> make<span class='b'>(</span>Str s, Bool ml<span class='b'>)</span> <span class='b'>{</span> toStr = s; multiLine = ml <span class='b'>}</span>

  <span class='k'>const</span> <span class='k'>override</span> Str toStr
  <span class='k'>const</span> Bool multiLine
<span class='b'>}</span></pre>
</div>
</div>
<div class='sidebar'>
<h2>More Info</h2>
<ul class='clean'>
  <li><a href='Tokenizer.html'>View Fandoc</a></li>
</ul>
<div class='slots'>
<div class='overview'>
<h2>Slots</h2>
<ul class='clean'>
  <li class='hidden' style='display: block;'><a href='#buf'>buf</a></li>
  <li class='hidden' style='display: block;'><a href='#ch'>ch</a></li>
  <li class='hidden' style='display: block;'><a href='#col'>col</a></li>
  <li class='hidden' style='display: block;'><a href='#consume'>consume</a></li>
  <li class='hidden' style='display: block;'><a href='#cur'>cur</a></li>
  <li class='hidden' style='display: block;'><a href='#docComment'>docComment</a></li>
  <li class='hidden' style='display: block;'><a href='#dsl'>dsl</a></li>
  <li class='hidden' style='display: block;'><a href='#endOfQuoted'>endOfQuoted</a></li>
  <li style='display: block;'><a href='#err'>err</a></li>
  <li style='display: block;'><a href='#escape'>escape</a></li>
  <li class='hidden' style='display: block;'><a href='#filename'>filename</a></li>
  <li class='hidden' style='display: block;'><a href='#find'>find</a></li>
  <li style='display: block;'><a href='#hex'>hex</a></li>
  <li class='hidden' style='display: block;'><a href='#inStrLiteral'>inStrLiteral</a></li>
  <li class='hidden' style='display: block;'><a href='#interpolation'>interpolation</a></li>
  <li class='hidden' style='display: block;'><a href='#isDoc'>isDoc</a></li>
  <li class='hidden' style='display: block;'><a href='#lastLine'>lastLine</a></li>
  <li class='hidden' style='display: block;'><a href='#line'>line</a></li>
  <li style='display: block;'><a href='#make'>make</a></li>
  <li class='hidden' style='display: block;'><a href='#makeVirtualToken'>makeVirtualToken</a></li>
  <li style='display: block;'><a href='#next'>next</a></li>
  <li class='hidden' style='display: block;'><a href='#number'>number</a></li>
  <li class='hidden' style='display: block;'><a href='#peek'>peek</a></li>
  <li class='hidden' style='display: block;'><a href='#peekPeek'>peekPeek</a></li>
  <li class='hidden' style='display: block;'><a href='#pos'>pos</a></li>
  <li class='hidden' style='display: block;'><a href='#posOfLine'>posOfLine</a></li>
  <li class='hidden' style='display: block;'><a href='#quoted'>quoted</a></li>
  <li class='hidden' style='display: block;'><a href='#skipCommentML'>skipCommentML</a></li>
  <li class='hidden' style='display: block;'><a href='#skipCommentSL'>skipCommentSL</a></li>
  <li class='hidden' style='display: block;'><a href='#skipStrWs'>skipStrWs</a></li>
  <li class='hidden' style='display: block;'><a href='#symbol'>symbol</a></li>
  <li style='display: block;'><a href='#tokenize'>tokenize</a></li>
  <li class='hidden' style='display: block;'><a href='#tokens'>tokens</a></li>
  <li class='hidden' style='display: block;'><a href='#whitespace'>whitespace</a></li>
  <li class='hidden' style='display: block;'><a href='#word'>word</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class='footer'>
<div>
<p>
compiler 1.0.56
[11-Nov-2010 Thu 10:08:17AM EST]
</p>
</div>
</div>
</body>
</html>
