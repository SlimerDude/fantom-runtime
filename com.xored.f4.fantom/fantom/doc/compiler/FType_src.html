<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
  <title>compiler::FType</title>
  <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
  <link rel='stylesheet' type='text/css' href='../doc.css'/>
  <script type='text/javascript' src='../doc.js'></script>
<!--[if lt IE 7]>
<script src='http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE7.js' type='text/javascript'></script>
<![endif]-->
</head>
<body onload='Login.check();'>
<div class='header'>
<div>
<h1><a href='/'>Fantom</a></h1>
<p id='sidewalkLogin_'>&nbsp;</p>
<form method='get' action='/sidewalk/search/'>
<p>
<input type='text' name='q' size='30' value='Search...' onfocus='if (value=="Search...") value=""' onblur='if (value=="") value="Search..."' />
</p>
</form>
<ul>
<li><a href='/'>Home</a></li>
<li class='active'><a href='../index.html'>Docs</a></li>
<li><a href='/sidewalk/blog/'>Blog</a></li>
<li><a href='/sidewalk/ticket/'>Tickets</a></li>
<li><a href='/sidewalk/topic/'>Discuss</a></li>
</ul></div>
</div>
<div class='subHeader'>
<div>
<ul>
  <li><a href='../index.html'>Doc Home</a></li>
  <li>&gt;</li>
  <li><a href='index.html'>compiler</a></li>
  <li>&gt;</li>
  <li><a href='FType.html'>FType</a></li>
</ul>
</div>
</div>
<div class='content'>
<div>
<div class='fandoc'>
<div class='type'>
<div class='overview'>
<h2>class</h2>
<h1>compiler::FType</h1>
<pre><a href='../sys/Obj.html'>sys::Obj</a>
  compiler::FType : <a href='CType.html'>compiler::CType</a></pre>
</div>
</div>
<div class='src'>
<pre>
<span class='y'>//</span>
<span class='y'>// Copyright (c) 2006, Brian Frank and Andy Frank</span>
<span class='y'>// Licensed under the Academic Free License version 3.0</span>
<span class='y'>//</span>
<span class='y'>// History:</span>
<span class='y'>//   26 Dec 05  Brian Frank  Creation</span>
<span class='y'>//   19 Aug 06  Brian Frank  Ported from Java to Fan</span>
<span class='y'>//</span>

<span class='z'>**</span>
<span class='z'>** FType is the read/write fcode representation of sys::Type.</span>
<span class='z'>**</span>
<span class='k'>class</span> FType : CType
<span class='b'>{</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Constructor</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>new</span> <span id='make'>make</span><span class='b'>(</span>FPod fpod<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>this</span>.fpod = fpod
    <span class='k'>this</span>.fattrs = FAttr<span class='b'>[</span>,<span class='b'>]</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// CType</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>override</span> CNamespace <span id='ns'>ns</span><span class='b'>()</span> <span class='b'>{</span> <span class='k'>return</span> fpod.ns <span class='b'>}</span>
  <span class='k'>override</span> FPod <span id='pod'>pod</span><span class='b'>()</span> <span class='b'>{</span> <span class='k'>return</span> fpod <span class='b'>}</span>
  <span class='k'>override</span> <span class='k'>once</span> Str <span id='name'>name</span><span class='b'>()</span> <span class='b'>{</span> <span class='k'>return</span> fpod.n<span class='b'>(</span>fpod.typeRef<span class='b'>(</span>self<span class='b'>)</span>.typeName<span class='b'>)</span> <span class='b'>}</span>
  <span class='k'>override</span> <span class='k'>once</span> Str <span id='qname'>qname</span><span class='b'>()</span> <span class='b'>{</span> <span class='k'>return</span> <span class='s'>"${fpod.name}::${name}"</span> <span class='b'>}</span>
  <span class='k'>override</span> Str <span id='signature'>signature</span><span class='b'>()</span> <span class='b'>{</span> <span class='k'>return</span> qname <span class='b'>}</span>

  FAttr? <span id='attr'>attr</span><span class='b'>(</span>Str name<span class='b'>)</span>
  <span class='b'>{</span>
    fattrs.find |a| <span class='b'>{</span> fpod.n<span class='b'>(</span>a.name<span class='b'>)</span> == name <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='k'>override</span> CType? <span id='base'>base</span>
  <span class='b'>{</span>
    get
    <span class='b'>{</span>
      <span class='k'>if</span> <span class='b'>(</span>&amp;base == <span class='k'>null</span><span class='b'>)</span> &amp;base = fpod.toType<span class='b'>(</span>fbase<span class='b'>)</span>
      <span class='k'>return</span> &amp;base
    <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='k'>override</span> <span class='k'>once</span> CType<span class='b'>[]</span> <span id='mixins'>mixins</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='k'>return</span> fpod.resolveTypes<span class='b'>(</span>fmixins<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='k'>override</span> <span class='k'>once</span> Bool <span id='isVal'>isVal</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='k'>return</span> isValType<span class='b'>(</span>qname<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='k'>override</span> CFacet? <span id='facet'>facet</span><span class='b'>(</span>Str qname<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>if</span> <span class='b'>(</span>ffacets == <span class='k'>null</span><span class='b'>)</span> reflect
    <span class='k'>return</span> ffacets.find |f| <span class='b'>{</span> f.qname == qname <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='k'>override</span> Str:CSlot <span id='slots'>slots</span>
  <span class='b'>{</span>
    get
    <span class='b'>{</span>
      <span class='k'>if</span> <span class='b'>(</span>slotsCached == <span class='k'>null</span><span class='b'>)</span> reflect
      <span class='k'>return</span> slotsCached
    <span class='b'>}</span>
  <span class='b'>}</span>
  <span class='k'>private</span> <span class='b'>[</span>Str:CSlot<span class='b'>]</span>? <span id='slotsCached'>slotsCached</span>

  <span class='k'>override</span> <span class='k'>once</span> COperators <span id='operators'>operators</span><span class='b'>()</span> <span class='b'>{</span> COperators<span class='b'>(</span><span class='k'>this</span><span class='b'>)</span> <span class='b'>}</span>

  <span class='k'>override</span> Bool <span id='isNullable'>isNullable</span><span class='b'>()</span> <span class='b'>{</span> <span class='k'>return</span> <span class='k'>false</span> <span class='b'>}</span>

  <span class='k'>override</span> <span class='k'>once</span> CType <span id='toNullable'>toNullable</span><span class='b'>()</span> <span class='b'>{</span> <span class='k'>return</span> NullableType<span class='b'>(</span><span class='k'>this</span><span class='b'>)</span> <span class='b'>}</span>

  <span class='k'>override</span> Bool <span id='isGeneric'>isGeneric</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='k'>return</span> fpod.name == <span class='s'>"sys"</span> &amp;&amp; <span class='b'>(</span>name == <span class='s'>"List"</span> || name == <span class='s'>"Map"</span> || name == <span class='s'>"Func"</span><span class='b'>)</span>
  <span class='b'>}</span>

  <span class='k'>override</span> Bool <span id='isParameterized'>isParameterized</span><span class='b'>()</span> <span class='b'>{</span> <span class='k'>return</span> <span class='k'>false</span> <span class='b'>}</span>

  <span class='k'>override</span> Bool <span id='isGenericParameter'>isGenericParameter</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='k'>return</span> fpod.name == <span class='s'>"sys"</span> &amp;&amp; name.size == 1
  <span class='b'>}</span>

  <span class='k'>override</span> <span class='k'>once</span> CType <span id='toListOf'>toListOf</span><span class='b'>()</span> <span class='b'>{</span> <span class='k'>return</span> ListType<span class='b'>(</span><span class='k'>this</span><span class='b'>)</span> <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Reflection</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>private</span> Void <span id='reflect'>reflect</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='y'>// lazy read from the pod file</span>
    read

    <span class='y'>// map all the declared fields and methods</span>
    slotsCached = Str:CSlot<span class='b'>[</span>:<span class='b'>]</span>
    ffields.each  |FField f|  <span class='b'>{</span> slots<span class='b'>[</span>f.name<span class='b'>]</span> = f <span class='b'>}</span>
    fmethods.each |FMethod m|
    <span class='b'>{</span>
      f := <span class='b'>(</span>FField?<span class='b'>)</span>slots<span class='b'>[</span>m.name<span class='b'>]</span>
      <span class='k'>if</span> <span class='b'>(</span>f != <span class='k'>null</span><span class='b'>)</span>
      <span class='b'>{</span>
        <span class='y'>// if already mapped to field must be getter/setter</span>
        <span class='k'>if</span> <span class='b'>(</span>m.flags.and<span class='b'>(</span>FConst.Getter<span class='b'>)</span> != 0<span class='b'>)</span>
          f.getter = m
        <span class='k'>else</span> <span class='k'>if</span> <span class='b'>(</span>m.flags.and<span class='b'>(</span>FConst.Setter<span class='b'>)</span> != 0<span class='b'>)</span>
          f.setter = m
        <span class='k'>else</span>
          <span class='k'>throw</span> Err<span class='b'>(</span><span class='s'>"Conflicting slots: $f and $m"</span><span class='b'>)</span>
      <span class='b'>}</span>
      <span class='k'>else</span>
      <span class='b'>{</span>
        slotsCached<span class='b'>[</span>m.name<span class='b'>]</span> = m
      <span class='b'>}</span>
    <span class='b'>}</span>

    <span class='y'>// inherited slots</span>
    <span class='k'>if</span> <span class='b'>(</span>base != <span class='k'>null</span><span class='b'>)</span> inherit<span class='b'>(</span>base<span class='b'>)</span>
    mixins.each |CType t| <span class='b'>{</span> inherit<span class='b'>(</span>t<span class='b'>)</span> <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='k'>private</span> Void <span id='inherit'>inherit</span><span class='b'>(</span>CType t<span class='b'>)</span>
  <span class='b'>{</span>
    t.slots.each |CSlot newSlot|
    <span class='b'>{</span>
      <span class='y'>// if slot already mapped, skip it</span>
      <span class='k'>if</span> <span class='b'>(</span>slotsCached<span class='b'>[</span>newSlot.name<span class='b'>]</span> != <span class='k'>null</span><span class='b'>)</span> <span class='k'>return</span>

      <span class='y'>// we never inherit constructors, private slots,</span>
      <span class='y'>// or internal slots outside of the pod</span>
      <span class='k'>if</span> <span class='b'>(</span>newSlot.isCtor || newSlot.isPrivate ||
          <span class='b'>(</span>newSlot.isInternal &amp;&amp; newSlot.parent.pod != t.pod<span class='b'>))</span>
        <span class='k'>return</span>

      <span class='y'>// inherit it</span>
      slotsCached<span class='b'>[</span>newSlot.name<span class='b'>]</span> = newSlot
    <span class='b'>}</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Meta IO</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  Void <span id='writeMeta'>writeMeta</span><span class='b'>(</span>OutStream out<span class='b'>)</span>
  <span class='b'>{</span>
    out.writeI2<span class='b'>(</span>self<span class='b'>)</span>
    out.writeI2<span class='b'>(</span>fbase<span class='b'>)</span>
    out.writeI2<span class='b'>(</span>fmixins.size<span class='b'>)</span>
    fmixins.each |Int m| <span class='b'>{</span> out.writeI2<span class='b'>(</span>m<span class='b'>)</span> <span class='b'>}</span>
    out.writeI4<span class='b'>(</span>flags.and<span class='b'>(</span>FConst.FlagsMask<span class='b'>))</span>
  <span class='b'>}</span>

  This <span id='readMeta'>readMeta</span><span class='b'>(</span>InStream in<span class='b'>)</span>
  <span class='b'>{</span>
    self    = in.readU2
    fbase   = in.readU2
    fmixins = Int<span class='b'>[</span>,<span class='b'>]</span>
    in.readU2.times <span class='b'>{</span> fmixins.add<span class='b'>(</span>in.readU2<span class='b'>)</span> <span class='b'>}</span>
    flags   = in.readU4
    <span class='k'>return</span> <span class='k'>this</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Body IO</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  Uri <span id='uri'>uri</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='k'>return</span> Uri.fromStr<span class='b'>(</span><span class='s'>"/fcode/"</span> + fpod.n<span class='b'>(</span>fpod.typeRef<span class='b'>(</span>self<span class='b'>)</span>.typeName<span class='b'>)</span> + <span class='s'>".fcode"</span><span class='b'>)</span>
  <span class='b'>}</span>

  Void <span id='write'>write</span><span class='b'>()</span>
  <span class='b'>{</span>
    out := fpod.out<span class='b'>(</span>uri<span class='b'>)</span>

    out.writeI2<span class='b'>(</span>ffields.size<span class='b'>)</span>
    ffields.each |FField f| <span class='b'>{</span> f.write<span class='b'>(</span>out<span class='b'>)</span> <span class='b'>}</span>

    out.writeI2<span class='b'>(</span>fmethods.size<span class='b'>)</span>
    fmethods.each |FMethod m| <span class='b'>{</span> m.write<span class='b'>(</span>out<span class='b'>)</span> <span class='b'>}</span>

    out.writeI2<span class='b'>(</span>fattrs.size<span class='b'>)</span>
    fattrs.each |FAttr a| <span class='b'>{</span> a.write<span class='b'>(</span>out<span class='b'>)</span> <span class='b'>}</span>

    out.close
  <span class='b'>}</span>

  Void <span id='read'>read</span><span class='b'>()</span>
  <span class='b'>{</span>
    in := fpod.in<span class='b'>(</span>uri<span class='b'>)</span>

    ffields = FField<span class='b'>[</span>,<span class='b'>]</span>
    in.readU2.times <span class='b'>{</span> ffields.add<span class='b'>(</span>FField<span class='b'>(</span><span class='k'>this</span><span class='b'>)</span>.read<span class='b'>(</span>in<span class='b'>))</span> <span class='b'>}</span>

    fmethods = FMethod<span class='b'>[</span>,<span class='b'>]</span>
    in.readU2.times <span class='b'>{</span> fmethods.add<span class='b'>(</span>FMethod<span class='b'>(</span><span class='k'>this</span><span class='b'>)</span>.read<span class='b'>(</span>in<span class='b'>))</span> <span class='b'>}</span>

    fattrs = FAttr<span class='b'>[</span>,<span class='b'>]</span>
    in.readU2.times <span class='b'>{</span> fattrs.add<span class='b'>(</span>FAttr.make.read<span class='b'>(</span>in<span class='b'>))</span> <span class='b'>}</span>

    ffacets = FFacet.decode<span class='b'>(</span>fpod, attr<span class='b'>(</span>FConst.FacetsAttr<span class='b'>))</span>

    in.close
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Fields</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>override</span> Int <span id='flags'>flags</span>    <span class='y'>// bitmask</span>
  Bool <span id='hollow'>hollow</span> := <span class='k'>true</span>   <span class='y'>// have we only read meta-data</span>
  FPod <span id='fpod'>fpod</span>             <span class='y'>// parent pod</span>
  Int <span id='self'>self</span>              <span class='y'>// self typeRef index</span>
  Int <span id='fbase'>fbase</span>             <span class='y'>// base typeRef index</span>
  Int<span class='b'>[]</span>? <span id='fmixins'>fmixins</span>        <span class='y'>// mixin typeRef indexes</span>
  FField<span class='b'>[]</span>? <span id='ffields'>ffields</span>     <span class='y'>// fields</span>
  FMethod<span class='b'>[]</span>? <span id='fmethods'>fmethods</span>   <span class='y'>// methods</span>
  FAttr<span class='b'>[]</span>? <span id='fattrs'>fattrs</span>       <span class='y'>// type attributes</span>
  FFacet<span class='b'>[]</span>? <span id='ffacets'>ffacets</span>     <span class='y'>// decoded facet attributes</span>

<span class='b'>}</span></pre>
</div>
</div>
<div class='sidebar'>
<h2>More Info</h2>
<ul class='clean'>
  <li><a href='FType.html'>View Fandoc</a></li>
</ul>
<div class='slots'>
<div class='overview'>
<h2>Slots</h2>
<ul class='clean'>
  <li style='display: block;'><a href='#attr'>attr</a></li>
  <li style='display: block;'><a href='#base'>base</a></li>
  <li style='display: block;'><a href='#facet'>facet</a></li>
  <li style='display: block;'><a href='#fattrs'>fattrs</a></li>
  <li style='display: block;'><a href='#fbase'>fbase</a></li>
  <li style='display: block;'><a href='#ffacets'>ffacets</a></li>
  <li style='display: block;'><a href='#ffields'>ffields</a></li>
  <li style='display: block;'><a href='#flags'>flags</a></li>
  <li style='display: block;'><a href='#fmethods'>fmethods</a></li>
  <li style='display: block;'><a href='#fmixins'>fmixins</a></li>
  <li style='display: block;'><a href='#fpod'>fpod</a></li>
  <li style='display: block;'><a href='#hollow'>hollow</a></li>
  <li class='hidden' style='display: block;'><a href='#inherit'>inherit</a></li>
  <li style='display: block;'><a href='#isGeneric'>isGeneric</a></li>
  <li style='display: block;'><a href='#isGenericParameter'>isGenericParameter</a></li>
  <li style='display: block;'><a href='#isNullable'>isNullable</a></li>
  <li style='display: block;'><a href='#isParameterized'>isParameterized</a></li>
  <li style='display: block;'><a href='#isVal'>isVal</a></li>
  <li style='display: block;'><a href='#make'>make</a></li>
  <li style='display: block;'><a href='#mixins'>mixins</a></li>
  <li style='display: block;'><a href='#name'>name</a></li>
  <li style='display: block;'><a href='#ns'>ns</a></li>
  <li style='display: block;'><a href='#operators'>operators</a></li>
  <li style='display: block;'><a href='#pod'>pod</a></li>
  <li style='display: block;'><a href='#qname'>qname</a></li>
  <li style='display: block;'><a href='#read'>read</a></li>
  <li style='display: block;'><a href='#readMeta'>readMeta</a></li>
  <li class='hidden' style='display: block;'><a href='#reflect'>reflect</a></li>
  <li style='display: block;'><a href='#self'>self</a></li>
  <li style='display: block;'><a href='#signature'>signature</a></li>
  <li style='display: block;'><a href='#slots'>slots</a></li>
  <li class='hidden' style='display: block;'><a href='#slotsCached'>slotsCached</a></li>
  <li style='display: block;'><a href='#toListOf'>toListOf</a></li>
  <li style='display: block;'><a href='#toNullable'>toNullable</a></li>
  <li style='display: block;'><a href='#uri'>uri</a></li>
  <li style='display: block;'><a href='#write'>write</a></li>
  <li style='display: block;'><a href='#writeMeta'>writeMeta</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class='footer'>
<div>
<p>
compiler 1.0.56
[11-Nov-2010 Thu 10:08:17AM EST]
</p>
</div>
</div>
</body>
</html>
