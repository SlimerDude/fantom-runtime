<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
  <title>compiler::InitClosures</title>
  <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
  <link rel='stylesheet' type='text/css' href='../doc.css'/>
  <script type='text/javascript' src='../doc.js'></script>
<!--[if lt IE 7]>
<script src='http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE7.js' type='text/javascript'></script>
<![endif]-->
</head>
<body onload='Login.check();'>
<div class='header'>
<div>
<h1><a href='/'>Fantom</a></h1>
<p id='sidewalkLogin_'>&nbsp;</p>
<form method='get' action='/sidewalk/search/'>
<p>
<input type='text' name='q' size='30' value='Search...' onfocus='if (value=="Search...") value=""' onblur='if (value=="") value="Search..."' />
</p>
</form>
<ul>
<li><a href='/'>Home</a></li>
<li class='active'><a href='../index.html'>Docs</a></li>
<li><a href='/sidewalk/blog/'>Blog</a></li>
<li><a href='/sidewalk/ticket/'>Tickets</a></li>
<li><a href='/sidewalk/topic/'>Discuss</a></li>
</ul></div>
</div>
<div class='subHeader'>
<div>
<ul>
  <li><a href='../index.html'>Doc Home</a></li>
  <li>&gt;</li>
  <li><a href='index.html'>compiler</a></li>
  <li>&gt;</li>
  <li><a href='InitClosures.html'>InitClosures</a></li>
</ul>
</div>
</div>
<div class='content'>
<div>
<div class='fandoc'>
<div class='type'>
<div class='overview'>
<h2>class</h2>
<h1>compiler::InitClosures</h1>
<pre><a href='../sys/Obj.html'>sys::Obj</a>
  <a href='CompilerSupport.html'>compiler::CompilerSupport</a>
    <a href='CompilerStep.html'>compiler::CompilerStep</a>
      compiler::InitClosures</pre>
</div>
</div>
<div class='src'>
<pre>
<span class='y'>//</span>
<span class='y'>// Copyright (c) 2006, Brian Frank and Andy Frank</span>
<span class='y'>// Licensed under the Academic Free License version 3.0</span>
<span class='y'>//</span>
<span class='y'>// History:</span>
<span class='y'>//   16 Jan 06  Brian Frank  Creation</span>
<span class='y'>//    2 Oct 06  Brian Frank  Ported from Java to Fan</span>
<span class='y'>//</span>

<span class='z'>**</span>
<span class='z'>** During the Parse step we created a list of all the closures.</span>
<span class='z'>** In InitClosures we map each ClosureExpr into a TypeDef as</span>
<span class='z'>** an anonymous class, then we map ClosureExpr.substitute to</span>
<span class='z'>** call the constructor anonymous class.</span>
<span class='z'>**</span>
<span class='k'>class</span> InitClosures : CompilerStep
<span class='b'>{</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Constructor</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>new</span> <span id='make'>make</span><span class='b'>(</span>Compiler compiler<span class='b'>)</span>
    : <span class='k'>super</span><span class='b'>(</span>compiler<span class='b'>)</span>
  <span class='b'>{</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Run</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>override</span> Void <span id='run'>run</span><span class='b'>()</span>
  <span class='b'>{</span>
    log.debug<span class='b'>(</span><span class='s'>"Closures"</span><span class='b'>)</span>
    compiler.closures.each |ClosureExpr c| <span class='b'>{</span> process<span class='b'>(</span>c<span class='b'>)</span> <span class='b'>}</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Process</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>private</span> Void <span id='process'>process</span><span class='b'>(</span>ClosureExpr c<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='y'>// class Class$Method$Num : |A,B..-&gt;R|</span>
    <span class='y'>// {</span>
    <span class='y'>//    new $make() {}</span>
    <span class='y'>//    Bool isImmutable() { return true }</span>
    <span class='y'>//    Obj? call(Obj? a, Obj? b, ...) { doCall((A)a, ...) }</span>
    <span class='y'>//    R doCall(A a, B b, ...) { closure.code }</span>
    <span class='y'>// }</span>

    setup<span class='b'>(</span>c<span class='b'>)</span>      <span class='y'>// setup our fields to process this closure</span>
    genClass      <span class='y'>// generate anonymous implementation class</span>
    genCtor       <span class='y'>// generate make()</span>
    genDoCall     <span class='y'>// generate doCall(...)</span>
    genCall       <span class='y'>// generate call(...) { doCall(...) }</span>
    substitute    <span class='y'>// substitute closure code with anonymous class ctor</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Setup</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>private</span> Void <span id='setup'>setup</span><span class='b'>(</span>ClosureExpr c<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>this</span>.closure         = c
    <span class='k'>this</span>.loc             = c.loc
    <span class='k'>this</span>.signature       = c.signature
    <span class='k'>this</span>.enclosingType   = c.enclosingType
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Generate Class</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>private</span> Void <span id='genClass'>genClass</span><span class='b'>()</span>
  <span class='b'>{</span>
    cls = TypeDef<span class='b'>(</span>ns, loc, closure.enclosingType.unit, closure.name<span class='b'>)</span>
    cls.flags   = FConst.Internal + FConst.Final + FConst.Synthetic
    cls.base    = closure.signature
    cls.closure = closure
    closure.cls = cls
    addTypeDef<span class='b'>(</span>cls<span class='b'>)</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Generate Constructor</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>private</span> Void <span id='genCtor'>genCtor</span><span class='b'>()</span>
  <span class='b'>{</span>
    code := Block<span class='b'>(</span>loc<span class='b'>)</span>
    code.stmts.add<span class='b'>(</span>ReturnStmt.makeSynthetic<span class='b'>(</span>loc<span class='b'>))</span>

    ctor = MethodDef<span class='b'>(</span>loc, cls<span class='b'>)</span>
    ctor.flags = FConst.Internal + FConst.Ctor + FConst.Synthetic
    ctor.name = <span class='s'>"make"</span>
    ctor.ret  = ns.voidType
    ctor.code = code
    cls.addSlot<span class='b'>(</span>ctor<span class='b'>)</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Generate doCall()</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>private</span> Void <span id='genDoCall'>genDoCall</span><span class='b'>()</span>
  <span class='b'>{</span>
    doCall = MethodDef<span class='b'>(</span>loc, cls<span class='b'>)</span>
    doCall.name  = <span class='s'>"doCall"</span>
    doCall.flags = FConst.Internal + FConst.Synthetic
    doCall.code  = closure.code
    doCall.ret = signature.ret
    doCall.paramDefs = signature.toParamDefs<span class='b'>(</span>loc<span class='b'>)</span>
    closure.doCall = doCall
    cls.addSlot<span class='b'>(</span>doCall<span class='b'>)</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Generate call()</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>private</span> Void <span id='genCall'>genCall</span><span class='b'>()</span>
  <span class='b'>{</span>
    c := CallExpr.makeWithMethod<span class='b'>(</span>loc, ThisExpr<span class='b'>(</span>loc<span class='b'>)</span>, doCall<span class='b'>)</span>
    genMethodCall<span class='b'>(</span>compiler, loc, cls, signature, c, <span class='k'>false</span><span class='b'>)</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** This method overrides either call(List) or callx(A...) to push the</span>
  <span class='z'>** args onto the stack, then redirect to the specified CallExpr c.</span>
  <span class='z'>** We share this code for both closures and curries.</span>
  <span class='z'>**</span>
  <span class='k'>static</span> MethodDef <span id='genMethodCall'>genMethodCall</span><span class='b'>(</span>Compiler compiler, Loc loc, TypeDef parent,
                                 FuncType signature, CallExpr c, Bool firstAsTarget<span class='b'>)</span>
  <span class='b'>{</span>
    ns := compiler.ns

    <span class='y'>// method def</span>
    m := MethodDef<span class='b'>(</span>loc, parent<span class='b'>)</span>
    m.flags = FConst.Override + FConst.Synthetic
    m.ret   = ns.objType.toNullable
    m.code  = Block<span class='b'>(</span>loc<span class='b'>)</span>

    <span class='y'>// signature:</span>
    <span class='y'>//   callList(List)             // if &gt; MaxIndirectParams</span>
    <span class='y'>//   call(Obj p0, Obj p1, ...)  // if &lt;= MaxIndirectParams</span>
    paramCount := signature.params.size
    useListArgs := paramCount &gt; 8
    <span class='k'>if</span> <span class='b'>(</span>useListArgs<span class='b'>)</span>
    <span class='b'>{</span>
      m.name  = <span class='s'>"callList"</span>
      p := ParamDef<span class='b'>(</span>loc, ns.objType.toListOf, <span class='s'>"list"</span><span class='b'>)</span>
      m.params.add<span class='b'>(</span>p<span class='b'>)</span>
    <span class='b'>}</span>
    <span class='k'>else</span>
    <span class='b'>{</span>
      m.name = <span class='s'>"call"</span>
      paramCount.times |Int i|
      <span class='b'>{</span>
        p := ParamDef<span class='b'>(</span>loc, ns.objType.toNullable, <span class='s'>"p$i"</span><span class='b'>)</span>
        m.paramDefs.add<span class='b'>(</span>p<span class='b'>)</span>
      <span class='b'>}</span>
    <span class='b'>}</span>

    <span class='y'>// init the doCall() expr with arguments</span>
    paramCount.times |Int i|
    <span class='b'>{</span>
      Expr? arg

      <span class='y'>// list.get(&lt;i&gt;)</span>
      <span class='k'>if</span> <span class='b'>(</span>useListArgs<span class='b'>)</span>
      <span class='b'>{</span>
        listGet := CallExpr.makeWithMethod<span class='b'>(</span>loc, UnknownVarExpr<span class='b'>(</span>loc, <span class='k'>null</span>, <span class='s'>"list"</span><span class='b'>)</span>, ns.objType.toListOf.method<span class='b'>(</span><span class='s'>"get"</span><span class='b'>))</span>
        listGet.args.add<span class='b'>(</span>LiteralExpr<span class='b'>(</span>loc, ExprId.intLiteral, ns.intType, i<span class='b'>))</span>
        arg = listGet
      <span class='b'>}</span>

      <span class='y'>// p&lt;i&gt;</span>
      <span class='k'>else</span>
      <span class='b'>{</span>
        arg = UnknownVarExpr<span class='b'>(</span>loc, <span class='k'>null</span>, <span class='s'>"p$i"</span><span class='b'>)</span>
      <span class='b'>}</span>

      <span class='y'>// cast to closure param type</span>
      arg = TypeCheckExpr.coerce<span class='b'>(</span>arg, signature.params<span class='b'>[</span>i<span class='b'>])</span>

      <span class='y'>// add to doCall() argument list</span>
      <span class='k'>if</span> <span class='b'>(</span>firstAsTarget &amp;&amp; i == 0<span class='b'>)</span>
        c.target = arg
      <span class='k'>else</span>
        c.args.add<span class='b'>(</span>arg<span class='b'>)</span>
    <span class='b'>}</span>

    <span class='y'>// return:</span>
    <span class='y'>//   doCall; return null;  // if doCall() is void</span>
    <span class='y'>//   return doCall         // if doCall() non-void</span>
    <span class='k'>if</span> <span class='b'>(</span>signature.ret.isVoid<span class='b'>)</span>
    <span class='b'>{</span>
      m.code.add<span class='b'>(</span>c.toStmt<span class='b'>)</span>
      m.code.add<span class='b'>(</span>ReturnStmt.makeSynthetic<span class='b'>(</span>loc, LiteralExpr.makeNull<span class='b'>(</span>loc, ns<span class='b'>)))</span>
    <span class='b'>}</span>
    <span class='k'>else</span>
    <span class='b'>{</span>
      m.code.add<span class='b'>(</span>ReturnStmt.makeSynthetic<span class='b'>(</span>loc, c<span class='b'>))</span>
    <span class='b'>}</span>

    <span class='y'>// add to our synthetic parent class</span>
    parent.addSlot<span class='b'>(</span>m<span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>parent.isClosure<span class='b'>)</span> parent.closure.call = m
    <span class='k'>return</span> m
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Substitute</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Generate in-place subtitution of closure:</span>
  <span class='z'>**   |-&gt;| { ... }  =&gt;  Closure$Cls.make()</span>
  <span class='z'>**</span>
  <span class='k'>private</span> Void <span id='substitute'>substitute</span><span class='b'>()</span>
  <span class='b'>{</span>
    closure.code = <span class='k'>null</span>
    closure.substitute = CallExpr.makeWithMethod<span class='b'>(</span>loc, <span class='k'>null</span>, ctor<span class='b'>)</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Fields</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  ClosureExpr? <span id='closure'>closure</span>        <span class='y'>// current closure</span>
  Loc? <span id='loc'>loc</span>                    <span class='y'>// closure.loc</span>
  FuncType? <span id='signature'>signature</span>         <span class='y'>// closure.sig</span>
  TypeDef? <span id='enclosingType'>enclosingType</span>      <span class='y'>// closure.enclosingType</span>
  TypeDef? <span id='cls'>cls</span>                <span class='y'>// current anonymous class implementing closure</span>
  MethodDef? <span id='ctor'>ctor</span>             <span class='y'>// anonymous class make ctor</span>
  MethodDef? <span id='doCall'>doCall</span>           <span class='y'>// R doCall(A a, ...) { closure.code }</span>

<span class='b'>}</span></pre>
</div>
</div>
<div class='sidebar'>
<h2>More Info</h2>
<ul class='clean'>
  <li><a href='InitClosures.html'>View Fandoc</a></li>
</ul>
<div class='slots'>
<div class='overview'>
<h2>Slots</h2>
<ul class='clean'>
  <li style='display: block;'><a href='#closure'>closure</a></li>
  <li style='display: block;'><a href='#cls'>cls</a></li>
  <li style='display: block;'><a href='#ctor'>ctor</a></li>
  <li style='display: block;'><a href='#doCall'>doCall</a></li>
  <li style='display: block;'><a href='#enclosingType'>enclosingType</a></li>
  <li class='hidden' style='display: block;'><a href='#genCall'>genCall</a></li>
  <li class='hidden' style='display: block;'><a href='#genClass'>genClass</a></li>
  <li class='hidden' style='display: block;'><a href='#genCtor'>genCtor</a></li>
  <li class='hidden' style='display: block;'><a href='#genDoCall'>genDoCall</a></li>
  <li style='display: block;'><a href='#genMethodCall'>genMethodCall</a></li>
  <li style='display: block;'><a href='#loc'>loc</a></li>
  <li style='display: block;'><a href='#make'>make</a></li>
  <li class='hidden' style='display: block;'><a href='#process'>process</a></li>
  <li style='display: block;'><a href='#run'>run</a></li>
  <li class='hidden' style='display: block;'><a href='#setup'>setup</a></li>
  <li style='display: block;'><a href='#signature'>signature</a></li>
  <li class='hidden' style='display: block;'><a href='#substitute'>substitute</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class='footer'>
<div>
<p>
compiler 1.0.56
[11-Nov-2010 Thu 10:08:17AM EST]
</p>
</div>
</div>
</body>
</html>
