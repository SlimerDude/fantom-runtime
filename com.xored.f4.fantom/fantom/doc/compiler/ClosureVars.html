<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
  <title>compiler::ClosureVars</title>
  <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
  <link rel='stylesheet' type='text/css' href='../doc.css'/>
  <script type='text/javascript' src='../doc.js'></script>
<!--[if lt IE 7]>
<script src='http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE7.js' type='text/javascript'></script>
<![endif]-->
</head>
<body onload='Login.check();'>
<div class='header'>
<div>
<h1><a href='/'>Fantom</a></h1>
<p id='sidewalkLogin_'>&nbsp;</p>
<form method='get' action='/sidewalk/search/'>
<p>
<input type='text' name='q' size='30' value='Search...' onfocus='if (value=="Search...") value=""' onblur='if (value=="") value="Search..."' />
</p>
</form>
<ul>
<li><a href='/'>Home</a></li>
<li class='active'><a href='../index.html'>Docs</a></li>
<li><a href='/sidewalk/blog/'>Blog</a></li>
<li><a href='/sidewalk/ticket/'>Tickets</a></li>
<li><a href='/sidewalk/topic/'>Discuss</a></li>
</ul></div>
</div>
<div class='subHeader'>
<div>
<ul>
  <li><a href='../index.html'>Doc Home</a></li>
  <li>&gt;</li>
  <li><a href='index.html'>compiler</a></li>
  <li>&gt;</li>
  <li><a href='ClosureVars.html'>ClosureVars</a></li>
</ul>
</div>
</div>
<div class='content'>
<div>
<div class='fandoc'>
<div class='type'>
<div class='overview'>
<h2>class</h2>
<h1>compiler::ClosureVars</h1>
<pre><a href='../sys/Obj.html'>sys::Obj</a>
  <a href='CompilerSupport.html'>compiler::CompilerSupport</a>
    <a href='CompilerStep.html'>compiler::CompilerStep</a>
      compiler::ClosureVars</pre>
</div>
<div class='detail'>

<p>ClosureVars is used to process closure variables which have been enclosed from their parent scope:</p>

<p>ResolveExpr ----------- ResolveExpr we detected variables used from parent scope and created shadow variables in the closure's scope with a reference via <code>MethodVar.shadows</code>.  Also during this step we note any variables which are reassigned making them non-final (according to Java final variable semantics).</p>

<p>Process Method -------------- First we walk all types looking for methods which use closure variables:</p>

<ol style='list-style-type:decimal'>
<li>For each one walk thru its variables to see if any variables enclosed are non-final (reassigned at some point).  These variables as hoisted onto the heap with wrappers:
<pre>class Wrapper$T { new make(T v) { val=v }  T val }</pre>
</li>

<li>If no wrapped variables, then we can leave a cvars method alone - everything stays the same.  If however we do have wrapped variables, then we need to walk the expr tree of the method replacing all access of the variable with its wrapper access:
<pre>x := 3     =>   x := Wrapper$Int(3)
x = x + 1  =>   x.val = x.val + 1</pre>
</li>

<li>If any params were wrapped, we generated a new local variable in <code>wrapNonFinalVars</code>.  During the expr tree walk we replaced all references to the param to its new wrapped local.   To finish processing the method we insert a bit of code in the beginning of the method to initialize the local.</li>
</ol>

<p>Process Closure --------------- After we have walked all methods using closure variables (which might include closure doCall methods themselves), then we walk all the closures.</p>

<ol style='list-style-type:decimal'>
<li>For each shadowed variables we need:
<ol style='list-style-type:lower-alpha'>
<li>Define field on the closure to store variable</li>

<li>Pass variable to closure constructor at substitution site</li>

<li>Add variable to as closure constructor param</li>

<li>Assign param to field in constructor If the variable has been wrapped we are doing this for the wrapped variable (we don't unwrap it).</li>
</ol>
</li>

<li>If any of the closures shadowed variables are wrapped, then we do a expr tree walk of doCall - the exact same thing as step 2 of the processMethod stage.</li>
</ol>
</div>
</div>
<div class='slots'>
<div class='detail'>
<h2>Slots</h2>
<dl>
<dt id='addToClosure' class='method hidden'>addToClosure<a href='ClosureVars_src.html#addToClosure'>Source</a></dt>
<dd class='hidden'>
<p><code class='sig'>static private <a href='FieldDef.html'>FieldDef</a> addToClosure(<a href='ClosureExpr.html'>ClosureExpr</a> closure, <a href='../sys/Str.html'>Str</a> name, <a href='Expr.html'>Expr</a> subtituteArg)</code></p>

<p>Common code between addVarToClosure and makeOuterThisField. Return storage field for closure variable.</p>
</dd>
<dt id='addVarToClosure' class='method hidden'>addVarToClosure<a href='ClosureVars_src.html#addVarToClosure'>Source</a></dt>
<dd class='hidden'>
<p><code class='sig'>private <a href='../sys/Void.html'>Void</a> addVarToClosure(<a href='ClosureExpr.html'>ClosureExpr</a> closure, <a href='MethodVar.html'>MethodVar</a> var, <a href='../sys/Str.html'>Str</a> name)</code></p>

<p>For each variable enclosed by the closure:</p>

<ol style='list-style-type:decimal'>
<li>Add field on the closure to store variable</li>

<li>Add param to as closure constructor</li>

<li>Pass variable to closure constructor at substitution site</li>

<li>Assign param to field in constructor</li>

<li>Initialize variable in doCall from field</li>
</ol>
</dd>
<dt id='fieldExpr' class='method hidden'>fieldExpr<a href='ClosureVars_src.html#fieldExpr'>Source</a></dt>
<dd class='hidden'>
<p><code class='sig'>static private <a href='FieldExpr.html'>FieldExpr</a> fieldExpr(<a href='Loc.html'>Loc</a> loc, <a href='Expr.html'>Expr</a> target, <a href='CField.html'>CField</a> field)</code></p>
</dd>
<dt id='fixLocalDef' class='method hidden'>fixLocalDef<a href='ClosureVars_src.html#fixLocalDef'>Source</a></dt>
<dd class='hidden'>
<p><code class='sig'>private <a href='Stmt.html'>Stmt</a>[]? fixLocalDef(<a href='LocalDefStmt.html'>LocalDefStmt</a> stmt)</code></p>

<p>If a local variable has been hoisted onto the heap with a wrapper, then generate wrapper initialization:</p>

<pre>// original code
local := 3

// becomes
local := Wrap$Int(3)</pre>
</dd>
<dt id='fixWrappedParams' class='method hidden'>fixWrappedParams<a href='ClosureVars_src.html#fixWrappedParams'>Source</a></dt>
<dd class='hidden'>
<p><code class='sig'>private <a href='../sys/Void.html'>Void</a> fixWrappedParams(<a href='MethodDef.html'>MethodDef</a> method)</code></p>

<p>After we have walked the expr tree, we go back and initialize the wrapper for any wrapped params used inside closures:</p>

<pre>Void foo(Int x)
{
  x$wrapper := Wrap$Int(x)
  ...</pre>
</dd>
<dt id='fixWrappedVar' class='method hidden'>fixWrappedVar<a href='ClosureVars_src.html#fixWrappedVar'>Source</a></dt>
<dd class='hidden'>
<p><code class='sig'>private <a href='Expr.html'>Expr</a> fixWrappedVar(<a href='LocalVarExpr.html'>LocalVarExpr</a> local)</code></p>

<p>If we are accessing a wrapped variable, then add indirection to access it from Wrapper.val field.</p>
</dd>
<dt id='genWrapper' class='method'>genWrapper<a href='ClosureVars_src.html#genWrapper'>Source</a></dt>
<dd>
<p><code class='sig'>static <a href='CField.html'>CField</a> genWrapper(<a href='CompilerSupport.html'>CompilerSupport</a> cs, <a href='CType.html'>CType</a> ctype)</code></p>

<p>Given a variable type, generate a wrapper class of the format:</p>

<pre>class Wrap$ctype[$n] { CType val }</pre>

<p>Wrappers are used to manage variables on the heap so that they can be shared between methods and closures.  We generate one wrapper class per variable type per pod with potentially a non-nullable and nullable variant ($n suffix).</p>

<p>Eventually we'd probably like to share wrappers for common types like Int, Str, Obj, etc.</p>

<p>Return the val field of the wrapper.</p>
</dd>
<dt id='initWrapper' class='method hidden'>initWrapper<a href='ClosureVars_src.html#initWrapper'>Source</a></dt>
<dd class='hidden'>
<p><code class='sig'>private <a href='Expr.html'>Expr</a> initWrapper(<a href='Loc.html'>Loc</a> loc, <a href='MethodVar.html'>MethodVar</a> var, <a href='Expr.html'>Expr</a> init)</code></p>

<p>Generate the expression: var := Wrapper(init)</p>
</dd>
<dt id='make' class='method'>make<a href='ClosureVars_src.html#make'>Source</a></dt>
<dd>
<p><code class='sig'>new make(<a href='Compiler.html'>Compiler</a> compiler)</code></p>
</dd>
<dt id='makeOuterThisField' class='method'>makeOuterThisField<a href='ClosureVars_src.html#makeOuterThisField'>Source</a></dt>
<dd>
<p><code class='sig'>static <a href='CField.html'>CField</a> makeOuterThisField(<a href='ClosureExpr.html'>ClosureExpr</a> closure)</code></p>

<p>This method is called by ClosureExpr to auto-generate the implicit outer "this" field in the Closure's implementation class:</p>

<ol style='list-style-type:decimal'>
<li>Add $this field to closure's anonymous class</li>

<li>Add $this param to closure's make constructor</li>

<li>Pass this to closure constructor at substitute site</li>

<li>Set field from param in constructor</li>
</ol>
</dd>
<dt id='processClosure' class='method hidden'>processClosure<a href='ClosureVars_src.html#processClosure'>Source</a></dt>
<dd class='hidden'>
<p><code class='sig'>private <a href='../sys/Void.html'>Void</a> processClosure(<a href='ClosureExpr.html'>ClosureExpr</a> closure)</code></p>

<p>Walk each closure:</p>

<ol style='list-style-type:decimal'>
<li>Find all the shadowed variables</li>

<li>Call addVarToClosure for each shadowed variable</li>

<li>If needed do expr tree walk</li>
</ol>
</dd>
<dt id='processMethod' class='method hidden'>processMethod<a href='ClosureVars_src.html#processMethod'>Source</a></dt>
<dd class='hidden'>
<p><code class='sig'>private <a href='../sys/Void.html'>Void</a> processMethod(<a href='MethodDef.html'>MethodDef</a> method)</code></p>
</dd>
<dt id='run' class='method'>run<a href='ClosureVars_src.html#run'>Source</a></dt>
<dd>
<p><code class='sig'>override <a href='../sys/Void.html'>Void</a> run()</code></p>
<div class='slotInfo'>
<p>Overrides <a href='CompilerStep.html#run'>compiler::CompilerStep.run</a></p>
<p>Doc inherited from <a href='CompilerStep.html#run'>compiler::CompilerStep.run</a></p>
</div>

<p>Run the step</p>
</dd>
<dt id='scanType' class='method hidden'>scanType<a href='ClosureVars_src.html#scanType'>Source</a></dt>
<dd class='hidden'>
<p><code class='sig'>private <a href='../sys/Void.html'>Void</a> scanType(<a href='TypeDef.html'>TypeDef</a> t)</code></p>
</dd>
<dt id='syntheticFieldFlags' class='field hidden'>syntheticFieldFlags<a href='ClosureVars_src.html#syntheticFieldFlags'>Source</a></dt>
<dd class='hidden'>
<p><code class='sig'>const static private <a href='../sys/Int.html'>Int</a> syntheticFieldFlags := ...</code></p>
</dd>
<dt id='visitExpr' class='method'>visitExpr<a href='ClosureVars_src.html#visitExpr'>Source</a></dt>
<dd>
<p><code class='sig'>override <a href='Expr.html'>Expr</a> visitExpr(<a href='Expr.html'>Expr</a> expr)</code></p>
<div class='slotInfo'>
<p>Overrides <a href='Visitor.html#visitExpr'>compiler::Visitor.visitExpr</a></p>
<p>Doc inherited from <a href='Visitor.html#visitExpr'>compiler::Visitor.visitExpr</a></p>
</div>

<p>Call to visit an expression.  Return expr or a new expression if doing a replacement for the expression in the abstract syntax tree.</p>
</dd>
<dt id='visitStmt' class='method'>visitStmt<a href='ClosureVars_src.html#visitStmt'>Source</a></dt>
<dd>
<p><code class='sig'>override <a href='Stmt.html'>Stmt</a>[]? visitStmt(<a href='Stmt.html'>Stmt</a> stmt)</code></p>
<div class='slotInfo'>
<p>Overrides <a href='Visitor.html#visitStmt'>compiler::Visitor.visitStmt</a></p>
<p>Doc inherited from <a href='Visitor.html#visitStmt'>compiler::Visitor.visitStmt</a></p>
</div>

<p>Callback when visiting a stmt.  Return a list to replace the statement with new statements, or return null to keep existing statement.</p>
</dd>
<dt id='walkMethod' class='method hidden'>walkMethod<a href='ClosureVars_src.html#walkMethod'>Source</a></dt>
<dd class='hidden'>
<p><code class='sig'>private <a href='../sys/Void.html'>Void</a> walkMethod(<a href='MethodDef.html'>MethodDef</a> method)</code></p>

<p>Walk the method body:</p>

<ol style='list-style-type:decimal'>
<li>Create wrapper for each local var definition which requries it</li>

<li>Add unwrap val access for each use of a wrapped local variable</li>

<li>If using a wrapped param, then replace with wrapped local</li>
</ol>
</dd>
<dt id='wrapNonFinalVars' class='method hidden'>wrapNonFinalVars<a href='ClosureVars_src.html#wrapNonFinalVars'>Source</a></dt>
<dd class='hidden'>
<p><code class='sig'>private <a href='../sys/Bool.html'>Bool</a> wrapNonFinalVars(<a href='MethodDef.html'>MethodDef</a> m)</code></p>

<p>Wrap each non-final variable which is reassigned and used inside a closure.  By wrapping it we hoist it into the heap so that it may be shared b/w method and closure(s).  Return true if we wrapped any vars.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class='sidebar'>
<h2>Type</h2>
<ul class='clean'>
  <li><a href='ClosureVars_src.html'>View Source</a></li>
  <li><a href='#' onclick='ShowSlots.toggle(event); return false;'>Show All Slots</a></li>
</ul>
<div class='slots'>
<div class='overview'>
<h2>Slots</h2>
<ul class='clean'>
  <li class='hidden'><a href='#addToClosure'>addToClosure</a></li>
  <li class='hidden'><a href='#addVarToClosure'>addVarToClosure</a></li>
  <li class='hidden'><a href='#fieldExpr'>fieldExpr</a></li>
  <li class='hidden'><a href='#fixLocalDef'>fixLocalDef</a></li>
  <li class='hidden'><a href='#fixWrappedParams'>fixWrappedParams</a></li>
  <li class='hidden'><a href='#fixWrappedVar'>fixWrappedVar</a></li>
  <li><a href='#genWrapper'>genWrapper</a></li>
  <li class='hidden'><a href='#initWrapper'>initWrapper</a></li>
  <li><a href='#make'>make</a></li>
  <li><a href='#makeOuterThisField'>makeOuterThisField</a></li>
  <li class='hidden'><a href='#processClosure'>processClosure</a></li>
  <li class='hidden'><a href='#processMethod'>processMethod</a></li>
  <li><a href='#run'>run</a></li>
  <li class='hidden'><a href='#scanType'>scanType</a></li>
  <li class='hidden'><a href='#syntheticFieldFlags'>syntheticFieldFlags</a></li>
  <li><a href='#visitExpr'>visitExpr</a></li>
  <li><a href='#visitStmt'>visitStmt</a></li>
  <li class='hidden'><a href='#walkMethod'>walkMethod</a></li>
  <li class='hidden'><a href='#wrapNonFinalVars'>wrapNonFinalVars</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class='footer'>
<div>
<p>
compiler 1.0.56
[11-Nov-2010 Thu 10:08:16AM EST]
</p>
</div>
</div>
</body>
</html>
