<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
  <title>compiler::ClosureToImmutable</title>
  <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
  <link rel='stylesheet' type='text/css' href='../doc.css'/>
  <script type='text/javascript' src='../doc.js'></script>
<!--[if lt IE 7]>
<script src='http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE7.js' type='text/javascript'></script>
<![endif]-->
</head>
<body onload='Login.check();'>
<div class='header'>
<div>
<h1><a href='/'>Fantom</a></h1>
<p id='sidewalkLogin_'>&nbsp;</p>
<form method='get' action='/sidewalk/search/'>
<p>
<input type='text' name='q' size='30' value='Search...' onfocus='if (value=="Search...") value=""' onblur='if (value=="") value="Search..."' />
</p>
</form>
<ul>
<li><a href='/'>Home</a></li>
<li class='active'><a href='../index.html'>Docs</a></li>
<li><a href='/sidewalk/blog/'>Blog</a></li>
<li><a href='/sidewalk/ticket/'>Tickets</a></li>
<li><a href='/sidewalk/topic/'>Discuss</a></li>
</ul></div>
</div>
<div class='subHeader'>
<div>
<ul>
  <li><a href='../index.html'>Doc Home</a></li>
  <li>&gt;</li>
  <li><a href='index.html'>compiler</a></li>
  <li>&gt;</li>
  <li><a href='ClosureToImmutable.html'>ClosureToImmutable</a></li>
</ul>
</div>
</div>
<div class='content'>
<div>
<div class='fandoc'>
<div class='type'>
<div class='overview'>
<h2>class</h2>
<h1>compiler::ClosureToImmutable</h1>
<pre><a href='../sys/Obj.html'>sys::Obj</a>
  <a href='CompilerSupport.html'>compiler::CompilerSupport</a>
    <a href='CompilerStep.html'>compiler::CompilerStep</a>
      compiler::ClosureToImmutable</pre>
</div>
</div>
<div class='src'>
<pre>
<span class='y'>//</span>
<span class='y'>// Copyright (c) 2009, Brian Frank and Andy Frank</span>
<span class='y'>// Licensed under the Academic Free License version 3.0</span>
<span class='y'>//</span>
<span class='y'>// History:</span>
<span class='y'>//   7 Sep 09  Brian Frank  Creation</span>
<span class='y'>//</span>

<span class='z'>**</span>
<span class='z'>** ClosureToImmutable processes each closure to determine</span>
<span class='z'>** its immutability.  At this point, all the enclosed variables</span>
<span class='z'>** have been mapped to fields by ClosureVars.  So we have</span>
<span class='z'>** three cases:</span>
<span class='z'>**</span>
<span class='z'>**  1. If every field is known const, then the function is</span>
<span class='z'>**     always immutable, and we can just override isImmutable</span>
<span class='z'>**     to return true.</span>
<span class='z'>**</span>
<span class='z'>**  2. If any field is known to never be const, then the function</span>
<span class='z'>**     can never be immutable, and we just use Func defaults for</span>
<span class='z'>**     isImmutable and toImmutable.</span>
<span class='z'>**</span>
<span class='z'>**  3. In the last case we have fields like Obj or List which require</span>
<span class='z'>**     us calling toImmutable.  In this case we generate a toImmutable</span>
<span class='z'>**     method which constructs a new closure instance by calling</span>
<span class='z'>**     toImmutable on each field.</span>
<span class='z'>**</span>
<span class='z'>**</span>
<span class='k'>class</span> ClosureToImmutable : CompilerStep
<span class='b'>{</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Constructor</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>new</span> <span id='make'>make</span><span class='b'>(</span>Compiler compiler<span class='b'>)</span> : <span class='k'>super</span><span class='b'>(</span>compiler<span class='b'>)</span> <span class='b'>{}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Run</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>override</span> Void <span id='run'>run</span><span class='b'>()</span>
  <span class='b'>{</span>
    compiler.closures.each |c| <span class='b'>{</span> process<span class='b'>(</span>c<span class='b'>)</span> <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='k'>private</span> Void <span id='process'>process</span><span class='b'>(</span>ClosureExpr closure<span class='b'>)</span>
  <span class='b'>{</span>
    cls := closure.cls

    <span class='y'>// if always immutable, then override isImmutable</span>
    <span class='y'>// to be true and set all the fields to be const;</span>
    <span class='y'>// Func.toImmutable will do the right thing for us</span>
    <span class='k'>if</span> <span class='b'>(</span>isAlwaysImmutable<span class='b'>(</span>cls<span class='b'>))</span>
    <span class='b'>{</span>
      genIsImmutable<span class='b'>(</span>cls, LiteralExpr.makeTrue<span class='b'>(</span>cls.loc, ns<span class='b'>))</span>
      setAllFieldsConst<span class='b'>(</span>cls<span class='b'>)</span>
      <span class='k'>return</span>
    <span class='b'>}</span>

    <span class='y'>// if never immutable we don't need to do anything, Func</span>
    <span class='y'>// isImmutable and toImmutable default to assume mutable</span>
    <span class='k'>if</span> <span class='b'>(</span>isNeverImmutable<span class='b'>(</span>cls<span class='b'>))</span> <span class='k'>return</span>

    <span class='y'>// if we have made it here we are neither always immutable</span>
    <span class='y'>// or never immutable - we could be immutable, but we have</span>
    <span class='y'>// to call toImmutable on each of our fields</span>
    genToImmutable<span class='b'>(</span>cls<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Are all the fields known to be const types?</span>
  <span class='z'>**</span>
  Bool <span id='isAlwaysImmutable'>isAlwaysImmutable</span><span class='b'>(</span>TypeDef cls<span class='b'>)</span>
  <span class='b'>{</span>
    cls.fieldDefs.all |f| <span class='b'>{</span> f.fieldType.isConst <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Are any of the fields known to never be immutable?</span>
  <span class='z'>**</span>
  Bool <span id='isNeverImmutable'>isNeverImmutable</span><span class='b'>(</span>TypeDef cls<span class='b'>)</span>
  <span class='b'>{</span>
    cls.fieldDefs.any |f| <span class='b'>{</span> !f.fieldType.isConstFieldType <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Set const flag on every field def.</span>
  <span class='z'>**</span>
  Void <span id='setAllFieldsConst'>setAllFieldsConst</span><span class='b'>(</span>TypeDef cls<span class='b'>)</span>
  <span class='b'>{</span>
    cls.fieldDefs.each |f| <span class='b'>{</span> f.flags = f.flags.or<span class='b'>(</span>FConst.Const<span class='b'>)</span> <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Generate: 'isImmutable() { return result }'</span>
  <span class='z'>**</span>
  <span class='k'>private</span> Void <span id='genIsImmutable'>genIsImmutable</span><span class='b'>(</span>TypeDef cls, Expr result<span class='b'>)</span>
  <span class='b'>{</span>
    loc := cls.loc
    m := MethodDef<span class='b'>(</span>loc, cls<span class='b'>)</span>
    m.flags = FConst.Public + FConst.Synthetic + FConst.Override
    m.name = <span class='s'>"isImmutable"</span>
    m.ret  = ns.boolType
    m.code = Block<span class='b'>(</span>loc<span class='b'>)</span>
    m.code.stmts.add<span class='b'>(</span>ReturnStmt.makeSynthetic<span class='b'>(</span>loc, result<span class='b'>))</span>
    cls.addSlot<span class='b'>(</span>m<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Generate toImmutable by attempting to construct a copy</span>
  <span class='z'>** of this closure with toImmutable called on every field</span>
  <span class='z'>** along with a flag to keep track of which state we are in.</span>
  <span class='z'>**</span>
  <span class='z'>**   Obj toImmutable()</span>
  <span class='z'>**   {</span>
  <span class='z'>**     r := make( (T1)f1.toImmutable, ... )</span>
  <span class='z'>**     r.isImmutable$ = true</span>
  <span class='z'>**     return true</span>
  <span class='z'>**   }</span>
  <span class='z'>**</span>
  <span class='z'>**   Bool isImmutable() { immutable }</span>
  <span class='z'>**</span>
  <span class='z'>**   private Bool immutable</span>
  <span class='z'>**</span>
  <span class='z'>**</span>
  <span class='z'>**</span>
  <span class='k'>private</span> Void <span id='genToImmutable'>genToImmutable</span><span class='b'>(</span>TypeDef cls<span class='b'>)</span>
  <span class='b'>{</span>
    loc := cls.loc

    <span class='y'>// Bool immutable</span>
    immutableField := FieldDef<span class='b'>(</span>loc, cls<span class='b'>)</span>
    immutableField.name = <span class='s'>"immutable"</span>
    immutableField.fieldType = ns.boolType
    immutableField.flags = FConst.Private + FConst.Storage + FConst.Synthetic
    cls.addSlot<span class='b'>(</span>immutableField<span class='b'>)</span>

    <span class='y'>// Bool isImmutable() { immutable }</span>
    genIsImmutable<span class='b'>(</span>cls, FieldExpr<span class='b'>(</span>loc, ThisExpr<span class='b'>(</span>loc, cls<span class='b'>)</span>, immutableField, <span class='k'>false</span><span class='b'>))</span>

    <span class='y'>// Obj toImmutable()</span>
    m := MethodDef<span class='b'>(</span>loc, cls<span class='b'>)</span>
    m.flags = FConst.Public + FConst.Synthetic + FConst.Override
    m.name = <span class='s'>"toImmutable"</span>
    m.ret  = ns.objType
    m.code = Block<span class='b'>(</span>loc<span class='b'>)</span>
    cls.addSlot<span class='b'>(</span>m<span class='b'>)</span>

    <span class='y'>// make( (T1)f1.toImmutable, ... )</span>
    ctor := cls.method<span class='b'>(</span><span class='s'>"make"</span><span class='b'>)</span>
    args := Expr<span class='b'>[</span>,<span class='b'>]</span>
    ctor.params.each |param|
    <span class='b'>{</span>
      field := cls.field<span class='b'>(</span>param.name<span class='b'>)</span>
      <span class='k'>if</span> <span class='b'>(</span>field == <span class='k'>null</span><span class='b'>)</span> <span class='k'>throw</span> Err<span class='b'>(</span><span class='s'>"Closure param missing matched field $param.name"</span><span class='b'>)</span>
      fieldGet := FieldExpr<span class='b'>(</span>loc, ThisExpr<span class='b'>(</span>loc, cls<span class='b'>)</span>, field, <span class='k'>false</span><span class='b'>)</span>
      <span class='k'>if</span> <span class='b'>(</span>field.fieldType.isConst<span class='b'>)</span>
      <span class='b'>{</span>
        args.add<span class='b'>(</span>fieldGet<span class='b'>)</span>
      <span class='b'>}</span>
      <span class='k'>else</span>
      <span class='b'>{</span>
        call := CallExpr.makeWithMethod<span class='b'>(</span>loc, fieldGet, ns.objToImmutable<span class='b'>)</span>
        args.add<span class='b'>(</span>TypeCheckExpr.coerce<span class='b'>(</span>call, field.fieldType<span class='b'>))</span>
      <span class='b'>}</span>
    <span class='b'>}</span>
    makeCall := CallExpr.makeWithMethod<span class='b'>(</span>loc, <span class='k'>null</span>, ctor, args<span class='b'>)</span>

    <span class='y'>// temp = make</span>
    temp := m.addLocalVar<span class='b'>(</span>cls, <span class='s'>"temp"</span>, m.code<span class='b'>)</span>
    m.code.add<span class='b'>(</span>BinaryExpr.makeAssign<span class='b'>(</span>
      LocalVarExpr<span class='b'>(</span>loc, temp<span class='b'>)</span>,
      makeCall<span class='b'>)</span>.toStmt<span class='b'>)</span>

    <span class='y'>// temp.immutable = true</span>
    m.code.add<span class='b'>(</span>BinaryExpr.makeAssign<span class='b'>(</span>
        FieldExpr<span class='b'>(</span>loc, LocalVarExpr<span class='b'>(</span>loc, temp<span class='b'>)</span>, immutableField, <span class='k'>false</span><span class='b'>)</span>,
        LiteralExpr.makeTrue<span class='b'>(</span>loc, ns<span class='b'>))</span>.toStmt<span class='b'>)</span>

    <span class='y'>// return temp</span>
    m.code.add<span class='b'>(</span>ReturnStmt.makeSynthetic<span class='b'>(</span>loc, LocalVarExpr<span class='b'>(</span>loc, temp<span class='b'>)))</span>
  <span class='b'>}</span>
<span class='b'>}</span>

</pre>
</div>
</div>
<div class='sidebar'>
<h2>More Info</h2>
<ul class='clean'>
  <li><a href='ClosureToImmutable.html'>View Fandoc</a></li>
</ul>
<div class='slots'>
<div class='overview'>
<h2>Slots</h2>
<ul class='clean'>
  <li class='hidden' style='display: block;'><a href='#genIsImmutable'>genIsImmutable</a></li>
  <li class='hidden' style='display: block;'><a href='#genToImmutable'>genToImmutable</a></li>
  <li style='display: block;'><a href='#isAlwaysImmutable'>isAlwaysImmutable</a></li>
  <li style='display: block;'><a href='#isNeverImmutable'>isNeverImmutable</a></li>
  <li style='display: block;'><a href='#make'>make</a></li>
  <li class='hidden' style='display: block;'><a href='#process'>process</a></li>
  <li style='display: block;'><a href='#run'>run</a></li>
  <li style='display: block;'><a href='#setAllFieldsConst'>setAllFieldsConst</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class='footer'>
<div>
<p>
compiler 1.0.56
[11-Nov-2010 Thu 10:08:17AM EST]
</p>
</div>
</div>
</body>
</html>
