<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
  <title>fandoc::FandocParser</title>
  <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
  <link rel='stylesheet' type='text/css' href='../doc.css'/>
  <script type='text/javascript' src='../doc.js'></script>
<!--[if lt IE 7]>
<script src='http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE7.js' type='text/javascript'></script>
<![endif]-->
</head>
<body onload='Login.check();'>
<div class='header'>
<div>
<h1><a href='/'>Fantom</a></h1>
<p id='sidewalkLogin_'>&nbsp;</p>
<form method='get' action='/sidewalk/search/'>
<p>
<input type='text' name='q' size='30' value='Search...' onfocus='if (value=="Search...") value=""' onblur='if (value=="") value="Search..."' />
</p>
</form>
<ul>
<li><a href='/'>Home</a></li>
<li class='active'><a href='../index.html'>Docs</a></li>
<li><a href='/sidewalk/blog/'>Blog</a></li>
<li><a href='/sidewalk/ticket/'>Tickets</a></li>
<li><a href='/sidewalk/topic/'>Discuss</a></li>
</ul></div>
</div>
<div class='subHeader'>
<div>
<ul>
  <li><a href='../index.html'>Doc Home</a></li>
  <li>&gt;</li>
  <li><a href='index.html'>fandoc</a></li>
  <li>&gt;</li>
  <li><a href='FandocParser.html'>FandocParser</a></li>
</ul>
</div>
</div>
<div class='content'>
<div>
<div class='fandoc'>
<div class='type'>
<div class='overview'>
<h2>class</h2>
<h1>fandoc::FandocParser</h1>
<pre><a href='../sys/Obj.html'>sys::Obj</a>
  fandoc::FandocParser</pre>
</div>
</div>
<div class='src'>
<pre>
<span class='y'>//</span>
<span class='y'>// Copyright (c) 2007, Brian Frank and Andy Frank</span>
<span class='y'>// Licensed under the Academic Free License version 3.0</span>
<span class='y'>//</span>
<span class='y'>// History:</span>
<span class='y'>//   17 Feb 07  Brian Frank  Creation</span>
<span class='y'>//</span>

<span class='z'>**</span>
<span class='z'>** FandocParser translate fandoc text into an in-memory</span>
<span class='z'>** representation of the document.</span>
<span class='z'>**</span>
<span class='z'>** See [pod doc]`pod-doc#api` for usage.</span>
<span class='z'>**</span>
<span class='k'>class</span> FandocParser
<span class='b'>{</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Parser</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Parse the document from the specified in stream into an in-memory</span>
  <span class='z'>** tree structure.  If close is true, the stream is guaranteed to be closed.</span>
  <span class='z'>**</span>
  Doc <span id='parse'>parse</span><span class='b'>(</span>Str filename, InStream in, Bool close := <span class='k'>true</span><span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>this</span>.filename = filename
    <span class='k'>this</span>.errs = FandocErr<span class='b'>[</span>,<span class='b'>]</span>
    readLines<span class='b'>(</span>in, close<span class='b'>)</span>

    doc := Doc.make
    <span class='k'>try</span>
    <span class='b'>{</span>
      header<span class='b'>(</span>doc<span class='b'>)</span>
      <span class='k'>while</span> <span class='b'>(</span>curt !== LineType.eof<span class='b'>)</span>
        doc.addChild<span class='b'>(</span>topBlock<span class='b'>)</span>
    <span class='b'>}</span>
    <span class='k'>catch</span> <span class='b'>(</span>Err e<span class='b'>)</span>
    <span class='b'>{</span>
      err<span class='b'>(</span><span class='s'>"Invalid line $curLine"</span>, curLine, e<span class='b'>)</span>
      doc.children = <span class='b'>[</span>Pre.make.addChild<span class='b'>(</span>DocText<span class='b'>(</span>lines.join<span class='b'>(</span><span class='s'>"\n"</span><span class='b'>)))]</span>
    <span class='b'>}</span>

    lines = <span class='k'>null</span>
    <span class='k'>return</span> doc
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Parse a string into its in-memory document tree structure.</span>
  <span class='z'>**</span>
  Doc <span id='parseStr'>parseStr</span><span class='b'>(</span>Str plaintext<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>return</span> parse<span class='b'>(</span><span class='s'>"str"</span>, plaintext.in, <span class='k'>true</span><span class='b'>)</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Header</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>private</span> Void <span id='header'>header</span><span class='b'>(</span>Doc doc<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>if</span> <span class='b'>(</span>!parseHeader<span class='b'>)</span> <span class='k'>return</span>
    skipBlankLines
    <span class='k'>while</span> <span class='b'>(</span>curt !== LineType.eof &amp;&amp; cur.startsWith<span class='b'>(</span><span class='s'>"**"</span><span class='b'>))</span>
    <span class='b'>{</span>
      colon := cur.index<span class='b'>(</span><span class='s'>":"</span><span class='b'>)</span>
      <span class='k'>if</span> <span class='b'>(</span>colon != <span class='k'>null</span><span class='b'>)</span>
      <span class='b'>{</span>
        key := cur<span class='b'>[</span>2..&lt;colon<span class='b'>]</span>.trim
        val := cur<span class='b'>[</span>colon+1..-1<span class='b'>]</span>.trim
        doc.meta<span class='b'>[</span>key<span class='b'>]</span> = val
      <span class='b'>}</span>
      <span class='k'>else</span>
      <span class='b'>{</span>
        <span class='k'>if</span> <span class='b'>(</span>!cur.startsWith<span class='b'>(</span><span class='s'>"****"</span><span class='b'>))</span> <span class='k'>break</span>
      <span class='b'>}</span>
      consume
    <span class='b'>}</span>
    skipBlankLines
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Block</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>private</span> DocElem <span id='topBlock'>topBlock</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='k'>switch</span> <span class='b'>(</span>peekt<span class='b'>)</span>
    <span class='b'>{</span>
      <span class='k'>case</span> LineType.h1:
      <span class='k'>case</span> LineType.h2:
      <span class='k'>case</span> LineType.h3:
        <span class='k'>return</span> heading
    <span class='b'>}</span>

    <span class='k'>return</span> block<span class='b'>(</span>0<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='k'>private</span> DocElem <span id='heading'>heading</span><span class='b'>()</span>
  <span class='b'>{</span>
    level := peekt.headingLevel
    h := Heading<span class='b'>(</span>level<span class='b'>)</span>
    curStart = 0
    formattedText<span class='b'>(</span>h<span class='b'>)</span>
    consume
    skipBlankLines
    <span class='k'>return</span> h
  <span class='b'>}</span>

  <span class='k'>private</span> DocElem <span id='block'>block</span><span class='b'>(</span>Int indent<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>switch</span> <span class='b'>(</span>curt<span class='b'>)</span>
    <span class='b'>{</span>
      <span class='k'>case</span> LineType.ol:
        <span class='k'>return</span> ol
      <span class='k'>case</span> LineType.ul:
        <span class='k'>return</span> ul
      <span class='k'>case</span> LineType.blockquote:
        <span class='k'>return</span> blockquote
      <span class='k'>case</span> LineType.preStart:
        <span class='k'>return</span> preExplicit
      <span class='k'>case</span> LineType.normal:
        <span class='k'>if</span> <span class='b'>(</span>curIndent &gt;= indent+2<span class='b'>)</span>
          <span class='k'>return</span> pre
        <span class='k'>else</span>
          <span class='k'>return</span> para
      <span class='k'>default</span>:
        <span class='k'>throw</span> Err<span class='b'>(</span>curt.toStr<span class='b'>)</span>
    <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='k'>private</span> DocElem <span id='para'>para</span><span class='b'>()</span>
  <span class='b'>{</span>
    para := Para.make

    <span class='y'>// if the first word is all capitals followed</span>
    <span class='y'>// by a colon then it is a admonition such as NOTE:</span>
    first := cur.trim.split.first
    <span class='k'>if</span> <span class='b'>(</span>first<span class='b'>[</span>-1<span class='b'>]</span> == <span class='s'>':'</span><span class='b'>)</span>
    <span class='b'>{</span>
      first = first<span class='b'>[</span>0..-2<span class='b'>]</span>
      <span class='k'>if</span> <span class='b'>(</span>first.all |Int ch-&gt;Bool| <span class='b'>{</span> <span class='k'>return</span> ch.isUpper <span class='b'>})</span>
      <span class='b'>{</span>
        para.admonition = first
        curStart = cur.index<span class='b'>(</span><span class='s'>":"</span><span class='b'>)</span> + 1
      <span class='b'>}</span>
    <span class='b'>}</span>

    <span class='k'>return</span> formattedText<span class='b'>(</span>para<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='k'>private</span> DocElem <span id='blockquote'>blockquote</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='y'>// block quote wraps paragraph</span>
    <span class='k'>return</span> BlockQuote.make.addChild<span class='b'>(</span>formattedText<span class='b'>(</span>Para.make<span class='b'>))</span>
  <span class='b'>}</span>

  <span class='k'>private</span> DocElem <span id='preExplicit'>preExplicit</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='y'>// skip pre&gt;</span>
    consume

    <span class='y'>// skip any blank lines</span>
    <span class='k'>while</span> <span class='b'>(</span>curt === LineType.blank<span class='b'>)</span> consume

    <span class='y'>// align against indentation of first line</span>
    indent := 0
    <span class='k'>while</span> <span class='b'>(</span>cur<span class='b'>[</span>indent<span class='b'>]</span> == <span class='s'>' '</span><span class='b'>)</span> indent++

    <span class='y'>// read preformatted lines</span>
    buf := StrBuf<span class='b'>(</span>256<span class='b'>)</span>
    <span class='k'>while</span> <span class='b'>(</span>curt !== LineType.preEnd &amp;&amp; curt !== LineType.eof<span class='b'>)</span>
    <span class='b'>{</span>
      <span class='k'>if</span> <span class='b'>(</span>cur.isEmpty<span class='b'>)</span> buf.add<span class='b'>(</span><span class='s'>"\n"</span><span class='b'>)</span>
      <span class='k'>else</span> <span class='k'>if</span> <span class='b'>(</span>cur.size &gt;= indent<span class='b'>)</span> buf.add<span class='b'>(</span>cur<span class='b'>[</span>indent..-1<span class='b'>])</span>.add<span class='b'>(</span><span class='s'>"\n"</span><span class='b'>)</span>
      <span class='k'>else</span> buf.add<span class='b'>(</span>cur<span class='b'>)</span>
      consume
    <span class='b'>}</span>
    consume

    <span class='k'>while</span> <span class='b'>(</span>curt === LineType.blank<span class='b'>)</span> consume

    pre := Pre.make
    pre.addChild<span class='b'>(</span>DocText<span class='b'>(</span>buf.toStr<span class='b'>))</span>
    <span class='k'>return</span> pre
  <span class='b'>}</span>

  <span class='k'>private</span> DocElem <span id='pre'>pre</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='y'>// first line defines left margin</span>
    indent := curIndent
    buf := StrBuf<span class='b'>(</span>256<span class='b'>)</span>
    buf.add<span class='b'>(</span>cur<span class='b'>[</span>indent..-1<span class='b'>])</span>
    consume

    <span class='k'>while</span> <span class='b'>(</span><span class='k'>true</span><span class='b'>)</span>
    <span class='b'>{</span>
      <span class='y'>// read in preformatted lines of code</span>
      <span class='k'>while</span> <span class='b'>(</span>curt === LineType.normal &amp;&amp; curIndent &gt;= indent<span class='b'>)</span>
      <span class='b'>{</span>
        buf.add<span class='b'>(</span><span class='s'>"\n"</span><span class='b'>)</span>.add<span class='b'>(</span>cur<span class='b'>[</span>indent..-1<span class='b'>])</span>
        consume
      <span class='b'>}</span>

      <span class='y'>// skip blanks but keep track of count</span>
      blanks := 0
      <span class='k'>while</span> <span class='b'>(</span>curt === LineType.blank<span class='b'>)</span> <span class='b'>{</span> consume; blanks++ <span class='b'>}</span>

      <span class='y'>// if more code, then add blank lines and continue</span>
      <span class='k'>if</span> <span class='b'>(</span>curt === LineType.normal &amp;&amp; curIndent &gt;= indent<span class='b'>)</span>
        blanks.times <span class='b'>{</span> buf.add<span class='b'>(</span><span class='s'>"\n"</span><span class='b'>)</span> <span class='b'>}</span>
      <span class='k'>else</span>
        <span class='k'>break</span>
    <span class='b'>}</span>

    pre := Pre.make
    pre.addChild<span class='b'>(</span>DocText<span class='b'>(</span>buf.toStr<span class='b'>))</span>
    <span class='k'>return</span> pre
  <span class='b'>}</span>

  <span class='k'>private</span> DocElem <span id='ol'>ol</span><span class='b'>()</span>
  <span class='b'>{</span>
    style := OrderedListStyle.fromFirstChar<span class='b'>(</span>cur.trim<span class='b'>[</span>0<span class='b'>])</span>
    <span class='k'>return</span> listItems<span class='b'>(</span>OrderedList<span class='b'>(</span>style<span class='b'>)</span>, curt, curIndent<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='k'>private</span> DocElem <span id='ul'>ul</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='k'>return</span> listItems<span class='b'>(</span>UnorderedList.make, curt, curIndent<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='k'>private</span> DocElem <span id='listItems'>listItems</span><span class='b'>(</span>DocElem list, LineType listType, Int listIndent<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>while</span> <span class='b'>(</span><span class='k'>true</span><span class='b'>)</span>
    <span class='b'>{</span>
      <span class='y'>// next item in my own list</span>
      <span class='k'>if</span> <span class='b'>(</span>curt === listType &amp;&amp; curIndent == listIndent<span class='b'>)</span>
      <span class='b'>{</span>
        list.addChild<span class='b'>(</span>formattedText<span class='b'>(</span>ListItem.make<span class='b'>))</span>
      <span class='b'>}</span>

      <span class='y'>// otherwise if indent is same or greater, then</span>
      <span class='y'>// this is a continuation of the my last node</span>
      <span class='k'>else</span> <span class='k'>if</span> <span class='b'>(</span>curIndent &gt;= listIndent<span class='b'>)</span>
      <span class='b'>{</span>
        <span class='b'>((</span>DocElem<span class='b'>)</span>list.children.last<span class='b'>)</span>.addChild<span class='b'>(</span>block<span class='b'>(</span>listIndent<span class='b'>))</span>
      <span class='b'>}</span>

      <span class='y'>// end of list</span>
      <span class='k'>else</span>
      <span class='b'>{</span>
        <span class='k'>break</span>
      <span class='b'>}</span>
    <span class='b'>}</span>
    <span class='k'>return</span> list
  <span class='b'>}</span>

  <span class='k'>private</span> DocElem <span id='formattedText'>formattedText</span><span class='b'>(</span>DocElem elem<span class='b'>)</span>
  <span class='b'>{</span>
    startLineNum := curLine
    startIndent  := curStart
    isBlockQuote := curt === LineType.blockquote

    buf := StrBuf<span class='b'>(</span>256<span class='b'>)</span>
    buf.add<span class='b'>(</span>cur<span class='b'>[</span>curStart..-1<span class='b'>]</span>.trim<span class='b'>)</span>
    consume

    <span class='k'>while</span> <span class='b'>(</span>curStart &lt;= startIndent &amp;&amp;
           <span class='b'>(</span>curt === LineType.normal || <span class='b'>(</span>isBlockQuote &amp;&amp; curt == LineType.blockquote<span class='b'>)))</span>
    <span class='b'>{</span>
      buf.add<span class='b'>(</span><span class='s'>"\n"</span><span class='b'>)</span>.add<span class='b'>(</span>cur<span class='b'>[</span>curStart..-1<span class='b'>]</span>.trim<span class='b'>)</span>
      consume
    <span class='b'>}</span>
    endLineNum := <span class='k'>this</span>.lineIndex - 2
    skipBlankLines

    oldNumChildren := elem.children.size
    <span class='k'>try</span>
    <span class='b'>{</span>
      InlineParser<span class='b'>(</span><span class='k'>this</span>, buf, startLineNum<span class='b'>)</span>.parse<span class='b'>(</span>elem<span class='b'>)</span>
    <span class='b'>}</span>
    <span class='k'>catch</span> <span class='b'>(</span>Err e<span class='b'>)</span>
    <span class='b'>{</span>
      <span class='k'>if</span> <span class='b'>(</span>e <span class='k'>is</span> FandocErr<span class='b'>)</span>
        errReport<span class='b'>((</span>FandocErr<span class='b'>)</span>e<span class='b'>)</span>
      <span class='k'>else</span>
        err<span class='b'>(</span><span class='s'>"Internal error: $e"</span>, startLineNum, e<span class='b'>)</span>

      elem.children = elem.children<span class='b'>[</span>0..&lt;oldNumChildren<span class='b'>]</span>
      elem.addChild<span class='b'>(</span>DocText<span class='b'>(</span>buf.toStr.replace<span class='b'>(</span><span class='s'>"\n"</span>, <span class='s'>" "</span><span class='b'>)))</span>
    <span class='b'>}</span>

    <span class='k'>return</span> elem
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// IO</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Read all the lines into memory and close stream if required.</span>
  <span class='z'>**</span>
  <span class='k'>private</span> Void <span id='readLines'>readLines</span><span class='b'>(</span>InStream in, Bool close<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>try</span>
    <span class='b'>{</span>
      lines = in.readAllLines
      numLines = lines.size
      lineIndex = curLine = 0
      consume
      consume
      curLine = 1
    <span class='b'>}</span>
    <span class='k'>finally</span>
    <span class='b'>{</span>
      <span class='k'>if</span> <span class='b'>(</span>close<span class='b'>)</span> in.close
    <span class='b'>}</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Utils</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Log an error</span>
  <span class='z'>**</span>
  <span class='k'>private</span> Void <span id='err'>err</span><span class='b'>(</span>Str msg, Int line, Err? cause := <span class='k'>null</span><span class='b'>)</span>
  <span class='b'>{</span>
    errReport<span class='b'>(</span>FandocErr<span class='b'>(</span>msg, filename, line, cause<span class='b'>))</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Log an error</span>
  <span class='z'>**</span>
  <span class='k'>private</span> Void <span id='errReport'>errReport</span><span class='b'>(</span>FandocErr err<span class='b'>)</span>
  <span class='b'>{</span>
    errs.add<span class='b'>(</span>err<span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>!silent<span class='b'>)</span> echo<span class='b'>(</span><span class='s'>"ERROR: $err"</span><span class='b'>)</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Skip any blank lines</span>
  <span class='z'>**</span>
  <span class='k'>private</span> Void <span id='skipBlankLines'>skipBlankLines</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='k'>while</span> <span class='b'>(</span>curt === LineType.blank<span class='b'>)</span> consume
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Return if line starting at index i is an ordered</span>
  <span class='z'>** list item:</span>
  <span class='z'>**   number* "." sp  (digits)</span>
  <span class='z'>**   letter  "." sp  (a-z | A-Z single letter only)</span>
  <span class='z'>**   roman*  "." sp  (ivx | IVX combos)</span>
  <span class='z'>**</span>
  <span class='k'>private</span> <span class='k'>static</span> Bool <span id='isOrderedListMark'>isOrderedListMark</span><span class='b'>(</span>Str line, Int i<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='y'>// check if first char is alpha numeric</span>
    <span class='k'>if</span> <span class='b'>(</span>!line<span class='b'>[</span>i<span class='b'>]</span>.isAlphaNum<span class='b'>)</span> <span class='k'>return</span> <span class='k'>false</span>

    <span class='y'>// find dot space</span>
    dot := line.index<span class='b'>(</span><span class='s'>". "</span>, i<span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>dot == <span class='k'>null</span><span class='b'>)</span> <span class='k'>return</span> <span class='k'>false</span>

    mark := line<span class='b'>[</span>i..&lt;dot<span class='b'>]</span>
    <span class='k'>if</span> <span class='b'>(</span>mark<span class='b'>[</span>0<span class='b'>]</span>.isDigit<span class='b'>)</span>
    <span class='b'>{</span>
      <span class='k'>return</span> mark.all |Int ch-&gt;Bool| <span class='b'>{</span> <span class='k'>return</span> ch.isDigit <span class='b'>}</span>
    <span class='b'>}</span>
    <span class='k'>else</span>
    <span class='b'>{</span>
      <span class='k'>return</span> mark.all |Int ch, Int index-&gt;Bool|
      <span class='b'>{</span>
        <span class='k'>switch</span> <span class='b'>(</span>ch<span class='b'>)</span>
        <span class='b'>{</span>
          <span class='k'>case</span> <span class='s'>'I'</span>:
          <span class='k'>case</span> <span class='s'>'V'</span>:
          <span class='k'>case</span> <span class='s'>'X'</span>:
          <span class='k'>case</span> <span class='s'>'i'</span>:
          <span class='k'>case</span> <span class='s'>'v'</span>:
          <span class='k'>case</span> <span class='s'>'x'</span>:
            <span class='k'>return</span> <span class='k'>true</span>
          <span class='k'>default</span>:
            <span class='k'>return</span> index == 0
        <span class='b'>}</span>
      <span class='b'>}</span>
    <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Consume the current line and advance to the next line</span>
  <span class='z'>**</span>
  <span class='k'>private</span> Void <span id='consume'>consume</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='y'>// advance cur to peek</span>
    cur       = peek
    curt      = peekt
    curIndent = peekIndent
    curStart  = peekStart
    curNotBlank := curt != LineType.blank
    curLine++

    <span class='y'>// update peek, peekIndent, and peekType</span>
    peek = <span class='b'>(</span>lineIndex &lt; numLines<span class='b'>)</span> ? lines<span class='b'>[</span>lineIndex++<span class='b'>]</span> : <span class='k'>null</span>
    peekIndent = peekStart = 0
    <span class='k'>if</span> <span class='b'>(</span>peek == <span class='k'>null</span><span class='b'>)</span>                  peekt = LineType.eof
    <span class='k'>else</span> <span class='k'>if</span> <span class='b'>(</span>peek.isSpace<span class='b'>)</span>             peekt = LineType.blank
    <span class='k'>else</span> <span class='k'>if</span> <span class='b'>(</span>peek.startsWith<span class='b'>(</span><span class='s'>"pre&gt;"</span><span class='b'>))</span>  peekt = LineType.preStart
    <span class='k'>else</span> <span class='k'>if</span> <span class='b'>(</span>peek.startsWith<span class='b'>(</span><span class='s'>"&lt;pre"</span><span class='b'>))</span>  peekt = LineType.preEnd
    <span class='k'>else</span> <span class='k'>if</span> <span class='b'>(</span>peek.startsWith<span class='b'>(</span><span class='s'>"***"</span><span class='b'>)</span> &amp;&amp; curNotBlank<span class='b'>)</span>  peekt = LineType.h1
    <span class='k'>else</span> <span class='k'>if</span> <span class='b'>(</span>peek.startsWith<span class='b'>(</span><span class='s'>"==="</span><span class='b'>)</span> &amp;&amp; curNotBlank<span class='b'>)</span>  peekt = LineType.h2
    <span class='k'>else</span> <span class='k'>if</span> <span class='b'>(</span>peek.startsWith<span class='b'>(</span><span class='s'>"---"</span><span class='b'>)</span> &amp;&amp; curNotBlank<span class='b'>)</span>  peekt = LineType.h3
    <span class='k'>else</span>
    <span class='b'>{</span>
      peekt = LineType.normal
      <span class='k'>while</span> <span class='b'>(</span>peek<span class='b'>[</span>peekIndent<span class='b'>]</span>.isSpace<span class='b'>)</span> peekIndent++
      <span class='k'>if</span> <span class='b'>(</span>peekIndent+2 &lt; peek.size<span class='b'>)</span>
      <span class='b'>{</span>
        <span class='k'>if</span> <span class='b'>(</span>peek<span class='b'>[</span>peekIndent<span class='b'>]</span> == <span class='s'>'-'</span> &amp;&amp; peek<span class='b'>[</span>peekIndent+1<span class='b'>]</span>.isSpace<span class='b'>)</span>
        <span class='b'>{</span>
          peekt = LineType.ul
          peekIndent += 2
          peekStart = peekIndent
        <span class='b'>}</span>
        <span class='k'>if</span> <span class='b'>(</span>isOrderedListMark<span class='b'>(</span>peek, peekIndent<span class='b'>))</span>
        <span class='b'>{</span>
          peekt = LineType.ol
          peekIndent += 2
          peekStart = peek.index<span class='b'>(</span><span class='s'>"."</span><span class='b'>)</span> + 2
        <span class='b'>}</span>
        <span class='k'>else</span> <span class='k'>if</span> <span class='b'>(</span>peek<span class='b'>[</span>peekIndent<span class='b'>]</span> == <span class='s'>'&gt;'</span> &amp;&amp; peek<span class='b'>[</span>peekIndent+1<span class='b'>]</span>.isSpace<span class='b'>)</span>
        <span class='b'>{</span>
          peekt = LineType.blockquote
          peekIndent += 2
          peekStart = peekIndent
        <span class='b'>}</span>
        <span class='k'>else</span>
        <span class='b'>{</span>
          peekStart = peekIndent
        <span class='b'>}</span>
      <span class='b'>}</span>
    <span class='b'>}</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Main</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>static</span> Void <span id='main'>main</span><span class='b'>(</span>Str<span class='b'>[]</span> args := Env.cur.args<span class='b'>)</span>
  <span class='b'>{</span>
    doc := make.parse<span class='b'>(</span>args<span class='b'>[</span>0<span class='b'>]</span>, File<span class='b'>(</span>args<span class='b'>[</span>0<span class='b'>]</span>.toUri<span class='b'>)</span>.in<span class='b'>)</span>
    doc.dump
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Fields</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>** If not silent, then errors are dumped to stdout</span>
  Bool <span id='silent'>silent</span> := <span class='k'>false</span>

  <span class='z'>** List of errors detected</span>
  FandocErr<span class='b'>[]</span> <span id='errs'>errs</span> := FandocErr<span class='b'>[</span>,<span class='b'>]</span>

  <span class='z'>** If true, then leading lines starting with '**' are parsed as header</span>
  Bool <span id='parseHeader'>parseHeader</span> := <span class='k'>true</span>

  <span class='k'>internal</span> Str <span id='filename'>filename</span> := <span class='s'>""</span> <span class='y'>// filename for reporting errors</span>
  <span class='k'>private</span> Str<span class='b'>[]</span>? <span id='lines'>lines</span>        <span class='y'>// lines of document</span>
  <span class='k'>private</span> Int <span id='numLines'>numLines</span>        <span class='y'>// lines.size</span>
  <span class='k'>private</span> Int <span id='lineIndex'>lineIndex</span>       <span class='y'>// current index in lines</span>
  <span class='k'>private</span> Str? <span id='cur'>cur</span>            <span class='y'>// current line</span>
  <span class='k'>private</span> Str? <span id='peek'>peek</span>           <span class='y'>// next line</span>
  <span class='k'>private</span> LineType? <span id='curt'>curt</span>      <span class='y'>// current line type</span>
  <span class='k'>private</span> LineType? <span id='peekt'>peekt</span>     <span class='y'>// peek line type</span>
  <span class='k'>private</span> Int <span id='curLine'>curLine</span>         <span class='y'>// one based line number of cur</span>
  <span class='k'>private</span> Int <span id='curIndent'>curIndent</span>       <span class='y'>// how many spaces is cur indented</span>
  <span class='k'>private</span> Int <span id='peekIndent'>peekIndent</span>      <span class='y'>// how many spaces is peek indented</span>
  <span class='k'>private</span> Int <span id='curStart'>curStart</span>        <span class='y'>// starting index of cur text</span>
  <span class='k'>private</span> Int <span id='peekStart'>peekStart</span>       <span class='y'>// starting index of cur text</span>
<span class='b'>}</span>

<span class='z'>**************************************************************************</span>
<span class='z'>** LineType</span>
<span class='z'>**************************************************************************</span>

<span class='k'>internal</span> <span class='k'>enum</span> <span class='k'>class</span> LineType
<span class='b'>{</span>
  eof,         <span class='y'>// end of file</span>
  blank,       <span class='y'>// space*</span>
  ul,          <span class='y'>// space* "-" space*</span>
  ol,          <span class='y'>// space* (number|letter)* "." space*</span>
  h1,          <span class='y'>// ***</span>
  h2,          <span class='y'>// ===</span>
  h3,          <span class='y'>// ---</span>
  blockquote,  <span class='y'>// &gt;</span>
  preStart,    <span class='y'>// pre&gt;</span>
  preEnd,      <span class='y'>// &lt;pre</span>
  normal       <span class='y'>// anything else</span>

  Bool isList<span class='b'>()</span> <span class='b'>{</span> <span class='k'>return</span> <span class='k'>this</span> === ul <span class='b'>}</span>

  Int headingLevel<span class='b'>()</span>
  <span class='b'>{</span>
    <span class='k'>switch</span> <span class='b'>(</span><span class='k'>this</span><span class='b'>)</span>
    <span class='b'>{</span>
      <span class='k'>case</span> h1: <span class='k'>return</span> 1
      <span class='k'>case</span> h2: <span class='k'>return</span> 2
      <span class='k'>case</span> h3: <span class='k'>return</span> 3
      <span class='k'>default</span>: <span class='k'>throw</span> Err<span class='b'>(</span>toStr<span class='b'>)</span>
    <span class='b'>}</span>
  <span class='b'>}</span>
<span class='b'>}</span></pre>
</div>
</div>
<div class='sidebar'>
<h2>More Info</h2>
<ul class='clean'>
  <li><a href='FandocParser.html'>View Fandoc</a></li>
</ul>
<div class='slots'>
<div class='overview'>
<h2>Slots</h2>
<ul class='clean'>
  <li class='hidden' style='display: block;'><a href='#block'>block</a></li>
  <li class='hidden' style='display: block;'><a href='#blockquote'>blockquote</a></li>
  <li class='hidden' style='display: block;'><a href='#consume'>consume</a></li>
  <li class='hidden' style='display: block;'><a href='#cur'>cur</a></li>
  <li class='hidden' style='display: block;'><a href='#curIndent'>curIndent</a></li>
  <li class='hidden' style='display: block;'><a href='#curLine'>curLine</a></li>
  <li class='hidden' style='display: block;'><a href='#curStart'>curStart</a></li>
  <li class='hidden' style='display: block;'><a href='#curt'>curt</a></li>
  <li class='hidden' style='display: block;'><a href='#err'>err</a></li>
  <li class='hidden' style='display: block;'><a href='#errReport'>errReport</a></li>
  <li style='display: block;'><a href='#errs'>errs</a></li>
  <li class='hidden' style='display: block;'><a href='#filename'>filename</a></li>
  <li class='hidden' style='display: block;'><a href='#formattedText'>formattedText</a></li>
  <li class='hidden' style='display: block;'><a href='#header'>header</a></li>
  <li class='hidden' style='display: block;'><a href='#heading'>heading</a></li>
  <li class='hidden' style='display: block;'><a href='#isOrderedListMark'>isOrderedListMark</a></li>
  <li class='hidden' style='display: block;'><a href='#lineIndex'>lineIndex</a></li>
  <li class='hidden' style='display: block;'><a href='#lines'>lines</a></li>
  <li class='hidden' style='display: block;'><a href='#listItems'>listItems</a></li>
  <li style='display: block;'><a href='#main'>main</a></li>
  <li class='hidden' style='display: block;'><a href='#numLines'>numLines</a></li>
  <li class='hidden' style='display: block;'><a href='#ol'>ol</a></li>
  <li class='hidden' style='display: block;'><a href='#para'>para</a></li>
  <li style='display: block;'><a href='#parse'>parse</a></li>
  <li style='display: block;'><a href='#parseHeader'>parseHeader</a></li>
  <li style='display: block;'><a href='#parseStr'>parseStr</a></li>
  <li class='hidden' style='display: block;'><a href='#peek'>peek</a></li>
  <li class='hidden' style='display: block;'><a href='#peekIndent'>peekIndent</a></li>
  <li class='hidden' style='display: block;'><a href='#peekStart'>peekStart</a></li>
  <li class='hidden' style='display: block;'><a href='#peekt'>peekt</a></li>
  <li class='hidden' style='display: block;'><a href='#pre'>pre</a></li>
  <li class='hidden' style='display: block;'><a href='#preExplicit'>preExplicit</a></li>
  <li class='hidden' style='display: block;'><a href='#readLines'>readLines</a></li>
  <li style='display: block;'><a href='#silent'>silent</a></li>
  <li class='hidden' style='display: block;'><a href='#skipBlankLines'>skipBlankLines</a></li>
  <li class='hidden' style='display: block;'><a href='#topBlock'>topBlock</a></li>
  <li class='hidden' style='display: block;'><a href='#ul'>ul</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class='footer'>
<div>
<p>
fandoc 1.0.56
[11-Nov-2010 Thu 10:08:22AM EST]
</p>
</div>
</div>
</body>
</html>
