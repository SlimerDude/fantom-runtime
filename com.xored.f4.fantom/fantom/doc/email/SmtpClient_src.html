<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
  <title>email::SmtpClient</title>
  <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
  <link rel='stylesheet' type='text/css' href='../doc.css'/>
  <script type='text/javascript' src='../doc.js'></script>
<!--[if lt IE 7]>
<script src='http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE7.js' type='text/javascript'></script>
<![endif]-->
</head>
<body onload='Login.check();'>
<div class='header'>
<div>
<h1><a href='/'>Fantom</a></h1>
<p id='sidewalkLogin_'>&nbsp;</p>
<form method='get' action='/sidewalk/search/'>
<p>
<input type='text' name='q' size='30' value='Search...' onfocus='if (value=="Search...") value=""' onblur='if (value=="") value="Search..."' />
</p>
</form>
<ul>
<li><a href='/'>Home</a></li>
<li class='active'><a href='../index.html'>Docs</a></li>
<li><a href='/sidewalk/blog/'>Blog</a></li>
<li><a href='/sidewalk/ticket/'>Tickets</a></li>
<li><a href='/sidewalk/topic/'>Discuss</a></li>
</ul></div>
</div>
<div class='subHeader'>
<div>
<ul>
  <li><a href='../index.html'>Doc Home</a></li>
  <li>&gt;</li>
  <li><a href='index.html'>email</a></li>
  <li>&gt;</li>
  <li><a href='SmtpClient.html'>SmtpClient</a></li>
</ul>
</div>
</div>
<div class='content'>
<div>
<div class='fandoc'>
<div class='type'>
<div class='overview'>
<h2>class</h2>
<h1>email::SmtpClient</h1>
<pre><a href='../sys/Obj.html'>sys::Obj</a>
  email::SmtpClient</pre>
</div>
</div>
<div class='src'>
<pre>
<span class='y'>//</span>
<span class='y'>// Copyright (c) 2008, Brian Frank and Andy Frank</span>
<span class='y'>// Licensed under the Academic Free License version 3.0</span>
<span class='y'>//</span>
<span class='y'>// History:</span>
<span class='y'>//   29 Apr 08  Brian Frank  Creation</span>
<span class='y'>//</span>

<span class='k'>using</span> inet

<span class='z'>**</span>
<span class='z'>** SmtpClient implements the client side of SMTP (Simple</span>
<span class='z'>** Mail Transport Protocol) as specified by RFC 2821.</span>
<span class='z'>**</span>
<span class='z'>** See [pod doc]`pod-doc` and [examples]`examples::email-sending`.</span>
<span class='z'>**</span>
<span class='k'>class</span> SmtpClient
<span class='b'>{</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Configuration</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** DNS hostname of server.</span>
  <span class='z'>**</span>
  Str? <span id='host'>host</span>

  <span class='z'>**</span>
  <span class='z'>** TCP port number of server, defaults to 25.</span>
  <span class='z'>**</span>
  Int <span id='port'>port</span> := 25

  <span class='z'>**</span>
  <span class='z'>** Username to use for authentication, or null to skip</span>
  <span class='z'>** authentication.</span>
  <span class='z'>**</span>
  Str? <span id='username'>username</span>

  <span class='z'>**</span>
  <span class='z'>** Password to use for authentication, or null to skip</span>
  <span class='z'>** authentication.</span>
  <span class='z'>**</span>
  Str? <span id='password'>password</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Send</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Return true if there is no open session.</span>
  <span class='z'>**</span>
  Bool <span id='isClosed'>isClosed</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='k'>return</span> sock == <span class='k'>null</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Open a session to the SMTP server.  If username and</span>
  <span class='z'>** password are configured, then SMTP authentication is</span>
  <span class='z'>** attempted.  Throw SmtpErr if there is a protocol error.</span>
  <span class='z'>** Throw IOErr is there is a network problem.</span>
  <span class='z'>**</span>
  Void <span id='open'>open</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='y'>// do sanity checking before opening the socket</span>
    <span class='k'>if</span> <span class='b'>(</span>host == <span class='k'>null</span><span class='b'>)</span> <span class='k'>throw</span> NullErr<span class='b'>(</span><span class='s'>"host is null"</span><span class='b'>)</span>

    <span class='y'>// open the socket connection</span>
    sock = TcpSocket<span class='b'>()</span>.connect<span class='b'>(</span>IpAddr<span class='b'>(</span>host<span class='b'>)</span>, port<span class='b'>)</span>
    <span class='k'>try</span>
    <span class='b'>{</span>
      <span class='y'>// read server hello</span>
      res := readRes
      <span class='k'>if</span> <span class='b'>(</span>res.code != 220<span class='b'>)</span> <span class='k'>throw</span> SmtpErr.makeRes<span class='b'>(</span>res<span class='b'>)</span>

      <span class='y'>// EHLO query the extensions supported</span>
      writeReq<span class='b'>(</span><span class='s'>"EHLO [$IpAddr.local.numeric]"</span><span class='b'>)</span>
      res = readRes
      <span class='k'>if</span> <span class='b'>(</span>res.code != 250<span class='b'>)</span> <span class='k'>throw</span> SmtpErr.makeRes<span class='b'>(</span>res<span class='b'>)</span>
      readExts<span class='b'>(</span>res<span class='b'>)</span>

      <span class='y'>// authenticate if configured</span>
      <span class='k'>if</span> <span class='b'>(</span>username != <span class='k'>null</span> &amp;&amp; password != <span class='k'>null</span> &amp;&amp; auths != <span class='k'>null</span><span class='b'>)</span>
        authenticate
    <span class='b'>}</span>
    <span class='k'>catch</span> <span class='b'>(</span>Err e<span class='b'>)</span>
    <span class='b'>{</span>
      close
      <span class='k'>throw</span> e
    <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Close the session to the SMTP server.  Do nothing if</span>
  <span class='z'>** session already closed.</span>
  <span class='z'>**</span>
  Void <span id='close'>close</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='k'>if</span> <span class='b'>(</span>sock != <span class='k'>null</span><span class='b'>)</span>
    <span class='b'>{</span>
      <span class='k'>try</span> <span class='b'>{</span> writeReq<span class='b'>(</span><span class='s'>"QUIT"</span><span class='b'>)</span> <span class='b'>}</span> <span class='k'>catch</span> <span class='b'>{}</span>
      <span class='k'>try</span> <span class='b'>{</span> sock.close <span class='b'>}</span> <span class='k'>catch</span> <span class='b'>{}</span>
      sock = <span class='k'>null</span>
    <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Send the email to the SMTP server.  Throw SmtpErr if</span>
  <span class='z'>** there is a protocol error.  Throw IOErr if there is</span>
  <span class='z'>** a networking problem.  If the session is closed, then</span>
  <span class='z'>** this call automatically opens the session and guarantees</span>
  <span class='z'>** a close after it is complete.</span>
  <span class='z'>**</span>
  Void <span id='send'>send</span><span class='b'>(</span>Email email<span class='b'>)</span>
  <span class='b'>{</span>
    email.validate
    autoOpen := isClosed
    <span class='k'>if</span> <span class='b'>(</span>autoOpen<span class='b'>)</span> open
    <span class='k'>try</span>
    <span class='b'>{</span>
      <span class='y'>// MAIL command</span>
      writeReq<span class='b'>(</span><span class='s'>"MAIL From:$email.from"</span><span class='b'>)</span>
      res := readRes
      <span class='k'>if</span> <span class='b'>(</span>res.code != 250<span class='b'>)</span> <span class='k'>throw</span> SmtpErr.makeRes<span class='b'>(</span>res<span class='b'>)</span>

      <span class='y'>// RCPT for each to address</span>
      email.recipients.each |Str to|
      <span class='b'>{</span>
        writeReq<span class='b'>(</span><span class='s'>"RCPT To:$to"</span><span class='b'>)</span>
        res = readRes
        <span class='k'>if</span> <span class='b'>(</span>res.code != 250<span class='b'>)</span> <span class='k'>throw</span> SmtpErr.makeRes<span class='b'>(</span>res<span class='b'>)</span>
      <span class='b'>}</span>

      <span class='y'>// DATA command</span>
      writeReq<span class='b'>(</span><span class='s'>"DATA"</span><span class='b'>)</span>
      res = readRes
      <span class='k'>if</span> <span class='b'>(</span>res.code != 354<span class='b'>)</span> <span class='k'>throw</span> SmtpErr.makeRes<span class='b'>(</span>res<span class='b'>)</span>

      <span class='y'>// encode email message</span>
      email.encode<span class='b'>(</span>sock.out<span class='b'>)</span>
      sock.out.flush
      res = readRes
      <span class='k'>if</span> <span class='b'>(</span>res.code != 250<span class='b'>)</span> <span class='k'>throw</span> SmtpErr.makeRes<span class='b'>(</span>res<span class='b'>)</span>
    <span class='b'>}</span>
    <span class='k'>finally</span>
    <span class='b'>{</span>
      <span class='k'>if</span> <span class='b'>(</span>autoOpen<span class='b'>)</span> close
    <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Write a request line to the server.</span>
  <span class='z'>**</span>
  <span class='k'>private</span> Void <span id='writeReq'>writeReq</span><span class='b'>(</span>Str req<span class='b'>)</span>
  <span class='b'>{</span>
    sock.out.print<span class='b'>(</span>req<span class='b'>)</span>.print<span class='b'>(</span><span class='s'>"\r\n"</span><span class='b'>)</span>.flush
    <span class='k'>if</span> <span class='b'>(</span>log.isDebug<span class='b'>)</span> log.debug<span class='b'>(</span><span class='s'>"c: $req"</span><span class='b'>)</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Read a single or multi-line reply from the server.</span>
  <span class='z'>**</span>
  <span class='k'>private</span> SmtpRes <span id='readRes'>readRes</span><span class='b'>()</span>
  <span class='b'>{</span>
    res := SmtpRes<span class='b'>()</span>

    <span class='k'>while</span> <span class='b'>(</span><span class='k'>true</span><span class='b'>)</span>
    <span class='b'>{</span>
      line := sock.in.readLine
      <span class='k'>try</span>
      <span class='b'>{</span>
        res.code = line<span class='b'>[</span>0..2<span class='b'>]</span>.toInt
        <span class='k'>if</span> <span class='b'>(</span>line.size &lt;= 4<span class='b'>)</span> <span class='b'>{</span> res.lines.add<span class='b'>(</span><span class='s'>""</span><span class='b'>)</span>; <span class='k'>break</span> <span class='b'>}</span>
        res.lines.add<span class='b'>(</span>line<span class='b'>[</span>4..-1<span class='b'>])</span>
        <span class='k'>if</span> <span class='b'>(</span>line<span class='b'>[</span>3<span class='b'>]</span> != <span class='s'>'-'</span><span class='b'>)</span> <span class='k'>break</span>
      <span class='b'>}</span>
      <span class='k'>catch</span> <span class='b'>(</span>Err e<span class='b'>)</span>
      <span class='b'>{</span>
        <span class='k'>throw</span> IOErr<span class='b'>(</span><span class='s'>"Invalid SMTP reply '$line'"</span><span class='b'>)</span>
      <span class='b'>}</span>
    <span class='b'>}</span>

    <span class='k'>if</span> <span class='b'>(</span>log.isDebug<span class='b'>)</span>
    <span class='b'>{</span>
      res.lines.each |Str line, Int i|
      <span class='b'>{</span>
        sep := i &lt; res.lines.size-1 ? <span class='s'>"-"</span> : <span class='s'>" "</span>
        log.debug<span class='b'>(</span><span class='s'>"s: $res.code$sep$line"</span><span class='b'>)</span>
      <span class='b'>}</span>
    <span class='b'>}</span>

    <span class='k'>return</span> res
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Query the reply lines to figure out which extensions</span>
  <span class='z'>** the server supports that we might use.</span>
  <span class='z'>**</span>
  <span class='k'>private</span> Void <span id='readExts'>readExts</span><span class='b'>(</span>SmtpRes res<span class='b'>)</span>
  <span class='b'>{</span>
    res.lines.each |Str line|
    <span class='b'>{</span>
      toks := line.upper.split
      <span class='k'>switch</span> <span class='b'>(</span>toks<span class='b'>[</span>0<span class='b'>])</span>
      <span class='b'>{</span>
        <span class='k'>case</span> <span class='s'>"AUTH"</span>:
          auths = toks<span class='b'>[</span>1..-1<span class='b'>]</span>
      <span class='b'>}</span>
    <span class='b'>}</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Authentication</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Authenticate using the strongest mechanism</span>
  <span class='z'>** which both the server and myself support.</span>
  <span class='z'>**</span>
  Void <span id='authenticate'>authenticate</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='k'>if</span> <span class='b'>(</span>auths.contains<span class='b'>(</span><span class='s'>"CRAM-MD5"</span><span class='b'>))</span> <span class='b'>{</span> authCramMd5; <span class='k'>return</span> <span class='b'>}</span>
    <span class='k'>if</span> <span class='b'>(</span>auths.contains<span class='b'>(</span><span class='s'>"LOGIN"</span><span class='b'>))</span>    <span class='b'>{</span> authLogin;   <span class='k'>return</span> <span class='b'>}</span>
    <span class='k'>if</span> <span class='b'>(</span>auths.contains<span class='b'>(</span><span class='s'>"PLAIN"</span><span class='b'>))</span>    <span class='b'>{</span> authPlain;   <span class='k'>return</span> <span class='b'>}</span>
    <span class='k'>throw</span> Err<span class='b'>(</span><span class='s'>"No AUTH mechanism available: $auths"</span><span class='b'>)</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Authenticate using CRAM-MD5 mechanism.</span>
  <span class='z'>**</span>
  Void <span id='authCramMd5'>authCramMd5</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='y'>// submit auth request which returns nonce</span>
    writeReq<span class='b'>(</span><span class='s'>"AUTH CRAM-MD5"</span><span class='b'>)</span>
    res := readRes
    <span class='k'>if</span> <span class='b'>(</span>res.code != 334<span class='b'>)</span> <span class='k'>throw</span> SmtpErr.makeRes<span class='b'>(</span>res<span class='b'>)</span>

    <span class='y'>// generate HMAC from nonce and password</span>
    nonce := Buf.fromBase64<span class='b'>(</span>res.line.trim<span class='b'>)</span>
    hmac := nonce.hmac<span class='b'>(</span><span class='s'>"MD5"</span>, password.toBuf<span class='b'>)</span>
    cred := <span class='s'>"$username $hmac.toHex.lower"</span>

    <span class='y'>// submit username space digest</span>
    writeReq<span class='b'>(</span>cred.toBuf.toBase64<span class='b'>)</span>
    res = readRes
    <span class='k'>if</span> <span class='b'>(</span>res.code != 235<span class='b'>)</span> <span class='k'>throw</span> SmtpErr.makeRes<span class='b'>(</span>res<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Authenticate using LOGIN mechanism.</span>
  <span class='z'>**</span>
  Void <span id='authLogin'>authLogin</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='y'>// auth</span>
    writeReq<span class='b'>(</span><span class='s'>"AUTH LOGIN"</span><span class='b'>)</span>
    res := readRes
    <span class='k'>if</span> <span class='b'>(</span>res.code != 334 || res.line != <span class='s'>"VXNlcm5hbWU6"</span><span class='b'>)</span> <span class='k'>throw</span> SmtpErr.makeRes<span class='b'>(</span>res<span class='b'>)</span>

    <span class='y'>// username</span>
    writeReq<span class='b'>(</span>username.toBuf.toBase64<span class='b'>)</span>
    res = readRes
    <span class='k'>if</span> <span class='b'>(</span>res.code != 334 || res.line != <span class='s'>"UGFzc3dvcmQ6"</span><span class='b'>)</span> <span class='k'>throw</span> SmtpErr.makeRes<span class='b'>(</span>res<span class='b'>)</span>

    <span class='y'>// password</span>
    writeReq<span class='b'>(</span>password.toBuf.toBase64<span class='b'>)</span>
    res = readRes
    <span class='k'>if</span> <span class='b'>(</span>res.code != 235<span class='b'>)</span> <span class='k'>throw</span> SmtpErr.makeRes<span class='b'>(</span>res<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Authenticate using PLAIN mechanism.</span>
  <span class='z'>**</span>
  Void <span id='authPlain'>authPlain</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='y'>// not tested against real SMTP server</span>
    creds := Buf<span class='b'>()</span>.write<span class='b'>(</span>0<span class='b'>)</span>.print<span class='b'>(</span>username<span class='b'>)</span>.write<span class='b'>(</span>0<span class='b'>)</span>.print<span class='b'>(</span>password<span class='b'>)</span>
    writeReq<span class='b'>(</span><span class='s'>"AUTH PLAIN $creds.toBase64"</span><span class='b'>)</span>
    res := readRes
    <span class='k'>if</span> <span class='b'>(</span>res.code != 235<span class='b'>)</span> <span class='k'>throw</span> SmtpErr.makeRes<span class='b'>(</span>res<span class='b'>)</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Fields</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>** Log for tracing</span>
  Log <span id='log'>log</span> := Log.get<span class='b'>(</span><span class='s'>"smtp"</span><span class='b'>)</span>

  <span class='k'>private</span> TcpSocket? <span id='sock'>sock</span>  <span class='y'>// Socket if open or null if closed</span>
  <span class='k'>private</span> Str<span class='b'>[]</span>? <span id='auths'>auths</span>     <span class='y'>// SASL auth mechanisms supported by server</span>
<span class='b'>}</span>

<span class='z'>**************************************************************************</span>
<span class='z'>** SmtpRes</span>
<span class='z'>**************************************************************************</span>

<span class='k'>internal</span> <span class='k'>class</span> SmtpRes
<span class='b'>{</span>
  Void dump<span class='b'>(</span>OutStream out := Env.cur.out<span class='b'>)</span>
  <span class='b'>{</span>
    lines.each |Str line, Int i|
    <span class='b'>{</span>
      sep := i &lt; lines.size-1 ? <span class='s'>"-"</span> : <span class='s'>" "</span>
      out.print<span class='b'>(</span>code<span class='b'>)</span>.print<span class='b'>(</span>sep<span class='b'>)</span>.printLine<span class='b'>(</span>line<span class='b'>)</span>
    <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='k'>override</span> Str toStr<span class='b'>()</span> <span class='b'>{</span> <span class='k'>return</span> <span class='s'>"$code $lines.last"</span> <span class='b'>}</span>

  Str line<span class='b'>()</span> <span class='b'>{</span> <span class='k'>return</span> lines.last <span class='b'>}</span>

  Int code
  Str<span class='b'>[]</span> lines := Str<span class='b'>[</span>,<span class='b'>]</span>
<span class='b'>}</span></pre>
</div>
</div>
<div class='sidebar'>
<h2>More Info</h2>
<ul class='clean'>
  <li><a href='SmtpClient.html'>View Fandoc</a></li>
</ul>
<div class='slots'>
<div class='overview'>
<h2>Slots</h2>
<ul class='clean'>
  <li style='display: block;'><a href='#authCramMd5'>authCramMd5</a></li>
  <li style='display: block;'><a href='#authLogin'>authLogin</a></li>
  <li style='display: block;'><a href='#authPlain'>authPlain</a></li>
  <li style='display: block;'><a href='#authenticate'>authenticate</a></li>
  <li class='hidden' style='display: block;'><a href='#auths'>auths</a></li>
  <li style='display: block;'><a href='#close'>close</a></li>
  <li style='display: block;'><a href='#host'>host</a></li>
  <li style='display: block;'><a href='#isClosed'>isClosed</a></li>
  <li style='display: block;'><a href='#log'>log</a></li>
  <li style='display: block;'><a href='#open'>open</a></li>
  <li style='display: block;'><a href='#password'>password</a></li>
  <li style='display: block;'><a href='#port'>port</a></li>
  <li class='hidden' style='display: block;'><a href='#readExts'>readExts</a></li>
  <li class='hidden' style='display: block;'><a href='#readRes'>readRes</a></li>
  <li style='display: block;'><a href='#send'>send</a></li>
  <li class='hidden' style='display: block;'><a href='#sock'>sock</a></li>
  <li style='display: block;'><a href='#username'>username</a></li>
  <li class='hidden' style='display: block;'><a href='#writeReq'>writeReq</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class='footer'>
<div>
<p>
email 1.0.56
[11-Nov-2010 Thu 10:08:23AM EST]
</p>
</div>
</div>
</body>
</html>
