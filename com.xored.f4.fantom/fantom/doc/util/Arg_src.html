<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
  <title>util::Arg</title>
  <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
  <link rel='stylesheet' type='text/css' href='../doc.css'/>
  <script type='text/javascript' src='../doc.js'></script>
<!--[if lt IE 7]>
<script src='http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE7.js' type='text/javascript'></script>
<![endif]-->
</head>
<body onload='Login.check();'>
<div class='header'>
<div>
<h1><a href='/'>Fantom</a></h1>
<p id='sidewalkLogin_'>&nbsp;</p>
<form method='get' action='/sidewalk/search/'>
<p>
<input type='text' name='q' size='30' value='Search...' onfocus='if (value=="Search...") value=""' onblur='if (value=="") value="Search..."' />
</p>
</form>
<ul>
<li><a href='/'>Home</a></li>
<li class='active'><a href='../index.html'>Docs</a></li>
<li><a href='/sidewalk/blog/'>Blog</a></li>
<li><a href='/sidewalk/ticket/'>Tickets</a></li>
<li><a href='/sidewalk/topic/'>Discuss</a></li>
</ul></div>
</div>
<div class='subHeader'>
<div>
<ul>
  <li><a href='../index.html'>Doc Home</a></li>
  <li>&gt;</li>
  <li><a href='index.html'>util</a></li>
  <li>&gt;</li>
  <li><a href='Arg.html'>Arg</a></li>
</ul>
</div>
</div>
<div class='content'>
<div>
<div class='fandoc'>
<div class='type'>
<div class='overview'>
<h2>const final class</h2>
<h1>util::Arg</h1>
<pre><a href='../sys/Obj.html'>sys::Obj</a>
  util::Arg : <a href='../sys/Facet.html'>sys::Facet</a></pre>
</div>
</div>
<div class='src'>
<pre>
<span class='y'>//</span>
<span class='y'>// Copyright (c) 2008, Brian Frank and Andy Frank</span>
<span class='y'>// Licensed under the Academic Free License version 3.0</span>
<span class='y'>//</span>
<span class='y'>// History:</span>
<span class='y'>//   8 Mar 08  Brian Frank  Creation</span>
<span class='y'>//   1 Dec 09  Brian Frank  Rename BootScript to AbstractMain</span>
<span class='y'>//</span>

<span class='k'>using</span> concurrent

<span class='z'>**</span>
<span class='z'>** AbstractMain provides conveniences for writing the main routine</span>
<span class='z'>** of an app. Command line arguments are configured as fields</span>
<span class='z'>** with the `Arg` facet:</span>
<span class='z'>**</span>
<span class='z'>**   @Arg { help = "source file to process" }</span>
<span class='z'>**   File? src</span>
<span class='z'>**</span>
<span class='z'>** Arguments are ordered by the field declaration order.  The</span>
<span class='z'>** last argument may be declared as a list to handle a variable</span>
<span class='z'>** numbers of arguments.</span>
<span class='z'>**</span>
<span class='z'>** Command line options are configured as fields with</span>
<span class='z'>** the `Opt` facet :</span>
<span class='z'>**</span>
<span class='z'>**   @Opt { help = "http port"; aliases=["p"] }</span>
<span class='z'>**   Int port := 8080</span>
<span class='z'>**</span>
<span class='z'>** Bool fields should always default to false and are considered</span>
<span class='z'>** flag options.  All other arg and opt fields must be a Str, File,</span>
<span class='z'>** or have a type which supports a 'fromStr' method.</span>
<span class='z'>**</span>
<span class='z'>** Option fields may include the "Opt" suffix, and arguments the</span>
<span class='z'>** "Arg" suffix.  These suffixes can be used when a field conflicts</span>
<span class='z'>** with an existing slot name.</span>
<span class='z'>**</span>
<span class='z'>** AbstractMain will automatically implement `usage` and</span>
<span class='z'>** `parseArgs` based on the fields which are declared as options</span>
<span class='z'>** and arguments.  In general subclasses only need to override `run`.</span>
<span class='z'>** If writing a daemon main, then you'll probably want to configure</span>
<span class='z'>** your services then call `runServices`.</span>
<span class='z'>**</span>
<span class='z'>** See [example]`examples::util-main`.</span>
<span class='z'>**</span>
<span class='k'>abstract</span> <span class='k'>class</span> AbstractMain
<span class='b'>{</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Environment</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Get the application name.  If this is a script it is the</span>
  <span class='z'>** name of the script file.  For a precompiled class called</span>
  <span class='z'>** "Main" this is the pod name, otherwise it is the type name.</span>
  <span class='z'>**</span>
  <span class='k'>virtual</span> Str appName<span class='b'>()</span>
  <span class='b'>{</span>
    t := Type.of<span class='b'>(</span><span class='k'>this</span><span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>t.pod.meta<span class='b'>[</span><span class='s'>"pod.isScript"</span><span class='b'>]</span> == <span class='s'>"true"</span><span class='b'>)</span> <span class='k'>return</span> t-&gt;sourceFile-&gt;toUri-&gt;basename
    <span class='k'>if</span> <span class='b'>(</span>t.name == <span class='s'>"Main"</span><span class='b'>)</span> <span class='k'>return</span> t.pod.name
    <span class='k'>return</span> t.name
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Log for this application; defaults to `appName`.</span>
  <span class='z'>**</span>
  <span class='k'>virtual</span> Log log<span class='b'>()</span> <span class='b'>{</span> Log.get<span class='b'>(</span>appName<span class='b'>)</span> <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Home directory for the application.  For a script</span>
  <span class='z'>** this defaults to directory of the script.  For pods</span>
  <span class='z'>** the default is "{Env.cur.workDir}/etc/{pod}".</span>
  <span class='z'>**</span>
  <span class='k'>virtual</span> File homeDir<span class='b'>()</span>
  <span class='b'>{</span>
    t := Type.of<span class='b'>(</span><span class='k'>this</span><span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>t.pod.meta<span class='b'>[</span><span class='s'>"pod.isScript"</span><span class='b'>]</span> == <span class='s'>"true"</span><span class='b'>)</span>
      <span class='k'>return</span> File<span class='b'>(</span>t-&gt;sourceFile-&gt;toUri<span class='b'>)</span>.parent
    <span class='k'>else</span>
      <span class='k'>return</span> Env.cur.workDir + <span class='u'>`etc/${t.pod.name}/`</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Print usage help.</span>
  <span class='z'>**</span>
  @Opt <span class='b'>{</span> help = <span class='s'>"Print usage help"</span>; aliases = <span class='b'>[</span><span class='s'>"?"</span><span class='b'>]</span> <span class='b'>}</span>
  Bool helpOpt := <span class='k'>false</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Command Line</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Get all the fields annotated with the '@arg' facet.</span>
  <span class='z'>**</span>
  <span class='k'>virtual</span> Field<span class='b'>[]</span> argFields<span class='b'>()</span>
  <span class='b'>{</span>
    Type.of<span class='b'>(</span><span class='k'>this</span><span class='b'>)</span>.fields.findAll |f| <span class='b'>{</span> f.hasFacet<span class='b'>(</span>Arg#<span class='b'>)</span> <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Get all the fields annotated with the '@opt' facet.</span>
  <span class='z'>**</span>
  <span class='k'>virtual</span> Field<span class='b'>[]</span> optFields<span class='b'>()</span>
  <span class='b'>{</span>
    Type.of<span class='b'>(</span><span class='k'>this</span><span class='b'>)</span>.fields.findAll |f| <span class='b'>{</span> f.hasFacet<span class='b'>(</span>Opt#<span class='b'>)</span> <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Parse the command line and set this instances fields.</span>
  <span class='z'>** Return false if not all of the arguments were passed.</span>
  <span class='z'>**</span>
  <span class='k'>virtual</span> Bool parseArgs<span class='b'>(</span>Str<span class='b'>[]</span> toks<span class='b'>)</span>
  <span class='b'>{</span>
    args := argFields
    opts := optFields
    varArgs := !args.isEmpty &amp;&amp; args.last.type.fits<span class='b'>(</span>List#<span class='b'>)</span>
    argi := 0
    <span class='k'>for</span> <span class='b'>(</span>i:=0; i&lt;toks.size; ++i<span class='b'>)</span>
    <span class='b'>{</span>
      tok := toks<span class='b'>[</span>i<span class='b'>]</span>
      Str? next := i+1 &lt; toks.size ? toks<span class='b'>[</span>i+1<span class='b'>]</span> : <span class='k'>null</span>
      <span class='k'>if</span> <span class='b'>(</span>tok.startsWith<span class='b'>(</span><span class='s'>"-"</span><span class='b'>))</span>
      <span class='b'>{</span>
        <span class='k'>if</span> <span class='b'>(</span>parseOpt<span class='b'>(</span>opts, tok, next<span class='b'>))</span> ++i
      <span class='b'>}</span>
      <span class='k'>else</span> <span class='k'>if</span> <span class='b'>(</span>argi &lt; args.size<span class='b'>)</span>
      <span class='b'>{</span>
        <span class='k'>if</span> <span class='b'>(</span>parseArg<span class='b'>(</span>args<span class='b'>[</span>argi<span class='b'>]</span>, tok<span class='b'>))</span> ++argi
      <span class='b'>}</span>
      <span class='k'>else</span>
      <span class='b'>{</span>
        log.warn<span class='b'>(</span><span class='s'>"Unexpected arg: $tok"</span><span class='b'>)</span>
      <span class='b'>}</span>
    <span class='b'>}</span>
    <span class='k'>if</span> <span class='b'>(</span>argi == args.size<span class='b'>)</span> <span class='k'>return</span> <span class='k'>true</span>
    <span class='k'>if</span> <span class='b'>(</span>argi == args.size-1 &amp;&amp; varArgs<span class='b'>)</span> <span class='k'>return</span> <span class='k'>true</span>
    <span class='k'>return</span> <span class='k'>false</span> <span class='y'>// missing args</span>
  <span class='b'>}</span>

  <span class='k'>private</span> Bool parseOpt<span class='b'>(</span>Field<span class='b'>[]</span> opts, Str tok, Str? next<span class='b'>)</span>
  <span class='b'>{</span>
    n := tok<span class='b'>[</span>1..-1<span class='b'>]</span>
    <span class='k'>for</span> <span class='b'>(</span>i:=0; i&lt;opts.size; ++i<span class='b'>)</span>
    <span class='b'>{</span>
      <span class='y'>// if name doesn't match opt or any of its aliases then continue</span>
      field := opts<span class='b'>[</span>i<span class='b'>]</span>
      facet := <span class='b'>(</span>Opt<span class='b'>)</span>field.facet<span class='b'>(</span>Opt#<span class='b'>)</span>
      aliases := facet
      <span class='k'>if</span> <span class='b'>(</span>optName<span class='b'>(</span>field<span class='b'>)</span> != n &amp;&amp; !facet.aliases.contains<span class='b'>(</span>n<span class='b'>))</span> <span class='k'>continue</span>

      <span class='y'>// if field is a bool we always assume the true value</span>
      <span class='k'>if</span> <span class='b'>(</span>field.type == Bool#<span class='b'>)</span>
      <span class='b'>{</span>
        field.set<span class='b'>(</span><span class='k'>this</span>, <span class='k'>true</span><span class='b'>)</span>
        <span class='k'>return</span> <span class='k'>false</span> <span class='y'>// did not consume next</span>
      <span class='b'>}</span>

      <span class='y'>// check that we have a next value to parse</span>
      <span class='k'>if</span> <span class='b'>(</span>next == <span class='k'>null</span> || next.startsWith<span class='b'>(</span><span class='s'>"-"</span><span class='b'>))</span>
      <span class='b'>{</span>
        log.err<span class='b'>(</span><span class='s'>"Missing value for -$n"</span><span class='b'>)</span>
        <span class='k'>return</span> <span class='k'>false</span> <span class='y'>// did not consume next</span>
      <span class='b'>}</span>

      <span class='k'>try</span>
      <span class='b'>{</span>
        <span class='y'>// parse the value to proper type and set field</span>
        field.set<span class='b'>(</span><span class='k'>this</span>, parseVal<span class='b'>(</span>field.type, next<span class='b'>))</span>
      <span class='b'>}</span>
      <span class='k'>catch</span> <span class='b'>(</span>Err e<span class='b'>)</span> log.err<span class='b'>(</span><span class='s'>"Cannot parse -$n as $field.type.name: $next"</span><span class='b'>)</span>
      <span class='k'>return</span> <span class='k'>true</span> <span class='y'>// we *did* consume next</span>
    <span class='b'>}</span>

    log.warn<span class='b'>(</span><span class='s'>"Unknown option -$n"</span><span class='b'>)</span>
    <span class='k'>return</span> <span class='k'>false</span> <span class='y'>// did not consume next</span>
  <span class='b'>}</span>

  <span class='k'>private</span> Bool parseArg<span class='b'>(</span>Field field, Str tok<span class='b'>)</span>
  <span class='b'>{</span>
    isList := field.type.fits<span class='b'>(</span>List#<span class='b'>)</span>
    <span class='k'>try</span>
    <span class='b'>{</span>
      <span class='y'>// if not a list, this is easy</span>
      <span class='k'>if</span> <span class='b'>(</span>!isList<span class='b'>)</span>
      <span class='b'>{</span>
        field.set<span class='b'>(</span><span class='k'>this</span>, parseVal<span class='b'>(</span>field.type, tok<span class='b'>))</span>
        <span class='k'>return</span> <span class='k'>true</span> <span class='y'>// increment argi</span>
      <span class='b'>}</span>

      <span class='y'>// if list, then parse list item and add to end of list</span>
      of := field.type.params<span class='b'>[</span><span class='s'>"V"</span><span class='b'>]</span>
      val :=  parseVal<span class='b'>(</span>of, tok<span class='b'>)</span>
      list := field.get<span class='b'>(</span><span class='k'>this</span><span class='b'>)</span> <span class='k'>as</span> Obj?<span class='b'>[]</span>
      <span class='k'>if</span> <span class='b'>(</span>list == <span class='k'>null</span><span class='b'>)</span> field.set<span class='b'>(</span><span class='k'>this</span>, list = List.make<span class='b'>(</span>of, 8<span class='b'>))</span>
      list.add<span class='b'>(</span>val<span class='b'>)</span>
    <span class='b'>}</span>
    <span class='k'>catch</span> <span class='b'>(</span>Err e<span class='b'>)</span> log.err<span class='b'>(</span><span class='s'>"Cannot parse argument as $field.type.name: $tok"</span><span class='b'>)</span>
    <span class='k'>return</span> !isList <span class='y'>// increment argi if not list</span>
  <span class='b'>}</span>

  <span class='k'>private</span> Str argName<span class='b'>(</span>Field f<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>if</span> <span class='b'>(</span>f.name.endsWith<span class='b'>(</span><span class='s'>"Arg"</span><span class='b'>))</span> <span class='k'>return</span> f.name<span class='b'>[</span>0..&lt;-3<span class='b'>]</span>
    <span class='k'>return</span> f.name
  <span class='b'>}</span>

  <span class='k'>private</span> Str optName<span class='b'>(</span>Field f<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>if</span> <span class='b'>(</span>f.name.endsWith<span class='b'>(</span><span class='s'>"Opt"</span><span class='b'>))</span> <span class='k'>return</span> f.name<span class='b'>[</span>0..&lt;-3<span class='b'>]</span>
    <span class='k'>return</span> f.name
  <span class='b'>}</span>

  <span class='k'>private</span> Void updateField<span class='b'>(</span>Field f, Str tok<span class='b'>)</span>
  <span class='b'>{</span>
    Obj? val := tok
    <span class='k'>if</span> <span class='b'>(</span>f.type.toNonNullable != Str#<span class='b'>)</span>
      val = f.type.method<span class='b'>(</span><span class='s'>"fromStr"</span><span class='b'>)</span>.call<span class='b'>(</span>tok<span class='b'>)</span>
    f.set<span class='b'>(</span><span class='k'>this</span>, val<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='k'>private</span> Obj? parseVal<span class='b'>(</span>Type of, Str tok<span class='b'>)</span>
  <span class='b'>{</span>
    of = of.toNonNullable
    <span class='k'>if</span> <span class='b'>(</span>of == Str#<span class='b'>)</span> <span class='k'>return</span> tok
    <span class='k'>if</span> <span class='b'>(</span>of == File#<span class='b'>)</span>
    <span class='b'>{</span>
      <span class='k'>if</span> <span class='b'>(</span>tok.contains<span class='b'>(</span><span class='s'>"\\"</span><span class='b'>))</span>
        <span class='k'>return</span> File.os<span class='b'>(</span>tok<span class='b'>)</span>.normalize
      <span class='k'>else</span>
        <span class='k'>return</span> File.make<span class='b'>(</span>tok.toUri, <span class='k'>false</span><span class='b'>)</span>
    <span class='b'>}</span>
    <span class='k'>return</span> of.method<span class='b'>(</span><span class='s'>"fromStr"</span><span class='b'>)</span>.call<span class='b'>(</span>tok<span class='b'>)</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Usage</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Print usage of arguments and options.</span>
  <span class='z'>** Return non-zero.</span>
  <span class='z'>**</span>
  <span class='k'>virtual</span> Int usage<span class='b'>(</span>OutStream out := Env.cur.out<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='y'>// get list of argument and option fields</span>
    args := argFields
    opts := optFields

    <span class='y'>// format args/opts into columns</span>
    argRows := usagePad<span class='b'>(</span>args.map |f| <span class='b'>{</span> usageArg<span class='b'>(</span>f<span class='b'>)</span> <span class='b'>})</span>
    optRows := usagePad<span class='b'>(</span>opts.map |f| <span class='b'>{</span> usageOpt<span class='b'>(</span>f<span class='b'>)</span> <span class='b'>})</span>

    <span class='y'>// format summary line</span>
    argSummary := args.join<span class='b'>(</span><span class='s'>" "</span><span class='b'>)</span> |field|
    <span class='b'>{</span>
      s := <span class='s'>"&lt;"</span> + argName<span class='b'>(</span>field<span class='b'>)</span> + <span class='s'>"&gt;"</span>
      <span class='k'>if</span> <span class='b'>(</span>field.type.fits<span class='b'>(</span>List#<span class='b'>))</span> s += <span class='s'>"*"</span>
      <span class='k'>return</span> s
    <span class='b'>}</span>

    <span class='y'>// print usage</span>
    out.printLine
    out.printLine<span class='b'>(</span><span class='s'>"Usage:"</span><span class='b'>)</span>
    out.printLine<span class='b'>(</span><span class='s'>"  $appName [options] $argSummary"</span><span class='b'>)</span>
    usagePrint<span class='b'>(</span>out, <span class='s'>"Arguments:"</span>, argRows<span class='b'>)</span>
    usagePrint<span class='b'>(</span>out, <span class='s'>"Options:"</span>, optRows<span class='b'>)</span>
    out.printLine
    <span class='k'>return</span> 1
  <span class='b'>}</span>

  <span class='k'>private</span> Str<span class='b'>[]</span> usageArg<span class='b'>(</span>Field field<span class='b'>)</span>
  <span class='b'>{</span>
    name := argName<span class='b'>(</span>field<span class='b'>)</span>
    help := field.facet<span class='b'>(</span>Arg#<span class='b'>)</span>-&gt;help <span class='k'>as</span> Str
    <span class='k'>return</span> <span class='b'>[</span>name, help<span class='b'>]</span>
  <span class='b'>}</span>

  <span class='k'>private</span> Str<span class='b'>[]</span> usageOpt<span class='b'>(</span>Field field<span class='b'>)</span>
  <span class='b'>{</span>
    name := optName<span class='b'>(</span>field<span class='b'>)</span>
    def  := field.get<span class='b'>(</span>Type.of<span class='b'>(</span><span class='k'>this</span><span class='b'>)</span>.make<span class='b'>)</span>
    help := field.facet<span class='b'>(</span>Opt#<span class='b'>)</span>-&gt;help <span class='k'>as</span> Str
    Str<span class='b'>[]</span> aliases := field.facet<span class='b'>(</span>Opt#<span class='b'>)</span>-&gt;aliases

    col1 := <span class='s'>"-$name"</span>
    <span class='k'>if</span> <span class='b'>(</span>!aliases.isEmpty<span class='b'>)</span> col1 += <span class='s'>", -"</span> + aliases.join<span class='b'>(</span><span class='s'>", -"</span><span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>def != <span class='k'>false</span><span class='b'>)</span> col1 += <span class='s'>" &lt;$field.type.name&gt;"</span>

    col2 := help
    <span class='k'>if</span> <span class='b'>(</span>def != <span class='k'>false</span> &amp;&amp; def != <span class='k'>null</span><span class='b'>)</span> col2 += <span class='s'>" (default $def)"</span>

    <span class='k'>return</span> <span class='b'>[</span>col1, col2<span class='b'>]</span>
  <span class='b'>}</span>

  <span class='k'>private</span> Str<span class='b'>[][]</span> usagePad<span class='b'>(</span>Str<span class='b'>[][]</span> rows<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>if</span> <span class='b'>(</span>rows.isEmpty<span class='b'>)</span> <span class='k'>return</span> rows
    Int max := rows.map |row| <span class='b'>{</span> row<span class='b'>[</span>0<span class='b'>]</span>.size <span class='b'>}</span>.max
    pad := 20.min<span class='b'>(</span>2 + max<span class='b'>)</span>
    rows.each |row| <span class='b'>{</span> row<span class='b'>[</span>0<span class='b'>]</span> = row<span class='b'>[</span>0<span class='b'>]</span>.padr<span class='b'>(</span>pad<span class='b'>)</span> <span class='b'>}</span>
    <span class='k'>return</span> rows
  <span class='b'>}</span>

  <span class='k'>private</span> Void usagePrint<span class='b'>(</span>OutStream out, Str title, Str<span class='b'>[][]</span> rows<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>if</span> <span class='b'>(</span>rows.isEmpty<span class='b'>)</span> <span class='k'>return</span>
    out.printLine<span class='b'>(</span>title<span class='b'>)</span>
    rows.each |row| <span class='b'>{</span> out.printLine<span class='b'>(</span><span class='s'>"  ${row[0]}  ${row[1]}"</span><span class='b'>)</span> <span class='b'>}</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Run</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Run the application.  This method is called after the</span>
  <span class='z'>** command line has been parsed.  See `runServices` to</span>
  <span class='z'>** launch a deamon application.  Return status code, zero</span>
  <span class='z'>** for success.</span>
  <span class='z'>**</span>
  <span class='k'>abstract</span> Int run<span class='b'>()</span>

  <span class='z'>**</span>
  <span class='z'>** Run the set of services:</span>
  <span class='z'>**   1. call install on each service</span>
  <span class='z'>**   2. call start on each service</span>
  <span class='z'>**   3. put main thread to sleep.</span>
  <span class='z'>**</span>
  <span class='k'>virtual</span> Int runServices<span class='b'>(</span>Service<span class='b'>[]</span> services<span class='b'>)</span>
  <span class='b'>{</span>
    services.each |Service s| <span class='b'>{</span> s.install <span class='b'>}</span>
    services.each |Service s| <span class='b'>{</span> s.start <span class='b'>}</span>
    Actor.sleep<span class='b'>(</span>Duration.maxVal<span class='b'>)</span>
    <span class='k'>return</span> 0
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Main</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Main performs the following tasks:</span>
  <span class='z'>**   1. Calls `parseArgs` to parse command line</span>
  <span class='z'>**   2. If args were incomplete or -help was specified</span>
  <span class='z'>**      then dump usage and return 1</span>
  <span class='z'>**   3. Call `run` and return 0</span>
  <span class='z'>**   4. If an exception is raised log it and return 1</span>
  <span class='z'>**</span>
  <span class='k'>virtual</span> Int main<span class='b'>(</span>Str<span class='b'>[]</span> args := Env.cur.args<span class='b'>)</span>
  <span class='b'>{</span>
    success := <span class='k'>false</span>
    <span class='k'>try</span>
    <span class='b'>{</span>
      <span class='y'>// parse command line</span>
      argsOk := parseArgs<span class='b'>(</span>args<span class='b'>)</span>

      <span class='y'>// if args not ok or help was specified, dump usage</span>
      <span class='k'>if</span> <span class='b'>(</span>!argsOk || helpOpt<span class='b'>)</span>
      <span class='b'>{</span>
        usage
        <span class='k'>if</span> <span class='b'>(</span>!helpOpt<span class='b'>)</span> log.err<span class='b'>(</span><span class='s'>"Missing arguments"</span><span class='b'>)</span>
        <span class='k'>return</span> 1
      <span class='b'>}</span>

      <span class='y'>// call run</span>
      <span class='k'>return</span> run
    <span class='b'>}</span>
    <span class='k'>catch</span> <span class='b'>(</span>Err err<span class='b'>)</span>
    <span class='b'>{</span>
      log.err<span class='b'>(</span><span class='s'>"Cannot boot"</span><span class='b'>)</span>
      err.trace
      <span class='k'>return</span> 1
    <span class='b'>}</span>
  <span class='b'>}</span>

<span class='b'>}</span>

<span class='z'>**************************************************************************</span>
<span class='z'>** Arg</span>
<span class='z'>**************************************************************************</span>

<span class='z'>**</span>
<span class='z'>** Facet for annotating an `AbstractMain` argument field.</span>
<span class='z'>**</span>
facet <span class='k'>class</span> Arg
<span class='b'>{</span>
  <span class='z'>** Usage help, should be a single short line summary</span>
  <span class='k'>const</span> Str <span id='help'>help</span> := <span class='s'>""</span>
<span class='b'>}</span>

<span class='z'>**************************************************************************</span>
<span class='z'>** Opt</span>
<span class='z'>**************************************************************************</span>

<span class='z'>**</span>
<span class='z'>** Facet for annotating an `AbstractMain` option field.</span>
<span class='z'>**</span>
facet <span class='k'>class</span> Opt
<span class='b'>{</span>
  <span class='z'>** Usage help, should be a single short line summary</span>
  <span class='k'>const</span> Str help := <span class='s'>""</span>

  <span class='z'>** Aliases for the option</span>
  <span class='k'>const</span> Str<span class='b'>[]</span> aliases := Str<span class='b'>[</span>,<span class='b'>]</span>
<span class='b'>}</span>

</pre>
</div>
</div>
<div class='sidebar'>
<h2>More Info</h2>
<ul class='clean'>
  <li><a href='Arg.html'>View Fandoc</a></li>
</ul>
<div class='slots'>
<div class='overview'>
<h2>Slots</h2>
<ul class='clean'>
  <li style='display: block;'><a href='#help'>help</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class='footer'>
<div>
<p>
util 1.0.56
[11-Nov-2010 Thu 10:08:19AM EST]
</p>
</div>
</div>
</body>
</html>
