<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
  <title>util::FileLogger</title>
  <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
  <link rel='stylesheet' type='text/css' href='../doc.css'/>
  <script type='text/javascript' src='../doc.js'></script>
<!--[if lt IE 7]>
<script src='http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE7.js' type='text/javascript'></script>
<![endif]-->
</head>
<body onload='Login.check();'>
<div class='header'>
<div>
<h1><a href='/'>Fantom</a></h1>
<p id='sidewalkLogin_'>&nbsp;</p>
<form method='get' action='/sidewalk/search/'>
<p>
<input type='text' name='q' size='30' value='Search...' onfocus='if (value=="Search...") value=""' onblur='if (value=="") value="Search..."' />
</p>
</form>
<ul>
<li><a href='/'>Home</a></li>
<li class='active'><a href='../index.html'>Docs</a></li>
<li><a href='/sidewalk/blog/'>Blog</a></li>
<li><a href='/sidewalk/ticket/'>Tickets</a></li>
<li><a href='/sidewalk/topic/'>Discuss</a></li>
</ul></div>
</div>
<div class='subHeader'>
<div>
<ul>
  <li><a href='../index.html'>Doc Home</a></li>
  <li>&gt;</li>
  <li><a href='index.html'>util</a></li>
  <li>&gt;</li>
  <li><a href='FileLogger.html'>FileLogger</a></li>
</ul>
</div>
</div>
<div class='content'>
<div>
<div class='fandoc'>
<div class='type'>
<div class='overview'>
<h2>const class</h2>
<h1>util::FileLogger</h1>
<pre><a href='../sys/Obj.html'>sys::Obj</a>
  <a href='../concurrent/ActorPool.html'>concurrent::ActorPool</a>
    util::FileLogger</pre>
</div>
</div>
<div class='src'>
<pre>
<span class='y'>//</span>
<span class='y'>// Copyright (c) 2008, Brian Frank and Andy Frank</span>
<span class='y'>// Licensed under the Academic Free License version 3.0</span>
<span class='y'>//</span>
<span class='y'>// History:</span>
<span class='y'>//   8 Apr 08  Brian Frank  Creation</span>
<span class='y'>//</span>

<span class='k'>using</span> concurrent

<span class='z'>**</span>
<span class='z'>** FileLogger appends Str log entries to a file.  You</span>
<span class='z'>** can add a FileLogger as a Log handler:</span>
<span class='z'>**</span>
<span class='z'>**    sysLogger := FileLogger</span>
<span class='z'>**    {</span>
<span class='z'>**      dir = scriptDir</span>
<span class='z'>**      filename = "sys-{YYMM}.log"</span>
<span class='z'>**    }</span>
<span class='z'>**    Log.addHandler |rec| { sysLogger.writeLogRec(rec) }</span>
<span class='z'>**</span>
<span class='z'>** See `filename` for specifying a datetime pattern for your log files.</span>
<span class='z'>**</span>
<span class='k'>const</span> <span class='k'>class</span> FileLogger : ActorPool
<span class='b'>{</span>

  <span class='z'>**</span>
  <span class='z'>** Constructor must set `dir` and `filename`</span>
  <span class='z'>**</span>
  <span class='k'>new</span> <span id='make'>make</span><span class='b'>(</span>|This|? f := <span class='k'>null</span><span class='b'>)</span> : <span class='k'>super</span><span class='b'>(</span>f<span class='b'>)</span> <span class='b'>{}</span>

  <span class='z'>**</span>
  <span class='z'>** Directory used to store log file(s).</span>
  <span class='z'>**</span>
  <span class='k'>const</span> File <span id='dir'>dir</span>

  <span class='z'>**</span>
  <span class='z'>** Log filename pattern.  The name may contain a pattern between</span>
  <span class='z'>** '{}' using the pattern format of `sys::DateTime.toLocale`.  For</span>
  <span class='z'>** example to maintain a log file per month, use a filename such</span>
  <span class='z'>** as "mylog-{YYYY-MM}.log".</span>
  <span class='z'>**</span>
  <span class='k'>const</span> Str <span id='filename'>filename</span>

  <span class='z'>**</span>
  <span class='z'>** Callback called each time the file logger opens an existing</span>
  <span class='z'>** or new log file.  Callback should write any header information</span>
  <span class='z'>** to the given output stream.  The callback will occur on the logger's</span>
  <span class='z'>** actor, so take care not incur additional actor messaging.</span>
  <span class='z'>**</span>
  <span class='k'>const</span> |OutStream|? <span id='onOpen'>onOpen</span>

  <span class='z'>**</span>
  <span class='z'>** Append string log message to file.</span>
  <span class='z'>**</span>
  Void <span id='writeLogRec'>writeLogRec</span><span class='b'>(</span>LogRec rec<span class='b'>)</span>
  <span class='b'>{</span>
    actor.send<span class='b'>(</span>rec<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Append string log message to file.</span>
  <span class='z'>**</span>
  Void <span id='writeStr'>writeStr</span><span class='b'>(</span>Str msg<span class='b'>)</span>
  <span class='b'>{</span>
    actor.send<span class='b'>(</span>msg<span class='b'>)</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Run the script</span>
  <span class='z'>**</span>
  <span class='k'>internal</span> Obj? <span id='receive'>receive</span><span class='b'>(</span>Obj msg<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>try</span>
    <span class='b'>{</span>
      <span class='y'>// get or initialize current state</span>
      state := Actor.locals<span class='b'>[</span><span class='s'>"state"</span><span class='b'>]</span> <span class='k'>as</span> FileLoggerState
      <span class='k'>if</span> <span class='b'>(</span>state == <span class='k'>null</span><span class='b'>)</span>
        Actor.locals<span class='b'>[</span><span class='s'>"state"</span><span class='b'>]</span> = state = FileLoggerState<span class='b'>(</span><span class='k'>this</span><span class='b'>)</span>

      <span class='y'>// append to current file</span>
      <span class='k'>if</span> <span class='b'>(</span>msg <span class='k'>is</span> LogRec<span class='b'>)</span>
      <span class='b'>{</span>
        rec := <span class='b'>(</span>LogRec<span class='b'>)</span>msg
        state.out.printLine<span class='b'>(</span>rec<span class='b'>)</span>
        <span class='k'>if</span> <span class='b'>(</span>rec.err != <span class='k'>null</span><span class='b'>)</span> rec.err.trace<span class='b'>(</span>state.out<span class='b'>)</span>
        state.out.flush
      <span class='b'>}</span>
      <span class='k'>else</span>
      <span class='b'>{</span>
        state.out.printLine<span class='b'>(</span>msg<span class='b'>)</span>.flush
      <span class='b'>}</span>
    <span class='b'>}</span>
    <span class='k'>catch</span> <span class='b'>(</span>Err e<span class='b'>)</span>
    <span class='b'>{</span>
      log.err<span class='b'>(</span><span class='s'>"FileLogger.receive"</span>, e<span class='b'>)</span>
    <span class='b'>}</span>
    <span class='k'>return</span> <span class='k'>null</span>
  <span class='b'>}</span>

  <span class='k'>private</span> <span class='k'>const</span> <span class='k'>static</span> Log <span id='log'>log</span> := Log.get<span class='b'>(</span><span class='s'>"logger"</span><span class='b'>)</span>
  <span class='k'>private</span> <span class='k'>const</span> Actor <span id='actor'>actor</span> := Actor<span class='b'>(</span><span class='k'>this</span><span class='b'>)</span> |msg| <span class='b'>{</span> receive<span class='b'>(</span>msg<span class='b'>)</span> <span class='b'>}</span>

<span class='b'>}</span>

<span class='k'>internal</span> <span class='k'>class</span> FileLoggerState
<span class='b'>{</span>
  <span class='k'>new</span> make<span class='b'>(</span>FileLogger logger<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>this</span>.logger   = logger
    <span class='k'>this</span>.dir      = logger.dir
    <span class='k'>this</span>.filename = logger.filename
    i := filename.index<span class='b'>(</span><span class='s'>"{"</span><span class='b'>)</span>
    <span class='k'>if</span> <span class='b'>(</span>i != <span class='k'>null</span><span class='b'>)</span>
      <span class='k'>this</span>.pattern = filename<span class='b'>[</span>i+1 ..&lt; filename.index<span class='b'>(</span><span class='s'>"}"</span><span class='b'>)]</span>
    <span class='k'>else</span>
      open<span class='b'>(</span>dir + filename.toUri<span class='b'>)</span>
  <span class='b'>}</span>

  OutStream out<span class='b'>()</span>
  <span class='b'>{</span>
    <span class='y'>// check if we need to open a new file</span>
    <span class='k'>if</span> <span class='b'>(</span>pattern != <span class='k'>null</span> &amp;&amp; DateTime.now.toLocale<span class='b'>(</span>pattern<span class='b'>)</span> != curPattern<span class='b'>)</span>
    <span class='b'>{</span>
      <span class='y'>// if we currently have a file open, then close it</span>
      curOut?.close

      <span class='y'>// open new file with new pattern</span>
      curPattern = DateTime.now.toLocale<span class='b'>(</span>pattern<span class='b'>)</span>
      newName := filename<span class='b'>[</span>0..&lt;filename.index<span class='b'>(</span><span class='s'>"{"</span><span class='b'>)]</span> +
                 curPattern +
                 filename<span class='b'>[</span>filename.index<span class='b'>(</span><span class='s'>"}"</span><span class='b'>)</span>+1..-1<span class='b'>]</span>
      curFile := dir + newName.toUri
      <span class='k'>return</span> open<span class='b'>(</span>curFile<span class='b'>)</span>
    <span class='b'>}</span>

    <span class='y'>// current output stream</span>
    <span class='k'>return</span> curOut
  <span class='b'>}</span>

  OutStream open<span class='b'>(</span>File curFile<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>this</span>.curOut = curFile.out<span class='b'>(</span><span class='k'>true</span><span class='b'>)</span>
    <span class='k'>try</span>
      logger.onOpen?.call<span class='b'>(</span><span class='k'>this</span>.curOut<span class='b'>)</span>
    <span class='k'>catch</span> <span class='b'>(</span>Err e<span class='b'>)</span>
      curOut.printLine<span class='b'>(</span><span class='s'>"ERROR: FileLogger.onOpen\n${e.traceToStr}"</span><span class='b'>)</span>
    <span class='k'>return</span> <span class='k'>this</span>.curOut
  <span class='b'>}</span>

  <span class='k'>const</span> FileLogger logger
  <span class='k'>const</span> Str filename
  <span class='k'>const</span> File dir
  Str? pattern
  Str curPattern := <span class='s'>""</span>
  OutStream? curOut
<span class='b'>}</span></pre>
</div>
</div>
<div class='sidebar'>
<h2>More Info</h2>
<ul class='clean'>
  <li><a href='FileLogger.html'>View Fandoc</a></li>
</ul>
<div class='slots'>
<div class='overview'>
<h2>Slots</h2>
<ul class='clean'>
  <li class='hidden' style='display: block;'><a href='#actor'>actor</a></li>
  <li style='display: block;'><a href='#dir'>dir</a></li>
  <li style='display: block;'><a href='#filename'>filename</a></li>
  <li class='hidden' style='display: block;'><a href='#log'>log</a></li>
  <li style='display: block;'><a href='#make'>make</a></li>
  <li style='display: block;'><a href='#onOpen'>onOpen</a></li>
  <li class='hidden' style='display: block;'><a href='#receive'>receive</a></li>
  <li style='display: block;'><a href='#writeLogRec'>writeLogRec</a></li>
  <li style='display: block;'><a href='#writeStr'>writeStr</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class='footer'>
<div>
<p>
util 1.0.56
[11-Nov-2010 Thu 10:08:19AM EST]
</p>
</div>
</div>
</body>
</html>
